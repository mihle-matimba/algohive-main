<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AlgoHive — Open Strategies</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root { --olive:#556B2F; --olive-700:#3e4f23; --olive-100:#ecf4e6; --page-bg:#f9f9f9; }
    html,body{ font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--page-bg); color:#111827 }

    /* Sidebar shell (partial injects markup) */
    .sidebar{ width:16rem; transition:width .2s ease; background:#fff; border-right:1px solid #e5e7eb; box-shadow:0 1px 2px rgba(0,0,0,.04); height:100vh; position:sticky; top:0; }
    .sidebar.is-collapsed{ width:4.25rem }
    .label{ transition:opacity .15s }
    .sidebar.is-collapsed .label,.sidebar.is-collapsed .section-title,.sidebar.is-collapsed .account-wrap{ opacity:0; pointer-events:none; width:0; height:0; padding:0; margin:0; }
    .section-title{ font-size:.7rem; letter-spacing:.05em; text-transform:uppercase; color:#9ca3af; padding-left:1rem; margin:.75rem 0 .25rem }
    .sidebar-link{ display:flex; align-items:center; gap:.75rem; padding:.7rem 1rem; border-radius:.7rem; color:#4b5563; font-weight:500 }
    .sidebar-link:hover{ background:#f3f4f6; color:#111827 }
    .sidebar-link.active{ background:var(--olive-100); color:var(--olive-700); font-weight:600 }

    /* Toolbar pills */
    .ah-pill2{ display:inline-flex; align-items:center; border:1px solid #e5e7eb; background:#f1f5f9; border-radius:9999px; padding:.55rem .9rem; font-size:.9rem }
    .ah-dd2{ position:relative }
    .ah-menu2{ display:none; position:absolute; left:0; top:110%; background:#fff; border:1px solid #e5e7eb; border-radius:.75rem; overflow:hidden; min-width:12rem; z-index:20; box-shadow:0 8px 20px rgba(0,0,0,.06) }
    .ah-menu2 button{ display:block; width:100%; text-align:left; padding:.6rem .9rem; font-size:.92rem }
    .ah-dd2.open .ah-menu2{ display:block }

    /* Table + header */
    .spark{ width:100%; height:44px }
    .spark-td{ min-width:120px; width:160px }
    .chip{ display:inline-flex; align-items:center; border-radius:9999px; padding:.2rem .45rem; font-size:.75rem; font-weight:600 }
    .num{ font-variant-numeric: tabular-nums }
    #rowsScroll{ max-height:540px; overflow-y:auto }
    thead th{ position:sticky; top:0; z-index:1 }
    .glass-header{ backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); background:rgba(255,255,255,.65); border-bottom:1px solid rgba(229,231,235,.9) }
    .row-selected{ background:var(--olive-100) }

    /* Stats tiles */
    .stat-tile{ background:#fff; border:1px solid #e5e7eb; border-radius:.75rem; padding:.9rem }
    .stat-label{ font-size:.75rem; color:#6b7280 }
    .stat-value{ font-weight:700; font-size:1.1rem }
  </style>
</head>

<body>
  <div class="min-h-screen flex">
    <!-- Global menu mount -->
    <div id="sidebarMount"></div>

    <!-- MAIN -->
    <main class="flex-1 bg-[var(--page-bg)] min-h-screen">
      <!-- Watchlist + Ticker -->
      <section class="w-full border-b border-gray-200 bg-white">
        <div class="max-w-7xl mx-auto px-6">
          <div class="flex items-center gap-4">
            <div class="tradingview-widget-container flex-1">
              <div class="tradingview-widget-container__widget"></div>
              <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
                {
                  "symbols": [
                    { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500 Index" },
                    { "proName": "FOREXCOM:NSXUSD", "title": "US 100 Cash CFD" },
                    { "proName": "FX_IDC:EURUSD", "title": "EUR to USD" },
                    { "proName": "BITSTAMP:BTCUSD", "title": "Bitcoin" },
                    { "proName": "BITSTAMP:ETHUSD", "title": "Ethereum" }
                  ],
                  "colorTheme": "light", "locale": "en", "isTransparent": true,
                  "displayMode": "adaptive", "showSymbolLogo": true
                }
              </script>
            </div>
          </div>
        </div>
      </section>

      <!-- Explore header (restored original layout with wide CTA) -->
      <section class="w-full bg-[var(--page-bg)]">
        <div class="max-w-7xl mx-auto px-6 border-b border-gray-200">
          <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 pt-8 pb-6">
            <div class="lg:col-span-8">
              <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                <div>
                  <h1 class="text-[32px] leading-[1.15] font-semibold tracking-tight">Explore OpenStrategies</h1>
                  <p class="text-sm text-gray-600 mt-1">
                    OpenStrategies Index is up <span class="text-green-600 font-medium">+3.87%</span> in the last quarter
                    <i class="fa-solid fa-circle-info text-gray-400 ml-1"></i>
                  </p>
                </div>
                <div class="w-full md:w-[560px]">
                  <div class="relative">
                    <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-600"></i>
                    <input id="searchInput" type="text" placeholder="Search for a strategy or provider"
                      class="h-12 w-full rounded-full border border-gray-200 bg-[#eef2f5] pl-11 pr-5 text-sm focus:outline-none focus:ring-2 focus:ring-[rgba(85,107,47,.18)] focus:border-[rgba(85,107,47,.45)]"/>
                  </div>
                </div>
              </div>
            </div>
            <!-- Original wide CTA -->
            <aside class="lg:col-span-4">
              <div class="rounded-2xl p-5 text-white bg-gradient-to-br from-black via-[#111827] to-[var(--olive)] border border-black/10 shadow-sm">
                <div class="text-sm uppercase tracking-wide text-white/80 mb-1">Get started</div>
                <h3 class="text-lg font-semibold leading-snug mb-2">Create your AlgoHive investor account</h3>
                <p class="text-sm text-white/80 mb-4">Allocate to vetted strategies in minutes.</p>
                <a href="#" class="inline-flex items-center gap-2 rounded-full bg-white text-black px-4 py-2 text-sm font-medium hover:opacity-90">
                  Sign up <i class="fa-solid fa-arrow-right text-xs"></i>
                </a>
              </div>
            </aside>
          </div>
        </div>
      </section>

      <!-- Main -->
      <section>
        <div class="max-w-7xl mx-auto px-6 pt-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
          <!-- Left -->
          <section class="lg:col-span-8 xl:col-span-9">
            <!-- Aggregate tiles -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4" id="aggTiles"></div>

            <!-- Toolbar (order: ASSET CLASS, STRATEGY TYPE, WINDOW, METRIC) -->
            <div class="mb-4">
              <div class="flex flex-wrap items-center gap-2">
                <!-- Asset Class -->
                <div class="ah-dd2">
                  <button id="btnAsset" class="ah-pill2">
                    <span id="assetLabel">Asset: All</span><i class="fa-solid fa-chevron-down ml-2 text-xs"></i>
                  </button>
                  <div class="ah-menu2">
                    <button data-asset="all">All</button>
                    <button data-asset="Equities">Equities</button>
                    <button data-asset="FX">FX</button>
                    <button data-asset="Crypto">Crypto</button>
                    <button data-asset="Futures">Futures</button>
                    <button data-asset="Commodities">Commodities</button>
                  </div>
                </div>

                <!-- Strategy Type -->
                <div class="ah-dd2">
                  <button id="btnCat" class="ah-pill2">
                    <i class="fa-solid fa-globe mr-2"></i><span id="catLabel">Strategy: All</span>
                    <i class="fa-solid fa-chevron-down ml-2 text-xs"></i>
                  </button>
                  <div class="ah-menu2">
                    <button data-filter="all">All strategies</button>
                    <button data-filter="trend">Trend</button>
                    <button data-filter="mean">Mean-revert</button>
                    <button data-filter="grid">Grid</button>
                    <button data-filter="news">News</button>
                  </div>
                </div>

                <!-- Window / Timeframe -->
                <div class="ah-dd2">
                  <button id="btnWin" class="ah-pill2">
                    <span id="winLabel">1D</span><i class="fa-solid fa-chevron-down ml-2 text-xs"></i>
                  </button>
                  <div class="ah-menu2">
                    <button data-window="1D">1D</button>
                    <button data-window="1M">1M</button>
                    <button data-window="3M">3M</button>
                    <button data-window="6M">6M</button>
                    <button data-window="1Y">1Y</button>
                    <button data-window="YTD">YTD</button>
                    <button data-window="3Y">3Y</button>
                    <button data-window="ALL">All</button>
                  </div>
                </div>

                <!-- Metric filter -->
                <div class="ah-dd2">
                  <button id="btnMetric" class="ah-pill2">
                    <span id="metricLabel">Metric: Any</span><i class="fa-solid fa-chevron-down ml-2 text-xs"></i>
                  </button>
                  <div class="ah-menu2">
                    <button data-metric="any">Any</button>
                    <button data-metric="sharpe_gt_1">Sharpe ≥ 1.0</button>
                    <button data-metric="dd_lt_10">Max DD ≤ 10%</button>
                    <button data-metric="win_gt_55">Win rate ≥ 55%</button>
                    <button data-metric="m1_gt_0">1M Return ≥ 0%</button>
                    <button data-metric="m3_gt_0">3M Return ≥ 0%</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Table -->
            <div class="overflow-hidden rounded-xl border border-gray-200 bg-white">
              <div id="rowsScroll">
                <table class="w-full text-sm">
                  <thead class="glass-header text-gray-600">
                    <tr>
                      <th class="px-4 py-3 text-left font-medium">
                        <a href="/factsheet.html" class="hover:underline">Strategy</a>
                      </th>
                      <th class="px-4 py-3 text-right font-medium">Min Allocation</th>
                      <th class="px-4 py-3 text-left font-medium">Chart</th>
                      <th class="px-4 py-3 text-right font-medium">Change</th>
                      <th class="px-4 py-3 text-right font-medium">TCM</th>
                      <th class="px-4 py-3 text-right font-medium">Investors</th>
                      <th class="px-4 py-3 text-right font-medium">Action</th>
                    </tr>
                  </thead>
                  <tbody id="rows" class="divide-y divide-gray-100"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- Right -->
          <aside class="lg:col-span-4 xl:col-span-3 space-y-6">
            <div id="strategyMetrics" class="border rounded-2xl p-5 bg-white border-gray-200 shadow-sm">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold">Strategy metrics</h3>
                <span id="selBadge" class="text-xs px-2 py-0.5 rounded-full bg-[var(--olive-100)] text-[var(--olive-700)]">selected</span>
              </div>
              <div class="mb-3">
                <div id="mName" class="text-sm font-medium"></div>
                <div id="mProvider" class="text-xs text-gray-500"></div>
              </div>
              <div id="mSpark" class="mb-3"></div>
              <div class="flex flex-wrap gap-2 mb-3">
                <span id="chip1M" class="chip bg-green-50 text-green-700">1M: <span id="m1M" class="ml-1">+0.0%</span></span>
                <span id="chip3M" class="chip bg-green-50 text-green-700">3M: <span id="m3M" class="ml-1">+0.0%</span></span>
                <span class="chip bg-gray-100 text-gray-700">YTD: <span id="mYTD" class="ml-1">0.0%</span></span>
              </div>
              <div class="grid grid-cols-2 gap-3 text-sm">
                <div><div class="text-gray-500 text-xs">Sharpe</div><div id="mSharpe" class="font-semibold">—</div></div>
                <div><div class="text-gray-500 text-xs">Max DD</div><div id="mDD" class="font-semibold">—</div></div>
                <div><div class="text-gray-500 text-xs">Win rate</div><div id="mWin" class="font-semibold">—</div></div>
                <div><div class="text-gray-500 text-xs">TCM</div><div id="mAUM" class="font-semibold">—</div></div>
              </div>
              <div class="mt-4 flex flex-col gap-2">
                <a href="#" class="inline-flex items-center justify-center gap-2 rounded-full bg-[var(--olive)] text-white px-4 py-2 text-sm hover:opacity-95 transition">Allocate</a>
                <a id="viewFactSheet" href="#" target="_blank" class="inline-flex items-center justify-center gap-2 rounded-full border border-[var(--olive)] text-[var(--olive)] px-4 py-2 text-sm hover:bg-[var(--olive-100)] transition">
                  View FactSheet <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i>
                </a>
              </div>
            </div>

            <div class="border rounded-2xl p-5 bg-white border-gray-200 shadow-sm">
              <div class="font-semibold mb-3">Top movers</div>
              <div id="topMovers" class="grid grid-cols-2 gap-3"></div>
            </div>
          </aside>
        </div>

        <!-- Disclaimer -->
        <div class="max-w-7xl mx-auto px-6 mt-10">
          <div class="rounded-lg bg-gray-50 border border-gray-200 p-5 text-xs text-gray-600 leading-relaxed">
            <strong>Disclaimer:</strong> Past performance is not indicative of future results. Returns displayed are <strong>net of model costs</strong> but
            <u>exclude brokerage fees, potential slippage, and applicable taxes</u>. Trading and investing involve significant risk,
            including the potential loss of capital. AlgoHive (FSP 55118) is regulated by the FSCA. Review our
            <a class="hover:underline" href="/docs/terms-of-service.pdf">Terms of Service</a>,
            <a class="hover:underline" href="/docs/risk-disclosure.pdf">Risk Disclosure</a>, and
            <a class="hover:underline" href="/docs/privacy-policy.pdf">Privacy Policy</a>.
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
  /* ===== Robust menu load (tries multiple paths) ===== */
  async function loadMenu(urls=[
    '/partials/menu.html','./partials/menu.html','partials/menu.html'
  ], mountId='sidebarMount'){
    const mount=document.getElementById(mountId); if(!mount) return;
    if(location.protocol==='file:'){ // local file guard
      mount.outerHTML = '<aside id="sidebar" class="sidebar"><div class="p-3">Run via a local server to load menu.</div></aside>';
      return;
    }
    for(const url of urls){
      try{
        const res=await fetch(url,{cache:'no-store'}); if(!res.ok) continue;
        mount.outerHTML = await res.text();
        break;
      }catch(e){}
    }
    // mark active + collapse wiring
    const navContainer=document.getElementById('navContainer');
    const sidebar=document.getElementById('sidebar');
    const collapseBtn=document.getElementById('collapseBtn');
    if(navContainer){
      navContainer.querySelectorAll('a.sidebar-link').forEach(a=>{
        a.classList.toggle('active', a.getAttribute('href')==='/open-strategies.html');
      });
    }
    if(sidebar && collapseBtn){
      const applyState=(c)=>{ sidebar.classList.toggle('is-collapsed', c); collapseBtn.innerHTML=c?'<i class="fa-solid fa-angles-right text-sm"></i>':'<i class="fa-solid fa-angles-left text-sm"></i>';};
      let collapsed=false; try{ collapsed = sessionStorage.getItem('ah_sidebar_collapsed')==='1'; }catch(e){}
      applyState(collapsed);
      collapseBtn.addEventListener('click',()=>{ collapsed=!collapsed; applyState(collapsed); try{ sessionStorage.setItem('ah_sidebar_collapsed', collapsed?'1':'0'); }catch(e){} });
    }
  }

  /* ===== Demo data ===== */
  function rnd(n,m){ return Math.random()*(m-n)+n; }
  function sparkGen(len=180, base=rnd(90,110)){ const arr=[base]; for(let i=1;i<len;i++){ arr.push(arr[i-1]*(1+rnd(-0.01,0.012))); } return arr.map(v=>+v.toFixed(2)); }
  const tags=['trend','mean','grid','news'];
  const providers=['AlgoForge','QuantBee','GridOps','PulseAI'];
  const strategies = Array.from({length:60}).map((_,i)=>({
    key:`strat-${i+1}`,
    name:`Strategy ${i+1}`,
    provider: providers[i%4],
    tag: tags[i%4],
    price: +rnd(79,229).toFixed(2),  // Min Allocation (used in Avg Investment)
    tcm: Math.round(rnd(120_000, 4_200_000)),
    investors: Math.round(rnd(40,1400)),
    spark: sparkGen()
  }));

  /* ===== State & helpers ===== */
  let AH_STATE = { tag:'all', asset:'all', window:'1D', metric:'any', cur:'ZAR', rows:20 };
  let selectedKey = strategies[0].key;
  let currentList = strategies.slice();

  const rowsEl = document.getElementById('rows');
  const searchInput = document.getElementById('searchInput');
  const scrollBox = document.getElementById('rowsScroll');

  function fmtMoney(v, cur=AH_STATE.cur){ try{ return new Intl.NumberFormat(cur==='ZAR'?'en-ZA':'en-US',{style:'currency',currency:cur,maximumFractionDigits:2}).format(v);}catch{return v.toFixed(2);} }
  function fmtTCM(r){ const abs=Math.abs(r), s=r<0?'-':''; const f=n=>Number.isInteger(n)?String(n):n.toFixed(1); if(abs<1_000) return `${s}R${abs}`; if(abs<1_000_000) return `${s}R${f(abs/1_000)}k`; if(abs<1_000_000_000) return `${s}R${f(abs/1_000_000)}m`; return `${s}R${f(abs/1_000_000_000)}b`; }
  function chipForChange(p){ const pos=p>=0; return `<span class="chip ${pos?'bg-green-50 text-green-700':'bg-red-50 text-red-700'}">${pos?'+':''}${(+p).toFixed(2)}%</span>`; }
  function sparkSvg(series, color='#111827'){ const w=160,h=44,p=6; const min=Math.min(...series), max=Math.max(...series), range=(max-min)||1; const step=(w-p*2)/(series.length-1); let d=''; series.forEach((v,i)=>{ const x=p+i*step; const y=p+(h-p*2)*(1-(v-min)/range); d+=(i?' L':' M')+x.toFixed(2)+' '+y.toFixed(2); }); return `<svg class="spark" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none"><path d="${d.trim()}" fill="none" stroke="${color}" stroke-width="2"/></svg>`; }

  // Timeframe % change from spark data
  function pctChangeForWindow(s, win){
    const arr=s.spark, n=arr.length, last=arr[n-1];
    const map={'1D':1,'1M':21,'3M':63,'6M':126,'1Y':252,'YTD':'YTD','3Y':756,'ALL':n-1};
    const off = map[win] ?? 1;
    let refIdx = n-2;
    if(typeof off==='number'){ refIdx=Math.max(0,n-1-off); }
    else if(off==='YTD'){ refIdx=Math.max(0, n-252); }
    const ref=arr[refIdx]||arr[0];
    return ((last/ref)-1)*100;
  }

  function strategyStats(s){
    const oneM = pctChangeForWindow(s,'1M');
    const threeM = pctChangeForWindow(s,'3M');
    const ytd = pctChangeForWindow(s,'YTD');
    const rets=[]; for(let i=1;i<s.spark.length;i++){ rets.push((s.spark[i]/s.spark[i-1])-1); }
    const avg=rets.reduce((a,b)=>a+b,0)/rets.length;
    const sd=Math.sqrt(rets.reduce((a,b)=>a+(b-avg)*(b-avg),0)/rets.length)||0.00001;
    const sharpe=(avg/sd)*Math.sqrt(252);
    let peak=s.spark[0], mdd=0; for(const v of s.spark){ peak=Math.max(peak,v); mdd=Math.min(mdd, v/peak-1); }
    const wins=rets.filter(r=>r>0).length/rets.length*100;
    return {
      oneM:+oneM.toFixed(2), threeM:+threeM.toFixed(2), ytd:+ytd.toFixed(2),
      sharpe:+sharpe.toFixed(2), dd:+(Math.abs(mdd)*100).toFixed(1), win:+wins.toFixed(0),
      tcm: fmtTCM(s.tcm)
    };
  }

  /* ===== Renderers ===== */
  function render(list, rowsCount=AH_STATE.rows){
    if(!rowsEl) return;
    const slice=list.slice(0, rowsCount);
    rowsEl.innerHTML = slice.map(s=>{
      const selected = s.key===selectedKey ? 'row-selected' : '';
      const chg = pctChangeForWindow(s, AH_STATE.window);
      return `<tr class="${selected}">
        <td class="px-4 py-3 truncate">
          <div class="font-medium truncate">${s.name}</div>
          <div class="text-xs text-gray-500 truncate">${s.provider} • ${s.tag}</div>
        </td>
        <td class="px-4 py-3 text-right num">${fmtMoney(s.price)}</td>
        <td class="px-4 py-3 spark-td">${sparkSvg(s.spark)}</td>
        <td class="px-4 py-3 text-right">${chipForChange(chg)}</td>
        <td class="px-4 py-3 text-right num">${fmtTCM(s.tcm)}</td>
        <td class="px-4 py-3 text-right num">${s.investors.toLocaleString()}</td>
        <td class="px-4 py-3 text-right">
          <button class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full border border-gray-200 hover:bg-[var(--olive-100)] text-xs" onclick="selectForMetrics('${s.key}')">
            View
          </button>
        </td>
      </tr>`;
    }).join('');
    renderTopMovers(list);
    renderAggTiles(list);
  }

  function aggregateStats(list){
    const totalTCM = list.reduce((a,b)=>a+b.tcm,0);
    const avgChg = list.reduce((a,b)=>a + pctChangeForWindow(b, AH_STATE.window), 0) / Math.max(1,list.length);
    const totalInv = list.reduce((a,b)=>a+b.investors,0);
    const avgInvestment = list.reduce((a,b)=>a+b.price,0) / Math.max(1,list.length);
    return { totalTCM, avgChg, totalInv, avgInvestment };
  }

  function renderAggTiles(list){
    const box=document.getElementById('aggTiles'); if(!box) return;
    const { totalTCM, avgChg, totalInv, avgInvestment } = aggregateStats(list);
    box.innerHTML = `
      <div class="stat-tile"><div class="stat-label">Total TCM</div><div class="stat-value num">${fmtTCM(totalTCM)}</div></div>
      <div class="stat-tile"><div class="stat-label">Avg ${AH_STATE.window} Change</div><div class="stat-value ${avgChg>=0?'text-green-600':'text-red-600'}">${avgChg>=0?'+':''}${avgChg.toFixed(2)}%</div></div>
      <div class="stat-tile"><div class="stat-label">Total Investors</div><div class="stat-value num">${totalInv.toLocaleString()}</div></div>
      <div class="stat-tile"><div class="stat-label">Avg Investment</div><div class="stat-value num">${fmtMoney(avgInvestment)}</div></div>
    `;
  }

  function renderTopMovers(list){
    const box=document.getElementById('topMovers'); if(!box) return;
    const movers=[...list].sort((a,b)=>Math.abs(pctChangeForWindow(b,AH_STATE.window))-Math.abs(pctChangeForWindow(a,AH_STATE.window))).slice(0,4);
    box.innerHTML = movers.map(s=>{
      const chg=pctChangeForWindow(s, AH_STATE.window);
      const selected = s.key===selectedKey ? 'bg-[var(--olive-100)]' : 'bg-white';
      return `<button class="text-left p-3 rounded-lg border border-gray-200 hover:bg-[var(--olive-100)] ${selected}" onclick="selectForMetrics('${s.key}')">
        <div class="text-sm font-medium truncate">${s.name}</div>
        <div class="text-xs text-gray-500 truncate">${s.provider}</div>
        <div class="mt-2">${chipForChange(chg)}</div>
      </button>`;
    }).join('');
  }

  // Metrics card
  function setChip(elId, val){ const el=document.getElementById(elId); if(!el) return; const parent=el.parentElement; const pos=val>=0; el.textContent=`${pos?'+':''}${val}%`; parent.className=`chip ${pos?'bg-green-50 text-green-700':'bg-red-50 text-red-700'}`; }
  window.renderMetricsCard = function(key){
    const s = strategies.find(x=>x.key===key) || strategies[0]; if(!s) return;
    const st=strategyStats(s);
    const mName=document.getElementById('mName'); if(!mName) return;
    mName.textContent=s.name;
    document.getElementById('mProvider').textContent=`${s.provider} • ${s.tag}`;
    document.getElementById('mSpark').innerHTML = sparkSvg(s.spark);
    setChip('m1M', st.oneM);
    setChip('m3M', st.threeM);
    document.getElementById('mYTD').textContent=`${st.ytd>=0?'+':''}${st.ytd}%`;
    document.getElementById('mSharpe').textContent=st.sharpe;
    document.getElementById('mDD').textContent=st.dd+'%';
    document.getElementById('mWin').textContent=st.win+'%';
    document.getElementById('mAUM').textContent=st.tcm;
    // Deep link to factsheet route
    const fs=document.getElementById('viewFactSheet');
    if (fs) fs.href=`/factsheet?strategyName=${encodeURIComponent(s.name)}`;
  }
  window.selectForMetrics = function(key){ selectedKey=key; render(currentList, AH_STATE.rows); renderMetricsCard(key); }

  /* ===== Filters & wiring ===== */
  // dropdown open/close
  document.querySelectorAll('.ah-dd2 > button').forEach(btn=>{
    btn.addEventListener('click',(e)=>{
      const dd=e.currentTarget.parentElement; const open=dd.classList.contains('open');
      document.querySelectorAll('.ah-dd2').forEach(d=>d.classList.remove('open'));
      if(!open) dd.classList.add('open');
    });
  });
  document.addEventListener('click',(e)=>{ if(!e.target.closest('.ah-dd2')) document.querySelectorAll('.ah-dd2').forEach(d=>d.classList.remove('open')); });

  // Strategy type
  document.querySelectorAll('.ah-menu2 button[data-filter]').forEach(b=>{
    b.addEventListener('click',()=>{ AH_STATE.tag=b.dataset.filter; const el=document.getElementById('catLabel'); if(el) el.textContent=(b.dataset.filter==='all'?'Strategy: All':`Strategy: ${b.textContent}`); applyToolbarFilters(); });
  });
  // Asset class (placeholder demo)
  document.querySelectorAll('.ah-menu2 button[data-asset]').forEach(b=>{
    b.addEventListener('click',()=>{ AH_STATE.asset=b.dataset.asset; const el=document.getElementById('assetLabel'); if(el) el.textContent=`Asset: ${b.textContent}`; applyToolbarFilters(); });
  });
  // Window / timeframe
  document.querySelectorAll('.ah-menu2 button[data-window]').forEach(b=>{
    b.addEventListener('click',()=>{ AH_STATE.window=b.dataset.window; const el=document.getElementById('winLabel'); if(el) el.textContent=b.dataset.window; applyToolbarFilters(); });
  });
  // Metric filter
  const metricLabelEl=document.getElementById('metricLabel');
  document.querySelectorAll('.ah-menu2 button[data-metric]').forEach(b=>{
    b.addEventListener('click',()=>{ AH_STATE.metric=b.dataset.metric; if(metricLabelEl) metricLabelEl.textContent=`Metric: ${b.textContent}`; applyToolbarFilters(); });
  });

  function metricPass(s){
    const st = strategyStats(s);
    switch(AH_STATE.metric){
      case 'sharpe_gt_1': return st.sharpe >= 1.0;
      case 'dd_lt_10': return st.dd <= 10;
      case 'win_gt_55': return st.win >= 55;
      case 'm1_gt_0': return st.oneM >= 0;
      case 'm3_gt_0': return st.threeM >= 0;
      default: return true;
    }
  }

  function applyToolbarFilters(){
    const q=(searchInput?.value||'').trim().toLowerCase();
    const tag=AH_STATE.tag, asset=AH_STATE.asset; // asset filter placeholder
    currentList = strategies.filter(s=>{
      const okTag = (tag==='all') || s.tag.toLowerCase().startsWith(tag);
      const okAsset = (asset==='all') || true; // hook this to real asset metadata when ready
      const okQ = !q || s.name.toLowerCase().includes(q) || s.provider.toLowerCase().includes(q);
      const okMetric = metricPass(s);
      return okTag && okAsset && okQ && okMetric;
    });
    AH_STATE.rows=20;
    render(currentList, AH_STATE.rows);
  }

  // Scroll-to-load
  scrollBox?.addEventListener('scroll', ()=>{
    const nearBottom = scrollBox.scrollTop + scrollBox.clientHeight >= scrollBox.scrollHeight - 8;
    if(nearBottom && AH_STATE.rows < currentList.length){ AH_STATE.rows += 15; render(currentList, AH_STATE.rows); }
  });

  /* ===== Init ===== */
  (async function init(){
    await loadMenu();
    applyToolbarFilters();
    renderMetricsCard(selectedKey);
  })();
  </script>
</body>
</html>
