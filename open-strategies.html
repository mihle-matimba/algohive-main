<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AlgoHive — Open Strategies</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root {
      --olive: #556B2F;
      --olive-700: #3e4f23;
      --olive-100: #ecf4e6;
      --page-bg: #f9f9f9;
    }

    html,
    body {
      font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--page-bg);
      color: #111827
    }

    /* Sidebar = full height, sticky */
    .sidebar {
      width: 16rem;
      transition: width .2s ease;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      background: #fff;
      border-right: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .04);
      height: 100vh;
      position: sticky;
      top: 0;
    }

    .sidebar.is-collapsed {
      width: 4.25rem
    }

    /* Sidebar header + collapse */
    .header {
      display: flex;
      align-items: center;
      gap: .75rem;
      margin-bottom: 1rem;
    }

    #collapseBtn {
      display: inline-flex;
      align-items: center;
      justify-content: center
    }

    /* Collapse layout adjustments */
    .sidebar.is-collapsed .header {
      justify-content: center
    }

    .sidebar.is-collapsed #collapseBtn {
      margin-left: 0
    }

    .label {
      transition: opacity .15s
    }

    .brand-logo {
      transition: opacity .15s, transform .2s
    }

    .sidebar.is-collapsed .label,
    .sidebar.is-collapsed .section-title,
    .sidebar.is-collapsed .account-wrap,
    .sidebar.is-collapsed .upgrade-card {
      /* hide these when collapsed */
      opacity: 0;
      pointer-events: none;
      width: 0;
      height: 0;
      padding: 0;
      margin: 0;
    }

    .sidebar.is-collapsed .brand-logo {
      opacity: 0;
      width: 0;
      height: 0;
      margin: 0;
      padding: 0;
      transform: scale(.9)
    }

    /* Nav groups */
    .section-title {
      font-size: .7rem;
      letter-spacing: .05em;
      text-transform: uppercase;
      color: #9ca3af;
      padding-left: 1rem;
      margin: .75rem 0 .25rem
    }

    .sidebar-link {
      display: flex;
      align-items: center;
      gap: .75rem;
      padding: .7rem 1rem;
      border-radius: .7rem;
      color: #4b5563;
      font-weight: 500;
      transition: background .2s, color .2s
    }

    .sidebar-link:hover {
      background: #f3f4f6;
      color: #111827
    }

    .sidebar-link.active {
      background: var(--olive-100);
      color: var(--olive-700);
      font-weight: 600
    }

    /* Center icons when collapsed */
    .sidebar.is-collapsed .sidebar-link {
      justify-content: center;
      gap: 0;
      padding: .7rem
    }

    .sidebar.is-collapsed .sidebar-link i {
      margin: 0
    }

    /* Dropdowns */
    .dropdown {
      background: #fff;
      border: 1px solid #e5e7eb;
      color: #374151;
      padding: .5rem .75rem;
      border-radius: .5rem;
      width: 100%;
      font-size: .875rem
    }

    .dropdown:focus {
      outline: none;
      border-color: var(--olive);
      box-shadow: 0 0 0 2px rgba(85, 107, 47, .2)
    }

    .chev {
      transition: transform .2s
    }

    .chev.rot {
      transform: rotate(180deg)
    }

    .group-body {
      overflow: hidden;
      transition: max-height .25s
    }

    /* Toolbar pills */
    .ah-pill2 {
      display: inline-flex;
      align-items: center;
      border: 1px solid #e5e7eb;
      background: #f1f5f9;
      border-radius: 9999px;
      padding: .55rem .9rem;
      font-size: .9rem
    }

    .ah-dd2 {
      position: relative
    }

    .ah-menu2 {
      display: none;
      position: absolute;
      left: 0;
      top: 110%;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: .75rem;
      overflow: hidden;
      min-width: 12rem;
      z-index: 20;
      box-shadow: 0 8px 20px rgba(0, 0, 0, .06)
    }

    .ah-menu2 button {
      display: block;
      width: 100%;
      text-align: left;
      padding: .6rem .9rem;
      font-size: .92rem
    }

    .ah-dd2.open .ah-menu2 {
      display: block
    }

    /* Right column cards */
    .sidebar-card {
      width: 100%;
      border-radius: 1rem;
      padding: 1.25rem;
      border: 1px solid #e5e7eb;
      background: #fff;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .04)
    }

    /* Table + numbers */
    .spark {
      width: 100%;
      height: 44px
    }

    .spark-td {
      min-width: 120px;
      width: 160px
    }

    .chip {
      display: inline-flex;
      align-items: center;
      border-radius: 9999px;
      padding: .2rem .45rem;
      font-size: .75rem;
      font-weight: 600
    }

    .row-selected {
      background: var(--olive-100)
    }

    .num {
      font-variant-numeric: tabular-nums
    }

    .truncate-cell {
      max-width: 220px
    }

    /* Strategy list scroller */
    #rowsScroll {
      max-height: 540px;
      overflow-y: auto
    }

    thead th {
      position: sticky;
      top: 0;
      z-index: 1
    }

    /* Stats tiles */
    .stat-tile {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 0.9rem
    }

    .stat-label {
      font-size: .75rem;
      color: #6b7280
    }

    .stat-value {
      font-weight: 700;
      font-size: 1.1rem
    }

    /* Full-height, sticky */
    .sidebar {
      width: 16rem;
      transition: width .2s ease;
      background: #fff;
      border-right: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .04);
      height: 100vh;
      position: sticky;
      top: 0;
      display: block;
      /* inner handles flex */
    }

    /* Middle section scrolls; bottom stays anchored */
    #navScroll {
      scrollbar-gutter: stable;
    }

    /* Collapsed: keep upgrade/profile hidden but still anchored at bottom */
    .sidebar.is-collapsed .label,
    .sidebar.is-collapsed .section-title,
    .sidebar.is-collapsed .account-wrap,
    .sidebar.is-collapsed .upgrade-card {
      opacity: 0;
      pointer-events: none;
      width: 0;
      height: 0;
      padding: 0;
      margin: 0;
    }

    /* Center icons + collapse layout when collapsed (unchanged from before) */
    .sidebar.is-collapsed .header {
      justify-content: center
    }

    .sidebar.is-collapsed #collapseBtn {
      margin-left: 0
    }

    .sidebar.is-collapsed .sidebar-link {
      justify-content: center;
      gap: 0;
      padding: .7rem
    }

    .sidebar.is-collapsed .sidebar-link i {
      margin: 0
    }

    /* Glass header row for the table */
    .glass-header {
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      background: rgba(255, 255, 255, 0.65);
      border-bottom: 1px solid rgba(229, 231, 235, 0.9);
      /* gray-200 */
    }
  </style>
</head>

<body>
  <div class="min-h-screen flex">
    <!-- SIDEBAR -->
<!-- Global menu mount -->
<div id="sidebarMount"></div>


    <!-- MAIN -->
    <main class="flex-1 bg-[var(--page-bg)] min-h-screen">
      <!-- Watchlist + Ticker -->
      <!-- Watchlist + Ticker (full-width inside MAIN) -->
<!-- Watchlist + Ticker (full-width but aligned with main content) -->
<section class="w-full border-b border-gray-200 bg-white">
  <div class="max-w-7xl mx-auto px-6">
    <div class="flex items-center gap-4">
      <div class="tradingview-widget-container flex-1">
        <div class="tradingview-widget-container__widget"></div>
        <script type="text/javascript"
          src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
            {
              "symbols": [
                { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500 Index" },
                { "proName": "FOREXCOM:NSXUSD", "title": "US 100 Cash CFD" },
                { "proName": "FX_IDC:EURUSD", "title": "EUR to USD" },
                { "proName": "BITSTAMP:BTCUSD", "title": "Bitcoin" },
                { "proName": "BITSTAMP:ETHUSD", "title": "Ethereum" }
              ],
              "colorTheme": "light",
              "locale": "en",
              "isTransparent": true,
              "displayMode": "adaptive",
              "showSymbolLogo": true
            }
        </script>
      </div>
    </div>
  </div>
</section>



      <!-- Explore header -->
      <section class="w-full bg-[var(--page-bg)]">
        <div class="max-w-7xl mx-auto px-6 border-b border-gray-200">
          <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 pt-8 pb-6">
            <div class="lg:col-span-8">
              <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                <div>
                  <h1 class="text-[32px] leading-[1.15] font-semibold tracking-tight">Explore OpenStrategies</h1>
                  <p class="text-sm text-gray-600 mt-1">
                    OpenStrategies Index is up <span class="text-green-600 font-medium">+3.87%</span> in the last
                    quarter
                    <i class="fa-solid fa-circle-info text-gray-400 ml-1"></i>
                  </p>
                </div>
                <div class="w-full md:w-[560px]">
                  <div class="relative">
                    <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-600"></i>
                    <input id="searchInput" type="text" placeholder="Search for a strategy or provider"
                      class="h-12 w-full rounded-full border border-gray-200 bg-[#eef2f5] pl-11 pr-5 text-sm focus:outline-none focus:ring-2 focus:ring-[rgba(85,107,47,.18)] focus:border-[rgba(85,107,47,.45)]" />
                  </div>
                </div>
              </div>
            </div>
            <!-- Gradient CTA -->
            <aside class="lg:col-span-4">
              <div
                class="rounded-2xl p-5 text-white bg-gradient-to-br from-black via-[#111827] to-[var(--olive)] border border-black/10 shadow-sm">
                <div class="text-sm uppercase tracking-wide text-white/80 mb-1">Get started</div>
                <h3 class="text-lg font-semibold leading-snug mb-2">Create your AlgoHive investor account</h3>
                <p class="text-sm text-white/80 mb-4">Allocate to vetted strategies in minutes.</p>
                <a href="#"
                  class="inline-flex items-center gap-2 rounded-full bg-white text-black px-4 py-2 text-sm font-medium hover:opacity-90">
                  Sign up <i class="fa-solid fa-arrow-right text-xs"></i>
                </a>
              </div>
            </aside>
          </div>
        </div>
      </section>

      <!-- Main -->
      <section>
        <div class="max-w-7xl mx-auto px-6 pt-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
          <!-- Left -->
          <section class="lg:col-span-8 xl:col-span-9">
            <!-- Aggregate tiles -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4" id="aggTiles"></div>

 <!-- Toolbar -->
<div class="mb-4">
  <div class="flex flex-wrap items-center gap-2">
    <!-- Category -->
    <div class="ah-dd2">
      <button id="btnCat" class="ah-pill2">
        <i class="fa-solid fa-globe mr-2"></i><span id="catLabel">All strategies</span>
        <i class="fa-solid fa-chevron-down ml-2 text-xs"></i>
      </button>
      <div class="ah-menu2">
        <button data-filter="all">All strategies</button>
        <button data-filter="trend">Trend</button>
        <button data-filter="mean">Mean-revert</button>
        <button data-filter="grid">Grid</button>
        <button data-filter="news">News</button>
      </div>
    </div>

    <!-- Window -->
    <div class="ah-dd2">
      <button id="btnWin" class="ah-pill2">
        <span id="winLabel">1D</span><i class="fa-solid fa-chevron-down ml-2 text-xs"></i>
      </button>
      <div class="ah-menu2">
        <button data-window="1D">1D</button>
        <button data-window="7D">7D</button>
        <button data-window="30D">30D</button>
        <button data-window="90D">90D</button>
      </div>
    </div>

    <!-- Key Metric filter -->
    <div class="ah-dd2">
      <button id="btnMetric" class="ah-pill2">
        <span id="metricLabel">Metric: Any</span><i class="fa-solid fa-chevron-down ml-2 text-xs"></i>
      </button>
      <div class="ah-menu2">
        <button data-metric="any">Any</button>
        <button data-metric="sharpe_gt_1">Sharpe ≥ 1.0</button>
        <button data-metric="dd_lt_10">Max DD ≤ 10%</button>
        <button data-metric="win_gt_55">Win rate ≥ 55%</button>
        <button data-metric="m1_gt_0">1M Return ≥ 0%</button>
        <button data-metric="m3_gt_0">3M Return ≥ 0%</button>
      </div>
    </div>

    <!-- Asset Class -->
    <div class="ah-dd2">
      <button id="btnAsset" class="ah-pill2">
        <span id="assetLabel">Asset: All</span><i class="fa-solid fa-chevron-down ml-2 text-xs"></i>
      </button>
      <div class="ah-menu2">
        <button data-asset="all">All</button>
        <button data-asset="Equities">Equities</button>
        <button data-asset="FX">FX</button>
        <button data-asset="Crypto">Crypto</button>
        <button data-asset="Futures">Futures</button>
        <button data-asset="Commodities">Commodities</button>
      </div>
    </div>
  </div>
</div>


            <!-- Table (sticky header + scroll-to-load) -->
            <div class="overflow-hidden rounded-xl border border-gray-200 bg-white">
              <div id="rowsScroll">
                <table class="w-full text-sm">
                  <thead class="glass-header text-gray-600">
                    <tr>
                      <th class="px-4 py-3 text-left font-medium">Strategy</th>
                      <th class="px-4 py-3 text-right font-medium">Min Allocation</th><!-- was Price -->
                      <th class="px-4 py-3 text-left font-medium">Chart</th>
                      <th class="px-4 py-3 text-right font-medium">Change</th>
                      <th class="px-4 py-3 text-right font-medium">TCM</th><!-- was AUM -->
                      <th class="px-4 py-3 text-right font-medium">Subs</th>
                      <th class="px-4 py-3 text-right font-medium">Action</th>
                    </tr>
                  </thead>
                  <tbody id="rows" class="divide-y divide-gray-100"></tbody>
                </table>
              </div>
            </div>

          </section>

          <!-- Right -->
          <aside class="lg:col-span-4 xl:col-span-3 space-y-6">
            <!-- Strategy metrics -->
            <div id="strategyMetrics" class="sidebar-card">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold">Strategy metrics</h3>
                <span id="selBadge"
                  class="text-xs px-2 py-0.5 rounded-full bg-[var(--olive-100)] text-[var(--olive-700)]">selected</span>
              </div>
              <div class="mb-3">
                <div id="mName" class="text-sm font-medium"></div>
                <div id="mProvider" class="text-xs text-gray-500"></div>
              </div>
              <div id="mSpark" class="mb-3"></div>
              <div class="flex flex-wrap gap-2 mb-3">
                <span id="chip1M" class="chip bg-green-50 text-green-700">1M: <span id="m1M"
                    class="ml-1">+0.0%</span></span>
                <span id="chip3M" class="chip bg-green-50 text-green-700">3M: <span id="m3M"
                    class="ml-1">+0.0%</span></span>
                <span class="chip bg-gray-100 text-gray-700">YTD: <span id="mYTD" class="ml-1">0.0%</span></span>
              </div>
              <div class="grid grid-cols-2 gap-3 text-sm">
                <div>
                  <div class="text-gray-500 text-xs">Sharpe</div>
                  <div id="mSharpe" class="font-semibold">—</div>
                </div>
                <div>
                  <div class="text-gray-500 text-xs">Max DD</div>
                  <div id="mDD" class="font-semibold">—</div>
                </div>
                <div>
                  <div class="text-gray-500 text-xs">Win rate</div>
                  <div id="mWin" class="font-semibold">—</div>
                </div>
                <div>
                  <div class="text-gray-500 text-xs">TCM</div>
                  <div id="mAUM" class="font-semibold">—</div>
                </div>
              </div>

              <!-- CTA buttons -->
              <div class="mt-4 flex flex-col gap-2">
                <a href="#"
                  class="inline-flex items-center justify-center gap-2 rounded-full bg-[var(--olive)] text-white px-4 py-2 text-sm hover:opacity-95 transition">
                  Allocate
                </a>
                <a id="viewFactSheet" href="#" target="_blank"
                  class="inline-flex items-center justify-center gap-2 rounded-full border border-[var(--olive)] text-[var(--olive)] px-4 py-2 text-sm hover:bg-[var(--olive-100)] transition">
                  View FactSheet <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i>
                </a>
              </div>
            </div>


            <!-- Top movers -->
            <div class="sidebar-card">
              <div class="font-semibold mb-3">Top movers</div>
              <div id="topMovers" class="grid grid-cols-2 gap-3"></div>
            </div>
          </aside>
        </div>

        <!-- Disclaimer Section -->
        <div class="max-w-7xl mx-auto px-6 mt-10">
          <div class="rounded-lg bg-gray-50 border border-gray-200 p-5 text-xs text-gray-600 leading-relaxed">
            <strong>Disclaimer:</strong>
            Past performance is not indicative of future results. Returns displayed are **net of model costs** but
            <u>exclude brokerage fees, potential slippage, and applicable taxes</u>.
            Trading and investing involve significant risk, including the potential loss of capital. You should
            carefully consider your financial situation and risk tolerance before allocating to any strategy.

            AlgoHive is an authorised Financial Services Provider (<strong>FSP No. 55118</strong>) regulated by the
            Financial Sector Conduct Authority (<strong>FSCA</strong>) in South Africa.

            By using this platform, you acknowledge that you have read and understood our
            <u><a href="/docs/terms-of-service.pdf" class="hover:underline">Terms of Service</a></u>,
            <u><a href="/docs/risk-disclosure.pdf" class="hover:underline">Risk Disclosure</a></u>,
            and
            <u><a href="/docs/privacy-policy.pdf" class="hover:underline">Privacy Policy</a></u>.

            Please review these documents carefully before making any investment decisions.
          </div>
        </div>

      </section>
    </main>
  </div>

 <script>
/* -------- 1) load shared menu.html into #sidebarMount (where your <aside> used to be) -------- */
async function loadMenu(url = 'partials/menu.html', mountId = 'sidebarMount'){
  const mount = document.getElementById(mountId);
  if(!mount) throw new Error(`#${mountId} not found`);
  const res = await fetch(url, { cache: 'no-store' });
  if(!res.ok) throw new Error(`Failed to load ${url} (${res.status})`);
  const html = await res.text();
  // Replace the mount with the sidebar HTML (menu.html has no <script> tags on purpose)
  mount.outerHTML = html;
}

/* -------- 2) Boot the page after sidebar exists -------- */
(async function init(){
  // Load the global sidebar first
  await loadMenu(); // make sure you have <div id="sidebarMount"></div> where the sidebar should be

  // ===== NAV (now safe — sidebar DOM exists) =====
  const activeKey = "open-strategies";
  const menu = [
    { section: "Menu", items: [
      { key:"dashboard",       label:"Dashboard",        icon:"fa-gauge",                   href:"/dashboard.html" },
      { key:"open-strategies", label:"Open Strategies",  icon:"fa-cubes",                   href:"/open-strategies.html" },
      { key:"portfolio",       label:"My Portfolio",     icon:"fa-chart-line",              href:"/portfolio.html" },
      { key:"funding",         label:"Funding",          icon:"fa-wallet",                  href:"/funding.html" },
      { key:"reports",         label:"Reports",          icon:"fa-file-invoice",            href:"/reports.html" },
      { key:"news",            label:"News & Insights",  icon:"fa-newspaper",               href:"/news.html" },
      { key:"alerts",          label:"Notifications",    icon:"fa-bell",                    href:"/alerts.html" },
    ]},
    { section: "General", items: [
      { key:"settings",        label:"Settings",         icon:"fa-gear",                    href:"/settings.html" },
      { key:"help",            label:"Help Desk",        icon:"fa-circle-question",         href:"/help.html" },
      { key:"integration",     label:"Integration",      icon:"fa-plug",                    href:"/integrations.html" },
      { key:"feedback",        label:"Feedback",         icon:"fa-comment-dots",            href:"/feedback.html" },
    ]},
  ];

  const navContainer = document.getElementById("navContainer");

  function createGroup(sectionObj) {
    const group = document.createElement("div"); group.className = "mb-2";
    const header = document.createElement("button"); header.className = "w-full flex items-center justify-between px-2 py-1"; header.setAttribute("aria-expanded", "true");
    const title = document.createElement("div"); title.className = "section-title"; title.textContent = sectionObj.section;
    const right = document.createElement("div"); right.className = "label"; right.innerHTML = '<i class="fa-solid fa-chevron-up chev text-xs"></i>';
    header.append(title, right);

    const body = document.createElement("div"); body.className = "group-body";
    const list = document.createElement("nav"); list.className = "space-y-1 px-0.5";

    sectionObj.items.forEach(item => {
      const a = document.createElement("a"); a.href = item.href || "#"; a.className = "sidebar-link"; a.title = item.label;
      if (item.key === activeKey) a.classList.add("active");
      a.innerHTML = `<i class="fa-solid ${item.icon}"></i><span class="label">${item.label}</span>`;
      list.appendChild(a);
    });

    body.appendChild(list); group.append(header, body);

    header.addEventListener("click", () => {
      const expanded = header.getAttribute("aria-expanded") === "true";
      header.setAttribute("aria-expanded", String(!expanded));
      const chev = header.querySelector(".chev");
      if (expanded) { body.style.maxHeight = "0px"; chev.classList.add("rot"); }
      else { body.style.maxHeight = body.scrollHeight + "px"; chev.classList.remove("rot"); }
    });

    requestAnimationFrame(() => { body.style.maxHeight = body.scrollHeight + "px"; });
    return group;
  }

  function renderNav() {
    if(!navContainer) return;
    navContainer.innerHTML = "";
    menu.forEach(s => navContainer.appendChild(createGroup(s)));
  }
  renderNav();

  // Collapse controls
  const sidebar = document.getElementById("sidebar");
  const collapseBtn = document.getElementById("collapseBtn");
  let collapsed = false;
  collapseBtn?.addEventListener("click", () => {
    collapsed = !collapsed; sidebar.classList.toggle("is-collapsed", collapsed);
    collapseBtn.innerHTML = collapsed ? '<i class="fa-solid fa-angles-right text-sm"></i>' : '<i class="fa-solid fa-angles-left text-sm"></i>';
    try { sessionStorage.setItem("ah_sidebar_collapsed", collapsed ? "1" : "0"); } catch (e) {}
  });
  try {
    const saved = sessionStorage.getItem("ah_sidebar_collapsed");
    if (saved === "1") {
      collapsed = true; sidebar.classList.add("is-collapsed");
      if (collapseBtn) collapseBtn.innerHTML = '<i class="fa-solid fa-angles-right text-sm"></i>';
    }
  } catch (e) {}

  // ===== DATA =====
  function rnd(n, m) { return Math.random() * (m - n) + n; }
  function sparkGen(len = 24, base = rnd(90, 110)) { const arr = [base]; for (let i = 1; i < len; i++) { arr.push(arr[i - 1] * (1 + rnd(-0.02, 0.025))); } return arr.map(v => +v.toFixed(2)); }
  const strategies = Array.from({ length: 60 }).map((_, i) => {
    const tags = ['trend', 'mean', 'grid', 'news']; const tag = tags[i % 4];
    return {
      key: `strat-${i + 1}`,
      name: `Strategy ${i + 1}`,
      provider: ['AlgoForge', 'QuantBee', 'GridOps', 'PulseAI'][i % 4],
      tag,
      price: +rnd(79, 229).toFixed(2),
      chg: +rnd(-3.5, 6.2).toFixed(2),
      aum: Math.round(rnd(120_000, 4_200_000)),
      subs: Math.round(rnd(40, 1400)),
      spark: sparkGen()
    }
  });

  // ===== STATE =====
  let AH_STATE = { tag: 'all', window: '1D', cur: 'ZAR', rows: 20 };
  let selectedKey = strategies[0].key;
  let currentList = strategies.slice();

  // ===== HELPERS =====
  const rowsEl = document.getElementById('rows');
  const searchInput = document.getElementById('searchInput');
  const scrollBox = document.getElementById('rowsScroll');

  function fmtMoney(v, cur = AH_STATE.cur) {
    try { return new Intl.NumberFormat(cur === 'ZAR' ? 'en-ZA' : 'en-US', { style: 'currency', currency: cur, maximumFractionDigits: 2 }).format(v); }
    catch { return v.toFixed(2); }
  }
  function fmtAUMCompact(r) {
    const abs = Math.abs(r), sign = r < 0 ? '-' : '';
    const fmt = n => Number.isInteger(n) ? String(n) : n.toFixed(1);
    if (abs < 1_000) return `${sign}R${abs}`;
    if (abs < 1_000_000) return `${sign}R${fmt(abs / 1_000)}k`;
    if (abs < 1_000_000_000) return `${sign}R${fmt(abs / 1_000_000)}m`;
    return `${sign}R${fmt(abs / 1_000_000_000)}b`;
  }
  function chipForChange(p) {
    const pos = p >= 0;
    return `<span class="chip ${pos ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}">${pos ? '+' : ''}${(+p).toFixed(2)}%</span>`;
  }
  function sparkSvg(series, color = '#111827') {
    const w = 160, h = 44, pad = 6; const min = Math.min(...series), max = Math.max(...series), range = (max - min) || 1;
    const step = (w - pad * 2) / (series.length - 1); let d = '';
    series.forEach((v, i) => { const x = pad + i * step; const y = pad + (h - pad * 2) * (1 - (v - min) / range); d += (i ? ' L' : ' M') + x.toFixed(2) + ' ' + y.toFixed(2); });
    return `<svg class="spark" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none"><path d="${d.trim()}" fill="none" stroke="${color}" stroke-width="2"/></svg>`;
  }
  function aggregateStats(list) {
    const totalAUM = list.reduce((a, b) => a + b.aum, 0);
    const avgChg = list.reduce((a, b) => a + Number(b.chg), 0) / Math.max(1, list.length);
    const totalSubs = list.reduce((a, b) => a + b.subs, 0);
    const avgPrice = list.reduce((a, b) => a + b.price, 0) / Math.max(1, list.length);
    return { totalAUM, avgChg, totalSubs, avgPrice };
  }

  // ===== RENDER =====
  function render(list, rowsCount = AH_STATE.rows) {
    if(!rowsEl) return;
    const slice = list.slice(0, rowsCount);
    rowsEl.innerHTML = slice.map(s => {
      const selected = s.key === selectedKey ? 'row-selected' : '';
      return `
        <tr class="${selected}">
          <td class="px-4 py-3 truncate-cell">
            <div class="font-medium truncate">${s.name}</div>
            <div class="text-xs text-gray-500 truncate">${s.provider} • ${s.tag}</div>
          </td>
          <td class="px-4 py-3 text-right num">${fmtMoney(s.price)}</td>
          <td class="px-4 py-3 spark-td">${sparkSvg(s.spark)}</td>
          <td class="px-4 py-3 text-right">${chipForChange(s.chg)}</td>
          <td class="px-4 py-3 text-right num">${fmtAUMCompact(s.aum)}</td>
          <td class="px-4 py-3 text-right num">${s.subs.toLocaleString()}</td>
          <td class="px-4 py-3 text-right">
            <button class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full border border-gray-200 hover:bg-[var(--olive-100)] text-xs"
              onclick="selectForMetrics('${s.key}')">
              View
            </button>
          </td>
        </tr>
      `;
    }).join('');
    renderTopMovers(list);
    renderAggTiles(list);
  }

  function renderAggTiles(list) {
    const box = document.getElementById('aggTiles');
    if(!box) return;
    const { totalAUM, avgChg, totalSubs, avgPrice } = aggregateStats(list);
    box.innerHTML = `
      <div class="stat-tile"><div class="stat-label">Total AUM</div><div class="stat-value num">${fmtAUMCompact(totalAUM)}</div></div>
      <div class="stat-tile"><div class="stat-label">Avg 1D Change</div><div class="stat-value ${avgChg >= 0 ? 'text-green-600' : 'text-red-600'}">${avgChg >= 0 ? '+' : ''}${avgChg.toFixed(2)}%</div></div>
      <div class="stat-tile"><div class="stat-label">Total Subscribers</div><div class="stat-value num">${totalSubs.toLocaleString()}</div></div>
      <div class="stat-tile"><div class="stat-label">Avg Price</div><div class="stat-value num">${fmtMoney(avgPrice)}</div></div>
    `;
  }

  // Scroll-to-load more rows
  scrollBox?.addEventListener('scroll', () => {
    const nearBottom = scrollBox.scrollTop + scrollBox.clientHeight >= scrollBox.scrollHeight - 8;
    if (nearBottom && AH_STATE.rows < currentList.length) {
      AH_STATE.rows += 15;
      render(currentList, AH_STATE.rows);
    }
  });

  function applyToolbarFilters() {
    const q = (searchInput?.value || '').trim().toLowerCase();
    const tag = AH_STATE.tag;
    currentList = strategies.filter(s => {
      const okTag = (tag === 'all') || s.tag.toLowerCase().startsWith(tag);
      const okQ = !q || s.name.toLowerCase().includes(q) || s.provider.toLowerCase().includes(q);
      return okTag && okQ;
    });
    AH_STATE.rows = 20;
    render(currentList, AH_STATE.rows);
  }

  // Right rail
  function renderTopMovers(list) {
    const box = document.getElementById('topMovers');
    if(!box) return;
    const movers = [...list].sort((a, b) => Math.abs(b.chg) - Math.abs(a.chg)).slice(0, 4);
    box.innerHTML = movers.map(s => {
      const selected = s.key === selectedKey ? 'bg-[var(--olive-100)]' : 'bg-white';
      return `
      <button class="text-left p-3 rounded-lg border border-gray-200 hover:bg-[var(--olive-100)] ${selected}"
              onclick="selectForMetrics('${s.key}')">
        <div class="text-sm font-medium truncate">${s.name}</div>
        <div class="text-xs text-gray-500 truncate">${s.provider}</div>
        <div class="mt-2">${chipForChange(s.chg)}</div>
      </button>`;
    }).join('');
  }

  // Metrics module
  function strategyStats(s) {
    return {
      oneM: +(s.chg * 0.8).toFixed(2),
      threeM: +(s.chg * 2.1).toFixed(2),
      ytd: +(s.chg * 3.4).toFixed(2),
      sharpe: (1.1 + (s.chg / 10)).toFixed(2),
      dd: (8 + Math.max(0, 5 - s.chg)).toFixed(1) + '%',
      win: (54 + Math.max(0, s.chg)).toFixed(0) + '%',
      aum: fmtAUMCompact(s.aum)
    };
  }
  function setChip(elId, val) {
    const el = document.getElementById(elId);
    if(!el) return;
    const parent = el.parentElement;
    const pos = val >= 0;
    el.textContent = `${pos ? '+' : ''}${val}%`;
    parent.className = `chip ${pos ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`;
  }
  window.renderMetricsCard = function renderMetricsCard(key) {
    const s = strategies.find(x => x.key === key) || strategies[0];
    if (!s) return;
    const st = strategyStats(s);

    const mName = document.getElementById('mName');
    if(!mName) return; // guard if metrics card not on this page

    document.getElementById('mName').textContent = s.name;
    document.getElementById('mProvider').textContent = `${s.provider} • ${s.tag}`;
    document.getElementById('mSpark').innerHTML = sparkSvg(s.spark);
    setChip('m1M', st.oneM);
    setChip('m3M', st.threeM);
    document.getElementById('mYTD').textContent = `${st.ytd >= 0 ? '+' : ''}${st.ytd}%`;
    document.getElementById('mSharpe').textContent = st.sharpe;
    document.getElementById('mDD').textContent = st.dd;
    document.getElementById('mWin').textContent = st.win;
    document.getElementById('mAUM').textContent = st.aum;

    const factSheetBtn = document.getElementById('viewFactSheet');
    if (factSheetBtn) factSheetBtn.href = `/factsheets/${s.key}.pdf`;
  }

  window.selectForMetrics = function selectForMetrics(key) {
    selectedKey = key;
    render(currentList, AH_STATE.rows);
    renderMetricsCard(key);
  }

  // Toolbar hooks
  document.querySelectorAll('.ah-dd2 > button').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const dd = e.currentTarget.parentElement; const open = dd.classList.contains('open');
      document.querySelectorAll('.ah-dd2').forEach(d => d.classList.remove('open'));
      if (!open) dd.classList.add('open');
    });
  });
  document.addEventListener('click', (e) => { if (!e.target.closest('.ah-dd2')) document.querySelectorAll('.ah-dd2').forEach(d => d.classList.remove('open')); });
  document.querySelectorAll('.ah-menu2 button[data-filter]').forEach(b => {
    b.addEventListener('click', () => { AH_STATE.tag = b.dataset.filter; const el = document.getElementById('catLabel'); if(el) el.textContent = b.textContent; applyToolbarFilters(); });
  });
  document.querySelectorAll('.ah-menu2 button[data-window]').forEach(b => {
    b.addEventListener('click', () => { AH_STATE.window = b.dataset.window; const el = document.getElementById('winLabel'); if(el) el.textContent = b.dataset.window; applyToolbarFilters(); });
  });
  document.querySelectorAll('.ah-menu2 button[data-cur]').forEach(b => {
    b.addEventListener('click', () => { AH_STATE.cur = b.dataset.cur; const el = document.getElementById('curLabel'); if(el) el.textContent = b.dataset.cur; applyToolbarFilters(); });
  });
  searchInput?.addEventListener('input', () => applyToolbarFilters());

  // INIT page
  applyToolbarFilters();
  selectForMetrics(selectedKey);
})(); // end init
</script>

</body>

</html>
