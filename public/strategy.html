<script>
  const $ = (q,el=document)=>el.querySelector(q);
  const modal  = $('#ozow-modal');
  const frame  = $('#ozow-frame');
  const allocBtn = $('#alloc-btn');

  function openOzow(){ modal.classList.remove('hidden'); document.body.style.overflow='hidden'; }
  function closeOzow(){ modal.classList.add('hidden'); document.body.style.overflow=''; frame.src='about:blank'; }

  // Close modal interactions
  modal?.addEventListener('click', (e)=>{ if(e.target.dataset.closeOzow!==undefined) closeOzow(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && !modal.classList.contains('hidden')) closeOzow(); });

  function postToIframe(targetName, action, fields){
    const form=document.createElement('form');
    form.method='POST'; form.action=action; form.target=targetName;
    for(const [k,v] of Object.entries(fields||{})){
      const i=document.createElement('input');
      i.type='hidden'; i.name=k; i.value=v; form.appendChild(i);
    }
    document.body.appendChild(form); form.submit(); form.remove();
  }

  async function startOzowCheckout({ amount, transactionReference, bankReference, customer }){
    const res = await fetch('/api/ozow/create', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ amount, transactionReference, bankReference, customer })
    });
    if(!res.ok){ alert('Could not start Ozow checkout'); return; }
    const { action, fields } = await res.json();
    openOzow();
    postToIframe('ozow-frame', action, fields);
  }

  allocBtn?.addEventListener('click', (e)=>{
    e.preventDefault();
    const amtText=(document.getElementById('alloc-total')?.textContent||'R 0').replace(/[^\d.,]/g,'');
    const amount=Number(amtText.replace(',',''));
    const transactionReference='AH-'+Date.now();
    const bankReference='ALGOHIVE-'+Math.random().toString(36).slice(2,8).toUpperCase();
    startOzowCheckout({ amount, transactionReference, bankReference, customer:'AlgoHive User' });
  });
</script>
