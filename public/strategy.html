<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AlgoHive – Strategy Factsheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        :root {
            --bg: #fff;
            --line: #e2e8f0;
            --ink: #0f172a;
            --olive: #556B2F
        }

        html,
        body {
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--ink)
        }

        .card {
            background: #fff;
            border: 1px solid var(--line);
            border-radius: 12px
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: .5rem;
            height: 40px;
            padding: 0 .875rem;
            border-radius: 10px;
            border: 1px solid var(--line);
            font-weight: 600
        }

        .input {
            height: 40px;
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 0 .75rem
        }

        .tab {
            height: 36px;
            border-radius: 8px;
            padding: 0 .75rem
        }

        .tab-active {
            background: #111827;
            color: #fff
        }

        #layout {
            --sb: 220px;
            display: grid;
            grid-template-columns: var(--sb) 1fr;
            min-height: 100vh
        }

        #layout.is-collapsed {
            --sb: 64px
        }

        #ah-sidebar {
            transition: width .2s ease;
            width: var(--sb)
        }

        #ah-sidebar[data-collapsed="true"] .label,
        #ah-sidebar[data-collapsed="true"] .chevron {
            display: none
        }

        #ah-sidebar details .sub {
            transition: height .2s ease
        }

        #ah-sidebar[data-collapsed="true"] details>.sub {
            display: none !important
        }

        #ah-sidebar .footer {
            transition: all .2s ease
        }

        #ah-sidebar[data-collapsed="true"] .btn-collapse :is(svg, i) {
            transform: rotate(180deg)
        }

        .ps-tile {
            border: 1px solid #e5e7eb;
            border-radius: 14px;
            padding: 14px 16px;
            background: #fff
        }

        .ps-label {
            color: #64748b;
            font-weight: 500;
            font-size: .85rem
        }

        .ps-value {
            font-weight: 600;
            font-size: 1rem;
            margin-top: 2px
        }

        @keyframes ah-spin {
            to {
                transform: rotate(360deg)
            }
        }

        .spin i {
            animation: ah-spin .8s linear infinite
        }

        .cal-grid {
            display: grid;
            grid-auto-rows: minmax(36px, auto);
            gap: 0;
            border-collapse: collapse
        }

        .cal-grid>.cal-sticky {
            border-right: 0
        }

        .cal-cell,
        .cal-head {
            border: 1px solid #e5e7eb;
            margin: 0
        }

        .cal-head.cal-sticky {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: .5rem;
            padding: .35rem .65rem;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            font-size: .75rem;
            font-weight: 600;
            background: #fff
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 9999px;
            display: inline-block
        }
    </style>
</head>

<body class="min-h-screen overflow-x-hidden">
    <div id="layout"> <!-- ===== Sidebar ===== -->
        <aside id="ah-sidebar" data-collapsed="false"
            class="border-r border-slate-200 h-[100vh] sticky top-0 bg-white flex flex-col overflow-hidden">
            <div class="px-4 py-4 flex items-center gap-3 border-b border-slate-200"> <img
                    src="https://static.wixstatic.com/media/ac771e_af06d86a7a1f4abd87e52e45f3bcbd96~mv2.png"
                    alt="AlgoHive Logo" class="w-10 h-10 object-contain" />
                <div class="min-w-0">
                    <div class="font-bold text-[15px] text-slate-900 label">AlgoHive</div>
                    <div class="text-[11px] text-slate-500 label">ID: <span id="sidebar-acc">—</span></div>
                </div>
            </div>
            <nav class="p-2 text-[14px] flex-1 overflow-y-auto"> <a
                    class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50 font-medium text-slate-900 bg-slate-100"
                    href="home.html" title="Home"> <i class="fa-solid fa-house text-slate-500 w-4 shrink-0"></i><span
                        class="label">Home</span> </a>
                <details class="group mt-1">
                    <summary
                        class="flex items-center justify-between px-3 py-2 rounded-lg hover:bg-slate-50 cursor-pointer font-medium text-slate-900">
                        <span class="flex items-center gap-3"><i class="fa-regular fa-user w-4 text-slate-500"></i><span
                                class="label">Portfolio</span></span> <i
                            class="fa-solid fa-chevron-down text-slate-400 group-open:rotate-180 transition-transform chevron"></i>
                    </summary>
                    <div class="ml-8 mt-1 flex flex-col sub"> <a
                            class="px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-2" href="#"
                            title="Positions"><i class="fa-solid fa-chart-pie w-4 text-slate-500"></i><span
                                class="label">My Strategies</span></a>
                    </div>
                </details>
                <details class="group mt-1">
                    <summary
                        class="flex items-center justify-between px-3 py-2 rounded-lg hover:bg-slate-50 cursor-pointer font-medium text-slate-900">
                        <span class="flex items-center gap-3"><i class="fa-solid fa-link w-4 text-slate-500"></i><span
                                class="label">Invest</span></span> <i
                            class="fa-solid fa-chevron-down text-slate-400 group-open:rotate-180 transition-transform chevron"></i>
                    </summary>
                    <div class="ml-8 mt-1 flex flex-col sub"> <a
                            class="px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-2"
                            href="strategies.html" title="OpenStrategies"><i
                                class="fa-solid fa-chart-line w-4 text-slate-500"></i><span
                                class="label">OpenStrategies</span></a> <a
                            class="px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-2" href="#"
                            title="Funds"><i class="fa-solid fa-coins w-4 text-slate-500"></i><span
                                class="label">Funds</span></a> </div>
                </details> <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50" href="pricing.html"
                    title="Plans & Features"><i class="fa-regular fa-square-check w-4 text-slate-500"></i><span
                        class="label">Plans & Features</span></a> 
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50" href="#" title="Support"><i
                        class="fa-solid fa-life-ring w-4 text-slate-500"></i><span class="label">Support</span></a> <a
                    class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50" href="#" title="Legal"><i
                        class="fa-solid fa-scale-balanced w-4 text-slate-500"></i><span class="label">Legal</span></a>
            </nav>
            <div class="p-3 border-t border-slate-200 footer flex items-center justify-between gap-2"> <a
                    id="ah-settings" class="btn h-10 w-10 p-0 rounded-xl bg-slate-100 hover:bg-slate-200 border-0"
                    href="settings.html" title="Settings"><i class="fa-solid fa-gear"></i></a> <button id="ah-collapse"
                    class="btn h-10 w-10 p-0 rounded-xl bg-slate-100 hover:bg-slate-200 border-0" title="Collapse"><i
                        class="fa-solid fa-arrow-left"></i></button> </div>
        </aside> <!-- ===== Main ===== -->
        <main class="flex-1 min-w-0"> <!-- Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 bg-white">
                <div class="flex items-center gap-3 flex-1 min-w-0 max-w-[460px]">
                    <div class="relative w-full"> <input class="input w-full pl-9" placeholder="Search" /> <svg
                            class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8" />
                            <path d="m21 21-4.3-4.3" />
                        </svg> </div>
                </div>
                <div class="flex items-center gap-3"> <button
                        class="relative h-10 w-10 rounded-full border border-slate-200 grid place-items-center hover:bg-slate-50"
                        aria-label="Notifications"> <i class="fa-regular fa-bell text-slate-500"></i> <span
                            class="absolute -top-0.5 -right-0.5 h-2.5 w-2.5 rounded-full bg-orange-500 ring-2 ring-white"></span>
                    </button> <img id="hdr-avatar"
                        src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><rect width='100%' height='100%' fill='%23f1f5f9'/></svg>"
                        alt="Profile" class="w-9 h-9 rounded-full object-cover border border-slate-200" /> <button
                        id="hdr-profile-btn"
                        class="flex items-center gap-2 text-slate-900 font-medium hover:text-slate-700"><span
                            id="hdr-name">—</span><i
                            class="fa-solid fa-chevron-down text-slate-500 text-xs"></i></button> </div>
            </div> <!-- GRID -->
            <div class="px-6 py-6 grid grid-cols-12 gap-6 min-w-0"> <!-- Equity Curve + header + description -->
                <section id="portfolio-card"
                    class="card border border-slate-200 shadow-none col-span-12 lg:col-span-9 min-w-0">
                    <div class="px-5 pt-5">
                        <div class="text-[12px] text-slate-500 font-semibold tracking-wide"> STRATEGY FACTSHEET <span
                                class="mx-1">•</span> <span id="fs-updated">Current Time —</span> </div>
                        <h1 class="text-2xl md:text-3xl font-extrabold mt-1" id="fs-title">-</h1>
                        <div class="mt-2 mb-3 flex flex-wrap items-center gap-2 text-slate-600" id="fs-badges"> <span
                                id="fs-provider">AlgoForge</span> <span class="mx-1 text-slate-400">•</span> <span>Live
                                since <span class="font-medium" id="fs-since">01/02/2021</span></span> <span
                                class="mx-1 text-slate-400">•</span>
                            <span id="fs-currency">ZAR</span> <span
                                class="badge bg-amber-50 border-amber-200 text-amber-700" id="fs-risk">Risk
                                Moderate</span> <span class="badge bg-emerald-50 border-emerald-200 text-emerald-700"
                                id="fs-aum">AUM -</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between px-5 py-4 border-t border-b border-slate-200">
                        <div>
                            <h3 class="font-normal text-slate-800">Equity Curve — <span id="pf-name"
                                    class="font-semibold">—</span></h3>
                            <div class="mt-1 text-sm text-slate-500" id="pf-updated">—</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button data-range="1D" class="tab tab-active text-[13px]">1D</button>
                            <button data-range="1M" class="tab text-[13px]">1M</button>
                            <button data-range="6M" class="tab text-[13px]">6M</button>
                            <button data-range="1Y" class="tab text-[13px]">1Y</button>
                            <button data-range="ALL" class="tab text-[13px]">All</button>
                            <button id="pf-refresh"
                                class="ml-2 h-9 w-9 rounded-lg border border-slate-200 hover:bg-slate-50 grid place-items-center"
                                title="Refresh"><i class="fa-solid fa-rotate-right"></i></button>
                        </div>


                    </div>
                    <div class="px-5 pt-4">
                        <div class="flex items-baseline gap-3">
                            <div class="text-2xl font-bold" id="pf-value">R 0.00</div>
                            <div class="text-lg font-normal" id="pf-change" data-sign="-">—</div>
                        </div>
                    </div>
                    <div class="px-2 pb-4 pt-2">
                        <div class="h-[260px]">
                            <canvas id="pf-chart" class="max-w-full"></canvas>
                        </div>

                    </div>

                    <!-- Strategy Description -->
                    <section class="card mx-5 mb-5 p-6">
                        <h3 class="text-lg font-medium text-slate-900 mb-2">Strategy Description</h3>
                        <p class="text-sm text-slate-700" id="fs-desc">-</p>
                        <ul class="list-disc pl-5 mt-2 text-sm text-slate-700" id="fs-desc-bullets">
                            <li>-</li>
                            <li>-</li>
                            <li>-</li>
                        </ul>
                    </section>
                </section> <!-- Right column -->
                <aside class="col-span-12 lg:col-span-3 lg:row-span-5 grid gap-6 lg:sticky lg:top-4 self-start min-w-0">
                    <!-- Allocate -->
                    <div class="card p-5 border border-slate-200">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-base font-medium text-slate-900">Allocate to Strategy</h3> <span
                                class="text-xs text-emerald-700 bg-emerald-50 border border-emerald-200 px-2 py-0.5 rounded-full">Demo</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="col-span-2"> <label class="block text-xs text-slate-500 mb-1.5"
                                    for="alloc-name">Strategy</label> <input id="alloc-name"
                                    class="h-9 w-full rounded-lg border border-slate-200 px-3 text-sm bg-slate-50"
                                    value="Trend Alpha" disabled /> </div>
                            <div> <label class="block text-xs text-slate-500 mb-1.5" for="alloc-price">Unit Price
                                    (ZAR)</label> <input id="alloc-price" type="number" step="0.01" value="112.40"
                                    class="h-9 w-full rounded-lg border border-slate-200 px-3 text-sm bg-slate-50"
                                    disabled /> </div>
                            <div> <label class="block text-xs text-slate-500 mb-1.5" for="alloc-units">Units</label>
                                <input id="alloc-units" type="number" min="1" value="10"
                                    class="h-9 w-full rounded-lg border border-slate-200 px-3 text-sm" />
                            </div>
                        </div>
                        <div class="mt-3 rounded-lg border border-slate-200 p-3 flex items-center justify-between">
                            <div class="text-xs text-slate-500">Total</div>
                            <div id="alloc-total" class="text-base font-semibold text-slate-900">R 1,124.00</div>
                        </div>
                        <div class="mt-3 flex items-center justify-end gap-2"> <button id="alloc-btn"
                                class="btn bg-[var(--olive)] text-white border-none hover:opacity-90"> <i
                                    class="fa-solid fa-circle-plus"></i> Allocate </button> </div>
                        <div id="alloc-toast"
                            class="hidden mt-3 rounded-lg border border-emerald-200 bg-emerald-50 p-3 text-emerald-800 text-sm">
                            <i class="fa-solid fa-check mr-2"></i> Allocation submitted for <span
                                id="toast-strat">—</span>: <span id="toast-units">—</span> unit(s) @ <span
                                id="toast-price">—</span>.
                        </div> <!-- Ozow Payment Modal -->
                        <div id="ozow-modal" class="fixed inset-0 z-[200] hidden">
                            <div class="absolute inset-0 bg-black/50" data-close-ozow></div>
                            <div
                                class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[95vw] max-w-3xl h-[80vh] rounded-2xl bg-white shadow-2xl border border-slate-200 flex flex-col overflow-hidden">
                                <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
                                    <div class="text-sm font-semibold text-slate-900">Complete payment with Ozow</div>
                                    <button class="h-9 w-9 grid place-items-center rounded-lg hover:bg-slate-100"
                                        data-close-ozow> <i class="fa-solid fa-xmark text-slate-600"></i> </button>
                                </div> <!-- SDK will inject the payment iframe here -->
                                <div id="paymentContainer" class="w-full h-full"></div>
                                <!-- optional hidden cancel button --> <button id="cancelOzowPayment" class="hidden"
                                    type="button"></button>
                                <div class="px-4 py-2 text-[12px] text-slate-500 border-t border-slate-200"> Press <kbd
                                        class="px-1 py-0.5 border rounded">Esc</kbd> to close </div>
                            </div>
                        </div>
                    </div> <!-- Asset class allocation -->
                    <div class="card p-5 border border-slate-200">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-base font-medium text-slate-900">Asset class allocation</h3> <span
                                class="text-xs text-slate-500">Total = 100%</span>
                        </div>
                        <div class="space-y-4" id="asset-allocation"></div>
                    </div> <!-- Strategy Overview -->
                    <div class="card p-5 border border-slate-200">
                        <div class="font-semibold mb-2">Strategy Overview</div>
                        <p id="fsDesc" class="text-sm text-slate-700">—</p>
                        <div class="grid grid-cols-2 gap-3 text-sm mt-3">
                            <div class="p-3 border rounded-xl">
                                <div class="text-slate-500 text-xs">Style</div>
                                <div id="fsStyle" class="font-semibold">—</div>
                            </div>
                            <div class="p-3 border rounded-xl">
                                <div class="text-slate-500 text-xs">Universe</div>
                                <div id="fsUniverse" class="font-semibold">—</div>
                            </div>
                            <div class="p-3 border rounded-xl">
                                <div class="text-slate-500 text-xs">Avg Holding</div>
                                <div id="fsHold" class="font-semibold">—</div>
                            </div>
                            <div class="p-3 border rounded-xl">
                                <div class="text-slate-500 text-xs">Trades / Month</div>
                                <div id="fsTrades" class="font-semibold">—</div>
                            </div>
                        </div>
                    </div>
                </aside> <!-- Performance Summary -->
                <section class="col-span-12 lg:col-span-9 min-w-0">
                    <div class="card p-6 rounded-2xl border border-slate-200">
                        <h3 class="text-lg font-medium text-slate-900 mb-5">Performance Summary</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
                            <div class="ps-tile">
                                <div class="ps-label">Best Day</div>
                                <div id="ps-best" class="ps-value">+4.25%</div>
                            </div>
                            <div class="ps-tile">
                                <div class="ps-label">Worst Day</div>
                                <div id="ps-worst" class="ps-value">-2.67%</div>
                            </div>
                            <div class="ps-tile">
                                <div class="ps-label">Avg Daily Return</div>
                                <div id="ps-avg" class="ps-value">+0.12%</div>
                            </div>
                            <div class="ps-tile">
                                <div class="ps-label">Positive Days</div>
                                <div id="ps-pos" class="ps-value">61%</div>
                            </div>
                            <div class="ps-tile">
                                <div class="ps-label">Trading Days</div>
                                <div id="ps-days" class="ps-value">245</div>
                            </div>
                            <div class="ps-tile">
                                <div class="ps-label">YTD</div>
                                <div id="ps-ytd" class="ps-value">—</div>
                            </div>

                        </div> <!-- Calendar Returns -->
                        <div class="mt-6">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-sm font-semibold text-slate-900">Calendar Returns</div>
                                <div class="flex items-center gap-3 text-xs"> <span class="inline-block w-5 h-3 rounded"
                                        id="legNeg"></span><span class="text-slate-500">Negative</span> <span
                                        class="inline-block w-5 h-3 rounded" id="legNeu"></span><span
                                        class="text-slate-500">Flat</span>
                                    <span class="inline-block w-5 h-3 rounded" id="legPos"></span><span
                                        class="text-slate-500">Positive</span>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <div id="calendarReturns" class="cal-grid"></div>
                            </div>
                        </div>
                    </div>
                </section> <!-- Portfolio Holdings -->
                <section class="col-span-12 lg:col-span-9 min-w-0">
                    <div class="card p-6 rounded-2xl border border-slate-200">
                        <div class="flex items-center justify-between mb-5">
                            <h3 class="text-lg font-medium text-slate-900">Portfolio Holdings</h3>
                            <div class="text-xs text-slate-500">Weights (demo)</div>
                        </div>
                        <div class="flex items-center gap-6"> <svg id="ph-donut" viewBox="0 0 180 180"
                                class="h-40 w-40 shrink-0"></svg>
                            <div id="ph-legend" class="text-sm grow"></div>
                        </div>
                    </div>
                </section>
            </div> <!-- jQuery (required by Ozow SDK) -->
            <script src="https://code.jquery.com/jquery-3.7.1.min.js"
                integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
            <!-- Ozow Embedded iFrame SDK -->
            <script src="https://static-content.ozow.com/scripts/js/v2/ozow-integration-2.0.min.js"></script>
            <!-- Charts -->
            <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
            <script> (() => { function drawDonut(svgEl, items) { const cx = 90, cy = 90, r = 62, R = 72, TAU = Math.PI * 2; svgEl.innerHTML = ''; const sum = items.reduce((s, i) => s + i.pct, 0) || 1; let a0 = -Math.PI / 2; items.forEach(it => { const frac = it.pct / sum, a1 = a0 + frac * TAU, la = (a1 - a0) > Math.PI ? 1 : 0; const p0 = [cx + R * Math.cos(a0), cy + R * Math.sin(a0)], p1 = [cx + R * Math.cos(a1), cy + R * Math.sin(a1)]; const q0 = [cx + r * Math.cos(a1), cy + r * Math.sin(a1)], q1 = [cx + r * Math.cos(a0), cy + r * Math.sin(a0)]; const d = M ${ p0[0]} ${ p0[1]} A ${ R } ${ R } 0 ${ la } 1 ${ p1[0] } ${ p1[1] } L ${ q0[0] } ${ q0[1] } A ${ r } ${ r } 0 ${ la } 0 ${ q1[0] } ${ q1[1] } Z; const path = document.createElementNS('http://www.w3.org/2000/svg', 'path'); path.setAttribute('d', d); path.setAttribute('fill', it.color || '#0f172a'); path.setAttribute('opacity', '.95'); svgEl.appendChild(path); a0 = a1; }); const tot = document.createElementNS('http://www.w3.org/2000/svg', 'text'); tot.textContent = '100%'; tot.setAttribute('x', cx); tot.setAttribute('y', cy + 5); tot.setAttribute('text-anchor', 'middle'); tot.setAttribute('font-size', '16'); tot.setAttribute('font-weight', '700'); svgEl.appendChild(tot); } const holdings = [{ label: 'AlgoHive Global Flexible Fund B3', pct: 20.15, color: '#111827' }, { label: 'Stability Income Fund B1', pct: 18.65, color: '#94a3b8' }, { label: 'Asc SA Absolute Prescient B3', pct: 10.07, color: '#2563eb' }, { label: 'Stone Growth BCI Opp B3', pct: 7.85, color: '#64748b' }, { label: 'Allan Gray Balanced R', pct: 7.58, color: '#6366f1' }, { label: 'Baillie Gifford Worldwide', pct: 7.55, color: '#10b981' }, { label: 'Laurium SA Flexible C1', pct: 7.56, color: '#ef4444' }, { label: 'Ninety One Opportunity Z', pct: 7.23, color: '#f59e0b' }, { label: 'AlgoHive Multi-Asset Growth', pct: 7.08, color: '#3f6212' }, { label: 'Truffle SCI Flexible R', pct: 7.58, color: '#6b7280' }]; drawDonut(document.getElementById('ph-donut'), holdings); document.getElementById('ph-legend').innerHTML = holdings.map(h => <div class="flex items-center justify-between py-1"> <div class="flex items-center gap-2 min-w-0"> <span class="legend-dot" style="background:${h.color}"></span> <span class="truncate">${h.label}</span> </div> <div class="ml-3 tabular-nums">${h.pct.toFixed(2)}%</div> </div>).join(''); const alloc = [{ label: 'Stocks', pct: 56, color: '#111827' }, { label: 'ETFs', pct: 22, color: '#2563eb' }, { label: 'Crypto', pct: 17, color: '#16a34a' }, { label: 'Cash', pct: 5, color: '#f59e0b' }]; const wrap = document.getElementById('asset-allocation'); if (wrap) { wrap.innerHTML = alloc.map(i => <div> <div class="flex items-center justify-between mb-1.5"> <span class="text-sm text-slate-700">${i.label}</span> <span class="text-sm font-medium">${i.pct}%</span> </div> <div class="h-2.5 w-full rounded-full bg-slate-100 overflow-hidden"> <div class="h-full rounded-full" style="width:${i.pct}%; background:${i.color}"></div> </div> </div>).join(''); } document.getElementById('fs-updated').textContent = 'Updated ' + new Date().toLocaleString('en-ZA', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }); const ctxEl = document.getElementById('pf-chart'); if (!ctxEl) return; const ctx = ctxEl.getContext('2d'); function makeSeries(n = 180, start = 90) { const arr = []; let p = start; for (let i = 0; i < n; i++) { const step = (Math.random() - 0.45) * 0.8; p = Math.max(70, p * (1 + step / 100)); arr.push(Number(p.toFixed(2))); } return arr; } const series = makeSeries(180, 88); const labels = series.map((_, i) => i + 1); const gradient = ctx.createLinearGradient(0, 0, 0, 260); gradient.addColorStop(0, 'rgba(85,107,47,0.35)'); gradient.addColorStop(1, 'rgba(85,107,47,0.06)'); const chart = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ data: series, tension: .35, borderWidth: 2, borderColor: '#556B2F', backgroundColor: gradient, fill: true, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { displayColors: false, callbacks: { label: (c) => 'R ' + c.raw.toLocaleString('en-ZA', { minimumFractionDigits: 2 }) } } }, scales: { x: { display: false }, y: { display: true, ticks: { color: '#94a3b8', maxTicksLimit: 4, callback: (v) => 'R ' + Number(v).toLocaleString('en-ZA') } } } }); const last = series[series.length - 1], first = series[0], chg = ((last - first) / first) * 100; document.getElementById('pf-value').textContent = 'R ' + last.toLocaleString('en-ZA', { minimumFractionDigits: 2 }); const chgEl = document.getElementById('pf-change'); chgEl.textContent = ${ chg >= 0 ? '+' : '' }${ chg.toFixed(2) }%; chgEl.style.color = chg >= 0 ? '#16a34a' : '#dc2626'; document.getElementById('pf-updated').textContent = new Date().toLocaleString('en-ZA', { month: 'long', day: '2-digit', hour: '2-digit', minute: '2-digit' }) + ' SAST'; document.querySelectorAll('#portfolio-card .tab').forEach(btn => { btn.addEventListener('click', () => { document.querySelectorAll('#portfolio-card .tab').forEach(b => b.classList.remove('tab-active')); btn.classList.add('tab-active'); const r = btn.getAttribute('data-range'); let slice = series; if (r === '1M') slice = series.slice(-22); if (r === '6M') slice = series.slice(-126); if (r === '1Y') slice = series.slice(-252); chart.data.labels = slice.map((_, i) => i + 1); chart.data.datasets[0].data = slice; chart.update(); const first = slice[0], last = slice[slice.length - 1], chg = ((last - first) / first) * 100; document.getElementById('pf-value').textContent = 'R ' + last.toLocaleString('en-ZA', { minimumFractionDigits: 2 }); const chgEl = document.getElementById('pf-change'); chgEl.textContent = ${ chg >= 0 ? '+' : '' }${ chg.toFixed(2) }%; chgEl.style.color = chg >= 0 ? '#16a34a' : '#dc2626'; }); }); document.getElementById('pf-refresh').addEventListener('click', (e) => { e.currentTarget.classList.add('spin'); setTimeout(() => e.currentTarget.classList.remove('spin'), 600); }); })(); </script>
            <!-- Calendar Returns -->
            <script> (function () { const R = { 2019: { Jan: .5, Feb: .3, Mar: .8, Apr: 1.1, May: -.9, Jun: .6, Jul: .8, Aug: .9, Sep: -.4, Oct: 1.0, Nov: .7, Dec: .9, YTD: 6.0 }, 2020: { Jan: .4, Feb: -2.2, Mar: -6.3, Apr: 3.7, May: 2.1, Jun: 1.0, Jul: 1.1, Aug: 1.4, Sep: .7, Oct: .9, Nov: 1.1, Dec: 1.2, YTD: 4.8 }, 2021: { Jan: .9, Feb: .7, Mar: .8, Apr: 1.2, May: .5, Jun: .4, Jul: .8, Aug: 1.0, Sep: .9, Oct: -.8, Nov: 1.0, Dec: .9, YTD: 8.0 }, 2022: { Jan: 1.0, Feb: -.9, Mar: .8, Apr: 1.2, May: .5, Jun: -2.2, Jul: .9, Aug: 2.1, Sep: -.5, Oct: 1.5, Nov: .6, Dec: 1.1, YTD: 5.8 }, 2023: { Jan: .7, Feb: .9, Mar: -.7, Apr: 1.3, May: 2.0, Jun: .4, Jul: 1.2, Aug: .8, Sep: 1.5, Oct: -.8, Nov: 1.1, Dec: .9, YTD: 9.0 }, 2024: { Jan: 1.0, Feb: .6, Mar: .5, Apr: .9, May: .8, Jun: .9, Jul: .3, Aug: .5, Sep: 1.0, Oct: .7, Nov: .8, Dec: .9, YTD: 8.6 } }; const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'YTD']; const years = Object.keys(R).map(Number).sort((a, b) => a - b); const grid = document.getElementById('calendarReturns'); if (!grid) return; grid.innerHTML = ''; grid.style.gridTemplateColumns = 120px repeat(${ months.length }, minmax(72px, 1fr)); const color = (v) => v == null ? '#e5e7eb' : v >= 1.5 ? '#bbf7d0' : v > 0 ? '#dcfce7' : v === 0 ? '#f1f5f9' : v > -1 ? '#fee2e2' : '#fecaca'; const corner = document.createElement('div'); corner.className = 'cal-head cal-sticky'; grid.appendChild(corner); months.forEach(m => { const h = document.createElement('div'); h.className = 'cal-head justify-center'; h.textContent = m; grid.appendChild(h); }); years.forEach(y => { const yr = document.createElement('div'); yr.className = 'cal-head cal-sticky'; yr.textContent = y; grid.appendChild(yr); months.forEach(m => { const v = R[y]?.[m]; const c = document.createElement('div'); c.className = 'cal-cell'; c.style.background = color(v); c.textContent = (v || v === 0) ? ${ v > 0 ? '+' : '' }${ v.toFixed(1) }%: '—'; grid.appendChild(c); }); }); document.getElementById('legNeg').style.background = '#fecaca'; document.getElementById('legNeu').style.background = '#f1f5f9'; document.getElementById('legPos').style.background = '#dcfce7'; })(); </script>
        </main>
    </div> <!-- Profile Modal -->
    <div id="profile-modal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/40"></div>
        <div
            class="absolute right-6 top-20 w-64 rounded-2xl bg-white shadow-xl border border-slate-200 overflow-hidden">
            <div class="px-4 py-3 border-b border-slate-200">
                <div class="text-sm font-semibold text-slate-900">Account</div>
                <div id="pm-email" class="text-xs text-slate-500 truncate">—</div>
            </div>
            <div class="p-2"> <a id="pm-profile" href="/settings.html#basic"
                    class="w-full flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-50"> <i
                        class="fa-regular fa-user text-slate-500 w-4"></i><span>Profile settings</span> </a> <button
                    id="pm-logout"
                    class="w-full flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-50 text-rose-700"> <i
                        class="fa-solid fa-right-from-bracket w-4"></i><span>Log out</span> </button> </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js" defer></script>
    <!-- Sidebar collapse memory -->
    <script> (function () { const layout = document.getElementById('layout'); const aside = document.getElementById('ah-sidebar'); const btn = document.getElementById('ah-collapse'); const saved = localStorage.getItem('ah_collapsed') === 'true'; if (saved) { aside.setAttribute('data-collapsed', 'true'); layout.classList.add('is-collapsed'); } btn.addEventListener('click', () => { const isCollapsed = aside.getAttribute('data-collapsed') === 'true'; if (!isCollapsed) aside.querySelectorAll('details[open]').forEach(d => d.removeAttribute('open')); aside.setAttribute('data-collapsed', String(!isCollapsed)); layout.classList.toggle('is-collapsed', !isCollapsed); localStorage.setItem('ah_collapsed', String(!isCollapsed)); layout.offsetHeight; window.dispatchEvent(new Event('resize')); }); })(); </script>
    <!-- Supabase profile (optional) -->
    <script type="module">
        import { supabase } from "/js/supabase.js";

        // tiny banner
        function banner(msg, tone = "warn") {
            let el = document.getElementById("banner");
            if (!el) {
                el = document.createElement("div");
                el.id = "banner";
                el.className = "fixed top-3 left-1/2 -translate-x-1/2 z-[200] px-4 py-2 rounded-lg shadow text-sm";
                document.body.appendChild(el);
            }
            el.className = "fixed top-3 left-1/2 -translate-x-1/2 z-[200] px-4 py-2 rounded-lg shadow text-sm";
            el.classList.remove("bg-amber-100", "text-amber-900", "bg-emerald-100", "text-emerald-900", "bg-rose-100", "text-rose-900");
            if (tone === "warn") { el.classList.add("bg-amber-100", "text-amber-900"); }
            if (tone === "ok") { el.classList.add("bg-emerald-100", "text-emerald-900"); }
            if (tone === "err") { el.classList.add("bg-rose-100", "text-rose-900"); }
            el.textContent = msg; clearTimeout(el._t); el._t = setTimeout(() => el.remove(), 3500);
        }
        // ---- Auth guard (redirect to login if needed) ----
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
            const next = encodeURIComponent(location.pathname + location.search + location.hash);
            location.replace(`/auth.html?tab=in&redirect=${next}`);
        }
        const { data: { user } } = await supabase.auth.getUser();

        // ---- Ensure profile row exists / fetch it ----
        async function ensureProfile(userId, email) {
            let { data, error } = await supabase.from("profiles").select("*").eq("id", userId).maybeSingle();
            if (error && error.code !== "PGRST116") throw error; // ignore "no rows"
            if (data) return data;
            const payload = { id: userId, email, updated_at: new Date().toISOString() };
            const up = await supabase.from("profiles").upsert(payload, { onConflict: "id" }).select("*").single();
            if (up.error) throw up.error;
            return up.data;
        }
        const row = await ensureProfile(user.id, user.email || null);

        // ---- Hydrate header + sidebar ----
        const hdrName = document.getElementById("hdr-name");
        const hdrAvatar = document.getElementById("hdr-avatar");
        const pmEmail = document.getElementById("pm-email");

        document.getElementById("sidebar-acc").textContent = row?.account_number || "—";

        const fn = (row?.first_name || "").trim();
        const ln = (row?.last_name || "").trim();
        hdrName.textContent = (fn || ln) ? `${fn} ${ln}`.trim() : (user.email?.split("@")[0] || "User");

        const blankAvatar = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><rect width='100%' height='100%' fill='%23f1f5f9'/></svg>";
        hdrAvatar.src = row?.avatar_url || blankAvatar;

        // ---- Profile modal / routes ----
        const profileBtn = document.getElementById("hdr-profile-btn");
        const modal = document.getElementById("profile-modal");
        const btnLogout = document.getElementById("pm-logout");
        const btnGear = document.getElementById("ah-settings");

        function openModal() { pmEmail.textContent = user?.email || "—"; modal.classList.remove("hidden"); }
        function closeModal() { modal.classList.add("hidden"); }

        profileBtn?.addEventListener("click", (e) => { e.preventDefault(); openModal(); });
        // close on backdrop click
        modal?.addEventListener("click", (e) => {
            if (e.target === modal || (e.target.classList && e.target.classList.contains("bg-black/40"))) closeModal();
        });
        // Esc to close
        window.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

        // settings gear → settings page
        btnGear?.addEventListener("click", (e) => { e.preventDefault(); location.href = "/settings.html#basic"; });

        // logout
        btnLogout?.addEventListener("click", async () => {
            try {
                await supabase.auth.signOut();
                location.replace("/auth.html?tab=in");
            } catch {
                banner("Sorry, logout failed.", "err");
            }
        });

        // ---- Session changes (safety) ----
        supabase.auth.onAuthStateChange((_ev, sess) => {
            if (!sess) { location.replace("/auth.html?tab=in"); }
        });


        // ---------- tiny utils ----------
        const $ = (q, el = document) => el.querySelector(q);
        const $$ = (q, el = document) => Array.from(el.querySelectorAll(q));
        const ZA = { minimumFractionDigits: 2, maximumFractionDigits: 2 };
        const money = (n, ccy = 'ZAR') => (ccy === 'ZAR' ? 'R ' : (ccy + ' ')) + Number(n || 0).toLocaleString('en-ZA', ZA);
        const liveSince = iso => iso ? new Date(iso).toLocaleDateString('en-ZA') : '—';
        const finite = v => Number.isFinite(Number(v));

        // ---------- URL params ----------
        const params = new URLSearchParams(location.search);
        const stratKey = params.get('id') || params.get('strategy') || params.get('code') || null;

        function renderDescAndBullets(strategy) {
            // 1) description
            const descEl = document.getElementById('fs-desc');
            if (descEl) descEl.textContent = strategy?.strategy_description || '—';

            // 2) bullets
            const wrap = document.getElementById('fs-desc-bullets');
            if (!wrap) return;

            const bullets = strategy?.strategy_description_bullets;
            wrap.innerHTML = '';

            if (!bullets || (Array.isArray(bullets) && bullets.length === 0)) {
                wrap.classList.add('hidden'); // hide list if nothing
                return;
            }
            wrap.classList.remove('hidden');

            // supports:
            // - ["text", ...]
            // - [{title,text}, ...]
            // - [{label,value}, ...]
            (bullets || []).forEach(b => {
                const li = document.createElement('li');
                li.className = 'text-sm text-slate-700';
                if (typeof b === 'string') {
                    li.textContent = b;
                } else if (b && typeof b === 'object') {
                    const t = (b.title || b.label || '').toString().trim();
                    const v = (b.text || b.value || '').toString().trim();
                    if (t && v) {
                        li.innerHTML = `<strong>${t}:</strong> ${v}`;
                    } else {
                        li.textContent = v || t || '—';
                    }
                } else {
                    li.textContent = '—';
                }
                wrap.appendChild(li);
            });
        }


        // ---------- chart setup ----------
        let chart, currentLabels = [], currentCCY = 'ZAR';
        function initChart() {
            const ctx = $('#pf-chart')?.getContext('2d');
            if (!ctx) return;
            const gradient = ctx.createLinearGradient(0, 0, 0, 260);
            gradient.addColorStop(0, 'rgba(85,107,47,0.35)');
            gradient.addColorStop(1, 'rgba(85,107,47,0.06)');
            chart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], tension: .35, borderWidth: 2, borderColor: '#556B2F', backgroundColor: gradient, fill: true, pointRadius: 0 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            displayColors: false,
                            callbacks: {
                                title: items => currentLabels[items[0].dataIndex] ?? '',
                                label: c => money(c.raw, currentCCY)
                            }
                        }
                    },
                    scales: {
                        x: { display: true, ticks: { maxTicksLimit: 6, color: '#94a3b8' }, grid: { display: false } },
                        y: { display: true, ticks: { color: '#94a3b8', maxTicksLimit: 4, callback: v => money(v, currentCCY) } }
                    }
                }
            });
        }

        // build index curve from % points (base = 100)
        function curveFromPct(points, base = 100) {
            const out = []; let lvl = base;
            for (const p of points) {
                const r = Number(p?.pct);
                if (Number.isFinite(r)) lvl *= (1 + r / 100);
                out.push(Number(lvl.toFixed(2)));
            }
            return out;
        }

        // push curve into chart + header stats
        function setCurve(seriesVals, ccy) {
            if (!chart) return;
            chart.data.labels = currentLabels;
            chart.data.datasets[0].data = seriesVals;
            chart.update();

            if (!seriesVals.length) {
                $('#pf-value').textContent = money(0, ccy);
                $('#pf-change').textContent = '—';
                return;
            }
            const first = seriesVals[0], last = seriesVals.at(-1);
            const chg = ((last - first) / first) * 100;
            $('#pf-value').textContent = money(last, ccy);
            const chgEl = $('#pf-change');
            chgEl.textContent = `${chg >= 0 ? '+' : ''}${chg.toFixed(2)}%`;
            chgEl.style.color = chg >= 0 ? '#16a34a' : '#dc2626';
            $('#pf-updated').textContent =
                new Date().toLocaleString('en-ZA', { month: 'long', day: '2-digit', hour: '2-digit', minute: '2-digit' }) + ' SAST';
        }

        // ---------- calendar (daily returns) ----------
        function renderCalendarDaily(container, daily) {
            container.innerHTML = '';
            if (!daily?.length) { container.textContent = 'No daily data yet.'; return; }

            const byYear = {};
            for (const d of daily) {
                if (!finite(d.pct)) continue;
                byYear[d.year] ??= {};
                byYear[d.year][d.month] ??= {};
                byYear[d.year][d.month][d.day] = Number(d.pct);
            }
            const monthsAbbr = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const years = Object.keys(byYear).map(Number).sort((a, b) => a - b);

            container.style.gridTemplateColumns = `120px repeat(12, minmax(72px, 1fr))`;
            const corner = document.createElement('div'); corner.className = 'cal-head cal-sticky'; container.appendChild(corner);
            monthsAbbr.forEach(m => { const h = document.createElement('div'); h.className = 'cal-head justify-center'; h.textContent = m; container.appendChild(h); });

            years.forEach(y => {
                const yr = document.createElement('div'); yr.className = 'cal-head cal-sticky'; yr.textContent = y; container.appendChild(yr);
                for (let m = 1; m <= 12; m++) {
                    const box = document.createElement('div'); box.className = 'cal-cell p-1';
                    const inner = document.createElement('div');
                    inner.style.display = 'grid'; inner.style.gridTemplateColumns = 'repeat(7,10px)'; inner.style.gap = '2px';
                    const dim = new Date(y, m, 0).getDate();
                    for (let d = 1; d <= dim; d++) {
                        const v = byYear[y]?.[m]?.[d];
                        const dot = document.createElement('div');
                        dot.style.cssText = 'width:10px;height:10px;border-radius:2px;';
                        let color = '#e5e7eb';
                        if (v != null) {
                            color = v >= 1.5 ? '#bbf7d0' : (v > 0 ? '#dcfce7' : (v === 0 ? '#f1f5f9' : (v > -1 ? '#fee2e2' : '#fecaca')));
                        }
                        dot.style.background = color;
                        dot.title = `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')} : ${v != null ? (v > 0 ? '+' : '') + v.toFixed(2) + '%' : '—'}`;
                        inner.appendChild(dot);
                    }
                    box.appendChild(inner);
                    container.appendChild(box);
                }
            });
            $('#legNeg').style.background = '#fecaca';
            $('#legNeu').style.background = '#f1f5f9';
            $('#legPos').style.background = '#dcfce7';
        }

        // ---------- perf summary ----------
        function fillPerfSummary(ps) {
            const pct = v => (v == null || isNaN(v)) ? '—' : `${v >= 0 ? '+' : ''}${Number(v).toFixed(2)}%`;
            document.getElementById('ps-best').textContent = pct(ps?.best_day_pct);
            document.getElementById('ps-worst').textContent = pct(ps?.worst_day_pct);
            document.getElementById('ps-avg').textContent = pct(ps?.avg_daily_return_pct);
            document.getElementById('ps-pos').textContent = (ps?.positive_days_pct == null ? '—' : `${Number(ps.positive_days_pct).toFixed(0)}%`);
            document.getElementById('ps-days').textContent = ps?.total_days ?? 0;

            // NEW: YTD
            document.getElementById('ps-ytd').textContent = pct(ps?.ytd_return_pct);
        }


        function hydrateHeader(strategy) {
            // header
            document.getElementById('fs-title').textContent = strategy.name || '—';
            document.getElementById('fs-provider').textContent = strategy.creator || '—';
            document.getElementById('fs-since').textContent = strategy.inception_date
                ? new Date(strategy.inception_date).toLocaleDateString('en-ZA')
                : '—';
            document.getElementById('fs-currency').textContent = strategy.currency || 'USD';
            document.getElementById('fs-risk').textContent = `Risk ${strategy.risk_level || '—'}`;
            document.getElementById('fs-aum').textContent = `AUM ${money(strategy.aum || 0, strategy.currency || 'ZAR')}`;
            const ecName = document.getElementById('pf-name');
            if (ecName) ecName.textContent = strategy.name || '—';

            // NEW: description + bullets
            renderDescAndBullets(strategy);

            // Strategy Overview tiles (right column)
            const fsDesc = document.getElementById('fsDesc');
            if (fsDesc) fsDesc.textContent =
                strategy.investment_objective_description || strategy.strategy_description || '—';

            const fsStyle = document.getElementById('fsStyle');
            if (fsStyle) fsStyle.textContent = strategy.style || '—';

            const fsUniverse = document.getElementById('fsUniverse');
            if (fsUniverse) fsUniverse.textContent = strategy.asset_universe || '—';

            const fsHold = document.getElementById('fsHold');
            if (fsHold) fsHold.textContent = Number.isFinite(strategy.avg_holding_days)
                ? `${strategy.avg_holding_days} days`
                : '—';

            const fsTrades = document.getElementById('fsTrades');
            if (fsTrades) fsTrades.textContent = Number.isFinite(strategy.avg_trades_per_month)
                ? `${strategy.avg_trades_per_month}`
                : '—';
        }




        // ---------- data load ----------
        async function fetchStrategy() {
            if (stratKey) {
                // try UUID then code
                let r = await supabase.from('strategies').select('*').eq('id', stratKey).maybeSingle();
                if (!r.data) {
                    r = await supabase.from('strategies').select('*').eq('code', stratKey).maybeSingle();
                }
                return r.data || null;
            }
            const { data } = await supabase.from('strategies').select('*').limit(1);
            return data?.[0] || null;
        }
        async function fetchMetrics(strategyId) {
            const { data } = await supabase.from('strategy_metrics').select('*').eq('strategy_id', strategyId).maybeSingle();
            return data || null;
        }

        // ---------- equity curve selection ----------
        function makeLabels1M(src) {
            return src.map(x => {
                const d = new Date(x.date);
                return d.toLocaleDateString('en-ZA', { day: '2-digit', month: 'short' }); // e.g. 10 Oct
            });
        }
        function makeLabels1D(src) {
            // src: [{ts, equity}]
            return (src || []).map(x => {
                const d = new Date(x.ts);
                // SAST (ZA) display
                return d.toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' });
            });
        }

        function makeLabelsMonthly(src) { return src.map(x => x.label || ''); }

        function selectRangeAndRender(rangeKey, metrics, strategy) {
            // --- 1D: use live equity time series (money values already) ---
            if (rangeKey === '1D') {
                const s1d = metrics?.series_1d || [];                  // [{ts, equity}]
                const vals = s1d
                    .map(p => Number(p?.equity))
                    .filter(v => Number.isFinite(v));                    // money values
                currentLabels = makeLabels1D(s1d);                     // HH:MM SAST labels
                setCurve(vals, strategy.currency || 'ZAR');            // no rebasing for 1D
                return;
            }

            // --- % series (index curve) for other ranges ---
            let src = [];
            if (rangeKey === '1M') {
                src = metrics?.series_1m || [];                        // [{date,label,pct}]
                currentLabels = makeLabels1M(src);
            } else if (rangeKey === '6M') {
                src = metrics?.series_6m || [];                        // [{label,pct}]
                currentLabels = makeLabelsMonthly(src);
            } else if (rangeKey === '1Y') {
                src = metrics?.series_1y || [];
                currentLabels = makeLabelsMonthly(src);
            } else {
                src = metrics?.series_all || [];
                currentLabels = makeLabelsMonthly(src);
            }

            const pcts = src.map(x => ({ pct: Number(x?.pct) }));
            let curve = curveFromPct(pcts, 100);                     // index 100 base

            // Rebase to show *money* with last point = current AUM (if available)
            const aum = Number(strategy?.aum);
            if (Number.isFinite(aum) && aum > 0 && curve.length) {
                const scale = aum / curve.at(-1);
                curve = curve.map(v => Number((v * scale).toFixed(2)));
            }
            setCurve(curve, strategy.currency || 'ZAR');
        }


        // ---------- boot ----------
        try {
            const strategy = await fetchStrategy();
            if (!strategy) throw new Error('No strategy found');
            const metrics = await fetchMetrics(strategy.id);

            currentCCY = strategy.currency || 'ZAR';
            hydrateHeader(strategy);
            initChart();

            // default range
            selectRangeAndRender('1D', metrics, strategy);

            // tabs
            $$('#portfolio-card .tab').forEach(btn => {
                btn.addEventListener('click', () => {
                    $$('#portfolio-card .tab').forEach(b => b.classList.remove('tab-active'));
                    btn.classList.add('tab-active');
                    selectRangeAndRender(btn.getAttribute('data-range'), metrics, strategy);
                });
            });


            // refresh button (re-pull metrics live if you want)
            $('#pf-refresh')?.addEventListener('click', async (e) => {
                e.currentTarget.classList.add('spin');
                try {
                    const fresh = await fetchMetrics(strategy.id);
                    selectRangeAndRender($('.tab.tab-active')?.getAttribute('data-range') || '1D', fresh, strategy);
                    fillPerfSummary(fresh?.perf_summary || null);
                    renderCalendarDaily($('#calendarReturns'), fresh?.calendar_returns || []);
                    $('#fs-updated').textContent = 'Updated ' + new Date().toLocaleString('en-ZA', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });
                } catch { }
                setTimeout(() => e.currentTarget.classList.remove('spin'), 600);
            });

            // perf + calendar
            fillPerfSummary(metrics?.perf_summary || null);
            renderCalendarDaily($('#calendarReturns'), metrics?.calendar_returns || []);

            // set header timestamp
            $('#fs-updated').textContent = 'Updated ' + new Date().toLocaleString('en-ZA', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });

            // === Auto-refresh metrics every 2 minutes ===
            // helper: light strategy fetch (gets fields used in header + AUM)
            async function fetchStrategyLite(id) {
                const { data, error } = await supabase
                    .from('strategies')
                    .select('id,name,creator,inception_date,currency,risk_level,aum,strategy_description,style,asset_universe,avg_holding_days,avg_trades_per_month')
                    .eq('id', id)
                    .maybeSingle();
                if (error) throw error;
                return data || null;
            }

            // === Auto-refresh metrics + strategy (AUM) every 2 minutes ===
            const doAutoRefresh = async () => {
                const btn = document.getElementById('pf-refresh');
                btn?.classList.add('spin');
                try {
                    // get metrics AND the latest strategy row (for AUM/currency/name changes)
                    const [freshMetrics, freshStrategy] = await Promise.all([
                        fetchMetrics(strategy.id),
                        fetchStrategyLite(strategy.id),
                    ]);

                    // fall back to the original 'strategy' if lite fetch fails
                    const activeStrategy = freshStrategy || strategy;

                    // update header (AUM, currency, desc, etc.)
                    hydrateHeader(activeStrategy);
                    currentCCY = activeStrategy.currency || 'ZAR';

                    // re-render equity curve with fresh AUM rebasing
                    const range =
                        document.querySelector('#portfolio-card .tab.tab-active')?.getAttribute('data-range') || '1D';
                    selectRangeAndRender(range, freshMetrics, activeStrategy);

                    // refresh summary & calendar from metrics
                    fillPerfSummary(freshMetrics?.perf_summary || null);
                    renderCalendarDaily(document.getElementById('calendarReturns'), freshMetrics?.calendar_returns || []);

                    // timestamp
                    document.getElementById('fs-updated').textContent =
                        'Updated ' + new Date().toLocaleString('en-ZA', {
                            day: '2-digit', month: '2-digit', year: 'numeric',
                            hour: '2-digit', minute: '2-digit', second: '2-digit'
                        });
                } catch (e) {
                    console.warn('[auto-refresh] failed:', e);
                } finally {
                    setTimeout(() => btn?.classList.remove('spin'), 600);
                }
            };

            // run every 2 minutes (120,000 ms)
            setInterval(doAutoRefresh, 1000);


        } catch (err) {
            console.error('[factsheet init] ', err);
            // graceful UI fallbacks:
            $('#pf-value').textContent = money(0);
            $('#pf-change').textContent = '—';
            $('#calendarReturns').textContent = 'No data.';
        }
    </script>

    <script>
  (function () {
    // ------- helpers -------
    const $  = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));
    const money = n => 'R ' + Number(n || 0).toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    // ------- elements -------
    const elUnits   = $('#alloc-units');
    const elPrice   = $('#alloc-price');
    const elTotal   = $('#alloc-total');
    const elStrat   = $('#alloc-name');
    const btnAlloc  = $('#alloc-btn');

    // Ozow modal + container
    const modal        = $('#ozow-modal');
    const modalBackdrop= modal?.querySelector('[data-close-ozow]');
    const container    = $('#paymentContainer');   // iFrame will be injected here
    const cancelBtn    = $('#cancelOzowPayment');  // hidden fallback

    // ------- dynamic total calc -------
    function updateTotal() {
      const price = Number(elPrice.value || 0);
      const units = Math.max(1, Math.floor(Number(elUnits.value || 0))); // whole numbers only
      elUnits.value = units; // normalize
      const total = price * units;
      elTotal.textContent = money(total);
      return total;
    }
    updateTotal();
    elUnits.addEventListener('input', updateTotal);
    elUnits.addEventListener('change', updateTotal);

    // ------- modal helpers -------
    function openModal() {
      if (!modal) return;
      modal.classList.remove('hidden');
      setLoading(true);
      // Esc to close
      const onEsc = (e) => { if (e.key === 'Escape') closeModal(); };
      modal._onEsc = onEsc;
      window.addEventListener('keydown', onEsc);
    }
    function closeModal() {
      if (!modal) return;
      modal.classList.add('hidden');
      if (modal._onEsc) window.removeEventListener('keydown', modal._onEsc);
      container.innerHTML = ''; // clear iFrame
    }
    function setLoading(on = true) {
      if (!container) return;
      container.innerHTML = on
        ? '<div class="w-full h-full grid place-items-center text-slate-600">Creating Ozow payment…</div>'
        : '<div class="w-full h-full grid place-items-center text-slate-600">Ready.</div>';
    }
    function loadIframe(url) {
      container.innerHTML = '';
      const iframe = document.createElement('iframe');
      iframe.src = url;            // Ozow checkout URL
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframe.style.border = '0';
      container.appendChild(iframe);
    }

    // backdrop / X button close
    modalBackdrop?.addEventListener('click', closeModal);
    modal?.querySelectorAll('[data-close-ozow]').forEach(b => b.addEventListener('click', closeModal));
    cancelBtn?.addEventListener('click', closeModal);

    // ------- Allocate → create Ozow payment -------
    btnAlloc?.addEventListener('click', async () => {
      try {
        const total = updateTotal();
        if (!total || total <= 0) {
          alert('Please enter a valid units amount.');
          return;
        }

        // pull user email from Supabase auth if present (your page already loads supabase)
        let customerEmail = 'user@algohive.app';
        try {
          // this block is safe even if supabase isn't available for some reason
          // (wrapped to avoid breaking)
          // @ts-ignore
          const { supabase } = window;
          if (supabase?.auth) {
            const { data: { user } } = await supabase.auth.getUser();
            if (user?.email) customerEmail = user.email;
          }
        } catch {}

        const reference = `AH-${(elStrat?.value || 'Strategy').replace(/\s+/g, '')}-${Date.now()}`;
        openModal();

        // Call your Vercel API to create PostPaymentRequest + hashCheck (server-side)
        const resp = await fetch('/api/ozow/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount: Number(total.toFixed(2)),
            reference,
            customerName: customerEmail,   // Ozow accepts a name; we pass email if no name
            // optional: any metadata you want to echo back on notifyUrl
            meta: {
              strategy: elStrat?.value || 'Strategy',
              units: Number(elUnits.value || 0),
              unitPrice: Number(elPrice.value || 0),
            }
          })
        });

        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data?.url) {
          setLoading(false);
          container.innerHTML = `<div class="p-4 text-rose-700">Failed to create Ozow payment: ${data?.error || 'Unknown error'}</div>`;
          return;
        }

        // EITHER iFrame inside modal (recommended for your UX):
        loadIframe(data.url);

        // OR hard-redirect to Ozow (uncomment next line & remove loadIframe above):
        // window.location.href = data.url;

      } catch (err) {
        console.error('[ozow] create failed', err);
        setLoading(false);
        container.innerHTML = `<div class="p-4 text-rose-700">Unexpected error, please try again.</div>`;
      }
    });

    // (Optional) listen for success/error page postMessage and auto-close modal
    window.addEventListener('message', (e) => {
      if (typeof e.data === 'string' && /ozow-(success|error|cancel)/i.test(e.data)) {
        closeModal();
        // You can toast or refresh balances here.
      }
    });
  })();
</script>


</body>

</html>
ƒ
