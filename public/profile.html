<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AlgoHive — Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --olive:#7e8d52; --olive-700:#576138; --ink:#0B1215; }
    body{ background:#f6f7f6 }
    .card{ box-shadow: 0 10px 30px rgba(15,23,42,.06), 0 2px 10px rgba(15,23,42,.05) }
    .input{ width:100%; border:1px solid rgb(226,232,240); border-radius:12px; padding:.65rem .9rem; }
    .label{ font-size:12px; color:#64748b }
    .hint{ font-size:11px; color:#64748b }
    .section-title{ font-weight:700; color:#0B1215; font-size:14px }
  </style>
</head>
<body class="min-h-screen">
  <!-- top bar -->
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-black/10">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2">
        <img src="https://static.wixstatic.com/media/ac771e_af06d86a7a1f4abd87e52e45f3bcbd96~mv2.png" alt="AlgoHive" class="h-7 w-auto">
        <span class="font-extrabold text-[var(--ink)]">AlgoHive</span>
      </a>
      <!-- Dashboard button removed -->
      <button class="js-logout text-sm px-3 py-1.5 rounded bg-black text-white">Log out</button>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold text-[var(--ink)]">Your Profile</h1>
    <p class="text-sm text-slate-600 mt-1">Please complete your details for KYC & suitability.</p>

    <!-- messages -->
    <div id="msg" class="hidden mt-4 rounded-lg border text-sm px-3 py-2"></div>

    <!-- Profile + Avatar -->
    <section class="mt-4 rounded-2xl border border-black/10 bg-white p-6 card">
      <form id="profile-form" class="flex flex-col gap-6">
        <!-- AVATAR -->
        <div class="flex flex-col items-center gap-3">
          <img id="avatar-preview" src="" alt="avatar" class="h-28 w-28 rounded-full object-cover border border-black/10 bg-black/5" />
          <div class="flex flex-col items-center gap-2">
            <label class="text-sm">
              <span class="block mb-1 text-slate-700">Avatar</span>
              <input id="avatar-file" type="file" accept="image/*" class="block text-xs" />
            </label>
            <button id="remove-avatar" type="button" class="hidden text-xs underline text-rose-700">Remove avatar</button>
          </div>
          <p class="hint">JPG/PNG, &lt; 2MB. Best results: square 512×512px.</p>
        </div>

        <!-- CONTACT -->
        <div class="space-y-3">
          <div class="section-title">Contact</div>
          <label class="block">
            <span class="label">Email</span>
            <input name="email" class="input bg-slate-50" readonly/>
          </label>
          <label class="block">
            <span class="label">Phone</span>
            <input name="phone" class="input" placeholder="+27 ..." inputmode="tel"/>
          </label>
        </div>

        <!-- IDENTITY -->
        <div class="space-y-3">
          <div class="section-title">Identity</div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <label class="block">
              <span class="label">First name</span>
              <input name="first_name" class="input" placeholder="First name" required/>
            </label>
            <label class="block">
              <span class="label">Last name</span>
              <input name="last_name" class="input" placeholder="Last name" required/>
            </label>
            <label class="block">
              <span class="label">Date of birth</span>
              <input name="dob" type="date" class="input"/>
            </label>
            <label class="block">
              <span class="label">ID / Passport number</span>
              <input name="id_number" class="input" placeholder="e.g. 910101..."/>
            </label>
            <label class="block">
              <span class="label">Nationality</span>
              <input name="nationality" class="input" placeholder="South African"/>
            </label>
            <label class="block">
              <span class="label">Country of residence</span>
              <input name="country_residence" class="input" placeholder="South Africa"/>
            </label>
          </div>
        </div>

        <!-- ADDRESS -->
        <div class="space-y-3">
          <div class="section-title">Residential address</div>
          <label class="block"><span class="label">Street</span><input name="address_street" class="input"/></label>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <label class="block"><span class="label">City</span><input name="address_city" class="input"/></label>
            <label class="block"><span class="label">Province</span><input name="address_province" class="input"/></label>
            <label class="block"><span class="label">Postal code</span><input name="address_postal_code" class="input"/></label>
          </div>
        </div>

        <!-- POSTAL -->
        <div class="space-y-3">
          <div class="section-title">Postal address (optional)</div>
          <label class="block"><span class="label">Street</span><input name="postal_street" class="input"/></label>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <label class="block"><span class="label">City</span><input name="postal_city" class="input"/></label>
            <label class="block"><span class="label">Province</span><input name="postal_province" class="input"/></label>
            <label class="block"><span class="label">Postal code</span><input name="postal_postal_code" class="input"/></label>
          </div>
        </div>

        <!-- TAX -->
        <div class="space-y-3">
          <div class="section-title">Tax</div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <label class="block"><span class="label">Tax residency</span><input name="tax_residency" class="input" placeholder="South Africa"/></label>
            <label class="block"><span class="label">Tax number</span><input name="tax_number" class="input" placeholder="e.g. 1234/567/8"/></label>
          </div>
        </div>

        <!-- EMPLOYMENT & SUITABILITY -->
        <div class="space-y-3">
          <div class="section-title">Employment & suitability</div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <label class="block"><span class="label">Employment status</span>
              <select name="employment_status" class="input">
                <option value="">Select…</option>
                <option>Employed</option><option>Self-employed</option><option>Student</option>
                <option>Unemployed</option><option>Retired</option>
              </select>
            </label>
            <label class="block"><span class="label">Occupation</span><input name="occupation" class="input"/></label>
            <label class="block"><span class="label">Employer</span><input name="employer" class="input"/></label>
            <label class="block"><span class="label">Annual income bracket</span>
              <select name="income_bracket" class="input">
                <option value="">Select…</option>
                <option>&lt; R250k</option><option>R250k–R500k</option><option>R500k–R1m</option>
                <option>R1m–R2m</option><option>&gt; R2m</option>
              </select>
            </label>
            <label class="block"><span class="label">Source of funds</span>
              <select name="source_of_funds" class="input">
                <option value="">Select…</option>
                <option>Salary</option><option>Business</option><option>Investments</option>
                <option>Inheritance</option><option>Gift</option><option>Other</option>
              </select>
            </label>
            <label class="block"><span class="label">Net worth range</span>
              <select name="net_worth_range" class="input">
                <option value="">Select…</option>
                <option>&lt; R500k</option><option>R500k–R1m</option><option>R1m–R5m</option>
                <option>R5m–R10m</option><option>&gt; R10m</option>
              </select>
            </label>
            <label class="block"><span class="label">Experience level</span>
              <select name="experience_level" class="input">
                <option value="">Select…</option>
                <option>None</option><option>Beginner</option><option>Intermediate</option><option>Advanced</option>
              </select>
            </label>
            <label class="block"><span class="label">Risk tolerance</span>
              <select name="risk_tolerance" class="input">
                <option value="">Select…</option>
                <option>Low</option><option>Moderate</option><option>High</option>
              </select>
            </label>
          </div>

          <div>
            <span class="label block mb-1">Investment objectives</span>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <label class="flex items-center gap-2"><input type="checkbox" name="objectives" value="Growth"> Growth</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="objectives" value="Income"> Income</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="objectives" value="Preservation"> Capital preservation</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="objectives" value="Speculation"> Speculation</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="objectives" value="Hedging"> Hedging</label>
            </div>
          </div>
        </div>

        <!-- COMPLIANCE -->
        <div class="space-y-3">
          <div class="section-title">Compliance</div>
          <label class="flex items-center gap-2 text-sm">
            <input type="checkbox" name="pep"> Politically Exposed Person (PEP)
          </label>
          <label class="flex items-center gap-2 text-sm">
            <input type="checkbox" name="fatca_crs"> I confirm FATCA/CRS declarations as needed
          </label>
        </div>

        <!-- SECURITY -->
        <div class="space-y-3">
          <div class="section-title">Security</div>
          <label class="block"><span class="label">2FA preference</span>
            <select name="twofa_preference" class="input">
              <option value="">Select…</option>
              <option>App</option><option>SMS</option><option>None</option>
            </select>
          </label>
        </div>

        <!-- KYC DOCUMENTS -->
        <div class="space-y-3">
          <div class="section-title">KYC documents</div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <label class="block">
              <span class="label">ID document</span>
              <input id="id-doc" type="file" accept="image/*,application/pdf" class="block text-xs"/>
              <p class="hint">PNG/JPG/PDF, &lt; 5MB</p>
            </label>
            <label class="block">
              <span class="label">Proof of address</span>
              <input id="addr-doc" type="file" accept="image/*,application/pdf" class="block text-xs"/>
              <p class="hint">Bank/utility, last 3 months, &lt; 5MB</p>
            </label>
          </div>
        </div>

        <!-- ACTIONS -->
        <div class="flex items-start justify-between gap-4">
          <div class="space-y-1">
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" name="terms_accepted"> I accept the Terms
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" name="popia_consent"> I consent to POPIA processing
            </label>
          </div>
          <div class="flex items-center gap-3">
            <button id="saveBtn" class="rounded-xl bg-[var(--olive)] text-white px-5 py-2">Save changes</button>
            <span id="savedTick" class="hidden text-sm text-emerald-700">Saved ✔</span>
          </div>
        </div>
      </form>
    </section>

    <!-- compliance footer -->
    <div class="mt-6 rounded-2xl border border-black/10 bg-black/[0.03] p-4">
      <p class="text-[11px] text-slate-600">
        AlgoHive (<b>FSP 55118</b>) is a registered Financial Services Provider. Investing involves risk. Past performance is not a guarantee of future results.
      </p>
    </div>
  </main>

  <script type="module">
    import { supabase } from "/js/supabase.js";
    import { signOut }    from "/js/auth.js";

    const AVATAR_BUCKET = "avatars";
    const KYC_BUCKET    = "kyc"; // make this PRIVATE in Storage

    // guard
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        const next = encodeURIComponent(location.pathname);
        location.replace(`/auth.html?tab=in&redirect=${next}`);
      }
    })();

    // elems
    const form = document.getElementById("profile-form");
    const msg  = document.getElementById("msg");
    const saveBtn = document.getElementById("saveBtn");
    const savedTick = document.getElementById("savedTick");
    const avatarPreview = document.getElementById("avatar-preview");
    const avatarFile = document.getElementById("avatar-file");
    const removeAvatarBtn = document.getElementById("remove-avatar");
    const idDocInput = document.getElementById("id-doc");
    const addrDocInput = document.getElementById("addr-doc");

    // helpers
    function showMsg(text, type="info"){
      msg.classList.remove("hidden","bg-rose-50","text-rose-700","border-rose-200","bg-emerald-50","text-emerald-700","border-emerald-200");
      if(type==="success"){ msg.classList.add("bg-emerald-50","text-emerald-700","border-emerald-200"); }
      if(type==="error"){   msg.classList.add("bg-rose-50","text-rose-700","border-rose-200"); }
      msg.textContent = text;
    }
    function clearMsg(){ msg.classList.add("hidden"); msg.textContent = ""; }
    function setSaving(on){ saveBtn.disabled = on; saveBtn.textContent = on ? "Saving…" : "Save changes"; }

    // load profile
    async function loadProfile(){
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      form.elements.email.value = user.email || "";

      const { data, error } = await supabase.from("profiles").select("*").eq("id", user.id).single();
      if (error && error.code !== "PGRST116") { showMsg(error.message, "error"); return; }

      // map inputs
      const fields = [
        "first_name","last_name","phone","dob","id_number","nationality","country_residence",
        "address_street","address_city","address_province","address_postal_code",
        "postal_street","postal_city","postal_province","postal_postal_code",
        "tax_residency","tax_number","employment_status","occupation","employer",
        "income_bracket","source_of_funds","net_worth_range","experience_level","risk_tolerance",
        "twofa_preference"
      ];
      for (const f of fields) form.elements[f].value = data?.[f] ?? "";

      // objectives (CSV)
      if (data?.objectives) {
        const set = new Set(String(data.objectives).split(",").map(s=>s.trim()).filter(Boolean));
        Array.from(form.querySelectorAll('input[name="objectives"]')).forEach(cb => {
          cb.checked = set.has(cb.value);
        });
      }

      form.elements.pep.checked = !!data?.pep;
      form.elements.fatca_crs.checked = !!data?.fatca_crs;
      form.elements.terms_accepted.checked = !!data?.terms_accepted;
      form.elements.popia_consent.checked  = !!data?.popia_consent;

      if (data?.avatar_url) {
        avatarPreview.src = data.avatar_url;
        removeAvatarBtn?.classList?.remove("hidden");
      } else {
        avatarPreview.src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='112' height='112'><rect width='100%' height='100%' fill='%23f1f5f9'/></svg>";
        removeAvatarBtn?.classList?.add("hidden");
      }
    }

    // upload avatar (no crop)
    async function uploadAvatar(file){
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error("Not signed in.");
      if (!file) return;
      if (!file.type.startsWith("image/")) throw new Error("Please pick an image.");
      if (file.size > 2 * 1024 * 1024) throw new Error("Image too large (max 2MB).");

      avatarPreview.src = URL.createObjectURL(file);

      const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
      const path = `${user.id}/avatar_${Date.now()}.${ext}`;

      const { error: upErr } = await supabase.storage.from(AVATAR_BUCKET)
        .upload(path, file, { cacheControl: "3600", upsert: true, contentType: file.type || "image/jpeg" });
      if (upErr) throw upErr;

      const { data: pub } = supabase.storage.from(AVATAR_BUCKET).getPublicUrl(path);
      const avatar_url = pub.publicUrl;

      const { error: upsertErr } = await supabase.from("profiles")
        .upsert({ id: user.id, avatar_url, updated_at: new Date().toISOString() }).eq("id", user.id);
      if (upsertErr) throw upsertErr;

      removeAvatarBtn?.classList?.remove("hidden");
      showMsg("Avatar updated.", "success");
    }

    // upload private KYC doc
    async function uploadKycDoc(file, key){
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error("Not signed in.");
      if (!file) return null;
      if (file.size > 5 * 1024 * 1024) throw new Error("File too large (max 5MB).");

      const ext = (file.name.split(".").pop() || "pdf").toLowerCase();
      const path = `${user.id}/${key}_${Date.now()}.${ext}`;

      const { error: upErr } = await supabase.storage.from(KYC_BUCKET)
        .upload(path, file, { cacheControl: "3600", upsert: true, contentType: file.type || "application/octet-stream" });
      if (upErr) throw upErr;

      // Private bucket: return the path; you’ll generate signed URLs server-side when needed
      return path;
    }

    // events
    avatarFile.addEventListener("change", async () => {
      clearMsg();
      const file = avatarFile.files?.[0];
      if (!file) return;
      try { await uploadAvatar(file); }
      catch (err) { showMsg(err.message || "Failed to upload avatar.", "error"); }
    });

    removeAvatarBtn?.addEventListener("click", async ()=>{
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        const { error } = await supabase.from("profiles")
          .update({ avatar_url: null, updated_at: new Date().toISOString() }).eq("id", user.id);
        if (error) throw error;
        avatarPreview.src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='112' height='112'><rect width='100%' height='100%' fill='%23f1f5f9'/></svg>";
        removeAvatarBtn?.classList?.add("hidden");
        showMsg("Avatar removed.", "success");
      } catch (err){ showMsg(err.message || "Could not remove avatar.", "error"); }
    });

    // save profile
    form.addEventListener("submit", async (e)=>{
      e.preventDefault(); clearMsg(); setSaving(true); savedTick.classList.add("hidden");
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error("Not signed in.");

        // collect multi-select objectives
        const objectives = Array.from(form.querySelectorAll('input[name="objectives"]:checked')).map(cb=>cb.value).join(", ");

        // uploads (if chosen)
        let id_doc_url = null, address_proof_url = null;
        if (idDocInput.files?.[0])     id_doc_url     = await uploadKycDoc(idDocInput.files[0], "id");
        if (addrDocInput.files?.[0])   address_proof_url = await uploadKycDoc(addrDocInput.files[0], "address");

        const payload = {
          id: user.id,
          email: form.elements.email.value,
          first_name: form.elements.first_name.value.trim(),
          last_name:  form.elements.last_name.value.trim(),
          phone:      form.elements.phone.value.trim(),
          dob:        form.elements.dob.value || null,
          id_number:  form.elements.id_number.value.trim() || null,
          nationality: form.elements.nationality.value.trim() || null,
          country_residence: form.elements.country_residence.value.trim() || null,

          address_street: form.elements.address_street.value.trim() || null,
          address_city: form.elements.address_city.value.trim() || null,
          address_province: form.elements.address_province.value.trim() || null,
          address_postal_code: form.elements.address_postal_code.value.trim() || null,

          postal_street: form.elements.postal_street.value.trim() || null,
          postal_city: form.elements.postal_city.value.trim() || null,
          postal_province: form.elements.postal_province.value.trim() || null,
          postal_postal_code: form.elements.postal_postal_code.value.trim() || null,

          tax_residency: form.elements.tax_residency.value.trim() || null,
          tax_number: form.elements.tax_number.value.trim() || null,

          employment_status: form.elements.employment_status.value || null,
          occupation: form.elements.occupation.value.trim() || null,
          employer:   form.elements.employer.value.trim() || null,
          income_bracket: form.elements.income_bracket.value || null,
          source_of_funds: form.elements.source_of_funds.value || null,
          net_worth_range: form.elements.net_worth_range.value || null,
          experience_level: form.elements.experience_level.value || null,
          risk_tolerance: form.elements.risk_tolerance.value || null,
          objectives,

          pep: form.elements.pep.checked,
          fatca_crs: form.elements.fatca_crs.checked,
          twofa_preference: form.elements.twofa_preference.value || null,
          terms_accepted: form.elements.terms_accepted.checked,
          popia_consent:  form.elements.popia_consent.checked,

          updated_at: new Date().toISOString()
        };

        if (id_doc_url) payload.id_doc_url = id_doc_url;
        if (address_proof_url) payload.address_proof_url = address_proof_url;

        const { error: upsertErr } = await supabase.from("profiles").upsert(payload).eq("id", user.id);
        if (upsertErr) throw upsertErr;

        await supabase.auth.updateUser({
          data: { first_name: payload.first_name, last_name: payload.last_name, full_name: `${payload.first_name} ${payload.last_name}`.trim() }
        }).catch(()=>{});

        showMsg("Profile saved.", "success");
        savedTick.classList.remove("hidden");
      } catch (err) {
        showMsg(err.message || "Failed to save profile.", "error");
      } finally {
        setSaving(false);
      }
    });

    // init + logout
    await loadProfile();
    document.querySelector(".js-logout")?.addEventListener("click", signOut);
  </script>
</body>
</html>
