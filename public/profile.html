<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AlgoHive — Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --olive:#7e8d52; --olive-700:#576138; --ink:#0B1215; }
    body{ background: #f5f6f9 }
    .card{ box-shadow: 0 10px 30px rgba(15,23,42,.06), 0 2px 10px rgba(15,23,42,.05) }
    .soft{ box-shadow: inset 0 1px 0 rgba(255,255,255,.6), 0 1px 2px rgba(15,23,42,.06) }
    .seg-btn{ @apply px-4 py-2 rounded-full text-sm transition; }
    .seg-on{ @apply bg-white text-slate-900 shadow; }
    .seg-off{ @apply text-slate-500 hover:bg-white/40; }
    .input{ @apply w-full rounded-2xl bg-white/70 border border-slate-200 px-4 py-3 text-[15px] placeholder:text-slate-400 focus:outline-none focus:ring-4 focus:ring-emerald-100 focus:border-emerald-400 transition; }
    .input-ok{ @apply border-emerald-400 ring-emerald-100; }
    .input-bad{ @apply border-rose-400 ring-rose-100; }
    .hint{ @apply text-[11px] text-slate-500; }
  </style>
</head>
<body class="min-h-screen">
  <!-- top bar (mobile-ish) -->
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-black/10">
    <div class="max-w-md mx-auto px-4 py-3 flex items-center justify-between">
      <button onclick="history.back()" class="text-slate-600 text-sm">&lt; Back</button>
      <div class="font-semibold text-slate-900">Profile</div>
      <button id="confirmBtn" class="text-[var(--olive)] text-sm font-semibold">Confirm</button>
    </div>
  </header>

  <main class="mx-auto max-w-md px-4 py-6">
    <!-- Profile header card -->
    <section class="card rounded-3xl bg-white p-5">
      <div class="flex items-center gap-4">
        <div class="relative">
          <img id="avatar-preview" src=""
               class="h-20 w-20 rounded-full object-cover bg-slate-100 border border-slate-200" alt="avatar">
          <label class="absolute -bottom-1 -right-1 inline-flex h-8 w-8 items-center justify-center rounded-full bg-[var(--olive)] text-white shadow cursor-pointer">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M11 5h2m-1-1v2m7 7l-7 7H5v-6l7-7 6 6z" />
            </svg>
            <input id="avatar-file" type="file" accept="image/*" class="hidden"/>
          </label>
        </div>
        <div>
          <div class="text-lg font-semibold text-slate-900" id="display-name">—</div>
          <div class="text-xs text-slate-500">Best Friend</div>
          <button id="remove-avatar" type="button" class="mt-1 text-xs text-rose-700 underline hidden">Remove photo</button>
        </div>
      </div>

      <!-- segmented control -->
      <div class="mt-5 bg-slate-100 rounded-full p-1 soft flex">
        <button class="seg-btn seg-off flex-1">Friends</button>
        <button class="seg-btn seg-off flex-1">Favorites</button>
        <button class="seg-btn seg-on  flex-1">Settings</button>
      </div>
    </section>

    <!-- form card -->
    <form id="profile-form" class="card mt-4 rounded-3xl bg-white p-5 space-y-5">
      <!-- Email -->
      <div>
        <label class="block text-[12px] text-slate-500 mb-1">Email address</label>
        <div class="relative">
          <input name="email" class="input pr-10 bg-white" readonly/>
          <svg id="email-ok" class="absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-emerald-500 hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2l-3.5-3.5-1.4 1.4L9 19 20.3 7.7l-1.4-1.4z"/></svg>
          <svg id="email-bad" class="absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-rose-500 hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M18.3 5.71L12 12.01 5.7 5.7 4.29 7.11 10.59 13.4l-6.3 6.3 1.41 1.41 6.3-6.29 6.29 6.29 1.41-1.41-6.29-6.3 6.29-6.29z"/></svg>
        </div>
        <p id="email-hint" class="hint mt-1">We’ll use this for sign-in.</p>
      </div>

      <!-- Full name -->
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-[12px] text-slate-500 mb-1">First name</label>
          <input name="first_name" class="input" placeholder="First name" required/>
        </div>
        <div>
          <label class="block text-[12px] text-slate-500 mb-1">Last name</label>
          <input name="last_name" class="input" placeholder="Last name" required/>
        </div>
      </div>

      <!-- Phone -->
      <div>
        <label class="block text-[12px] text-slate-500 mb-1">Phone</label>
        <input name="phone" class="input" placeholder="+27 ..." inputmode="tel"/>
        <p class="hint mt-1">Optional. For security alerts.</p>
      </div>

      <div class="flex items-center justify-between pt-1">
        <p class="hint">JPG/PNG, &lt; 2MB. Best results: square 512×512px.</p>
        <div class="flex items-center gap-3">
          <button id="saveBtn" class="rounded-full bg-[var(--olive)] text-white px-5 py-2 shadow hover:opacity-95 transition">
            Save
          </button>
          <span id="savedTick" class="hidden text-sm text-emerald-700">Saved ✔</span>
        </div>
      </div>
      <div id="msg" class="hidden rounded-xl border text-sm px-3 py-2"></div>
    </form>

    <!-- compliance -->
    <div class="mt-6 rounded-3xl border border-black/10 bg-black/[0.03] p-4">
      <p class="text-[11px] text-slate-600">
        AlgoHive (<b>FSP 55118</b>) is a registered Financial Services Provider. Investing involves risk. Past performance is not a guarantee of future results.
      </p>
    </div>
  </main>

  <script type="module">
    import { supabase } from "/js/supabase.js";
    import { signOut }    from "/js/auth.js";

    const BUCKET = "avatars";

    // elems
    const form = document.getElementById("profile-form");
    const msg  = document.getElementById("msg");
    const saveBtn = document.getElementById("saveBtn");
    const savedTick = document.getElementById("savedTick");
    const avatarPreview = document.getElementById("avatar-preview");
    const avatarFile = document.getElementById("avatar-file");
    const removeAvatarBtn = document.getElementById("remove-avatar");
    const displayName = document.getElementById("display-name");

    // email state icons
    const emailOk  = document.getElementById("email-ok");
    const emailBad = document.getElementById("email-bad");
    const emailHint = document.getElementById("email-hint");

    // helpers
    function showMsg(text, type="info"){
      msg.classList.remove("hidden","bg-rose-50","text-rose-700","border-rose-200","bg-emerald-50","text-emerald-700","border-emerald-200");
      if(type==="success"){ msg.classList.add("bg-emerald-50","text-emerald-700","border-emerald-200"); }
      if(type==="error"){   msg.classList.add("bg-rose-50","text-rose-700","border-rose-200"); }
      msg.textContent = text;
    }
    function clearMsg(){ msg.classList.add("hidden"); msg.textContent = ""; }
    function setSaving(on){ saveBtn.disabled = on; saveBtn.textContent = on ? "Saving…" : "Save"; }

    // guard
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        const next = encodeURIComponent(location.pathname);
        location.replace(`/auth.html?tab=in&redirect=${next}`);
      }
    })();

    // load
    async function loadProfile(){
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      form.elements.email.value = user.email || "";
      const { data, error } = await supabase.from("profiles").select("*").eq("id", user.id).single();
      if (error && error.code !== "PGRST116") { showMsg(error.message, "error"); return; }

      const first = data?.first_name ?? "";
      const last  = data?.last_name ?? "";
      form.elements.first_name.value = first;
      form.elements.last_name.value  = last;
      form.elements.phone.value      = data?.phone ?? "";
      displayName.textContent = (first || last) ? `${first} ${last}`.trim() : "—";

      if (data?.avatar_url) {
        avatarPreview.src = data.avatar_url;
        removeAvatarBtn.classList.remove("hidden");
      } else {
        avatarPreview.src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><rect width='100%' height='100%' fill='%23f1f5f9'/></svg>";
        removeAvatarBtn.classList.add("hidden");
      }
    }

    // upload avatar (no crop)
    async function uploadAvatar(file){
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error("Not signed in.");
      if (!file) return;
      if (!file.type.startsWith("image/")) throw new Error("Please pick an image.");
      if (file.size > 2 * 1024 * 1024) throw new Error("Image too large (max 2MB).");

      avatarPreview.src = URL.createObjectURL(file);

      const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
      const path = `${user.id}/avatar_${Date.now()}.${ext}`;

      const { error: upErr } = await supabase.storage.from(BUCKET)
        .upload(path, file, { cacheControl: "3600", upsert: true, contentType: file.type || "image/jpeg" });
      if (upErr) throw upErr;

      const { data: pub } = supabase.storage.from(BUCKET).getPublicUrl(path);
      const avatar_url = pub.publicUrl;

      const { error: upsertErr } = await supabase.from("profiles")
        .upsert({ id: user.id, avatar_url, updated_at: new Date().toISOString() }).eq("id", user.id);
      if (upsertErr) throw upsertErr;

      removeAvatarBtn.classList.remove("hidden");
      showMsg("Avatar updated.", "success");
    }

    // events
    avatarFile.addEventListener("change", async () => {
      clearMsg();
      const file = avatarFile.files?.[0];
      if (!file) return;
      try { await uploadAvatar(file); }
      catch (err) { showMsg(err.message || "Failed to upload avatar.", "error"); }
    });

    removeAvatarBtn.addEventListener("click", async ()=>{
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        const { error } = await supabase.from("profiles")
          .update({ avatar_url: null, updated_at: new Date().toISOString() }).eq("id", user.id);
        if (error) throw error;
        avatarPreview.src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><rect width='100%' height='100%' fill='%23f1f5f9'/></svg>";
        removeAvatarBtn.classList.add("hidden");
        showMsg("Avatar removed.", "success");
      } catch (err){ showMsg(err.message || "Could not remove avatar.", "error"); }
    });

    // simple email validity feedback (visual only)
    const emailInput = form.elements.email;
    function paintEmail(valid){
      emailOk.classList.toggle("hidden", !valid);
      emailBad.classList.toggle("hidden", valid);
      emailInput.classList.remove("input-ok","input-bad");
      if (valid) emailInput.classList.add("input-ok"); else emailInput.classList.add("input-bad");
      emailHint.textContent = valid ? "Looks good." : "Please enter a valid email (username@domain.com).";
    }
    emailInput.addEventListener("input", ()=>{
      const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value);
      paintEmail(ok);
    });

    // save
    form.addEventListener("submit", async (e)=>{
      e.preventDefault(); clearMsg(); setSaving(true); savedTick.classList.add("hidden");
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error("Not signed in.");

        const first_name = form.elements.first_name.value.trim();
        const last_name  = form.elements.last_name.value.trim();
        const phone      = form.elements.phone.value.trim();

        const { error: upsertErr } = await supabase.from("profiles").upsert({
          id: user.id, first_name, last_name, phone, updated_at: new Date().toISOString()
        }).eq("id", user.id);
        if (upsertErr) throw upsertErr;

        await supabase.auth.updateUser({
          data: { first_name, last_name, full_name: `${first_name} ${last_name}`.trim() }
        }).catch(()=>{});

        displayName.textContent = `${first_name} ${last_name}`.trim() || "—";
        showMsg("Profile saved.", "success");
        savedTick.classList.remove("hidden");
      } catch (err) {
        showMsg(err.message || "Failed to save profile.", "error");
      } finally {
        setSaving(false);
      }
    });

    // init + confirm + logout
    await loadProfile();
    document.getElementById("confirmBtn")?.addEventListener("click", ()=> form.requestSubmit());
    document.querySelector(".js-logout")?.addEventListener("click", signOut);
  </script>
</body>
</html>
