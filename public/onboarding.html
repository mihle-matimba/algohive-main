<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AlgoHive — Onboarding</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --olive: #7e8d52;
            --olive-700: #576138;
            --ink: #0B1215;
        }

        body {
            background: #f6f7f6;
        }

        .preloader {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background: #f6f7f6;
            color: var(--ink);
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            transition: opacity .45s ease;
        }

        .preloader__logo {
            height: 3rem;
            width: auto;
            animation: heroSlideUp .6s ease-out, preloaderPulse 2.4s ease-in-out .45s infinite;
        }

        .preloader__brand {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.01em;
            animation: heroSlideUp .6s ease-out .08s both;
        }

        .preloader__tagline {
            font-size: .95rem;
            color: rgba(11, 18, 21, 0.68);
            animation: heroSlideUp .6s ease-out .14s both;
        }

        .preloader--hide {
            opacity: 0;
            pointer-events: none;
        }

        .btn-shine {
            position: relative;
            overflow: hidden;
            transition: transform .25s ease, box-shadow .25s ease;
        }

        .btn-shine::before {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: linear-gradient(120deg, transparent 0%, rgba(255, 255, 255, .7) 50%, transparent 100%);
            transform: translateX(-120%);
            transition: transform .8s ease;
        }

        .btn-shine:hover::before {
            transform: translateX(120%);
        }

        .btn-shine:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px -16px rgba(11, 18, 21, 0.4);
        }

        .btn-shine:disabled {
            box-shadow: none;
            transform: none;
        }

        .btn-shine:disabled::before {
            display: none;
        }

        .auth-left {
            animation: heroSlideUp .7s ease-out .25s both;
        }

        .auth-right {
            animation: heroScaleIn .9s cubic-bezier(.2, .8, .2, 1) .35s both;
        }

        @keyframes heroScaleIn {
            0% {
                transform: scale(1.06);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes heroSlideUp {
            0% {
                transform: translateY(16px);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes preloaderPulse {

            0%,
            100% {
                opacity: .45;
            }

            50% {
                opacity: 1;
            }
        }

        .swap-anim {
            animation: heroSlideUp .5s ease both;
        }

        .orb-gradient {
            background-image: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.75), rgba(255, 255, 255, 0) 60%),
                radial-gradient(circle at 80% 20%, rgba(126, 141, 82, 0.18), rgba(255, 255, 255, 0) 55%),
                radial-gradient(circle at 50% 80%, rgba(126, 141, 82, 0.12), rgba(255, 255, 255, 0) 55%);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .input-error {
            border-color: rgba(248, 113, 113, 0.55) !important;
            box-shadow: 0 0 0 1px rgba(248, 113, 113, 0.28);
        }

        .field-error {
            outline: 2px solid rgba(248, 113, 113, 0.35);
            outline-offset: 4px;
            border-radius: 1.25rem;
        }

        .step-flow {
            position: relative;
            margin-left: 0.75rem;
        }

        .step-flow li {
            position: relative;
            list-style: none;
            padding-left: 3rem;
        }

        .step-flow li::before {
            content: "";
            position: absolute;
            left: 1.125rem;
            top: 2.5rem;
            bottom: -2.5rem;
            width: 1px;
            background: linear-gradient(to bottom, rgba(148, 163, 184, 0.28), rgba(148, 163, 184, 0.08));
        }

        .step-flow li:last-child::before {
            bottom: 0.75rem;
            background: linear-gradient(to bottom, rgba(148, 163, 184, 0.28), rgba(148, 163, 184, 0));
        }

        .step-circle {
            transition: all .25s ease;
        }

        .step-item--active .step-circle {
            border-color: var(--olive);
            background: rgba(126, 141, 82, 0.12);
            color: var(--olive-700);
        }

        .step-item--complete .step-circle {
            background: var(--olive);
            color: #fff;
            border-color: var(--olive);
        }

        .toast-stack {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            z-index: 400;
            pointer-events: none;
        }

        .toast-card {
            pointer-events: auto;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            min-width: 260px;
            max-width: 360px;
            padding: 0.9rem 1rem;
            border-radius: 1rem;
            background-image: linear-gradient(135deg, #0b1215, #1c2714);
            color: #f8fafc;
            box-shadow: 0 18px 42px -18px rgba(11, 18, 21, 0.7);
            border: 1px solid rgba(126, 141, 82, 0.45);
            transform: translateX(120%);
            opacity: 0;
            animation: toastIn 0.45s cubic-bezier(.22, 1, .36, 1) forwards;
        }

        .plan-group--error {
            outline: 2px solid rgba(248, 113, 113, 0.45);
            outline-offset: 6px;
            border-radius: 1.75rem;
        }

        .toast-card[data-tone="err"],
        .toast-card[data-tone="warn"] {
            border-color: rgba(248, 113, 113, 0.55);
        }

        .toast-icon {
            flex-shrink: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.15rem;
            height: 2.15rem;
            border-radius: 9999px;
            background: rgba(126, 141, 82, 0.18);
            border: 1px solid rgba(126, 141, 82, 0.45);
            color: rgba(226, 232, 240, 0.95);
        }

        .toast-card[data-tone="err"] .toast-icon,
        .toast-card[data-tone="warn"] .toast-icon {
            background: rgba(248, 113, 113, 0.12);
            border-color: rgba(248, 113, 113, 0.45);
            color: rgba(254, 226, 226, 0.95);
        }

        .toast-card[data-tone="ok"] .toast-icon {
            color: rgba(190, 242, 100, 0.95);
        }

        .toast-message {
            margin: 0;
            font-size: 0.95rem;
            line-height: 1.45;
            font-weight: 500;
            color: inherit;
        }

        .toast-content {
            flex: 1;
            display: flex;
            align-items: center;
            padding-top: 0.1rem;
        }

        .toast-dismiss {
            margin-left: auto;
            margin-top: 0.1rem;
            background: transparent;
            border: 0;
            color: rgba(248, 250, 252, 0.75);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border-radius: 9999px;
            transition: background 0.2s ease, color 0.2s ease;
            cursor: pointer;
        }

        .toast-dismiss:hover {
            background: rgba(15, 23, 42, 0.22);
            color: rgba(248, 250, 252, 0.95);
        }

        .product-card {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 1.5rem;
            border-radius: 1.75rem;
            padding: 1.75rem;
            color: #f8fafc;
            background: #0b1215;
            overflow: hidden;
            text-decoration: none;
            border: 1px solid rgba(248, 250, 252, 0.08);
            box-shadow: 0 32px 68px -42px rgba(0, 0, 0, 0.85);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .product-card::after {
            content: "";
            position: absolute;
            inset: 0;
            z-index: 0;
            opacity: 0.88;
            transition: opacity 0.3s ease;
        }

        .product-card>* {
            position: relative;
            z-index: 1;
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 42px 82px -44px rgba(0, 0, 0, 0.82);
        }

        .product-card:hover::after {
            opacity: 1;
        }

        .product-card--invest::after {
            background: linear-gradient(140deg, #010302 0%, #0d2518 42%, #2f8f4e 100%);
        }

        .product-card--loan::after {
            background: linear-gradient(140deg, #150023 0%, #6a1687 48%, #d43bff 100%);
        }

        .product-card__eyebrow {
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.32em;
            text-transform: uppercase;
            color: rgba(248, 250, 252, 0.7);
        }

        .product-card__title {
            font-size: 1.3rem;
            font-weight: 600;
            letter-spacing: -0.01em;
            color: #f8fafc;
        }

        .product-card__copy {
            font-size: 0.95rem;
            line-height: 1.6;
            color: rgba(248, 250, 252, 0.78);
        }

        .product-card__cta {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 0.28em;
            text-transform: uppercase;
            color: rgba(248, 250, 252, 0.85);
        }

        .product-card__cta svg {
            width: 1rem;
            height: 1rem;
        }

        .product-card:hover .product-card__cta {
            color: #ffffff;
        }

        .toast-card--leaving {
            animation: toastOut 0.32s ease forwards;
        }

        @keyframes toastIn {
            0% {
                transform: translateX(120%);
                opacity: 0;
            }

            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes toastOut {
            0% {
                transform: translateX(0);
                opacity: 1;
            }

            100% {
                transform: translateX(120%);
                opacity: 0;
            }
        }
    </style>
</head>

<body class="min-h-screen antialiased text-slate-900">
    <div id="preloader" class="preloader">
        <img src="https://static.wixstatic.com/media/ac771e_af06d86a7a1f4abd87e52e45f3bcbd96~mv2.png"
            alt="AlgoHive logo" class="preloader__logo" />
        <span class="preloader__brand">AlgoHive</span>
        <span class="preloader__tagline">Where Smart Capital Gathers</span>
    </div>
    <div class="flex min-h-screen flex-col bg-transparent lg:flex-row lg:items-stretch">
        <!-- Left: Onboarding -->
        <main
            class="auth-left relative hidden w-full max-w-2xl bg-white px-6 py-12 shadow-sm sm:px-10 sm:py-14 no-scrollbar lg:flex lg:h-screen lg:max-w-lg lg:flex-col lg:overflow-y-auto lg:px-16 lg:py-20 lg:shadow lg:sticky lg:top-0">
            <!-- Brand -->
            <div class="flex items-center gap-2">
                <img src="https://static.wixstatic.com/media/ac771e_af06d86a7a1f4abd87e52e45f3bcbd96~mv2.png"
                    alt="AlgoHive" class="h-8 w-auto" />
                <span class="text-lg font-semibold tracking-tight text-[var(--ink)]">AlgoHive</span>
            </div>

            <!-- Onboarding content -->
            <div class="mt-10 flex flex-1 flex-col gap-12 pr-3 lg:mt-16 lg:pr-6">
                <header class="space-y-3 pr-1">
                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-[var(--olive)]">Start here</p>
                    <h1 class="text-3xl font-semibold text-slate-900 sm:text-[34px]">Connect your AlgoHive accounts</h1>
                    <p class="text-sm text-slate-500">Complete each onboarding step to tailor AlgoHive to your personal
                        investing experience.</p>
                </header>

                <section class="text-left text-slate-700">
                    <ol class="step-flow space-y-10">
                        <li data-step-item="1">
                            <span data-step-indicator="1"
                                class="step-circle absolute left-0 top-0 flex h-9 w-9 items-center justify-center rounded-full border border-[var(--olive)]/40 bg-white text-sm font-semibold text-[var(--olive-700)] shadow-sm">1</span>
                            <div class="space-y-1">
                                <h2 class="text-base font-semibold text-slate-900">Basic info</h2>
                                <p class="text-sm text-slate-500">Share your personal details to set up your profile.
                                </p>
                            </div>
                        </li>
                        <li data-step-item="2">
                            <span data-step-indicator="2"
                                class="step-circle absolute left-0 top-0 flex h-9 w-9 items-center justify-center rounded-full border border-[var(--olive)]/40 bg-white text-sm font-semibold text-[var(--olive-700)] shadow-sm">2</span>
                            <div class="space-y-1">
                                <h2 class="text-base font-semibold text-slate-900">Employment &amp; income</h2>
                                <p class="text-sm text-slate-500">Confirm your employment status and income sources.</p>
                            </div>
                        </li>
                        <li data-step-item="3">
                            <span data-step-indicator="3"
                                class="step-circle absolute left-0 top-0 flex h-9 w-9 items-center justify-center rounded-full border border-[var(--olive)]/40 bg-white text-sm font-semibold text-[var(--olive-700)] shadow-sm">3</span>
                            <div class="space-y-1">
                                <h2 class="text-base font-semibold text-slate-900">Compliance</h2>
                                <p class="text-sm text-slate-500">Provide your declarations and regulatory
                                    acknowledgements.</p>
                            </div>
                        </li>
                        <li data-step-item="4">
                            <span data-step-indicator="4"
                                class="step-circle absolute left-0 top-0 flex h-9 w-9 items-center justify-center rounded-full border border-[var(--olive)]/40 bg-white text-sm font-semibold text-[var(--olive-700)] shadow-sm">4</span>
                            <div class="space-y-1">
                                <h2 class="text-base font-semibold text-slate-900">KYC</h2>
                                <p class="text-sm text-slate-500">Upload your identity documents for quick verification.
                                </p>
                            </div>
                        </li>
                        <li data-step-item="5">
                            <span data-step-indicator="5"
                                class="step-circle absolute left-0 top-0 flex h-9 w-9 items-center justify-center rounded-full border border-[var(--olive)]/40 bg-white text-sm font-semibold text-[var(--olive-700)] shadow-sm">5</span>
                            <div class="space-y-1">
                                <h2 class="text-base font-semibold text-slate-900">Subscription plans</h2>
                                <p class="text-sm text-slate-500">Choose the strategies and billing that suit you best.
                                </p>
                            </div>
                        </li>
                    </ol>
                </section>
            </div>

        </main>

        <!-- Right: Workspace -->
        <aside class="auth-right relative flex w-full flex-1 bg-[#f7f9ff] lg:items-stretch lg:rounded-none">
            <div class="absolute inset-0 orb-gradient opacity-90"></div>
            <div class="relative z-10 flex w-full items-start justify-center px-4 py-12 sm:px-8 lg:px-16 lg:py-20">
                <div class="w-full max-w-3xl space-y-8">
                    <header id="onboardingIntro" class="space-y-2 text-left text-slate-800">
                        <p class="text-xs font-semibold uppercase tracking-[0.35em] text-[var(--olive)]">Onboarding</p>
                        <h1 class="text-3xl font-semibold sm:text-[34px]">Complete your AlgoHive profile</h1>
                        <p class="text-sm text-slate-600">Share the information we need to tailor AlgoHive to your
                            individual investing needs.</p>
                    </header>

                    <section
                        class="rounded-3xl border border-white/40 bg-white/90 p-6 shadow-[0_20px_50px_-28px_rgba(15,23,42,0.55)] backdrop-blur sm:p-8">
                        <div class="flex flex-col gap-6">
                            <div id="stepSummary"
                                class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
                                <div>
                                    <p id="currentStepLabel"
                                        class="text-xs font-semibold uppercase tracking-[0.4em] text-[var(--olive-700)]">
                                        Step 1 of 5 · Basic info</p>
                                    <h2 id="currentStepTitle" class="text-xl font-semibold text-slate-900">Tell us about
                                        yourself</h2>
                                </div>
                                <div class="flex flex-col items-start gap-2 text-left sm:items-end sm:text-right">
                                    <span
                                        class="text-[11px] font-semibold uppercase tracking-[0.35em] text-slate-400">Having
                                        trouble?</span>
                                    <a href="mailto:support@algohive.io"
                                        class="inline-flex items-center justify-center gap-2 rounded-full border border-[var(--olive)] px-4 py-2 text-xs font-semibold text-[var(--olive-700)] transition hover:bg-[var(--olive)] hover:text-white">Contact
                                        us</a>
                                </div>
                            </div>

                            <div id="onboardingFlow" class="space-y-10">
                                <form data-panel="1" class="tab-panel space-y-10" novalidate>
                                    <div class="grid gap-6 md:grid-cols-2">
                                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                            First name
                                            <input type="text" id="first_name" name="first_name"
                                                placeholder="e.g. Buyusiphe"
                                                class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                        </label>
                                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                            Last name
                                            <input type="text" id="last_name" name="last_name"
                                                placeholder="e.g. Maimbra"
                                                class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                        </label>
                                    </div>

                                    <div class="grid gap-6 md:grid-cols-[minmax(0,360px)_1fr]">
                                        <div class="flex flex-col gap-2">
                                            <span class="text-sm font-medium text-slate-700">Avatar</span>
                                            <div
                                                class="flex items-center gap-4 rounded-2xl border border-dashed border-slate-200 bg-slate-50/60 p-4">
                                                <div
                                                    class="flex h-16 w-16 items-center justify-center overflow-hidden rounded-full bg-slate-200">
                                                    <img id="avatar-preview"
                                                        src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'&gt;&lt;rect width='100%' height='100%' fill='%23e2e8f0'/&gt;&lt;/svg&gt;"
                                                        alt="Profile avatar preview" class="h-16 w-16 object-cover" />
                                                </div>
                                                <div class="flex flex-1 flex-col gap-2 text-sm text-slate-500">
                                                    <input type="file" id="avatar-file" name="avatar"
                                                        accept="image/png,image/jpeg" class="hidden" />
                                                    <label for="avatar-file"
                                                        class="inline-flex cursor-pointer items-center justify-center gap-2 rounded-full border border-[var(--olive)] px-4 py-1.5 text-xs font-semibold text-[var(--olive-700)] transition hover:bg-[var(--olive)] hover:text-white">
                                                        Choose file
                                                    </label>
                                                    <span id="avatar-filename" class="text-xs text-slate-400">No file
                                                        chosen</span>
                                                    <p class="text-xs text-slate-400">JPG/PNG, 2 MB. Best results:
                                                        512×512px.</p>
                                                    <button type="button" id="remove-avatar"
                                                        class="self-start text-xs font-medium text-rose-500 hover:underline hidden">Remove
                                                        avatar</button>
                                                </div>
                                            </div>
                                        </div>
                                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                            Contact phone
                                            <input type="tel" id="phone" name="phone" placeholder="+27 81 750 8624"
                                                class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                        </label>
                                    </div>

                                    <div class="grid gap-6 md:grid-cols-2">
                                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                            Date of birth
                                            <input type="date" id="dob" name="dob"
                                                class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                        </label>
                                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                            ID / Passport number
                                            <input type="text" id="id_number" name="id_number"
                                                placeholder="0405238097086"
                                                class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                        </label>
                                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                            Nationality
                                            <select id="nationality" name="nationality"
                                                class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20">
                                                <option value="">Select a country…</option>
                                                <option value="Afghanistan">Afghanistan</option>
                                                <option value="Albania">Albania</option>
                                                <option value="Algeria">Algeria</option>
                                                <option value="Andorra">Andorra</option>
                                                <option value="Angola">Angola</option>
                                                <option value="Antigua and Barbuda">Antigua and Barbuda</option>
                                                <option value="Argentina">Argentina</option>
                                                <option value="Armenia">Armenia</option>
                                                <option value="Australia">Australia</option>
                                                <option value="Austria">Austria</option>
                                                <option value="Azerbaijan">Azerbaijan</option>
                                                <option value="Bahamas">Bahamas</option>
                                                <option value="Bahrain">Bahrain</option>
                                                <option value="Bangladesh">Bangladesh</option>
                                                <option value="Barbados">Barbados</option>
                                                <option value="Belarus">Belarus</option>
                                                <option value="Belgium">Belgium</option>
                                                <option value="Belize">Belize</option>
                                                <option value="Benin">Benin</option>
                                                <option value="Bhutan">Bhutan</option>
                                                <option value="Bolivia">Bolivia</option>
                                                <option value="Bosnia and Herzegovina">Bosnia and Herzegovina</option>
                                                <option value="Botswana">Botswana</option>
                                                <option value="Brazil">Brazil</option>
                                                <option value="Brunei">Brunei</option>
                                                <option value="Bulgaria">Bulgaria</option>
                                                <option value="Burkina Faso">Burkina Faso</option>
                                                <option value="Burundi">Burundi</option>
                                                <option value="Cabo Verde">Cabo Verde</option>
                                                <option value="Cambodia">Cambodia</option>
                                                <option value="Cameroon">Cameroon</option>
                                                <option value="Canada">Canada</option>
                                                <option value="Central African Republic">Central African Republic
                                                </option>
                                                <option value="Chad">Chad</option>
                                                <option value="Chile">Chile</option>
                                                <option value="China">China</option>
                                                <option value="Colombia">Colombia</option>
                                                <option value="Comoros">Comoros</option>
                                                <option value="Congo">Congo</option>
                                                <option value="Costa Rica">Costa Rica</option>
                                                <option value="Côte d'Ivoire">Côte d'Ivoire</option>
                                                <option value="Croatia">Croatia</option>
                                                <option value="Cuba">Cuba</option>
                                                <option value="Cyprus">Cyprus</option>
                                                <option value="Czechia">Czechia</option>
                                                <option value="Democratic Republic of the Congo">Democratic Republic of
                                                    the Congo</option>
                                                <option value="Denmark">Denmark</option>
                                                <option value="Djibouti">Djibouti</option>
                                                <option value="Dominica">Dominica</option>
                                                <option value="Dominican Republic">Dominican Republic</option>
                                                <option value="Ecuador">Ecuador</option>
                                                <option value="Egypt">Egypt</option>
                                                <option value="El Salvador">El Salvador</option>
                                                <option value="Equatorial Guinea">Equatorial Guinea</option>
                                                <option value="Eritrea">Eritrea</option>
                                                <option value="Estonia">Estonia</option>
                                                <option value="Eswatini">Eswatini</option>
                                                <option value="Ethiopia">Ethiopia</option>
                                                <option value="Fiji">Fiji</option>
                                                <option value="Finland">Finland</option>
                                                <option value="France">France</option>
                                                <option value="Gabon">Gabon</option>
                                                <option value="Gambia">Gambia</option>
                                                <option value="Georgia">Georgia</option>
                                                <option value="Germany">Germany</option>
                                                <option value="Ghana">Ghana</option>
                                                <option value="Greece">Greece</option>
                                                <option value="Grenada">Grenada</option>
                                                <option value="Guatemala">Guatemala</option>
                                                <option value="Guinea">Guinea</option>
                                                <option value="Guinea-Bissau">Guinea-Bissau</option>
                                                <option value="Guyana">Guyana</option>
                                                <option value="Haiti">Haiti</option>
                                                <option value="Holy See">Holy See</option>
                                                <option value="Honduras">Honduras</option>
                                                <option value="Hungary">Hungary</option>
                                                <option value="Iceland">Iceland</option>
                                                <option value="India">India</option>
                                                <option value="Indonesia">Indonesia</option>
                                                <option value="Iran">Iran</option>
                                                <option value="Iraq">Iraq</option>
                                                <option value="Ireland">Ireland</option>
                                                <option value="Israel">Israel</option>
                                                <option value="Italy">Italy</option>
                                                <option value="Jamaica">Jamaica</option>
                                                <option value="Japan">Japan</option>
                                                <option value="Jordan">Jordan</option>
                                                <option value="Kazakhstan">Kazakhstan</option>
                                                <option value="Kenya">Kenya</option>
                                                <option value="Kiribati">Kiribati</option>
                                                <option value="Kuwait">Kuwait</option>
                                                <option value="Kyrgyzstan">Kyrgyzstan</option>
                                                <option value="Laos">Laos</option>
                                                <option value="Latvia">Latvia</option>
                                                <option value="Lebanon">Lebanon</option>
                                                <option value="Lesotho">Lesotho</option>
                                                <option value="Liberia">Liberia</option>
                                                <option value="Libya">Libya</option>
                                                <option value="Liechtenstein">Liechtenstein</option>
                                                <option value="Lithuania">Lithuania</option>
                                                <option value="Luxembourg">Luxembourg</option>
                                                <option value="Madagascar">Madagascar</option>
                                                <option value="Malawi">Malawi</option>
                                                <option value="Malaysia">Malaysia</option>
                                                <option value="Maldives">Maldives</option>
                                                <option value="Mali">Mali</option>
                                                <option value="Malta">Malta</option>
                                                <option value="Marshall Islands">Marshall Islands</option>
                                                <option value="Mauritania">Mauritania</option>
                                                <option value="Mauritius">Mauritius</option>
                                                <option value="Mexico">Mexico</option>
                                                <option value="Micronesia">Micronesia</option>
                                                <option value="Moldova">Moldova</option>
                                                <option value="Monaco">Monaco</option>
                                                <option value="Mongolia">Mongolia</option>
                                                <option value="Montenegro">Montenegro</option>
                                                <option value="Morocco">Morocco</option>
                                                <option value="Mozambique">Mozambique</option>
                                                <option value="Myanmar">Myanmar</option>
                                                <option value="Namibia">Namibia</option>
                                                <option value="Nauru">Nauru</option>
                                                <option value="Nepal">Nepal</option>
                                                <option value="Netherlands">Netherlands</option>
                                                <option value="New Zealand">New Zealand</option>
                                                <option value="Nicaragua">Nicaragua</option>
                                                <option value="Niger">Niger</option>
                                                <option value="Nigeria">Nigeria</option>
                                                <option value="North Korea">North Korea</option>
                                                <option value="North Macedonia">North Macedonia</option>
                                                <option value="Norway">Norway</option>
                                                <option value="Oman">Oman</option>
                                                <option value="Pakistan">Pakistan</option>
                                                <option value="Palau">Palau</option>
                                                <option value="Palestine State">Palestine State</option>
                                                <option value="Panama">Panama</option>
                                                <option value="Papua New Guinea">Papua New Guinea</option>
                                                <option value="Paraguay">Paraguay</option>
                                                <option value="Peru">Peru</option>
                                                <option value="Philippines">Philippines</option>
                                                <option value="Poland">Poland</option>
                                                <option value="Portugal">Portugal</option>
                                                <option value="Qatar">Qatar</option>
                                                <option value="Romania">Romania</option>
                                                <option value="Russia">Russia</option>
                                                <option value="Rwanda">Rwanda</option>
                                                <option value="Saint Kitts and Nevis">Saint Kitts and Nevis</option>
                                                <option value="Saint Lucia">Saint Lucia</option>
                                                <option value="Saint Vincent and the Grenadines">Saint Vincent and the
                                                    Grenadines</option>
                                                <option value="Samoa">Samoa</option>
                                                <option value="San Marino">San Marino</option>
                                                <option value="Sao Tome and Principe">Sao Tome and Principe</option>
                                                <option value="Saudi Arabia">Saudi Arabia</option>
                                                <option value="Senegal">Senegal</option>
                                                <option value="Serbia">Serbia</option>
                                                <option value="Seychelles">Seychelles</option>
                                                <option value="Sierra Leone">Sierra Leone</option>
                                                <option value="Singapore">Singapore</option>
                                                <option value="Slovakia">Slovakia</option>
                                                <option value="Slovenia">Slovenia</option>
                                                <option value="Solomon Islands">Solomon Islands</option>
                                                <option value="Somalia">Somalia</option>
                                                <option value="South Africa">South Africa</option>
                                                <option value="South Korea">South Korea</option>
                                                <option value="South Sudan">South Sudan</option>
                                                <option value="Spain">Spain</option>
                                                <option value="Sri Lanka">Sri Lanka</option>
                                                <option value="Sudan">Sudan</option>
                                                <option value="Suriname">Suriname</option>
                                                <option value="Sweden">Sweden</option>
                                                <option value="Switzerland">Switzerland</option>
                                                <option value="Syria">Syria</option>
                                                <option value="Tajikistan">Tajikistan</option>
                                                <option value="Tanzania">Tanzania</option>
                                                <option value="Thailand">Thailand</option>
                                                <option value="Timor-Leste">Timor-Leste</option>
                                                <option value="Togo">Togo</option>
                                                <option value="Tonga">Tonga</option>
                                                <option value="Trinidad and Tobago">Trinidad and Tobago</option>
                                                <option value="Tunisia">Tunisia</option>
                                                <option value="Turkey">Turkey</option>
                                                <option value="Turkmenistan">Turkmenistan</option>
                                                <option value="Tuvalu">Tuvalu</option>
                                                <option value="Uganda">Uganda</option>
                                                <option value="Ukraine">Ukraine</option>
                                                <option value="United Arab Emirates">United Arab Emirates</option>
                                                <option value="United Kingdom">United Kingdom</option>
                                                <option value="United States">United States</option>
                                                <option value="Uruguay">Uruguay</option>
                                                <option value="Uzbekistan">Uzbekistan</option>
                                                <option value="Vanuatu">Vanuatu</option>
                                                <option value="Venezuela">Venezuela</option>
                                                <option value="Vietnam">Vietnam</option>
                                                <option value="Yemen">Yemen</option>
                                                <option value="Zambia">Zambia</option>
                                                <option value="Zimbabwe">Zimbabwe</option>
                                            </select>
                                        </label>
                                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                            Country of residence
                                            <input type="text" id="country_residence" name="country_residence"
                                                placeholder="South Africa"
                                                class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                        </label>
                                    </div>

                                    <div
                                        class="flex flex-col gap-4 border-t border-slate-100 pt-6 sm:flex-row sm:items-center sm:justify-between">
                                        <div class="flex items-center gap-2">
                                            <button type="button" data-step-delta="1" data-save-profile
                                                class="btn-shine inline-flex items-center justify-center gap-2 rounded-full bg-[var(--olive)] px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-[var(--olive)]/30 transition hover:shadow-xl hover:shadow-[var(--olive)]/40">Save
                                                &amp; continue</button>
                                        </div>
                                    </div>
                                </form>

                                <form data-panel="2" class="tab-panel hidden space-y-10" novalidate>
                                    <div class="space-y-6">
                                        <div class="grid gap-6 md:grid-cols-2">
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Employment status
                                                <select id="employment_status" name="employment_status"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20">
                                                    <option value="">Select…</option>
                                                    <option value="employed">Employed</option>
                                                    <option value="self-employed">Self-employed</option>
                                                    <option value="student">Student</option>
                                                    <option value="unemployed">Unemployed</option>
                                                    <option value="retired">Retired</option>
                                                </select>
                                            </label>
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Occupation
                                                <input type="text" id="occupation" name="occupation"
                                                    placeholder="e.g. Quantitative analyst"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                            </label>
                                        </div>

                                        <div class="grid gap-6 md:grid-cols-2">
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Employer
                                                <input type="text" id="employer" name="employer"
                                                    placeholder="Company or trading entity"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                            </label>
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Annual income bracket
                                                <select id="income_bracket" name="income_bracket"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20">
                                                    <option value="">Select…</option>
                                                    <option value="lt_250k">&lt; R250k</option>
                                                    <option value="250k_500k">R250k–R500k</option>
                                                    <option value="500k_1m">R500k–R1m</option>
                                                    <option value="1m_2m">R1m–R2m</option>
                                                    <option value="gt_2m">&gt; R2m</option>
                                                </select>
                                            </label>
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Source of funds
                                                <select id="source_of_funds" name="source_of_funds"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20">
                                                    <option value="">Select…</option>
                                                    <option value="salary">Salary</option>
                                                    <option value="business">Business income</option>
                                                    <option value="investments">Investments</option>
                                                    <option value="inheritance">Inheritance</option>
                                                    <option value="gift">Gift</option>
                                                    <option value="other">Other</option>
                                                </select>
                                            </label>
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Net worth range
                                                <select id="net_worth_range" name="net_worth_range"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20">
                                                    <option value="">Select…</option>
                                                    <option value="lt_500k">&lt; R500k</option>
                                                    <option value="500k_1m">R500k–R1m</option>
                                                    <option value="1m_5m">R1m–R5m</option>
                                                    <option value="5m_10m">R5m–R10m</option>
                                                    <option value="gt_10m">&gt; R10m</option>
                                                </select>
                                            </label>
                                        </div>

                                        <div class="grid gap-6 md:grid-cols-2">
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Experience level
                                                <select id="experience_level" name="experience_level"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20">
                                                    <option value="">Select…</option>
                                                    <option value="none">None</option>
                                                    <option value="beginner">Beginner</option>
                                                    <option value="intermediate">Intermediate</option>
                                                    <option value="advanced">Advanced</option>
                                                </select>
                                            </label>
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Risk tolerance
                                                <select id="risk_tolerance" name="risk_tolerance"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20">
                                                    <option value="">Select…</option>
                                                    <option value="low">Low</option>
                                                    <option value="moderate">Moderate</option>
                                                    <option value="high">High</option>
                                                </select>
                                            </label>
                                        </div>

                                        <div class="space-y-3">
                                            <span class="text-sm font-medium text-slate-700">Investment
                                                objectives</span>
                                            <div id="objectives-group" class="grid gap-3 rounded-2xl sm:grid-cols-2">
                                                <label
                                                    class="flex items-center gap-3 rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm font-medium text-slate-600 shadow-sm">
                                                    <input type="checkbox" name="objectives" value="Growth"
                                                        class="h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                    Growth
                                                </label>
                                                <label
                                                    class="flex items-center gap-3 rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm font-medium text-slate-600 shadow-sm">
                                                    <input type="checkbox" name="objectives" value="Income"
                                                        class="h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                    Income
                                                </label>
                                                <label
                                                    class="flex items-center gap-3 rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm font-medium text-slate-600 shadow-sm">
                                                    <input type="checkbox" name="objectives" value="Preservation"
                                                        class="h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                    Capital preservation
                                                </label>
                                                <label
                                                    class="flex items-center gap-3 rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm font-medium text-slate-600 shadow-sm">
                                                    <input type="checkbox" name="objectives" value="Speculation"
                                                        class="h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                    Speculation
                                                </label>
                                                <label
                                                    class="flex items-center gap-3 rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm font-medium text-slate-600 shadow-sm">
                                                    <input type="checkbox" name="objectives" value="Hedging"
                                                        class="h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                    Hedging
                                                </label>
                                                <label
                                                    class="flex items-center gap-3 rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm font-medium text-slate-600 shadow-sm">
                                                    <input type="checkbox" name="objectives" value="Other"
                                                        class="h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                    Other
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div
                                        class="flex flex-col gap-4 border-t border-slate-100 pt-6 sm:flex-row sm:items-center sm:justify-between">
                                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                                            <button type="button" data-step-delta="-1"
                                                class="inline-flex items-center justify-center rounded-full border border-slate-300 px-5 py-2.5 text-sm font-semibold text-slate-600 transition hover:bg-slate-100">Back</button>
                                            <button type="button" data-step-delta="1" data-save-profile
                                                class="btn-shine inline-flex items-center justify-center gap-2 rounded-full bg-[var(--olive)] px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-[var(--olive)]/30 transition hover:shadow-xl hover:shadow-[var(--olive)]/40">Save
                                                &amp; continue</button>
                                        </div>
                                    </div>
                                </form>

                                <form data-panel="3" class="tab-panel hidden space-y-10" novalidate>
                                    <div class="space-y-6">
                                        <div class="space-y-3">
                                            <p class="text-sm font-medium text-slate-700">Regulatory declarations</p>
                                            <label
                                                class="flex items-start gap-3 rounded-2xl border border-slate-200 bg-white px-4 py-3 text-left text-sm text-slate-600 shadow-sm">
                                                <input type="checkbox" id="pep" name="pep"
                                                    class="mt-1 h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                <span> I confirm I am <span class="font-semibold">not</span> a
                                                    Politically Exposed Person (PEP), or I have disclosed this to
                                                    AlgoHive.</span>
                                            </label>
                                            <label
                                                class="flex items-start gap-3 rounded-2xl border border-slate-200 bg-white px-4 py-3 text-left text-sm text-slate-600 shadow-sm">
                                                <input type="checkbox" id="fatca_crs" name="fatca_crs"
                                                    class="mt-1 h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                <span>I confirm my FATCA/CRS status and will notify AlgoHive of any
                                                    changes.</span>
                                            </label>
                                            <label
                                                class="flex items-start gap-3 rounded-2xl border border-slate-200 bg-white px-4 py-3 text-left text-sm text-slate-600 shadow-sm">
                                                <input type="checkbox" name="aml"
                                                    class="mt-1 h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                <span>I acknowledge AlgoHive’s anti-money laundering policies and agree
                                                    to provide any supporting documentation if requested.</span>
                                            </label>
                                        </div>

                                        <div class="space-y-3">
                                            <p class="text-sm font-medium text-slate-700">Suitability acknowledgements
                                            </p>
                                            <label
                                                class="flex items-start gap-3 rounded-2xl border border-slate-200 bg-white px-4 py-3 text-left text-sm text-slate-600 shadow-sm">
                                                <input type="checkbox" name="objectives_ack"
                                                    class="mt-1 h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                <span>I understand AlgoHive’s strategies involve market risk and have
                                                    considered my investment objectives and tolerance.</span>
                                            </label>
                                            <label
                                                class="flex items-start gap-3 rounded-2xl border border-slate-200 bg-white px-4 py-3 text-left text-sm text-slate-600 shadow-sm">
                                                <input type="checkbox" name="disclosures"
                                                    class="mt-1 h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                <span>I confirm all the information supplied is accurate and I will
                                                    update AlgoHive if anything changes.</span>
                                            </label>
                                        </div>

                                    </div>

                                    <div
                                        class="flex flex-col gap-4 border-t border-slate-100 pt-6 sm:flex-row sm:items-center sm:justify-between">
                                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                                            <button type="button" data-step-delta="-1"
                                                class="inline-flex items-center justify-center rounded-full border border-slate-300 px-5 py-2.5 text-sm font-semibold text-slate-600 transition hover:bg-slate-100">Back</button>
                                            <button type="button" data-step-delta="1" data-save-profile
                                                class="btn-shine inline-flex items-center justify-center gap-2 rounded-full bg-[var(--olive)] px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-[var(--olive)]/30 transition hover:shadow-xl hover:shadow-[var(--olive)]/40">Save
                                                &amp; continue</button>
                                        </div>
                                    </div>
                                </form>

                                <form data-panel="4" class="tab-panel hidden space-y-10" novalidate>
                                    <div class="space-y-6">
                                        <div
                                            class="space-y-4 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
                                            <div
                                                class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                                <div>
                                                    <p class="text-sm font-semibold text-slate-800">SamSub verification
                                                    </p>
                                                    <p id="samsubStatusText" class="text-sm text-slate-500">Start your
                                                        SamSub identity verification to unlock AlgoHive.</p>
                                                </div>
                                                <span id="samsubStatusBadge"
                                                    class="inline-flex items-center justify-center rounded-full border border-amber-200 bg-amber-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-amber-700">Not
                                                    started</span>
                                            </div>
                                            <div class="space-y-3 text-sm text-slate-600">
                                                <p>We partner with SamSub to securely verify your identity and protect
                                                    your account.</p>
                                                <ul class="list-disc space-y-2 pl-5 text-slate-500">
                                                    <li>Use a valid government-issued ID and a recent proof of address.
                                                    </li>
                                                    <li>Ensure your documents are well lit and all details are clearly
                                                        visible.</li>
                                                    <li>The verification portal will open in a secure SamSub window.
                                                    </li>
                                                </ul>
                                            </div>
                                            <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                                                <button type="button" id="samsubStartButton"
                                                    class="btn-shine inline-flex items-center justify-center gap-2 rounded-full bg-[var(--olive)] px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-[var(--olive)]/30 transition hover:shadow-xl hover:shadow-[var(--olive)]/40"
                                                    data-saving-text="Starting…">
                                                    Start SamSub verification
                                                </button>
                                                <button type="button" id="samsubCheckButton"
                                                    class="hidden inline-flex items-center justify-center rounded-full border border-slate-300 px-5 py-2.5 text-sm font-semibold text-slate-600 transition hover:bg-slate-100"
                                                    data-saving-text="Checking…">
                                                    Check status
                                                </button>
                                                <span id="samsubLastChecked"
                                                    class="hidden text-xs text-slate-400 sm:ml-3">Last checked just
                                                    now</span>
                                            </div>
                                        </div>

                                        <div id="samsubLinkCard"
                                            class="hidden rounded-3xl border border-dashed border-[var(--olive)]/40 bg-[var(--olive)]/5 p-6 text-left shadow-sm">
                                            <div
                                                class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                                <div>
                                                    <p class="text-sm font-semibold text-slate-800">Complete your
                                                        verification</p>
                                                    <p class="text-sm text-slate-600">Use the secure link below to
                                                        finish your SamSub identity check.</p>
                                                </div>
                                            </div>
                                            <div class="mt-4 flex flex-wrap items-center gap-3">
                                                <a id="samsubLinkHref" href="#" target="_blank" rel="noreferrer"
                                                    class="inline-flex items-center justify-center gap-2 rounded-full bg-[var(--olive)] px-5 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-[var(--olive-700)]">
                                                    Open verification portal
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                                        viewBox="0 0 20 20" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="1.6" d="M7 13l6-6m0 0H8m5 0v5" />
                                                    </svg>
                                                </a>
                                                <button type="button" id="samsubCopyLink"
                                                    class="inline-flex items-center justify-center gap-2 rounded-full border border-[var(--olive)] px-4 py-2 text-xs font-semibold text-[var(--olive-700)] transition hover:bg-[var(--olive)] hover:text-white">
                                                    Copy link
                                                </button>
                                            </div>
                                            <p id="samsubLinkMessage" class="mt-3 text-xs text-slate-500">Verification
                                                links expire quickly, so complete the process in one sitting.</p>
                                            <iframe id="sumsub-iframe" title="SamSub verification"
                                                class="mt-6 hidden h-[44rem] w-full rounded-3xl border-0 bg-white shadow-inner"
                                                style="height: 700px;" allow="camera *; microphone *; fullscreen"
                                                referrerpolicy="no-referrer"></iframe>
                                        </div>

                                        <div class="rounded-3xl border border-slate-200 bg-white px-6 py-5 shadow-sm">
                                            <p class="text-sm font-medium text-slate-700">What happens next?</p>
                                            <ul id="samsubNextSteps"
                                                class="mt-3 list-disc space-y-2 pl-5 text-sm text-slate-500">
                                                <li>Complete the SamSub verification in the secure window below for the
                                                    smoothest experience.</li>
                                                <li>Return to this page and use “Check status” to confirm your approval.
                                                </li>
                                                <li>Once approved, you can continue to subscription plans.</li>
                                            </ul>
                                        </div>
                                    </div>

                                    <div
                                        class="flex flex-col gap-4 border-t border-slate-100 pt-6 sm:flex-row sm:items-center sm:justify-between">
                                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                                            <button type="button" data-step-delta="-1"
                                                class="inline-flex items-center justify-center rounded-full border border-slate-300 px-5 py-2.5 text-sm font-semibold text-slate-600 transition hover:bg-slate-100">Back</button>
                                            <button type="button" data-step-delta="1" data-save-profile
                                                class="btn-shine inline-flex items-center justify-center gap-2 rounded-full bg-[var(--olive)] px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-[var(--olive)]/30 transition hover:shadow-xl hover:shadow-[var(--olive)]/40">Save
                                                &amp; continue</button>
                                        </div>
                                    </div>
                                </form>

                                <form data-panel="5" class="tab-panel hidden space-y-10" novalidate>
                                    <div class="space-y-6">
                                        <div data-plan-group class="grid gap-6 md:grid-cols-2">
                                            <label
                                                class="relative flex cursor-pointer flex-col gap-5 rounded-3xl border border-slate-200 bg-white p-6 text-left shadow-sm transition hover:border-[var(--olive)] hover:shadow-lg">
                                                <input type="radio" name="plan" value="core"
                                                    class="peer absolute right-6 top-6 h-4 w-4 border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                <div class="space-y-1">
                                                    <span
                                                        class="text-sm font-semibold uppercase tracking-[0.25em] text-[var(--olive)]">Core</span>
                                                    <p class="text-3xl font-semibold text-slate-900">
                                                        R450
                                                        <span class="text-base font-medium text-slate-500">/mo</span>
                                                    </p>
                                                </div>
                                                <ul class="space-y-2 text-sm text-slate-600">
                                                    <li class="flex items-start gap-2">
                                                        <span
                                                            class="mt-1 inline-flex h-1.5 w-1.5 rounded-full bg-[var(--olive)]"></span>
                                                        <span>Funds * (CIS)</span>
                                                    </li>
                                                    <li class="flex items-start gap-2">
                                                        <span
                                                            class="mt-1 inline-flex h-1.5 w-1.5 rounded-full bg-[var(--olive)]"></span>
                                                        <span>Unsecured Lending</span>
                                                    </li>
                                                    <li class="flex items-start gap-2">
                                                        <span
                                                            class="mt-1 inline-flex h-1.5 w-1.5 rounded-full bg-[var(--olive)]"></span>
                                                        <span>AlgoPay (Credit Facilitation &amp; Rewards &amp;
                                                            Payments)</span>
                                                    </li>
                                                    <li class="flex items-start gap-2">
                                                        <span
                                                            class="mt-1 inline-flex h-1.5 w-1.5 rounded-full bg-[var(--olive)]"></span>
                                                        <span>Up to 6 strategies</span>
                                                    </li>
                                                </ul>
                                            </label>

                                            <label
                                                class="relative flex cursor-pointer flex-col gap-5 rounded-3xl border border-slate-200 bg-white p-6 text-left shadow-sm transition hover:border-[var(--olive)] hover:shadow-lg">
                                                <input type="radio" name="plan" value="professional"
                                                    class="peer absolute right-6 top-6 h-4 w-4 border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                <div class="space-y-1">
                                                    <span
                                                        class="text-sm font-semibold uppercase tracking-[0.25em] text-[var(--olive)]">Professional</span>
                                                    <p class="text-3xl font-semibold text-slate-900">
                                                        R899
                                                        <span class="text-base font-medium text-slate-500">/mo</span>
                                                    </p>
                                                </div>
                                                <ul class="space-y-2 text-sm text-slate-600">
                                                    <li class="flex items-start gap-2">
                                                        <span
                                                            class="mt-1 inline-flex h-1.5 w-1.5 rounded-full bg-[var(--olive)]"></span>
                                                        <span>Open Strategies * up to 10</span>
                                                    </li>
                                                    <li class="flex items-start gap-2">
                                                        <span
                                                            class="mt-1 inline-flex h-1.5 w-1.5 rounded-full bg-[var(--olive)]"></span>
                                                        <span>Managed V.A.S.T *</span>
                                                    </li>
                                                    <li class="flex items-start gap-2">
                                                        <span
                                                            class="mt-1 inline-flex h-1.5 w-1.5 rounded-full bg-[var(--olive)]"></span>
                                                        <span>Self-Managed V.A.S.T</span>
                                                    </li>
                                                    <li class="flex items-start gap-2">
                                                        <span
                                                            class="mt-1 inline-flex h-1.5 w-1.5 rounded-full bg-[var(--olive)]"></span>
                                                        <span>Funds * (CIS)</span>
                                                    </li>
                                                    <li class="flex items-start gap-2">
                                                        <span
                                                            class="mt-1 inline-flex h-1.5 w-1.5 rounded-full bg-[var(--olive)]"></span>
                                                        <span>Investment Backed Lending &amp; Unsecured</span>
                                                    </li>
                                                    <li class="flex items-start gap-2">
                                                        <span
                                                            class="mt-1 inline-flex h-1.5 w-1.5 rounded-full bg-[var(--olive)]"></span>
                                                        <span>AlgoPay (Credit Facilitation &amp; Rewards &amp;
                                                            Payments)</span>
                                                    </li>
                                                </ul>
                                            </label>
                                        </div>

                                        <div class="text-center">
                                            <button type="button" data-plan-skip
                                                class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400 transition hover:text-slate-600">Skip
                                                for now</button>
                                        </div>
                                    </div>

                                    <div
                                        class="flex flex-col gap-4 border-t border-slate-100 pt-6 sm:flex-row sm:items-center sm:justify-between">
                                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                                            <button type="button" data-step-delta="-1"
                                                class="inline-flex items-center justify-center rounded-full border border-slate-300 px-5 py-2.5 text-sm font-semibold text-slate-600 transition hover:bg-slate-100">Back</button>
                                            <button type="button" data-complete data-save-profile
                                                class="btn-shine inline-flex items-center justify-center gap-2 rounded-full bg-[var(--olive)] px-6 py-3 text-sm font-semibold text-white shadow-lg shadow-[var(--olive)]/30 transition hover:shadow-xl hover:shadow-[var(--olive)]/40">Complete
                                                onboarding</button>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <div id="onboardingComplete"
                                class="hidden space-y-6 rounded-3xl border border-white/40 bg-white/90 p-6 text-left shadow-[0_20px_50px_-28px_rgba(15,23,42,0.55)] backdrop-blur sm:p-8">
                                <div id="checkoutLoader"
                                    class="flex items-center gap-4 rounded-3xl border border-slate-200 bg-white px-6 py-5 shadow-sm">
                                    <span
                                        class="h-10 w-10 animate-spin rounded-full border-2 border-[var(--olive)] border-t-transparent"></span>
                                    <p class="text-sm font-semibold text-slate-800">Finalising your setup…</p>
                                </div>

                                <div id="explorePanel" class="hidden space-y-4">
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-[var(--olive)]">
                                        Explore AlgoHive</p>
                                    <h3 class="text-xl font-semibold text-slate-900">Welcome to AlgoHive</h3>
                                    <p class="text-sm text-slate-500">You're officially part of the hive! Explore
                                        tailored investing opportunities and smart lending tools crafted to help you
                                        reach your goals.</p>
                                    <p class="text-sm text-slate-500">Pick your next step below to dive into AlgoHive.
                                    </p>
                                    <div class="grid gap-4 sm:grid-cols-2">
                                        <a href="#" class="product-card product-card--invest">
                                            <p class="product-card__eyebrow">Welcome</p>
                                            <p class="product-card__title">Start investing</p>
                                            <span class="product-card__cta">Explore strategies
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                                                    <path stroke="currentColor" stroke-linecap="round"
                                                        stroke-linejoin="round" stroke-width="1.6" d="M8 5l4 5-4 5" />
                                                </svg>
                                            </span>
                                        </a>
                                        <a href="#" class="product-card product-card--loan">
                                            <p class="product-card__eyebrow">Welcome</p>
                                            <p class="product-card__title">Apply for a loan</p>
                                            <span class="product-card__cta">View loan offers
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                                                    <path stroke="currentColor" stroke-linecap="round"
                                                        stroke-linejoin="round" stroke-width="1.6" d="M8 5l4 5-4 5" />
                                                </svg>
                                            </span>
                                        </a>
                                    </div>
                                </div>

                                <div id="checkoutPanel"
                                    class="hidden rounded-3xl border border-slate-200 bg-white p-6 shadow-lg sm:p-8">
                                    <div class="mb-6 flex items-center justify-between">
                                        <div>
                                            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
                                                Subscribe</p>
                                            <h3 id="checkoutTitle" class="mt-1 text-xl font-semibold text-slate-900">
                                                Review your plan</h3>
                                        </div>
                                        <span id="checkoutBadge"
                                            class="rounded-full bg-[var(--olive)]/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em] text-[var(--olive-700)]">Plan</span>
                                    </div>
                                    <div id="checkoutReview"
                                        class="grid gap-6 lg:grid-cols-[minmax(0,1.2fr)_minmax(0,1fr)]">
                                        <form class="space-y-5">
                                            <div>
                                                <label class="text-sm font-semibold text-slate-800">Saved payment
                                                    method</label>
                                                <div
                                                    class="mt-2 flex items-center gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm font-medium text-slate-600 shadow-sm">
                                                    <span
                                                        class="inline-flex h-7 w-10 items-center justify-center rounded-lg bg-white shadow-inner">VISA</span>
                                                    <span>•••• 3589</span>
                                                    <button type="button"
                                                        class="ml-auto text-xs font-semibold text-[var(--olive)] underline-offset-2 hover:underline">Change</button>
                                                </div>
                                            </div>
                                            <div>
                                                <div
                                                    class="flex items-center justify-between text-sm font-semibold text-slate-800">
                                                    <span>Credit or debit card</span>
                                                    <div class="flex items-center gap-1 text-slate-400">
                                                        <span class="h-5 w-8 rounded bg-white shadow-inner"></span>
                                                        <span class="h-5 w-8 rounded bg-white shadow-inner"></span>
                                                    </div>
                                                </div>
                                                <div class="mt-3 grid gap-3 sm:grid-cols-2">
                                                    <label
                                                        class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-400">
                                                        Card holder
                                                        <input type="text" name="card_name" placeholder="Full name"
                                                            class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-sm text-slate-700 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/30" />
                                                    </label>
                                                    <label
                                                        class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-400">
                                                        Card number
                                                        <input type="text" name="card_number"
                                                            placeholder="1234 5678 9012 3456"
                                                            class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-sm text-slate-700 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/30" />
                                                    </label>
                                                    <label
                                                        class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-400">
                                                        Expires
                                                        <input type="text" name="card_expiry" placeholder="MM / YY"
                                                            class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-sm text-slate-700 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/30" />
                                                    </label>
                                                    <label
                                                        class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-400">
                                                        CVV
                                                        <input type="text" name="card_cvv" placeholder="123"
                                                            class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-sm text-slate-700 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/30" />
                                                    </label>
                                                    <label
                                                        class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-400">
                                                        ZIP code
                                                        <input type="text" name="card_zip" placeholder="00000"
                                                            class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-sm text-slate-700 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/30" />
                                                    </label>
                                                </div>
                                            </div>
                                            <button type="button"
                                                class="btn-shine inline-flex w-full items-center justify-center gap-2 rounded-full bg-[var(--olive)] px-6 py-3 text-sm font-semibold text-white shadow-lg shadow-[var(--olive)]/30 transition hover:shadow-xl hover:shadow-[var(--olive)]/40">Subscribe
                                                now</button>
                                        </form>
                                        <aside
                                            class="space-y-5 rounded-3xl border border-slate-200 bg-slate-50 p-5 shadow-inner">
                                            <div class="space-y-1">
                                                <p class="text-sm font-semibold text-slate-800">Subscription summary</p>
                                                <p id="checkoutSubtitle" class="text-xs text-slate-500">Billed monthly
                                                </p>
                                            </div>
                                            <div
                                                class="flex items-baseline gap-2 text-3xl font-semibold text-slate-900">
                                                <span id="checkoutPrice">R0.00</span>
                                                <span class="text-sm font-medium text-slate-500">ZAR</span>
                                            </div>
                                            <ul id="checkoutPerks" class="space-y-3 text-sm text-slate-600"></ul>
                                            <div
                                                class="space-y-2 rounded-2xl border border-dashed border-slate-300 bg-white p-4 text-sm text-slate-600">
                                                <div class="flex items-center justify-between">
                                                    <span>Today</span>
                                                    <span id="checkoutDueToday"
                                                        class="font-semibold text-slate-900">R0.00</span>
                                                </div>
                                                <div class="flex items-center justify-between text-xs text-slate-500">
                                                    <span>Renews</span>
                                                    <span id="checkoutRenewal">1 × every month</span>
                                                </div>
                                                <div class="flex items-center justify-between text-xs text-slate-500">
                                                    <span>Next charge</span>
                                                    <span id="checkoutNextCharge">March 1, 2024</span>
                                                </div>
                                            </div>
                                            <p class="text-xs text-slate-400">Change or cancel your plan anytime.</p>
                                        </aside>
                                    </div>
                                    <div id="corePaymentContainer" class="mt-6 hidden">
                                        <iframe id="corePaymentFrame" src="https://paystack.shop/pay/eo1b1n9h45"
                                            title="AlgoHive Core plan payment" loading="lazy"
                                            class="h-[680px] w-full rounded-3xl border border-slate-200 shadow-lg"
                                            allow="payment *; clipboard-write"></iframe>
                                        <p id="corePaymentStatus" class="mt-3 text-xs text-slate-500">Complete your
                                            payment in the secure Paystack window above. We'll automatically confirm
                                            when it's successful.</p>
                                    </div>
                                </div>
                                <div id="professionalPaymentContainer"
                                    class="hidden rounded-3xl border border-slate-200 bg-white p-6 shadow-lg sm:p-8">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
                                                Subscribe</p>
                                            <h3 class="mt-1 text-xl font-semibold text-slate-900">AlgoHive Professional
                                                subscription</h3>
                                            <p class="mt-3 text-sm text-slate-600">Complete your secure checkout to
                                                unlock AlgoHive Professional.</p>
                                        </div>
                                        <span
                                            class="rounded-full bg-[var(--olive)]/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em] text-[var(--olive-700)]">Professional
                                            plan</span>
                                    </div>
                                    <iframe id="professionalPaymentFrame" src="https://paystack.shop/pay/8v7rlnuobj"
                                        title="AlgoHive Professional plan payment" loading="lazy"
                                        class="mt-6 h-[680px] w-full rounded-3xl border border-slate-200 shadow-lg"
                                        allow="payment *; clipboard-write"></iframe>
                                    <p id="professionalPaymentStatus" class="mt-3 text-xs text-slate-500">Complete your
                                        payment in the secure Paystack window above. We'll automatically confirm when
                                        it's successful.</p>
                                </div>
                                <div id="corePaymentContainer"
                                    class="hidden rounded-3xl border border-slate-200 bg-white p-6 shadow-lg sm:p-8">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
                                                Subscribe</p>
                                            <h3 class="mt-1 text-xl font-semibold text-slate-900">AlgoHive Core
                                                subscription</h3>
                                            <p class="mt-3 text-sm text-slate-600">Complete your secure checkout to
                                                unlock AlgoHive Core.</p>
                                        </div>
                                        <span
                                            class="rounded-full bg-[var(--olive)]/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em] text-[var(--olive-700)]">Core
                                            plan</span>
                                    </div>
                                    <iframe id="corePaymentFrame" src="https://paystack.shop/pay/eo1b1n9h45"
                                        title="AlgoHive Core plan payment" loading="lazy"
                                        class="mt-6 h-[680px] w-full rounded-3xl border border-slate-200 shadow-lg"
                                        allow="payment *; clipboard-write"></iframe>
                                    <p id="corePaymentStatus" class="mt-3 text-xs text-slate-500">Complete your payment
                                        in the secure Paystack window above. We'll automatically confirm when it's
                                        successful.</p>
                                </div>
                                <div id="professionalPaymentContainer"
                                    class="hidden rounded-3xl border border-slate-200 bg-white p-6 shadow-lg sm:p-8">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
                                                Subscribe</p>
                                            <h3 class="mt-1 text-xl font-semibold text-slate-900">AlgoHive Professional
                                                subscription</h3>
                                            <p class="mt-3 text-sm text-slate-600">Complete your secure checkout to
                                                unlock AlgoHive Professional.</p>
                                        </div>
                                        <span
                                            class="rounded-full bg-[var(--olive)]/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em] text-[var(--olive-700)]">Professional
                                            plan</span>
                                    </div>
                                    <iframe id="professionalPaymentFrame" src="https://paystack.shop/pay/8v7rlnuobj"
                                        title="AlgoHive Professional plan payment" loading="lazy"
                                        class="mt-6 h-[680px] w-full rounded-3xl border border-slate-200 shadow-lg"
                                        allow="payment *; clipboard-write"></iframe>
                                    <p id="professionalPaymentStatus" class="mt-3 text-xs text-slate-500">Complete your
                                        payment in the secure Paystack window above. We'll automatically confirm when
                                        it's successful.</p>
                                </div>
                                <div id="corePaymentContainer"
                                    class="hidden rounded-3xl border border-slate-200 bg-white p-6 shadow-lg sm:p-8">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
                                                Subscribe</p>
                                            <h3 class="mt-1 text-xl font-semibold text-slate-900">AlgoHive Core
                                                subscription</h3>
                                            <p class="mt-3 text-sm text-slate-600">Complete your secure checkout to
                                                unlock AlgoHive Core.</p>
                                        </div>
                                        <span
                                            class="rounded-full bg-[var(--olive)]/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em] text-[var(--olive-700)]">Core
                                            plan</span>
                                    </div>
                                    <iframe id="corePaymentFrame" src="https://paystack.shop/pay/eo1b1n9h45"
                                        title="AlgoHive Core plan payment" loading="lazy"
                                        class="mt-6 h-[680px] w-full rounded-3xl border border-slate-200 shadow-lg"
                                        allow="payment *; clipboard-write"></iframe>
                                    <p id="corePaymentStatus" class="mt-3 text-xs text-slate-500">Complete your payment
                                        in the secure Paystack window above. We'll automatically confirm when it's
                                        successful.</p>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </aside>
    </div>

    <script type="module" nonce="ALGOHIVE">
        import { supabase } from "/js/supabase.js";

        const preloader = document.getElementById("preloader");
        window.addEventListener("load", () => {
            if (!preloader) return;
            preloader.classList.add("preloader--hide");
            setTimeout(() => preloader.remove(), 450);
        });

        function banner(msg, tone = "warn") {
            const stackId = "toast-stack";
            let stack = document.getElementById(stackId);
            if (!stack) {
                stack = document.createElement("div");
                stack.id = stackId;
                stack.className = "toast-stack";
                document.body.appendChild(stack);
            }

            const toast = document.createElement("div");
            toast.className = "toast-card";
            toast.dataset.tone = tone;

            const icon = document.createElement("span");
            icon.className = "toast-icon";
            icon.setAttribute("aria-hidden", "true");
            icon.innerHTML = tone === "ok"
                ? '<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 6L8.5 14L4 9.5" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"/></svg>'
                : '<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.5 6.5L6.5 13.5" stroke="currentColor" stroke-width="1.75" stroke-linecap="round"/><path d="M6.5 6.5L13.5 13.5" stroke="currentColor" stroke-width="1.75" stroke-linecap="round"/></svg>';

            const content = document.createElement("div");
            content.className = "toast-content";
            const message = document.createElement("p");
            message.className = "toast-message";
            message.textContent = msg;
            content.appendChild(message);

            const close = document.createElement("button");
            close.type = "button";
            close.className = "toast-dismiss";
            close.setAttribute("aria-label", "Dismiss notification");
            close.innerHTML = '<svg width="14" height="14" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12.75 7.25L7.25 12.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M7.25 7.25L12.75 12.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>';

            toast.append(icon, content, close);
            stack.prepend(toast);

            let isLeaving = false;
            const removeToast = () => {
                if (isLeaving) return;
                isLeaving = true;
                toast.classList.add("toast-card--leaving");
                toast.addEventListener(
                    "animationend",
                    () => {
                        toast.remove();
                        if (!stack.hasChildNodes()) {
                            stack.remove();
                        }
                    },
                    { once: true },
                );
            };

            const timeout = setTimeout(removeToast, 5000);
            close.addEventListener("click", () => {
                clearTimeout(timeout);
                removeToast();
            });
        }

        const REQUIRED_FIELDS = [
            "first_name",
            "last_name",
            "phone",
            "dob",
            "id_number",
            "nationality",
            "country_residence",
            "employment_status",
            "occupation",
            "employer",
            "income_bracket",
            "source_of_funds",
            "net_worth_range",
            "experience_level",
            "risk_tolerance",
            "objectives",
        ];
        const OBJECTIVES_FIELD_KEY = "objectives";
        const FORM_REQUIRED_FIELDS = REQUIRED_FIELDS.filter((key) => key !== OBJECTIVES_FIELD_KEY);
        const STEP_FIELD_GROUPS = {
            1: ["first_name", "last_name", "phone", "dob", "id_number", "nationality", "country_residence"],
            2: [
                "employment_status",
                "occupation",
                "employer",
                "income_bracket",
                "source_of_funds",
                "net_worth_range",
                "experience_level",
                "risk_tolerance",
                OBJECTIVES_FIELD_KEY,
            ],
        };

        const hasValue = (value) => String(value ?? "").trim().length > 0;
        function computeProfileComplete(row) {
            return REQUIRED_FIELDS.every((key) => {
                if (key === OBJECTIVES_FIELD_KEY) return hasValue(row?.objectives);
                return hasValue(row?.[key]);
            });
        }

        const objectivesGroup = document.getElementById("objectives-group");
        const planGroup = document.querySelector('[data-plan-group]');
        const planRadios = Array.from(document.querySelectorAll('input[name="plan"]'));
        const planSkipButton = document.querySelector('[data-plan-skip]');
        const completeButton = document.querySelector('[data-complete][data-save-profile]');
        const corePaymentContainer = document.getElementById("corePaymentContainer");
        const corePaymentFrame = document.getElementById("corePaymentFrame");
        const corePaymentStatus = document.getElementById("corePaymentStatus");
        const corePaymentStatusDefaultClass = corePaymentStatus?.className || "";
        const corePaymentStatusDefaultText = corePaymentStatus?.textContent?.trim() || "";
        const professionalPaymentContainer = document.getElementById("professionalPaymentContainer");
        const professionalPaymentFrame = document.getElementById("professionalPaymentFrame");
        const professionalPaymentStatus = document.getElementById("professionalPaymentStatus");
        const professionalPaymentStatusDefaultClass = professionalPaymentStatus?.className || "";
        const professionalPaymentStatusDefaultText = professionalPaymentStatus?.textContent?.trim() || "";
        const samsubStatusBadge = document.getElementById("samsubStatusBadge");
        const samsubStatusText = document.getElementById("samsubStatusText");
        const samsubStartButton = document.getElementById("samsubStartButton");
        const samsubCheckButton = document.getElementById("samsubCheckButton");
        const samsubLastCheckedLabel = document.getElementById("samsubLastChecked");
        const samsubLinkCard = document.getElementById("samsubLinkCard");
        const samsubLinkHref = document.getElementById("samsubLinkHref");
        const samsubCopyLinkButton = document.getElementById("samsubCopyLink");
        const samsubLinkMessage = document.getElementById("samsubLinkMessage");
        const samsubNextStepsList = document.getElementById("samsubNextSteps");
        const sumsubIframe = document.getElementById("sumsub-iframe");
        const kycContinueButton = document.querySelector('[data-panel="4"] [data-step-delta="1"][data-save-profile]');
        const samsubLinkMessageDefault = samsubLinkMessage?.textContent || "Verification links expire quickly, so complete the process in one sitting.";
        const SAMSUB_STORAGE_KEY = "ah:samsub:kyc";
        const SAMSUB_LEVEL_NAME = "idv-and-phone-verification";
        const SAMSUB_DEFAULT_MESSAGE = "Start your SamSub identity verification to unlock AlgoHive.";
        const SAMSUB_DEFAULT_NEXT_STEPS = [
            "Complete the SamSub verification in the secure window below for the smoothest experience.",
            "Return to this page and use “Check status” to confirm your approval.",
            "Once approved, you can continue to subscription plans.",
        ];
        let samsubApplicantId = null;
        let samsubVerificationUrl = null;
        let samsubStatusState = "idle";
        let samsubExternalUserId = null;
        let samsubLastCheckedAt = null;
        let kycDone = false;

        const SAMSUB_STATUS_META = {
            idle: {
                badge:
                    "inline-flex items-center justify-center rounded-full border border-amber-200 bg-amber-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-amber-700",
                label: "Not started",
                message: SAMSUB_DEFAULT_MESSAGE,
            },
            link_ready: {
                badge:
                    "inline-flex items-center justify-center rounded-full border border-[var(--olive)]/50 bg-[var(--olive)]/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-[var(--olive-700)]",
                label: "Link ready",
                message: "We've generated a secure SamSub window. Complete your verification to continue.",
            },
            pending: {
                badge:
                    "inline-flex items-center justify-center rounded-full border border-sky-200 bg-sky-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-sky-700",
                label: "In review",
                message: "SamSub is reviewing your documents. This usually takes a few minutes.",
            },
            completed: {
                badge:
                    "inline-flex items-center justify-center rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-emerald-700",
                label: "Verified",
                message: "Your identity is verified. You're all set!",
            },
            failed: {
                badge:
                    "inline-flex items-center justify-center rounded-full border border-rose-200 bg-rose-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-rose-700",
                label: "Action required",
                message: "SamSub couldn't verify your identity. Please retry or contact support.",
            },
            error: {
                badge:
                    "inline-flex items-center justify-center rounded-full border border-amber-200 bg-amber-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-amber-700",
                label: "Try again",
                message: "We couldn't update your SamSub status. Try again shortly.",
            },
        };

        function syncKycContinueButton() {
            if (!kycContinueButton) return;
            const allow = !!kycDone;
            kycContinueButton.disabled = !allow;
            kycContinueButton.classList.toggle("opacity-60", !allow);
            kycContinueButton.classList.toggle("cursor-not-allowed", !allow);
            if (!allow) {
                kycContinueButton.setAttribute("aria-disabled", "true");
            } else {
                kycContinueButton.removeAttribute("aria-disabled");
            }
        }

        function syncSamsubStartButton() {
            if (!samsubStartButton) return;
            if (kycDone) {
                samsubStartButton.classList.add("hidden");
                return;
            }
            samsubStartButton.classList.remove("hidden");
            const text = samsubApplicantId ? "Resend verification link" : "Start SamSub verification";
            samsubStartButton.textContent = text;
            samsubStartButton.dataset.originalText = text;
        }

        function formatDateTime(date) {
            if (!(date instanceof Date) || Number.isNaN(date.getTime())) return "";
            return new Intl.DateTimeFormat("en-US", { dateStyle: "medium", timeStyle: "short" }).format(date);
        }

        function updateSamsubLastChecked(value) {
            samsubLastCheckedAt = value instanceof Date ? value : value ? new Date(value) : null;
            if (!samsubLastCheckedLabel) return;
            if (!samsubLastCheckedAt || Number.isNaN(samsubLastCheckedAt.getTime())) {
                samsubLastCheckedLabel.classList.add("hidden");
                samsubLastCheckedLabel.textContent = "";
                return;
            }
            samsubLastCheckedLabel.textContent = `Last checked ${formatDateTime(samsubLastCheckedAt)}`;
            samsubLastCheckedLabel.classList.remove("hidden");
        }

        function renderSamsubSteps(items) {
            if (!samsubNextStepsList) return;
            const entries = Array.isArray(items) && items.length ? items : SAMSUB_DEFAULT_NEXT_STEPS;
            samsubNextStepsList.innerHTML = "";
            entries.forEach((text) => {
                const li = document.createElement("li");
                li.textContent = text;
                samsubNextStepsList.appendChild(li);
            });
        }

        async function parseJsonResponse(response, context = "request") {
            const raw = await response.text();
            if (!raw) return {};
            try {
                return JSON.parse(raw);
            } catch (error) {
                const statusText = `${response.status || ""} ${response.statusText || ""}`.trim() || "unknown status";
                console.error(`Failed to parse ${context} response.`, { error, raw, status: response.status });
                throw new Error(`The server returned an unreadable response (${statusText}). Please try again later.`);
            }
        }

        function loadSamsubState() {
            try {
                const raw = localStorage.getItem(SAMSUB_STORAGE_KEY);
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                return typeof parsed === "object" && parsed ? parsed : null;
            } catch (error) {
                console.error(error);
                return null;
            }
        }

        function saveSamsubState(state) {
            try {
                if (!state) {
                    localStorage.removeItem(SAMSUB_STORAGE_KEY);
                    return;
                }
                localStorage.setItem(SAMSUB_STORAGE_KEY, JSON.stringify(state));
            } catch (error) {
                console.error(error);
            }
        }

        function mergeSamsubState(partial) {
            if (!partial) return;
            const current = loadSamsubState() || {};
            saveSamsubState({ ...current, ...partial });
        }

        function clearSamsubState() {
            try {
                localStorage.removeItem(SAMSUB_STORAGE_KEY);
            } catch (error) {
                console.error(error);
            }
        }

        function setSamsubStatus(status, options = {}) {
            samsubStatusState = status;
            const meta = SAMSUB_STATUS_META[status] || SAMSUB_STATUS_META.idle;
            if (samsubStatusBadge) {
                samsubStatusBadge.textContent = meta.label;
                samsubStatusBadge.className = meta.badge;
            }
            if (samsubStatusText) {
                samsubStatusText.textContent = options.message || meta.message || SAMSUB_DEFAULT_MESSAGE;
            }
            if (samsubCheckButton) {
                const show = !!options.showCheck;
                samsubCheckButton.classList.toggle("hidden", !show);
                if (!show) samsubCheckButton.disabled = false;
            }
            if (options.lastChecked) {
                updateSamsubLastChecked(options.lastChecked instanceof Date ? options.lastChecked : new Date(options.lastChecked));
            } else if (!options.preserveLastChecked && (status === "idle" || status === "link_ready")) {
                updateSamsubLastChecked(null);
            }
            syncSamsubStartButton();
            syncKycContinueButton();
        }

        function applySamsubLink(url, options = {}) {
            samsubVerificationUrl = url || null;
            if (!samsubLinkCard) return;
            if (url) {
                samsubLinkCard.classList.remove("hidden");
                if (samsubLinkHref) samsubLinkHref.href = url;
                if (sumsubIframe) {
                    sumsubIframe.classList.remove("hidden");
                    sumsubIframe.src = url;
                }
                if (samsubLinkMessage) {
                    samsubLinkMessage.textContent = options.message || samsubLinkMessageDefault;
                }
            } else {
                samsubLinkCard.classList.add("hidden");
                if (samsubLinkHref) samsubLinkHref.removeAttribute("href");
                if (sumsubIframe) {
                    sumsubIframe.classList.add("hidden");
                    sumsubIframe.removeAttribute("src");
                }
                if (samsubLinkMessage) samsubLinkMessage.textContent = samsubLinkMessageDefault;
            }
        }

        syncKycContinueButton();
        syncSamsubStartButton();

        function setPlanGroupError(active) {
            if (!planGroup) return;
            planGroup.classList.toggle("plan-group--error", !!active);
        }

        function clearFieldErrors() {
            FORM_REQUIRED_FIELDS.forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.classList.remove("input-error");
            });
            objectivesGroup?.classList.remove("field-error");
            setPlanGroupError(false);
        }

        function syncObjectivesHighlight() {
            const checked = document.querySelectorAll('input[name="objectives"]:checked').length > 0;
            if (objectivesGroup) objectivesGroup.classList.toggle("field-error", !checked);
            return checked;
        }

        FORM_REQUIRED_FIELDS.forEach((id) => {
            const el = document.getElementById(id);
            if (!el) return;
            const handle = () => {
                if (hasValue(el.value)) el.classList.remove("input-error");
            };
            el.addEventListener("input", handle);
            el.addEventListener("change", handle);
        });

        document.querySelectorAll('input[name="objectives"]').forEach((cb) => {
            cb.addEventListener("change", () => {
                syncObjectivesHighlight();
            });
        });

        planRadios.forEach((radio) => {
            radio.addEventListener("change", () => {
                selectedPlanKey = radio.value;
                planSkipped = false;
                const selectingPaystack = paystackPlanKeys.includes(radio.value);
                activePaystackPlan = selectingPaystack ? radio.value : null;

                paystackPlanKeys.forEach((planKey) => {
                    const context = paymentContexts[planKey];
                    if (!context) return;
                    const isTarget = radio.value === planKey;
                    const { container, statusEl } = context;

                    if (container) {
                        container.classList.toggle("hidden", !isTarget);
                        if (isTarget) {
                            container.classList.add("swap-anim");
                        } else {
                            container.classList.remove("swap-anim");
                        }
                    }

                    if (statusEl) {
                        if (isTarget) {
                            const alreadyOnPlan = paymentCompletion[planKey] || profileRow?.plan === planKey;
                            if (alreadyOnPlan) {
                                paymentCompletion[planKey] = true;
                                statusEl.className = "mt-3 text-xs font-semibold text-[var(--olive)]";
                                statusEl.textContent = `Payment confirmed — your profile is already on the ${planLabels[planKey]} plan.`;
                            } else {
                                resetPaymentStatus(planKey);
                            }
                        } else {
                            resetPaymentStatus(planKey);
                        }
                    }
                });

                if (checkoutPanel) {
                    checkoutPanel.classList.toggle("hidden", selectingPaystack);
                    checkoutPanel.classList.toggle("swap-anim", !selectingPaystack);
                    if (selectingPaystack) checkoutPanel.classList.remove("swap-anim");
                }
                if (checkoutReview) {
                    checkoutReview.classList.toggle("hidden", selectingPaystack);
                }
                setPlanGroupError(false);
                if (explorePanel && !explorePanel.classList.contains("hidden")) {
                    explorePanel.classList.add("hidden");
                }
            });
        });

        planSkipButton?.addEventListener("click", () => {
            planSkipped = true;
            selectedPlanKey = null;
            activePaystackPlan = null;
            planRadios.forEach((radio) => {
                radio.checked = false;
            });
            paystackPlanKeys.forEach((planKey) => {
                const context = paymentContexts[planKey];
                if (!context) return;
                context.container?.classList.add("hidden");
                context.container?.classList.remove("swap-anim");
                resetPaymentStatus(planKey);
            });
            activePaystackPlan = null;
            if (checkoutReview) checkoutReview.classList.remove("hidden");
            setPlanGroupError(false);
            if (checkoutPanel) {
                checkoutPanel.classList.add("hidden");
            }
            if (explorePanel) {
                explorePanel.classList.add("hidden");
            }
            window.requestAnimationFrame(() => {
                completeButton?.click();
            });
        });

        const stepMeta = {
            1: { label: "Step 1 of 5 · Basic info", title: "Tell us about yourself" },
            2: { label: "Step 2 of 5 · Employment & income", title: "Share your work and income profile" },
            3: { label: "Step 3 of 5 · Compliance", title: "Confirm your declarations" },
            4: { label: "Step 4 of 5 · KYC", title: "Verify your identity" },
            5: { label: "Step 5 of 5 · Subscription plans", title: "Choose your AlgoHive access" },
        };

        const panels = Array.from(document.querySelectorAll("[data-panel]"));
        const panelForms = panels.filter((panel) => panel instanceof HTMLFormElement);
        const onboardingFlow = document.getElementById("onboardingFlow");
        const onboardingComplete = document.getElementById("onboardingComplete");
        const checkoutLoader = document.getElementById("checkoutLoader");
        const checkoutPanel = document.getElementById("checkoutPanel");
        const checkoutReview = document.getElementById("checkoutReview");
        const explorePanel = document.getElementById("explorePanel");
        const checkoutBadge = document.getElementById("checkoutBadge");
        const checkoutTitle = document.getElementById("checkoutTitle");
        const checkoutSubtitle = document.getElementById("checkoutSubtitle");
        const checkoutPrice = document.getElementById("checkoutPrice");
        const checkoutPerksList = document.getElementById("checkoutPerks");
        const checkoutDueToday = document.getElementById("checkoutDueToday");
        const checkoutRenewal = document.getElementById("checkoutRenewal");
        const checkoutNextCharge = document.getElementById("checkoutNextCharge");
        const stepLabel = document.getElementById("currentStepLabel");
        const stepTitle = document.getElementById("currentStepTitle");
        const onboardingIntro = document.getElementById("onboardingIntro");
        const stepSummary = document.getElementById("stepSummary");
        const stepItems = Array.from(document.querySelectorAll("[data-step-item]"));
        const completedSteps = new Set();
        let currentStep = 1;
        const totalSteps = panels.length;
        let supabaseUser = null;
        let profileRow = null;
        let profileComplete = false;
        let selectedPlanKey = planRadios.find((radio) => radio.checked)?.value || null;
        let planSkipped = false;
        let checkoutRevealStarted = false;
        let checkoutRevealTimer = null;
        const paystackPlanKeys = ["core", "professional"];
        const planLabels = { core: "Core", professional: "Professional" };
        const paymentCompletion = { core: false, professional: false };
        let activePaystackPlan = null;
        const paymentContexts = {
            core: {
                container: corePaymentContainer,
                frame: corePaymentFrame,
                statusEl: corePaymentStatus,
                defaultClass: corePaymentStatusDefaultClass,
                defaultText: corePaymentStatusDefaultText,
            },
            professional: {
                container: professionalPaymentContainer,
                frame: professionalPaymentFrame,
                statusEl: professionalPaymentStatus,
                defaultClass: professionalPaymentStatusDefaultClass,
                defaultText: professionalPaymentStatusDefaultText,
            },
        };

        const revealExplorePanel = (options = {}) => {
            const { scroll = false } = options;
            if (checkoutRevealTimer) {
                window.clearTimeout(checkoutRevealTimer);
                checkoutRevealTimer = null;
            }
            if (checkoutLoader) checkoutLoader.classList.add("hidden");
            if (checkoutPanel) {
                checkoutPanel.classList.add("hidden");
                checkoutPanel.classList.remove("swap-anim");
            }
            if (checkoutReview) checkoutReview.classList.remove("hidden");
            paystackPlanKeys.forEach((planKey) => {
                const context = paymentContexts[planKey];
                if (!context) return;
                context.container?.classList.add("hidden");
                context.container?.classList.remove("swap-anim");
                resetPaymentStatus(planKey);
            });
            activePaystackPlan = null;
            if (explorePanel) {
                explorePanel.classList.remove("hidden");
                explorePanel.classList.add("swap-anim");
                if (scroll) {
                    explorePanel.scrollIntoView({ behavior: "smooth", block: "start" });
                }
            }
        };

        const resolvePlanFromSource = (source) => {
            if (!source) return null;
            return paystackPlanKeys.find((planKey) => paymentContexts[planKey]?.frame?.contentWindow === source) || null;
        };

        const resetPaymentStatus = (planKey) => {
            const context = paymentContexts[planKey];
            if (!context?.statusEl) return;
            context.statusEl.className = context.defaultClass;
            context.statusEl.textContent = context.defaultText;
        };

        const setPaymentStatus = (planKey, className, text) => {
            const context = paymentContexts[planKey];
            if (!context?.statusEl) return;
            context.statusEl.className = className;
            context.statusEl.textContent = text;
        };

        const markPaymentFailure = (planKey) => {
            paymentCompletion[planKey] = false;
            setPaymentStatus(planKey, "mt-3 text-xs text-red-500", "Payment wasn't completed. Please try again above.");
            banner("Payment wasn't completed. Please try again.", "err");
        };

        const markPaymentUpdating = (planKey) => {
            setPaymentStatus(planKey, "mt-3 text-xs font-semibold text-[var(--olive)]", "Payment confirmed. Updating your profile…");
        };

        const markPaymentAdvance = (planKey, message) => {
            setPaymentStatus(planKey, "mt-3 text-xs font-semibold text-[var(--olive)]", message);
        };

        const planSuccessMessage = (planKey, { includeNext = false } = {}) => {
            const label = planLabels[planKey] || planKey;
            return includeNext
                ? `Payment confirmed — your profile is now on the ${label} plan. Taking you to what's next…`
                : `Payment confirmed — your profile is now on the ${label} plan.`;
        };

        const planErrorMessage = () => "We received a success signal but could not update your plan. Please try again or contact support.";

        const successBannerMessage = (planKey) => {
            const label = planLabels[planKey] || planKey;
            return `${label} plan activated successfully.`;
        };

        const handleSuccessfulPayment = async (planKey) => {
            paymentCompletion[planKey] = true;
            paystackPlanKeys.forEach((key) => {
                if (key !== planKey) paymentCompletion[key] = false;
            });
            markPaymentUpdating(planKey);

            try {
                await updateProfilePlan(planKey);
                paystackPlanKeys.forEach((key) => {
                    paymentCompletion[key] = profileRow?.plan === key;
                });
                markPaymentAdvance(planKey, planSuccessMessage(planKey, { includeNext: true }));
                banner(successBannerMessage(planKey), "ok");
                window.setTimeout(() => {
                    revealExplorePanel({ scroll: true });
                }, 1200);
            } catch (error) {
                console.error(error);
                paymentCompletion[planKey] = false;
                setPaymentStatus(planKey, "mt-3 text-xs text-red-500", error.message || planErrorMessage());
                banner(error.message || "Could not update plan after payment.", "err");
            }
        };

        const formatNextCharge = (monthOffset = 1) => {
            const base = new Date();
            base.setDate(1);
            base.setHours(0, 0, 0, 0);
            base.setMonth(base.getMonth() + Math.max(1, Number(monthOffset) || 1));
            return new Intl.DateTimeFormat("en-US", { month: "long", day: "numeric", year: "numeric" }).format(base);
        };

        const PAYSTACK_ORIGINS = [/^https:\/\/([a-z0-9-]+\.)*paystack\.shop$/i, /^https:\/\/([a-z0-9-]+\.)*paystack\.com$/i];
        const isPaystackOrigin = (origin) => typeof origin === "string" && PAYSTACK_ORIGINS.some((regex) => regex.test(origin));

        const coerceMessagePayload = (payload) => {
            if (typeof payload === "string") {
                const trimmed = payload.trim();
                if (!trimmed) return trimmed;
                try {
                    return JSON.parse(trimmed);
                } catch (error) {
                    return trimmed;
                }
            }
            return payload;
        };

        const containsAnyToken = (value, tokens) => {
            if (value == null) return false;
            const lower = String(value).toLowerCase();
            return tokens.some((token) => lower.includes(token));
        };

        const isSuccessfulPaymentPayload = (payload) => {
            if (!payload) return false;
            const successTokens = ["success", "completed", "paid", "approved"];
            if (typeof payload === "string") {
                return containsAnyToken(payload, successTokens);
            }
            if (typeof payload === "object") {
                return [
                    payload.event,
                    payload.type,
                    payload.action,
                    payload.status,
                    payload.state,
                    payload.message,
                    payload.reason,
                    payload.data?.status,
                    payload.data?.message,
                ].some((value) => containsAnyToken(value, successTokens));
            }
            return false;
        };

        const isFailedPaymentPayload = (payload) => {
            if (!payload) return false;
            const failureTokens = [
                "fail",
                "error",
                "declin",
                "cancel",
                "close",
                "abort",
                "reject",
                "timeout",
                "expired",
            ];
            if (typeof payload === "string") {
                return containsAnyToken(payload, failureTokens);
            }
            if (typeof payload === "object") {
                return [
                    payload.event,
                    payload.type,
                    payload.action,
                    payload.status,
                    payload.state,
                    payload.message,
                    payload.reason,
                    payload.data?.status,
                    payload.data?.message,
                ].some((value) => containsAnyToken(value, failureTokens));
            }
            return false;
        };

        const planDetails = {
            core: {
                badge: "Core plan",
                title: "AlgoHive Core subscription",
                subtitle: "R450 billed monthly",
                price: "R450.00",
                dueToday: "R450.00",
                renewal: "1 × every month",
                nextChargeOffset: 1,
                perks: [
                    "Funds * (CIS)",
                    "Unsecured Lending",
                    "AlgoPay — credit facilitation, rewards & payments",
                    "Up to 6 strategies",
                ],
            },
            professional: {
                badge: "Professional plan",
                title: "AlgoHive Professional subscription",
                subtitle: "R899 billed monthly",
                price: "R899.00",
                dueToday: "R899.00",
                renewal: "1 × every month",
                nextChargeOffset: 1,
                perks: [
                    "Open Strategies * up to 10",
                    "Managed V.A.S.T *",
                    "Self-Managed V.A.S.T",
                    "Funds * (CIS)",
                    "Investment Backed Lending & unsecured",
                    "AlgoPay — credit facilitation, rewards & payments",
                ],
            },
        };

        const updateCheckout = (planKey, options = {}) => {
            const { scroll = true } = options;
            const detail = planDetails[planKey];
            if (!detail) return;

            const showPaystackFrame = paystackPlanKeys.includes(planKey);
            const showCoreFrame = planKey === "core";
            const showProfessionalFrame = planKey === "professional";
            activePaystackPlan = showPaystackFrame ? planKey : null;

            if (checkoutBadge) checkoutBadge.textContent = detail.badge;
            if (checkoutTitle) checkoutTitle.textContent = detail.title;
            if (checkoutSubtitle) checkoutSubtitle.textContent = detail.subtitle;
            if (checkoutPrice) checkoutPrice.textContent = detail.price;
            if (checkoutPerksList) {
                checkoutPerksList.innerHTML = "";
                if (Array.isArray(detail.perks)) {
                    detail.perks.forEach((perk) => {
                        const li = document.createElement("li");
                        li.className = "flex items-start gap-2";
                        li.innerHTML =
                            '<svg class="mt-0.5 h-4 w-4 flex-shrink-0 text-[var(--olive)]" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 6L8.5 14L4 9.5" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"/></svg>' +
                            `<span>${perk}</span>`;
                        checkoutPerksList.appendChild(li);
                    });
                }
            }
            if (checkoutDueToday) checkoutDueToday.textContent = detail.dueToday;
            if (checkoutRenewal) checkoutRenewal.textContent = detail.renewal;
            if (checkoutNextCharge) checkoutNextCharge.textContent = formatNextCharge(detail.nextChargeOffset);

            paystackPlanKeys.forEach((key) => {
                const context = paymentContexts[key];
                if (!context) return;
                const { container, statusEl, defaultClass, defaultText } = context;
                const isTarget = planKey === key;

                if (container) {
                    container.classList.toggle("hidden", !isTarget);
                    if (isTarget) {
                        container.classList.add("swap-anim");
                    } else {
                        container.classList.remove("swap-anim");
                    }
                }

                if (statusEl) {
                    if (isTarget) {
                        const alreadyOnPlan = paymentCompletion[key] || profileRow?.plan === key;
                        if (alreadyOnPlan) {
                            paymentCompletion[key] = true;
                            statusEl.className = "mt-3 text-xs font-semibold text-[var(--olive)]";
                            statusEl.textContent = planSuccessMessage(key);
                        } else {
                            resetPaymentStatus(key);
                        }
                    } else {
                        resetPaymentStatus(key);
                    }
                }
            });

            if (checkoutPanel) {
                checkoutPanel.classList.toggle("hidden", showPaystackFrame);
                checkoutPanel.classList.toggle("swap-anim", !showPaystackFrame);
                if (showPaystackFrame) checkoutPanel.classList.remove("swap-anim");
            }

            if (checkoutReview) {
                checkoutReview.classList.toggle("hidden", showPaystackFrame);
            }

            if (explorePanel && !explorePanel.classList.contains("hidden")) {
                explorePanel.classList.add("hidden");
                explorePanel.classList.remove("swap-anim");
            }

            const scrollTarget = showCoreFrame
                ? corePaymentContainer
                : showProfessionalFrame
                    ? professionalPaymentContainer
                    : checkoutPanel;
            if (scroll) {
                scrollTarget?.scrollIntoView({ behavior: "smooth", block: "start" });
            }
        };

        const beginCheckoutReveal = () => {
            if (checkoutRevealStarted) return;
            checkoutRevealStarted = true;

            if (checkoutLoader) checkoutLoader.classList.remove("hidden");
            checkoutPanel?.classList.add("hidden");
            checkoutPanel?.classList.remove("swap-anim");
            paystackPlanKeys.forEach((planKey) => {
                const context = paymentContexts[planKey];
                if (!context) return;
                context.container?.classList.add("hidden");
                context.container?.classList.remove("swap-anim");
                resetPaymentStatus(planKey);
            });
            if (explorePanel) explorePanel.classList.add("hidden");
            explorePanel?.classList.remove("swap-anim");

            checkoutRevealTimer = window.setTimeout(() => {
                if (checkoutLoader) checkoutLoader.classList.add("hidden");

                if (planSkipped || !selectedPlanKey) {
                    revealExplorePanel({ scroll: false });
                    return;
                }

                updateCheckout(selectedPlanKey, { scroll: false });
            }, 5000);
        };

        if (onboardingComplete && !onboardingComplete.classList.contains("hidden")) {
            if (onboardingIntro) onboardingIntro.classList.add("hidden");
            if (stepSummary) stepSummary.classList.add("hidden");
            beginCheckoutReveal();
        }

        function syncStepIndicators() {
            stepItems.forEach((item) => {
                const index = Number(item.dataset.stepItem);
                if (!index) return;
                const circle = item.querySelector(`[data-step-indicator="${index}"]`);
                const isActive = currentStep === index;
                const isComplete = completedSteps.has(index);
                item.classList.toggle("step-item--active", isActive && !isComplete);
                item.classList.toggle("step-item--complete", isComplete);
                if (circle) {
                    circle.textContent = isComplete ? "✓" : String(index);
                }
            });
        }

        function autoCompleteStepsFromProfile(row) {
            const ensureStepFields = (step) => {
                const keys = STEP_FIELD_GROUPS[step];
                if (!keys || !keys.length) return false;
                return keys.every((key) => {
                    if (key === OBJECTIVES_FIELD_KEY) return hasValue(row?.objectives);
                    return hasValue(row?.[key]);
                });
            };

            if (ensureStepFields(1)) completedSteps.add(1);
            if (ensureStepFields(2)) completedSteps.add(2);
            if (row && row.pep) completedSteps.add(3);
            if (kycDone) completedSteps.add(4);
        }

        const activateStep = (step) => {
            const nextValue = Math.min(Math.max(step, 1), totalSteps);
            currentStep = nextValue;

            panels.forEach((panel) => {
                const panelStep = Number(panel.dataset.panel);
                const isActive = panelStep === nextValue;
                panel.classList.toggle("hidden", !isActive);
                panel.setAttribute("aria-hidden", String(!isActive));
            });

            const meta = stepMeta[nextValue];
            if (meta) {
                if (stepLabel) stepLabel.textContent = meta.label;
                if (stepTitle) stepTitle.textContent = meta.title;
            }

            syncStepIndicators();
        };

        document.querySelectorAll("[data-step-delta]").forEach((button) => {
            if (button.hasAttribute("data-save-profile")) return;
            button.addEventListener("click", () => {
                const delta = Number(button.dataset.stepDelta ?? 0);
                if (Number.isNaN(delta)) return;
                activateStep(currentStep + delta);
            });
        });

        document.querySelectorAll("[data-step-target]").forEach((button) => {
            button.addEventListener("click", () => {
                const target = Number(button.dataset.stepTarget ?? currentStep);
                if (Number.isNaN(target)) return;
                activateStep(target);
            });
        });

        if (samsubStartButton) {
            samsubStartButton.addEventListener("click", startSamsubVerification);
        }

        if (samsubCheckButton) {
            samsubCheckButton.addEventListener("click", () => {
                checkSamsubStatus({ silent: false });
            });
        }

        if (samsubCopyLinkButton) {
            samsubCopyLinkButton.addEventListener("click", async () => {
                if (!samsubVerificationUrl) {
                    banner("Generate a verification link first.", "warn");
                    return;
                }
                try {
                    await navigator.clipboard.writeText(samsubVerificationUrl);
                    banner("Verification link copied to your clipboard.", "ok");
                } catch (error) {
                    console.error(error);
                    banner("Copy failed. You can copy it manually from the button above.", "warn");
                }
            });
        }

        panelForms.forEach((form) => {
            form.addEventListener("submit", (event) => {
                event.preventDefault();
            });
        });

        const BLANK_AVATAR = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='100%' height='100%' fill='%23e2e8f0'/></svg>";
        const avatarPreview = document.getElementById("avatar-preview");
        const avatarFile = document.getElementById("avatar-file");
        const avatarRemove = document.getElementById("remove-avatar");
        const avatarFilename = document.getElementById("avatar-filename");

        function setAvatarSrc(url) {
            const finalUrl = url ? `${url}${url.includes("?") ? "&" : "?"}v=${Date.now()}` : BLANK_AVATAR;
            if (avatarPreview) avatarPreview.src = finalUrl;
        }

        function setAvatarFilename(text) {
            if (avatarFilename) avatarFilename.textContent = text;
        }

        function getRequiredFieldsUpTo(step) {
            const out = new Set();
            for (let s = 1; s <= step; s += 1) {
                const fields = STEP_FIELD_GROUPS[s];
                if (!fields) continue;
                fields.forEach((key) => out.add(key));
            }
            return Array.from(out);
        }

        function validateProfile(step) {
            clearFieldErrors();
            const requiredKeys = getRequiredFieldsUpTo(step);
            const missing = [];
            requiredKeys.forEach((key) => {
                if (key === OBJECTIVES_FIELD_KEY) {
                    if (!syncObjectivesHighlight()) missing.push(key);
                    return;
                }
                const el = document.getElementById(key);
                if (!el) return;
                if (!hasValue(el.value)) {
                    el.classList.add("input-error");
                    missing.push(key);
                }
            });
            if (step >= totalSteps) {
                const hasPlan = planRadios.some((radio) => radio.checked);
                const requirePlan = !planSkipped;
                setPlanGroupError(requirePlan && !hasPlan);
                if (requirePlan && !hasPlan) missing.push("plan");
            } else {
                setPlanGroupError(false);
            }
            return missing;
        }

        function focusFirstMissing(missingKeys) {
            if (!missingKeys.length) return;
            const firstKey = missingKeys[0];
            if (firstKey === OBJECTIVES_FIELD_KEY) {
                objectivesGroup?.scrollIntoView({ behavior: "smooth", block: "center" });
                const firstCb = objectivesGroup?.querySelector('input[name="objectives"]');
                firstCb?.focus();
            } else if (firstKey === "plan") {
                planGroup?.scrollIntoView({ behavior: "smooth", block: "center" });
                const firstPlan = planRadios[0];
                firstPlan?.focus();
            } else {
                const el = document.getElementById(firstKey);
                if (el) {
                    el.scrollIntoView({ behavior: "smooth", block: "center" });
                    if (el instanceof HTMLElement) el.focus();
                }
            }
        }

        function setBusy(button, on) {
            if (!button) return;
            if (!button.dataset.originalText) button.dataset.originalText = button.textContent.trim();
            const savingText = button.dataset.savingText || "Saving…";
            button.disabled = on;
            button.classList.toggle("opacity-70", on);
            button.textContent = on ? savingText : button.dataset.originalText;
        }

        async function ensureProfile(userId, email) {
            let { data, error } = await supabase.from("profiles").select("*").eq("id", userId).maybeSingle();
            if (error && error.code !== "PGRST116") throw error;
            if (data) return data;
            const up = await supabase
                .from("profiles")
                .upsert({ id: userId, email, updated_at: new Date().toISOString() }, { onConflict: "id" })
                .select("*")
                .single();
            if (up.error) throw up.error;
            return up.data;
        }

        function resolveKycBoolean(row) {
            const v = row?.kyc_status;
            if (typeof v === "boolean") return v;
            if (typeof v === "string") return ["verified", "approved", "done", "passed", "kyc_done"].includes(v.toLowerCase());
            return false;
        }

        function setFieldValue(id, value) {
            const el = document.getElementById(id);
            if (!el) return;
            if (el instanceof HTMLInputElement || el instanceof HTMLSelectElement || el instanceof HTMLTextAreaElement) {
                el.value = value ?? "";
            }
        }

        function hydrateObjectives(csv) {
            const set = new Set(
                (csv || "")
                    .split(",")
                    .map((part) => part.trim().toLowerCase())
                    .filter(Boolean),
            );
            document.querySelectorAll('input[name="objectives"]').forEach((cb) => {
                cb.checked = set.has(cb.value.trim().toLowerCase());
            });
        }

        function collectProfilePayload() {
            if (!supabaseUser) throw new Error("Please sign in again.");
            const payload = {
                id: supabaseUser.id,
                first_name: (document.getElementById("first_name")?.value || "").trim(),
                last_name: (document.getElementById("last_name")?.value || "").trim(),
                phone: (document.getElementById("phone")?.value || "").trim(),
                dob: document.getElementById("dob")?.value || null,
                id_number: (document.getElementById("id_number")?.value || "").trim() || null,
                nationality: (document.getElementById("nationality")?.value || "").trim() || null,
                country_residence: (document.getElementById("country_residence")?.value || "").trim() || null,
                employment_status: document.getElementById("employment_status")?.value || null,
                occupation: (document.getElementById("occupation")?.value || "").trim() || null,
                employer: (document.getElementById("employer")?.value || "").trim() || null,
                income_bracket: document.getElementById("income_bracket")?.value || null,
                source_of_funds: document.getElementById("source_of_funds")?.value || null,
                net_worth_range: document.getElementById("net_worth_range")?.value || null,
                experience_level: document.getElementById("experience_level")?.value || null,
                risk_tolerance: document.getElementById("risk_tolerance")?.value || null,
                objectives: Array.from(document.querySelectorAll('input[name="objectives"]:checked'))
                    .map((cb) => cb.value)
                    .join(", "),
                pep: !!document.getElementById("pep")?.checked,
                fatca_crs: !!document.getElementById("fatca_crs")?.checked,
                updated_at: new Date().toISOString(),
            };
            return payload;
        }


        function buildKycPayload(partial = {}) {
            const allowed = new Set(["kyc_status"]);
            if (profileRow && typeof profileRow === "object") {
                Object.keys(profileRow).forEach((key) => allowed.add(key));
            }
            return Object.entries(partial || {}).reduce((acc, [key, value]) => {
                if (allowed.has(key)) acc[key] = value;
                return acc;
            }, {});
        }

        async function updateProfileKyc(partial, { silent = true } = {}) {
            if (!supabaseUser) return null;
            const filtered = buildKycPayload(partial);
            if (!Object.keys(filtered).length) return null;
            const payload = {
                id: supabaseUser.id,
                updated_at: new Date().toISOString(),
                ...filtered,
            };
            try {
                const { data, error } = await supabase
                    .from("profiles")
                    .upsert(payload, { onConflict: "id" })
                    .select("*")
                    .single();
                if (error) throw error;
                profileRow = { ...profileRow, ...data };
                if (typeof data.kyc_status !== "undefined") {
                    kycDone = resolveKycBoolean(data);
                }
                return data;
            } catch (error) {
                console.error(error);
                if (!silent) banner(error.message || "Could not update KYC status.", "err");
                return null;
            }
        }

        async function markSamsubPending(applicantId) {
            samsubApplicantId = applicantId || samsubApplicantId || null;
            kycDone = false;
            completedSteps.delete(4);
            syncStepIndicators();
            syncKycContinueButton();
            syncSamsubStartButton();
            const partial = {
                kyc_status: "pending",
                kyc_reference: samsubApplicantId,
                kyc_applicant_id: samsubApplicantId,
                kyc_external_user_id: samsubExternalUserId,
                kyc_started_at: new Date().toISOString(),
            };
            await updateProfileKyc(partial, { silent: true });
        }

        function resolveSamsubState(payload) {
            const values = [];
            const push = (value) => {
                if (value == null) return;
                if (Array.isArray(value)) {
                    value.forEach((item) => push(item));
                } else {
                    const str = String(value).trim();
                    if (str) values.push(str);
                }
            };

            push(payload?.reviewStatus);
            push(payload?.reviewResult?.reviewAnswer);
            push(payload?.reviewResult?.reviewStatus);
            push(payload?.reviewResult?.moderationComment);
            push(payload?.reviewResult?.clientComment);
            push(payload?.status);
            push(payload?.action);
            push(payload?.reason);
            push(payload?.clientComment);
            if (Array.isArray(payload?.reviewResult?.rejectLabels)) {
                push(payload.reviewResult.rejectLabels.join(" "));
            }

            const normalized = values.map((value) => value.toLowerCase());
            const includesAny = (tokens) => normalized.some((value) => tokens.some((token) => value.includes(token)));

            if (includesAny(["approved", "completed", "finished", "accepted", "verified", "green", "pass", "passed", "clear"])) {
                return { state: "completed", message: "SamSub approved your documents." };
            }

            if (includesAny(["reject", "declin", "failed", "red", "fraud", "expired"])) {
                const summary =
                    payload?.reviewResult?.moderationComment || payload?.reviewStatus || payload?.status || "Action required";
                return {
                    state: "failed",
                    message: `SamSub reported: ${summary}. Please review and try again.`,
                    banner: "SamSub needs more information to verify your identity.",
                };
            }

            const summary = payload?.reviewStatus || payload?.reviewResult?.reviewStatus || payload?.status || "Pending";
            return {
                state: "pending",
                message: `Current SamSub status: ${summary}. We'll notify you once it's complete.`,
                banner: "SamSub is still reviewing your documents.",
            };
        }

        async function markSamsubVerified(statusPayload) {
            const verifiedAt =
                statusPayload?.reviewResult?.reviewDate ||
                statusPayload?.reviewResult?.moderationDate ||
                new Date().toISOString();
            const partial = {
                kyc_status: "verified",
                kyc_reference: samsubApplicantId,
                kyc_applicant_id: samsubApplicantId,
                kyc_external_user_id: samsubExternalUserId,
                kyc_verified_at: verifiedAt,
            };
            await updateProfileKyc(partial, { silent: false });
            kycDone = true;
            completedSteps.add(4);
            syncStepIndicators();
            syncKycContinueButton();
            setSamsubStatus("completed", { showCheck: true, message: "Your identity is verified. You're all set!", lastChecked: new Date() });
            renderSamsubSteps();
            applySamsubLink(null);
            clearSamsubState();
            banner("SamSub verification complete. You're good to go!", "ok");
        }

        async function startsamsubVerification() {
            const externalUserId = "tester-1234";
            const levelName = "id-and-liveness";

            const res = await fetch('/api/samsub/kyc/init-websdk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    externalUserId,
                    levelName,
                    ttlInSecs: 1800,
                    // optional redirects:
                    // redirect: { successUrl: 'https://www.thealgohive.com/kyc/success', failUrl: 'https://www.thealgohive.com/kyc/failed' }
                })
            });
            const json = await res.json();
            if (!res.ok) throw new Error(json?.error?.message || 'Failed to get WebSDK link');

            const link = json?.data?.url;
            if (!link) throw new Error('No WebSDK URL returned');

            // open it (pick one)
            window.location.href = link;       // new page
            // OR document.getElementById('sumsub-frame').src = link; // iframe embed
        }




        async function checkSamsubStatus({ silent = false } = {}) {
            if (!supabaseUser) {
                banner("Please sign in again.", "err");
                return;
            }
            if (!samsubApplicantId) {
                banner("Start your SamSub verification first.", "warn");
                return;
            }

            if (samsubCheckButton) setBusy(samsubCheckButton, true);
            try {
                const response = await fetch(`/api/samsub/kyc/status/${encodeURIComponent(samsubApplicantId)}`);
                const payload = await parseJsonResponse(response, "SamSub status check");
                if (!response.ok) {
                    const message =
                        payload?.error?.message ||
                        payload?.error ||
                        payload?.description ||
                        payload?.data?.description ||
                        "Could not check SamSub status.";
                    throw new Error(message);
                }

                const statusPayload = payload && typeof payload === "object" ? payload : {};
                const interpretation = resolveSamsubState(statusPayload);
                const checkedAt = new Date();
                updateSamsubLastChecked(checkedAt);
                mergeSamsubState({
                    userId: supabaseUser.id,
                    applicantId: samsubApplicantId,
                    verificationUrl: samsubVerificationUrl,
                    lastStatus: statusPayload,
                    lastCheckedAt: checkedAt.toISOString(),
                });

                if (interpretation.state === "completed") {
                    await markSamsubVerified(statusPayload);
                    return;
                }

                if (interpretation.state === "failed") {
                    setSamsubStatus("failed", { showCheck: true, message: interpretation.message, lastChecked: checkedAt });
                    if (!silent) banner(interpretation.banner || interpretation.message, "warn");
                    return;
                }

                setSamsubStatus("pending", { showCheck: true, message: interpretation.message, lastChecked: checkedAt });
                if (!silent) banner(interpretation.banner || "SamSub is still reviewing your documents.", "warn");
            } catch (error) {
                console.error(error);
                setSamsubStatus("error", { showCheck: true, message: error.message || "Could not check SamSub status." });
                banner(error.message || "Could not check SamSub status.", "err");
            } finally {
                if (samsubCheckButton) setBusy(samsubCheckButton, false);
            }
        }

        function determineInitialStep(row) {
            for (let step = 1; step <= totalSteps; step += 1) {
                const fields = STEP_FIELD_GROUPS[step];
                if (!fields) continue;
                for (const key of fields) {
                    if (key === OBJECTIVES_FIELD_KEY) {
                        if (!hasValue(row?.objectives)) return step;
                    } else if (!hasValue(row?.[key])) {
                        return step;
                    }
                }
            }
            if (!resolveKycBoolean(row)) return 4;
            return totalSteps;
        }

        async function updateProfilePlan(planKey) {
            if (!supabaseUser) throw new Error("Please sign in again.");
            const { data, error } = await supabase
                .from("profiles")
                .upsert({ id: supabaseUser.id, plan: planKey, updated_at: new Date().toISOString() }, { onConflict: "id" })
                .select("*")
                .single();
            if (error) throw error;
            profileRow = { ...profileRow, ...data };
            return data;
        }

        async function persistProfile(button) {
            if (!supabaseUser) {
                banner("Please sign in again.", "err");
                return false;
            }
            setBusy(button, true);
            try {
                const payload = collectProfilePayload();
                const { data: saved, error } = await supabase
                    .from("profiles")
                    .upsert(payload, { onConflict: "id" })
                    .select("*")
                    .single();

                if (error) throw error;

                profileRow = { ...profileRow, ...saved };
                profileComplete = computeProfileComplete(saved);
                if (typeof saved.kyc_status !== "undefined") {
                    kycDone = resolveKycBoolean(saved);
                }

                autoCompleteStepsFromProfile(profileRow);

                banner("Profile saved successfully.", "ok");
                document.dispatchEvent(new Event("ah:profile-saved"));
                return true;
            } catch (error) {
                console.error(error);
                banner(error.message || "Save failed", "err");
                return false;
            } finally {
                setBusy(button, false);
            }
        }

        const AVATAR_BUCKET = "avatars";

        async function uploadAvatar(file) {
            if (!supabaseUser) throw new Error("Please sign in again.");
            if (!file) throw new Error("Pick an image");
            if (!file.type.startsWith("image/")) throw new Error("Pick a valid image");
            if (file.size > 2 * 1024 * 1024) throw new Error("Image too large (max 2MB)");

            setAvatarSrc(URL.createObjectURL(file));

            const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
            const path = `${supabaseUser.id}/avatar_${Date.now()}.${ext}`;

            const { error: upErr } = await supabase.storage.from(AVATAR_BUCKET).upload(path, file, {
                upsert: true,
                cacheControl: "3600",
                contentType: file.type,
            });
            if (upErr) throw upErr;

            const { data: pub } = supabase.storage.from(AVATAR_BUCKET).getPublicUrl(path);
            const avatar_url = pub?.publicUrl;
            if (!avatar_url) throw new Error("Could not get public URL");

            const { error: dbErr } = await supabase
                .from("profiles")
                .upsert({ id: supabaseUser.id, avatar_url, updated_at: new Date().toISOString() }, { onConflict: "id" });
            if (dbErr) throw dbErr;

            profileRow = { ...profileRow, avatar_url };
            setAvatarSrc(avatar_url);
            avatarRemove?.classList.remove("hidden");
            setAvatarFilename(file.name);
            banner("Avatar updated successfully.", "ok");
        }

        avatarFile?.addEventListener("change", async () => {
            const file = avatarFile.files?.[0];
            if (!file) return;
            try {
                await uploadAvatar(file);
            } catch (error) {
                console.error(error);
                banner(error.message || "Avatar upload failed", "err");
                setAvatarSrc(profileRow?.avatar_url || null);
                setAvatarFilename(profileRow?.avatar_url ? "Avatar on file" : "No file chosen");
            } finally {
                avatarFile.value = "";
            }
        });

        avatarRemove?.addEventListener("click", async () => {
            if (!supabaseUser) {
                banner("Please sign in again.", "err");
                return;
            }
            try {
                const { error } = await supabase
                    .from("profiles")
                    .upsert({ id: supabaseUser.id, avatar_url: null, updated_at: new Date().toISOString() }, { onConflict: "id" });
                if (error) throw error;
                profileRow = { ...profileRow, avatar_url: null };
                setAvatarSrc(null);
                setAvatarFilename("No file chosen");
                avatarRemove.classList.add("hidden");
                banner("Avatar removed", "ok");
            } catch (error) {
                console.error(error);
                banner(error.message || "Could not remove avatar", "err");
            }
        });

        window.addEventListener("message", async (event) => {
            if (!isPaystackOrigin(event.origin)) return;

            const planKey = resolvePlanFromSource(event.source) || activePaystackPlan;
            if (!planKey || !paystackPlanKeys.includes(planKey)) return;

            const payload = coerceMessagePayload(event.data);
            if (!payload || paymentCompletion[planKey]) return;

            if (isFailedPaymentPayload(payload)) {
                markPaymentFailure(planKey);
                return;
            }

            if (!isSuccessfulPaymentPayload(payload)) return;

            await handleSuccessfulPayment(planKey);
        });

        window.addEventListener("message", async (event) => {
            if (event.origin !== window.location.origin) return;

            const payload = coerceMessagePayload(event.data);
            if (!payload || typeof payload !== "object") return;
            if (payload.source !== "algohive-paystack-success" || payload.status !== "success") return;

            const planKey = resolvePlanFromSource(event.source) || activePaystackPlan;
            if (!planKey || paymentCompletion[planKey]) return;

            await handleSuccessfulPayment(planKey);
        });

        document.querySelectorAll("[data-save-profile]").forEach((button) => {
            button.addEventListener("click", async () => {
                const validationStep = button.hasAttribute("data-complete") ? totalSteps : currentStep;
                const missing = validateProfile(validationStep);
                if (missing.length) {
                    focusFirstMissing(missing);
                    banner("Please fill in the highlighted fields.", "err");
                    return;
                }

                const saved = await persistProfile(button);
                if (!saved) return;

                if (currentStep === 4 && !kycDone) {
                    banner("Complete your SamSub verification before continuing.", "warn");
                    syncKycContinueButton();
                    return;
                }

                completedSteps.add(currentStep);

                if (button.hasAttribute("data-complete")) {
                    for (let step = 1; step <= totalSteps; step += 1) {
                        completedSteps.add(step);
                    }
                    syncStepIndicators();
                    button.disabled = true;
                    button.textContent = "All steps saved";
                    button.classList.add("opacity-80");
                    if (onboardingFlow) onboardingFlow.classList.add("hidden");
                    if (onboardingIntro) onboardingIntro.classList.add("hidden");
                    if (stepSummary) stepSummary.classList.add("hidden");
                    if (onboardingComplete) {
                        onboardingComplete.classList.remove("hidden");
                        onboardingComplete.classList.add("swap-anim");
                        beginCheckoutReveal();
                    }
                    if (stepLabel) stepLabel.textContent = "";
                    if (stepTitle) stepTitle.textContent = "";
                    banner("Onboarding complete.", "ok");
                    return;
                }

                const delta = Number(button.dataset.stepDelta ?? 0);
                if (!Number.isNaN(delta) && delta !== 0) {
                    activateStep(currentStep + delta);
                    return;
                }

                syncStepIndicators();
            });
        });

        activateStep(1);

        (async () => {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    const next = encodeURIComponent(location.pathname + location.search + location.hash);
                    location.replace(`/auth.html?tab=in&redirect=${next}`);
                    return;
                }

                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    const next = encodeURIComponent(location.pathname + location.search + location.hash);
                    location.replace(`/auth.html?tab=in&redirect=${next}`);
                    return;
                }

                supabaseUser = user;
                const row = await ensureProfile(user.id, user.email || null);
                profileRow = row;
                paystackPlanKeys.forEach((planKey) => {
                    paymentCompletion[planKey] = row?.plan === planKey;
                });

                setFieldValue("first_name", row?.first_name);
                setFieldValue("last_name", row?.last_name);
                setFieldValue("phone", row?.phone);
                setFieldValue("dob", row?.dob);
                setFieldValue("id_number", row?.id_number);
                setFieldValue("nationality", row?.nationality);
                setFieldValue("country_residence", row?.country_residence);
                setFieldValue("employment_status", row?.employment_status);
                setFieldValue("occupation", row?.occupation);
                setFieldValue("employer", row?.employer);
                setFieldValue("income_bracket", row?.income_bracket);
                setFieldValue("source_of_funds", row?.source_of_funds);
                setFieldValue("net_worth_range", row?.net_worth_range);
                setFieldValue("experience_level", row?.experience_level);
                setFieldValue("risk_tolerance", row?.risk_tolerance);

                hydrateObjectives(row?.objectives || "");
                syncObjectivesHighlight();

                const pepEl = document.getElementById("pep");
                if (pepEl) pepEl.checked = !!row?.pep;
                const fatcaEl = document.getElementById("fatca_crs");
                if (fatcaEl) fatcaEl.checked = !!row?.fatca_crs;

                setAvatarSrc(row?.avatar_url || null);
                setAvatarFilename(row?.avatar_url ? "Avatar on file" : "No file chosen");
                avatarRemove?.classList.toggle("hidden", !row?.avatar_url);

                profileComplete = computeProfileComplete(row);
                kycDone = resolveKycBoolean(row);

                samsubExternalUserId = row?.kyc_external_user_id || user.id || null;
                let storedSamsubState = loadSamsubState();
                if (storedSamsubState?.userId && storedSamsubState.userId !== user.id) {
                    clearSamsubState();
                    storedSamsubState = null;
                }

                samsubApplicantId = row?.kyc_reference || row?.kyc_applicant_id || storedSamsubState?.applicantId || null;
                const hasStoredLink = storedSamsubState?.verificationUrl && !kycDone;
                if (hasStoredLink && (!storedSamsubState?.applicantId || storedSamsubState.applicantId === samsubApplicantId)) {
                    applySamsubLink(storedSamsubState.verificationUrl, { message: samsubLinkMessageDefault });
                } else {
                    applySamsubLink(null);
                }

                if (storedSamsubState?.instructions) {
                    renderSamsubSteps(storedSamsubState.instructions);
                } else {
                    renderSamsubSteps();
                }

                if (storedSamsubState?.lastCheckedAt) {
                    updateSamsubLastChecked(new Date(storedSamsubState.lastCheckedAt));
                } else {
                    updateSamsubLastChecked(null);
                }

                if (kycDone) {
                    setSamsubStatus("completed", {
                        showCheck: true,
                        preserveLastChecked: true,
                        lastChecked: storedSamsubState?.lastCheckedAt ? new Date(storedSamsubState.lastCheckedAt) : undefined,
                    });
                    clearSamsubState();
                } else if (typeof row?.kyc_status === "string" && row.kyc_status.toLowerCase() === "pending") {
                    setSamsubStatus("pending", {
                        showCheck: !!samsubApplicantId,
                        preserveLastChecked: true,
                        message: "SamSub is reviewing your documents.",
                    });
                } else if (samsubApplicantId && hasStoredLink) {
                    setSamsubStatus("link_ready", {
                        showCheck: true,
                        preserveLastChecked: true,
                        message: "We saved your SamSub link. Complete the verification to continue.",
                    });
                } else if (samsubApplicantId) {
                    setSamsubStatus("pending", {
                        showCheck: true,
                        preserveLastChecked: true,
                        message: "SamSub is reviewing your documents.",
                    });
                } else {
                    setSamsubStatus("idle", { preserveLastChecked: true });
                }

                syncSamsubStartButton();
                syncKycContinueButton();

                autoCompleteStepsFromProfile(profileRow);

                const initialStep = determineInitialStep(row);
                for (let step = 1; step < initialStep; step += 1) {
                    completedSteps.add(step);
                }

                activateStep(initialStep);
            } catch (error) {
                console.error(error);
                banner(error.message || "Could not load your profile.", "err");
            }
        })();
    </script>
    <!-- Put this once (allowed by your CSP) -->
    <script src="https://static.sumsub.com/idensic/static/sumsub-kyc.js" nonce="ALGOHIVE"></script>
    <div id="sumsub-sdk" style="display:none;"></div>

    <!-- add once; your CSP must allow this script host (see note below) -->
    <script src="https://web.sumsub.com/idensic/static/sumsub-kyc.js" nonce="ALGOHIVE"></script>


</body>

</html>
