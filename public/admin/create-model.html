<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AlgoHive – Create Model</title>

  <script src="https://cdn.tailwindcss.com" nonce="ALGOHIVE"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    :root {
      --bg: #fff;
      --line: #e2e8f0;
      --ink: #0f172a;
      --olive: #556B2F;
    }

    html,
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink)
    }

    .card {
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 12px
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .5rem;
      height: 40px;
      padding: 0 .875rem;
      border-radius: 10px;
      border: 1px solid var(--line);
      font-weight: 600
    }

    .input {
      height: 40px;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 0 .75rem
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="bg-slate-50/70 border-b border-slate-200">
    <div class="max-w-5xl mx-auto px-4 py-6 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <span class="h-10 w-10 rounded-xl bg-amber-100 text-amber-700 flex items-center justify-center text-xl font-bold shadow-sm">A</span>
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">Admin</p>
          <h1 class="text-2xl font-bold">Create Model</h1>
          <p class="text-sm text-slate-500">Add a new strategy to the library and seed its metrics.</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <a href="/admin/models.html" class="btn bg-white hover:bg-slate-50"><i class="fa-solid fa-arrow-left"></i>Back to models</a>
      </div>
    </div>
  </div>

  <main class="max-w-5xl mx-auto px-4 py-8">
    <div class="card p-6 shadow-sm">
      <div class="flex items-start justify-between gap-4 pb-4 border-b border-slate-200 mb-6">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">New entry</p>
          <h2 class="text-xl font-semibold">Strategy &amp; metrics</h2>
          <p class="text-sm text-slate-500">All fields map directly to Supabase <code>strategies</code> and <code>strategy_metrics</code>.</p>
        </div>
        <span id="status-chip" class="text-xs font-semibold text-slate-500"></span>
      </div>

      <form id="create-form" class="space-y-6">
        <div class="grid md:grid-cols-2 gap-4">
          <label class="flex flex-col gap-1 text-sm font-medium text-slate-700">Name
            <input required name="name" class="input w-full" placeholder="Strategy name" />
          </label>
          <label class="flex flex-col gap-1 text-sm font-medium text-slate-700">Currency
            <input required name="currency" class="input w-full" placeholder="USD" />
          </label>
          <label class="flex flex-col gap-1 text-sm font-medium text-slate-700">Risk level
            <input name="risk_level" class="input w-full" placeholder="Conservative / Balanced / Aggressive" />
          </label>
          <label class="flex flex-col gap-1 text-sm font-medium text-slate-700">Risk score
            <input name="risk_score" class="input w-full" placeholder="e.g. 4" />
          </label>
        </div>

        <label class="flex flex-col gap-1 text-sm font-medium text-slate-700">Description
          <textarea name="strategy_description" class="input w-full h-20 resize-none" placeholder="Short description of the strategy"></textarea>
        </label>

        <div class="grid md:grid-cols-3 gap-4">
          <label class="flex flex-col gap-1 text-sm font-medium text-slate-700">Code
            <input name="code" class="input w-full" placeholder="Unique code" />
          </label>
          <label class="flex flex-col gap-1 text-sm font-medium text-slate-700">Style
            <input name="style" class="input w-full" placeholder="Quant / Discretionary" />
          </label>
          <label class="flex flex-col gap-1 text-sm font-medium text-slate-700">Asset universe
            <input name="asset_universe" class="input w-full" placeholder="FX / Equities" />
          </label>
        </div>

        <div class="grid md:grid-cols-3 gap-4">
          <label class="flex flex-col gap-1 text-sm font-medium text-slate-700">Avg. holding period (days)
            <input name="avg_holding_days" type="number" min="0" class="input w-full" placeholder="e.g. 10" />
          </label>
          <label class="flex flex-col gap-1 text-sm font-medium text-slate-700">Avg. trades per month
            <input name="avg_trades_per_month" type="number" min="0" class="input w-full" placeholder="e.g. 25" />
          </label>
          <label class="flex flex-col gap-1 text-sm font-medium text-slate-700">Total units
            <input name="total_units" type="number" min="0" class="input w-full" placeholder="e.g. 100" />
          </label>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <label class="flex flex-col gap-1 text-sm font-medium text-slate-700">Data source
            <select name="data_source" class="input w-full">
              <option value="Massive">Massive (default)</option>
              <option value="Alpaca">Alpaca</option>
              <option value="JSE">JSE</option>
            </select>
          </label>
          <div></div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <label class="flex flex-col gap-1 text-sm font-medium text-slate-700">Holdings (JSON array)
            <textarea name="portfolio_holdings" class="input w-full h-24 resize-none" placeholder='[{"symbol":"AAPL","weight":0.2}]'></textarea>
          </label>
          <label class="flex flex-col gap-1 text-sm font-medium text-slate-700">Asset allocation (JSON array)
            <textarea name="asset_allocation" class="input w-full h-24 resize-none" placeholder='[{"asset_class":"Equity","weight":0.6}]'></textarea>
          </label>
        </div>

        <div class="flex items-center justify-between gap-3 pt-2">
          <p id="form-status" class="text-sm text-slate-500"></p>
          <div class="flex items-center gap-2">
            <a href="/admin/models.html" class="btn bg-white hover:bg-slate-100">Cancel</a>
            <button type="submit" class="btn bg-amber-500 text-white border-transparent shadow-md hover:shadow-lg transition"><i class="fa-solid fa-floppy-disk"></i>Save model</button>
          </div>
        </div>
      </form>
    </div>
  </main>

  <script type="module" nonce="ALGOHIVE">
    import { supabase } from "/js/supabase.js";

    const form = document.getElementById('create-form');
    const formStatus = document.getElementById('form-status');
    const statusChip = document.getElementById('status-chip');

    const redirectToAuth = () => {
      const next = encodeURIComponent(location.pathname + location.search + location.hash);
      location.replace(`/auth.html?tab=in&redirect=${next}`);
    };

    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      redirectToAuth();
      throw new Error('redirecting');
    }
    supabase.auth.onAuthStateChange((_ev, sess) => { if (!sess) redirectToAuth(); });

    const num = (v) => {
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    };

    const parseJsonArray = (text, label) => {
      if (!text || !text.trim()) return [];
      try {
        const parsed = JSON.parse(text);
        return Array.isArray(parsed) ? parsed : (() => { throw new Error(`${label} must be a JSON array`); })();
      } catch (err) {
        throw new Error(`${label} is not valid JSON`);
      }
    };

    async function createModel(event) {
      event.preventDefault();
      formStatus.textContent = 'Saving model to Supabase…';
      statusChip.textContent = '';

      const formData = new FormData(form);

      const strategyPayload = {
        name: formData.get('name')?.trim(),
        currency: formData.get('currency')?.trim() || 'USD',
        risk_level: formData.get('risk_level')?.trim() || null,
        strategy_description: formData.get('strategy_description')?.trim() || null,
        code: formData.get('code')?.trim() || null,
        style: formData.get('style')?.trim() || null,
        asset_universe: formData.get('asset_universe')?.trim() || null,
        avg_holding_days: num(formData.get('avg_holding_days')),
        avg_trades_per_month: num(formData.get('avg_trades_per_month')),
        total_units: num(formData.get('total_units')),
        risk_score: formData.get('risk_score')?.trim() || null,
        data_source: formData.get('data_source') || 'Massive'
      };

      let holdings = [];
      let allocation = [];

      try {
        holdings = parseJsonArray(formData.get('portfolio_holdings') || '', 'Holdings');
        allocation = parseJsonArray(formData.get('asset_allocation') || '', 'Asset allocation');
      } catch (err) {
        formStatus.textContent = err.message;
        statusChip.textContent = 'Fix validation errors';
        statusChip.className = 'text-xs font-semibold text-rose-600';
        return;
      }

      const { data: strategy, error: strategyError } = await supabase
        .from('strategies')
        .insert(strategyPayload)
        .select()
        .single();

      if (strategyError) {
        console.error('Failed to create strategy', strategyError);
        formStatus.textContent = 'Failed to save strategy. Please try again.';
        statusChip.textContent = 'Save failed';
        statusChip.className = 'text-xs font-semibold text-rose-600';
        return;
      }

      const { error: metricsError } = await supabase
        .from('strategy_metrics')
        .insert({
          strategy_id: strategy.id,
          portfolio_holdings: holdings,
          asset_allocation: allocation
        });

      if (metricsError) {
        console.error('Failed to create metrics', metricsError);
        formStatus.textContent = 'Strategy saved but metrics failed. Please retry metrics.';
        statusChip.textContent = 'Partial save';
        statusChip.className = 'text-xs font-semibold text-amber-600';
        return;
      }

      formStatus.textContent = 'Saved! Redirecting to models…';
      statusChip.textContent = 'Created';
      statusChip.className = 'text-xs font-semibold text-emerald-600';
      setTimeout(() => location.assign('/admin/models.html'), 900);
    }

    form.addEventListener('submit', createModel);
  </script>
</body>
</html>
