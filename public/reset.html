<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Reset password — AlgoHive</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen grid place-items-center bg-gray-50">
  <main class="w-full max-w-md bg-white p-6 rounded-2xl shadow">
    <h1 class="text-lg font-semibold">Set a new password</h1>
    <p id="note" class="mt-1 text-sm text-slate-600">Enter your new password below.</p>

    <div id="msg" class="hidden mt-3 rounded-lg border text-sm px-3 py-2"></div>

    <form id="reset-form" class="mt-4 space-y-3">
      <input name="password" type="password" placeholder="New password" class="w-full border rounded px-3 py-2" required />
      <button type="submit" class="w-full rounded px-3 py-2 bg-black text-white">Update password</button>
    </form>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const supabase = createClient("https://YOUR_PROJECT.supabase.co", "YOUR_PUBLIC_ANON_KEY", {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    const msg = document.getElementById("msg");
    function showMsg(text, type="info"){
      msg.classList.remove("hidden","bg-rose-50","text-rose-700","border-rose-200","bg-emerald-50","text-emerald-700","border-emerald-200");
      if(type==="success"){ msg.classList.add("bg-emerald-50","text-emerald-700","border-emerald-200"); }
      if(type==="error"){   msg.classList.add("bg-rose-50","text-rose-700","border-rose-200"); }
      msg.textContent = text;
    }

    // Ensure we have a recovery session (the link sets it)
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      showMsg("Recovery link invalid or expired. Click the email link again.", "error");
      document.getElementById("reset-form").classList.add("hidden");
    }

    // Handle update
    const form = document.getElementById("reset-form");
    const btn  = form.querySelector('button[type="submit"]');
    function setLoading(on){ btn.disabled = on; btn.textContent = on ? "Updating…" : "Update password"; }

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      try {
        setLoading(true);
        const password = e.target.password.value;
        const { error } = await supabase.auth.updateUser({ password });
        if (error) throw error;
        showMsg("Password updated. Redirecting…", "success");
        setTimeout(()=> location.replace("/dashboard.html"), 800);
      } catch (err){
        showMsg(err.message || "Failed to update password.", "error");
      } finally { setLoading(false); }
    });
  </script>
</body>
</html>
