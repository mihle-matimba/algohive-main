<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ozow Dynamic Payment Demo (iFrame)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #form-container { max-width: 400px; margin-bottom: 20px; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input[type="number"], input[type="text"], input[type="email"] { width: 100%; padding: 8px; margin-top: 4px; box-sizing: border-box; }
    button { padding: 10px 15px; margin-top: 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; }
    #paymentContainer { border: 1px solid #000; height: 600px; width: 100%; margin-top: 20px; display: grid; place-items: center; }
    .muted { color:#666; font-size:14px }
  </style>
</head>
<body>
  <h1>Ozow Dynamic Payment Integration</h1>

  <div id="form-container">
    <h2>Enter Payment Details</h2>

    <label for="amount">Dynamic Amount (ZAR):</label>
    <input type="number" id="amount" value="500.00" min="1.00" step="0.01"/>

    <label for="reference">Transaction Reference:</label>
    <input type="text" id="reference" value="INV-456789" maxlength="50"/>

    <label for="customer">Customer Email:</label>
    <input type="email" id="customer" value="user@example.com" maxlength="100"/>

    <button id="payUsingOzow">Pay with Ozow</button>
    <button id="cancelOzowPayment" style="background-color:#dc3545;">Cancel Payment</button>

    <p class="muted">This demo loads Ozow’s secure checkout URL returned by your backend into the iFrame below.</p>
  </div>

  <hr/>

  <h3>Ozow iFrame Loads Here:</h3>
  <div id="paymentContainer">
    <span class="muted">No payment started yet.</span>
  </div>

  <!-- jQuery only if you still want it (not required for this flow) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <script>
    const container = document.getElementById('paymentContainer');
    const btnPay    = document.getElementById('payUsingOzow');
    const btnCancel = document.getElementById('cancelOzowPayment');

    function setLoading(on=true){
      container.innerHTML = on ? '<div>Creating payment…</div>' : '<span class="muted">No payment started yet.</span>';
    }

    function loadIframe(url){
      container.innerHTML = '';
      const iframe = document.createElement('iframe');
      iframe.src = url;              // URL from /api/ozow/create (staging/live)
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframe.style.border = '0';
      container.appendChild(iframe);
    }

    btnPay.addEventListener('click', async () => {
      const amount = Number(document.getElementById('amount').value || 0);
      const reference = document.getElementById('reference').value.trim();
      const customer = document.getElementById('customer').value.trim();

      if (!amount || amount <= 0 || !reference) {
        alert('Please enter a valid amount and transaction reference.');
        return;
      }

      try {
        setLoading(true);
        // Call your Vercel function that does PostPaymentRequest + hashCheck server-side
        const resp = await fetch('/api/ozow/create', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            amount,
            customerName: customer || 'AlgoHive User',
            // optional: pass reference through so backend can use it for transactionReference/bankReference
            reference
          })
        });

        const data = await resp.json();
        if (!resp.ok || !data?.url) {
          console.error('Ozow create error:', data);
          container.innerHTML = `<div style="color:#b91c1c">Failed to create payment: ${data?.error || 'Unknown error'}</div>`;
          return;
        }

        // Load Ozow checkout URL inside the iFrame
        window.location.href = data.url; 
      } catch (err) {
        console.error(err);
        container.innerHTML = `<div style="color:#b91c1c">Unexpected error. Check console.</div>`;
      }
    });

    btnCancel.addEventListener('click', () => {
      // Just clear/replace the iFrame area (there’s nothing to “cancel” client-side for the REST URL)
      container.innerHTML = '<h2>Payment was Cancelled.</h2>';
    });

    // Optional: listen for messages if you implement postMessage on your success/error pages
    window.addEventListener('message', (e) => {
      // e.g., if your success page posts a message when done
      // console.log('Message from iframe:', e.data);
    });
  </script>
</body>
</html>
