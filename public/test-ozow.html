<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ozow Dynamic Payment Demo</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #form-container { max-width: 420px; margin-bottom: 20px; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input[type="number"], input[type="text"], input[type="email"] { width: 100%; padding: 8px; margin-top: 4px; box-sizing: border-box; }
    button { padding: 10px 15px; margin-top: 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .muted { color:#666; font-size:14px }
    .error { color:#b91c1c; }
    .ok { color:#047857; }
  </style>
</head>
<body>
  <h1>Ozow Dynamic Payment Integration</h1>

  <div id="form-container">
    <h2>Enter Payment Details</h2>

    <label for="amount">Dynamic Amount (ZAR):</label>
    <input type="number" id="amount" value="500.00" min="1.00" step="0.01"/>

    <label for="reference">Transaction Reference:</label>
    <input type="text" id="reference" value="INV-456789" maxlength="50"/>

    <label for="customer">Customer Email (optional):</label>
    <input type="email" id="customer" value="user@example.com" maxlength="100"/>

    <button id="payUsingOzow">Pay with Ozow</button>
    <button id="cancelOzowPayment" style="background-color:#dc3545;">Cancel</button>

    <p class="muted">Click “Pay with Ozow” to create a payment server-side and redirect to Ozow’s secure checkout.</p>
    <div id="status" class="muted"></div>
  </div>

  <script>
    const btnPay    = document.getElementById('payUsingOzow');
    const btnCancel = document.getElementById('cancelOzowPayment');
    const statusEl  = document.getElementById('status');

    function setStatus(msg, cls = 'muted') {
      statusEl.className = cls;
      statusEl.textContent = msg;
    }

    async function createPayment(amount, reference, customerEmail) {
      const resp = await fetch('/api/ozow/create', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          amount,
          reference,
          customerName: customerEmail || 'AlgoHive User'
        })
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || !data?.url) {
        const err = data?.error || 'Unknown error';
        throw new Error(err);
      }
      return data.url;
    }

    btnPay.addEventListener('click', async () => {
      const amount = Number(document.getElementById('amount').value || 0);
      const reference = document.getElementById('reference').value.trim();
      const customer = document.getElementById('customer').value.trim();

      if (!amount || amount <= 0 || !reference) {
        setStatus('Please enter a valid amount and reference.', 'error');
        return;
      }

      try {
        btnPay.disabled = true;
        setStatus('Creating payment link…');
        const redirectUrl = await createPayment(amount, reference, customer);
        setStatus('Redirecting to Ozow…', 'ok');
        window.location.href = redirectUrl; // safest flow
      } catch (e) {
        console.error(e);
        setStatus(`Failed to create payment: ${e.message}`, 'error');
        btnPay.disabled = false;
      }
    });

    btnCancel.addEventListener('click', () => {
      // Just clear the UI / reset fields
      document.getElementById('amount').value = '500.00';
      document.getElementById('reference').value = 'INV-456789';
      setStatus('Cancelled. Nothing was created.');
      btnPay.disabled = false;
    });
  </script>
</body>
</html>
