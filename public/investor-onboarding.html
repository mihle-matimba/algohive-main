<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Investor Onboarding | AlgoHive</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com" nonce="ALGOHIVE"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <!-- Leaflet (CSP-allowed via cdnjs) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js" defer></script>

  <!-- Confetti -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/canvas-confetti/1.9.3/confetti.browser.min.js" defer></script>

  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --olive:#7e8d52; --brand:#f59e0b; --line:#e2e8f0; --panel:#ffffff; --bg:#f8fafc;
    }
    html,body{ background:var(--bg); color:var(--ink) }
    .card{ background:var(--panel); border:1px solid var(--line); border-radius:16px; box-shadow:0 10px 30px rgba(2,12,27,0.06) }
    .btn-olive{ background:var(--olive); color:#fff }
    .btn-olive:hover{ filter:brightness(.95) }
    .muted{ color:var(--muted) }
    .step-dot{ width:28px; height:28px; border-radius:999px; display:grid; place-items:center; font-weight:700; border:1px solid var(--line); background:#fff; color:var(--muted) }
    .step-dot.active{ background:var(--olive); color:#fff; border-color:var(--olive) }
    .divider{ height:1px; background:linear-gradient(90deg, transparent, var(--line), transparent) }
    .inp{ border:1px solid var(--line); border-radius:12px; padding:.65rem .9rem; width:100% }
    .inp:focus{ outline:none; border-color:var(--olive); box-shadow:0 0 0 4px rgba(126,141,82,.15) }
    .error{ border-color:#ef4444 !important }
    .tab-btn{ padding:.5rem .75rem; border-radius:10px; border:1px solid var(--line); background:#fff; font-weight:600; color:var(--muted) }
    .tab-btn.active{ color:var(--ink); border-color:var(--olive); box-shadow:0 0 0 3px rgba(126,141,82,.15) }
    #map{ height: 260px; border-radius:12px; border:1px solid var(--line) }
  </style>
</head>
<body class="min-h-screen">
  <!-- Top -->
  <header class="bg-white border-b border-[var(--line)]">
    <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img class="w-8 h-8" src="https://static.wixstatic.com/shapes/ac771e_e60a2d47ce2d4afb858cb00c0e618c9e.svg" alt="AlgoHive"/>
        <div class="font-bold">AlgoHive Investor Onboarding</div>
      </div>
      <div class="hidden sm:flex items-center gap-3 text-sm text-[var(--muted)]">
        <span>Secure</span><span>•</span><span>No hidden fees</span>
      </div>
    </div>
  </header>

  <!-- Stepper + Tabs -->
  <div class="max-w-6xl mx-auto px-4 mt-6">
    <div class="card p-4">
      <div class="flex items-center gap-2">
        <div id="s1" class="step-dot active">1</div><div class="flex-1 h-[2px] bg-[var(--line)]"></div>
        <div id="s2" class="step-dot">2</div><div class="flex-1 h-[2px] bg-[var(--line)]"></div>
        <div id="s3" class="step-dot">3</div><div class="flex-1 h-[2px] bg-[var(--line)]"></div>
        <div id="s4" class="step-dot">4</div>
      </div>
      <div class="mt-3 h-1 w-full bg-[var(--line)] rounded">
        <div id="progressBar" class="h-1 rounded bg-[var(--olive)]" style="width:25%"></div>
      </div>
      <div class="mt-4 flex gap-2">
        <button data-goto="1" class="tab-btn active">Intro</button>
        <button data-goto="2" class="tab-btn">Details</button>
        <button data-goto="3" class="tab-btn">Payment</button>
        <button data-goto="4" class="tab-btn">Complete</button>
      </div>
    </div>
  </div>

  <!-- Step 1 -->
  <section id="step1" class="max-w-6xl mx-auto px-4 mt-8">
    <div class="grid lg:grid-cols-2 gap-8 items-center">
      <div class="card p-8">
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-amber-50 border border-amber-200 text-amber-700 text-sm">
          <i class="fa-solid fa-seedling"></i> Welcome to AlgoHive
        </div>
        <h1 class="mt-4 text-4xl font-extrabold">Own a stake in the hive.</h1>
        <p class="mt-2 text-lg muted">
          Join as a shareholder and partner in our growth journey. Clean process, clear docs, bank-grade security.
        </p>
        <div class="mt-6 flex gap-3">
          <button data-next class="btn-olive rounded-xl px-6 py-3 font-semibold">Get Started <i class="fa-solid fa-arrow-right ml-2"></i></button>
          <a class="rounded-xl px-6 py-3 border border-[var(--line)]" href="#">Learn more</a>
        </div>
        <div class="mt-6 divider"></div>
        <div class="mt-4 grid grid-cols-3 gap-4 text-center">
          <div><div class="text-2xl font-bold">R0</div><div class="muted text-sm">AUM fees</div></div>
          <div><div class="text-2xl font-bold">Bank</div><div class="muted text-sm">integrations</div></div>
          <div><div class="text-2xl font-bold">24/7</div><div class="muted text-sm">Support</div></div>
        </div>
      </div>
      <div class="grid sm:grid-cols-2 gap-6">
        <div class="card p-6"><div class="w-10 h-10 rounded bg-emerald-50 text-emerald-700 grid place-items-center"><i class="fa-solid fa-shield-halved"></i></div><div class="mt-2 font-semibold">Secure Process</div><p class="muted text-sm mt-1">Bank-grade security and controls.</p></div>
        <div class="card p-6"><div class="w-10 h-10 rounded bg-blue-50 text-blue-700 grid place-items-center"><i class="fa-solid fa-chart-line"></i></div><div class="mt-2 font-semibold">Proven</div><p class="muted text-sm mt-1">Listed strategies with track records.</p></div>
        <div class="card p-6"><div class="w-10 h-10 rounded bg-purple-50 text-purple-700 grid place-items-center"><i class="fa-solid fa-headset"></i></div><div class="mt-2 font-semibold">Human Support</div><p class="muted text-sm mt-1">Actual people, not a maze.</p></div>
        <div class="card p-6"><div class="w-10 h-10 rounded bg-amber-50 text-amber-700 grid place-items-center"><i class="fa-solid fa-lock"></i></div><div class="mt-2 font-semibold">Transparent</div><p class="muted text-sm mt-1">Clear steps and pricing.</p></div>
      </div>
    </div>
  </section>

  <!-- Step 2: Details -->
  <section id="step2" class="max-w-6xl mx-auto px-4 mt-8 hidden">
    <div class="card p-8">
      <h2 class="text-2xl font-bold">Your Details</h2>
      <p class="muted">Minimum investment <strong>R80,000</strong>. Share price <strong>R1,000</strong> (no bonus shares).</p>

      <form id="detailsForm" class="mt-6 grid gap-6">
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm muted mb-1">Full name *</label>
            <input id="fullName" class="inp" placeholder="e.g. John Smith" required/>
            <div id="fullNameError" class="hidden text-sm text-red-600 mt-1">Please enter your full name</div>
          </div>
          <div>
            <label class="block text-sm muted mb-1">Email *</label>
            <input id="email" type="email" class="inp" placeholder="you@domain.com" required/>
            <div id="emailError" class="hidden text-sm text-red-600 mt-1">Please enter a valid email</div>
          </div>
        </div>

        <div class="grid sm:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm muted mb-1">ID number *</label>
            <input id="idNumber" class="inp" placeholder="e.g. 910101..." required/>
            <div id="idError" class="hidden text-sm text-red-600 mt-1">ID required</div>
          </div>
          <div>
            <label class="block text-sm muted mb-1">Cell number *</label>
            <input id="phone" class="inp" placeholder="+27 ..." inputmode="tel" required/>
            <div id="phoneError" class="hidden text-sm text-red-600 mt-1">Phone required</div>
          </div>
          <div>
            <label class="block text-sm muted mb-1">Investment amount (ZAR) *</label>
            <div class="flex">
              <span class="px-3 grid place-items-center border border-[var(--line)] rounded-l-md bg-gray-50">R</span>
              <input id="investmentAmount" type="number" min="80000" step="1000" value="80000" class="inp rounded-l-none" required/>
            </div>
            <div id="amountError" class="hidden text-sm text-red-600 mt-1">Minimum is R80,000</div>
            <div class="text-xs muted mt-1">Share price: R1,000</div>
          </div>
        </div>

        <!-- Address -->
        <div class="grid lg:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm muted mb-1">Search address *</label>
            <input id="addrSearch" class="inp" placeholder="Type an address…"/>
            <div class="text-xs muted mt-1">We’ll pin it on the map.</div>
          </div>
          <div>
            <label class="block text-sm muted mb-1">Selected address</label>
            <input id="addressText" class="inp" placeholder="—" readonly/>
          </div>
        </div>

        <div id="map" class="mt-2"></div>

        <!-- Summary -->
        <div class="grid sm:grid-cols-3 gap-4 mt-6">
          <div class="card p-4">
            <div class="muted text-sm">Amount</div>
            <div id="summaryAmount" class="text-xl font-bold">R80,000.00</div>
          </div>
          <div class="card p-4">
            <div class="muted text-sm">Share price</div>
            <div class="text-xl font-bold">R1,000</div>
          </div>
          <div class="card p-4">
            <div class="muted text-sm">Shares</div>
            <div id="summaryShares" class="text-xl font-bold">80</div>
          </div>
        </div>

        <div class="flex items-center justify-between mt-4">
          <button type="button" data-prev class="rounded-xl px-5 py-2.5 border border-[var(--line)]">Back</button>
          <button type="button" id="toPayment" class="btn-olive rounded-xl px-6 py-3 font-semibold">Proceed to Payment <i class="fa-solid fa-arrow-right ml-2"></i></button>
        </div>
      </form>
    </div>
  </section>

  <!-- Step 3: Payment -->
  <section id="step3" class="max-w-6xl mx-auto px-4 mt-8 hidden">
    <div class="card p-8">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 class="text-2xl font-bold">Bank Transfer</h2>
          <p class="muted">Transfer the amount below and then upload your POP (PDF).</p>
        </div>
        <div class="text-right">
          <div class="text-sm muted">Total Amount</div>
          <div id="paymentTotal" class="text-2xl font-extrabold text-[var(--olive)]">R80,000.00</div>
        </div>
      </div>

      <div class="grid lg:grid-cols-2 gap-6 mt-6">
        <div class="card p-5">
          <div class="grid sm:grid-cols-2 gap-4">
            <div><div class="muted text-xs mb-1">Bank</div><div class="font-semibold">Capitec Bank</div></div>
            <div><div class="muted text-xs mb-1">Account Name</div><div class="font-semibold">AlgoHive Business Account</div></div>
            <div><div class="muted text-xs mb-1">Account Number</div><div class="font-semibold">1053 0458 83</div></div>
            <div><div class="muted text-xs mb-1">Branch Code</div><div class="font-semibold">470010</div></div>
            <div class="sm:col-span-2"><div class="muted text-xs mb-1">Reference</div><div class="font-semibold">INV-<span id="emailRef">your@email</span></div></div>
          </div>
          <p class="muted text-sm mt-3">Use the exact reference. EFTs usually clear in 1–2 business days.</p>

          <button id="downloadPdfBtn" class="mt-4 w-full btn-olive rounded-xl px-4 py-3 font-semibold">
            <i class="fa-solid fa-download mr-2"></i> Download Confirmation PDF
          </button>
        </div>

        <div class="card p-5">
          <h3 class="font-semibold">Upload Proof of Payment (PDF)</h3>
          <p class="muted text-sm">After your transfer, upload your POP here.</p>
          <input id="popFile" type="file" accept="application/pdf" class="mt-3"/>
          <button id="uploadPopBtn" class="mt-3 btn-olive rounded-xl px-4 py-2 font-semibold">Upload POP</button>
          <div id="popMsg" class="mt-2 text-sm"></div>
        </div>
      </div>

      <div class="flex items-center justify-between mt-6">
        <button type="button" data-prev class="rounded-xl px-5 py-2.5 border border-[var(--line)]">Back</button>
        <button type="button" id="toComplete" class="rounded-xl px-6 py-3 border border-[var(--line)]">Skip & Finish</button>
      </div>
    </div>
  </section>

  <!-- Step 4: Complete -->
  <section id="step4" class="max-w-6xl mx-auto px-4 mt-8 hidden">
    <div class="card p-10 text-center" id="completeCard">
      <div class="w-24 h-24 rounded-full mx-auto grid place-items-center bg-emerald-100">
        <i class="fa-solid fa-check text-4xl text-emerald-700"></i>
      </div>
      <h2 class="mt-6 text-3xl font-extrabold">Welcome to AlgoHive 🎉</h2>
      <p class="mt-2 muted">We’ve received your details. We’ll review your POP and activate your dashboard shortly.</p>
      <div class="mt-8">
        <a href="/home.html" class="btn-olive inline-flex rounded-xl px-6 py-3 font-semibold">Go to Dashboard</a>
      </div>
    </div>
  </section>

  <!-- Supabase + App Logic -->
  <script type="module" nonce="ALGOHIVE">
    // ======= Supabase init (fill these) =======
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.1/+esm";
    const SUPABASE_URL = "https://aazofjsssobejhkyyiqv.supabase.co"; // TODO
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhem9manNzc29iZWpoa3l5aXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMTI1NDUsImV4cCI6MjA3MzY4ODU0NX0.guYlxaV5RwTlTVFoUhpER0KWEIGPay8svLsxMwyRUyM";                // TODO
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ======= State =======
    let currentStep = 1;
    const totalSteps = 4;
    const minInvestment = 80000;
    const sharePrice = 1000;

    const state = {
      fullName: "",
      email: "",
      idNumber: "",
      phone: "",
      addressText: "",
      lat: null,
      lng: null,
      amount: minInvestment,
      shares: Math.floor(minInvestment / sharePrice),
      user: null,
      popPath: null
    };

    // ======= Auth guard (assumes you use Supabase Auth) =======
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      // send to your sign-in; keep simple here
      // location.href = "/auth.html?tab=in&redirect=" + encodeURIComponent(location.pathname);
    } else {
      const me = await supabase.auth.getUser();
      state.user = me.data.user;
    }

    // ======= UI bindings =======
    document.querySelectorAll('[data-next]').forEach(b => b.addEventListener('click', nextStep));
    document.querySelectorAll('[data-prev]').forEach(b => b.addEventListener('click', prevStep));
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => gotoStep(Number(btn.dataset.goto)));
    });

    // Details inputs
    const amtEl = document.getElementById('investmentAmount');
    amtEl.addEventListener('input', () => {
      let amt = parseFloat(amtEl.value || "0");
      if (isNaN(amt) || amt < minInvestment) {
        amt = minInvestment;
        amtEl.value = String(minInvestment);
      }
      state.amount = amt;
      state.shares = Math.floor(amt / sharePrice);
      document.getElementById('summaryAmount').textContent = `R${amt.toFixed(2)}`;
      document.getElementById('summaryShares').textContent = state.shares;
    });

    document.getElementById('toPayment').addEventListener('click', validateDetails);

    // Payment actions
    document.getElementById('downloadPdfBtn').addEventListener('click', () => {
      window.location.href = "https://ac771e08-657e-406a-9fb7-dc82bd541742.usrfiles.com/ugd/ac771e_7f8b25db5489452b8d43cceec9e9475c.pdf";
    });
    document.getElementById('uploadPopBtn').addEventListener('click', uploadPOP);
    document.getElementById('toComplete').addEventListener('click', finishFlow);

    // Stepper visuals
    function updateStepper(){
      const pct = (currentStep / totalSteps) * 100;
      document.getElementById('progressBar').style.width = `${pct}%`;
      for (let i=1;i<=4;i++){
        document.getElementById(`s${i}`).classList.toggle('active', i<=currentStep);
        document.querySelector(`[data-goto="${i}"]`)?.classList.toggle('active', i===currentStep);
      }
    }
    function gotoStep(n){
      if (n<1 || n>totalSteps) return;
      document.getElementById(`step${currentStep}`).classList.add('hidden');
      currentStep = n;
      document.getElementById(`step${currentStep}`).classList.remove('hidden');
      updateStepper();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function nextStep(){ gotoStep(currentStep+1); }
    function prevStep(){ gotoStep(currentStep-1); }

    // ======= Validate step 2 =======
    function validateDetails(){
      const fullName = document.getElementById('fullName').value.trim();
      const email = document.getElementById('email').value.trim();
      const idNumber = document.getElementById('idNumber').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const amt = parseFloat(document.getElementById('investmentAmount').value);

      let ok = true;
      const setErr = (id, show) => document.getElementById(id).classList.toggle('hidden', !show);

      if (!fullName){ setErr('fullNameError', true); ok=false; } else setErr('fullNameError', false);
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ setErr('emailError', true); ok=false; } else setErr('emailError', false);
      if (!idNumber){ document.getElementById('idError').classList.remove('hidden'); ok=false; } else document.getElementById('idError').classList.add('hidden');
      if (!phone){ document.getElementById('phoneError').classList.remove('hidden'); ok=false; } else document.getElementById('phoneError').classList.add('hidden');
      if (!amt || amt < minInvestment){ document.getElementById('amountError').classList.remove('hidden'); ok=false; } else document.getElementById('amountError').classList.add('hidden');
      if (!state.addressText || state.lat===null || state.lng===null){ alert('Please pick an address on the map.'); ok=false; }

      if (!ok) return;

      // save to state
      state.fullName = fullName;
      state.email = email;
      state.idNumber = idNumber;
      state.phone = phone;

      // hydrate payment
      document.getElementById('paymentTotal').textContent = `R${state.amount.toFixed(2)}`;
      document.getElementById('emailRef').textContent = state.email || '—';

      nextStep();
    }

    // ======= POP upload =======
    async function uploadPOP(){
      const file = document.getElementById('popFile').files?.[0];
      const msg = document.getElementById('popMsg');
      msg.textContent = '';
      if (!file) { msg.textContent = 'Please select a PDF first.'; return; }
      if (file.type !== 'application/pdf'){ msg.textContent = 'PDF only, please.'; return; }

      try {
        // ensure session
        let userId = state.user?.id;
        if (!userId) {
          const me = await supabase.auth.getUser();
          userId = me.data.user?.id;
          if (!userId) throw new Error('Not signed in');
        }

        const ts = Date.now();
        const path = `pop/${userId}/pop_${ts}.pdf`;

        msg.textContent = 'Uploading…';
        const { error: upErr } = await supabase.storage.from('documents').upload(path, file, {
          upsert: true, contentType: 'application/pdf'
        });
        if (upErr) throw upErr;

        // Insert (or upsert) application row
        const payload = {
          user_id: userId,
          full_name: state.fullName,
          email: state.email,
          amount: state.amount,
          share_price: sharePrice,
          shares: state.shares,
          id_number: state.idNumber,
          phone: state.phone,
          address_text: state.addressText,
          address_lat: state.lat,
          address_lng: state.lng,
          pop_path: path,
          status: 'received',
          updated_at: new Date().toISOString()
        };

        // If you want a single app per user, use upsert on user_id:
        const { error: dbErr } = await supabase
          .from('investment_applications')
          .upsert(payload, { onConflict: 'user_id' });
        if (dbErr) throw dbErr;

        state.popPath = path;
        msg.textContent = 'POP uploaded. Thank you!';
        confetti({ particleCount: 140, spread: 70, origin: { y: 0.6 } });
      } catch (e) {
        console.error(e);
        msg.textContent = e.message || 'Upload failed. Please try again.';
      }
    }

    // ======= Finish =======
    function finishFlow(){
      gotoStep(4);
      setTimeout(() => confetti({ particleCount: 220, spread: 80, origin: { y: 0.6 } }), 250);
    }

    // ======= Leaflet map + search =======
    let map, marker;
    function initMap(){
      map = L.map('map', { zoomControl: true }).setView([-26.2041, 28.0473], 10); // Joburg-ish
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      map.on('click', async (e) => {
        setMarker(e.latlng.lat, e.latlng.lng);
        reverseGeocode(e.latlng.lat, e.latlng.lng);
      });
    }
    function setMarker(lat, lng){
      state.lat = lat; state.lng = lng;
      if (!marker) {
        marker = L.marker([lat, lng], { draggable: true }).addTo(map);
        marker.on('dragend', () => {
          const ll = marker.getLatLng();
          setMarker(ll.lat, ll.lng);
          reverseGeocode(ll.lat, ll.lng);
        });
      } else {
        marker.setLatLng([lat, lng]);
      }
    }
    async function reverseGeocode(lat, lng){
      try{
        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`);
        const j = await r.json();
        const disp = j.display_name || `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        state.addressText = disp;
        document.getElementById('addressText').value = disp;
      }catch{
        document.getElementById('addressText').value = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
      }
    }
    async function searchAddress(q){
      if (!q || q.length < 3) return;
      const r = await fetch(`https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&limit=1`);
      const j = await r.json();
      if (j?.length){
        const { lat, lon, display_name } = j[0];
        const latf = parseFloat(lat), lngf = parseFloat(lon);
        map.setView([latf, lngf], 15);
        setMarker(latf, lngf);
        state.addressText = display_name;
        document.getElementById('addressText').value = display_name;
      }
    }
    document.getElementById('addrSearch').addEventListener('keydown', e => {
      if (e.key === 'Enter'){ e.preventDefault(); searchAddress(e.currentTarget.value.trim()); }
    });

    // kick off
    initMap();
    updateStepper();
  </script>
</body>
</html>
