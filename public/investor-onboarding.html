<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Investor Onboarding | AlgoHive</title>

  <!-- Tailwind (light) -->
  <script src="https://cdn.tailwindcss.com" nonce="ALGOHIVE"></script>
  <script nonce="ALGOHIVE">
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ink: "#0f172a",
            muted: "#64748b",
            olive: "#7e8d52",
            line: "#e5e7eb",
            soft: "#f8fafc"
          },
          boxShadow: {
            soft: "0 10px 30px rgba(2,12,27,.06)"
          }
        }
      }
    }
  </script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <!-- Leaflet map (Address picker) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" nonce="ALGOHIVE"></script>

  <style>
    .tab-btn{ border:1px solid transparent }
    .tab-btn[aria-current="step"]{ background:#f1f5f9; border-color:#cbd5e1 }
    .inp{ border:1px solid #e2e8f0; }
    .inp:focus{ outline: none; box-shadow: 0 0 0 3px rgba(126,141,82,.25); border-color:#7e8d52; }
    .error{ border-color:#ef4444 !important; }
    .dropzone--active{ border-color:#7e8d52; background:#f7fbe8 }
  </style>
</head>
<body class="bg-soft text-ink">

  <!-- Header -->
  <header class="bg-white shadow-sm">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img class="w-8 h-8" alt="AlgoHive" src="https://static.wixstatic.com/shapes/ac771e_e60a2d47ce2d4afb858cb00c0e618c9e.svg"/>
        <div class="font-semibold">AlgoHive Investor Portal</div>
      </div>
      <div class="hidden sm:flex items-center gap-3 text-sm text-muted">
        <span>Secure</span><span>•</span><span>Bank verified</span><span>•</span><span>No hidden fees</span>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Step tabs -->
    <nav class="flex items-center gap-3 text-sm">
      <button class="tab-btn px-3 py-2 rounded-lg font-medium" data-step-tab="1" aria-current="step"><span class="text-muted mr-1">1</span>Intro</button>
      <button class="tab-btn px-3 py-2 rounded-lg font-medium" data-step-tab="2"><span class="text-muted mr-1">2</span>Details</button>
      <button class="tab-btn px-3 py-2 rounded-lg font-medium" data-step-tab="3"><span class="text-muted mr-1">3</span>Bank Transfer</button>
      <button class="tab-btn px-3 py-2 rounded-lg font-medium" data-step-tab="4"><span class="text-muted mr-1">4</span>Confirmation</button>
    </nav>

    <!-- Progress -->
    <div class="mt-3 h-1 w-full bg-white rounded shadow-inner">
      <div id="progressBar" class="h-1 rounded bg-olive" style="width:25%"></div>
    </div>

    <!-- STEP 1: Intro -->
    <section id="step1" class="mt-8">
      <div class="bg-white rounded-2xl shadow-soft p-8">
        <div class="grid lg:grid-cols-2 gap-8 items-center">
          <div>
            <span class="inline-flex items-center gap-2 text-xs px-2 py-1 rounded bg-[#f6f8f2] text-olive border border-[#dfe6cf]">
              <i class="fa-solid fa-seedling"></i> Welcome
            </span>
            <h1 class="mt-4 text-3xl sm:text-4xl font-extrabold tracking-tight">Invest in the <span class="text-olive">hive</span> that builds better portfolios.</h1>
            <p class="mt-3 text-lg text-muted">Thank you for choosing to invest with AlgoHive. Follow the quick steps to complete your application.</p>

            <div class="mt-8 flex gap-3">
              <button class="bg-olive text-white rounded-xl px-5 py-3 font-semibold shadow-soft hover:brightness-95" data-next>
                Get Started <i class="fa-solid fa-arrow-right ml-2"></i>
              </button>
            </div>
          </div>

          <!-- Right card (kept simple, removed stats) -->
          <div class="bg-soft rounded-2xl p-6 border border-[#e9eedc]">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-[#eff5e3] text-olive grid place-items-center border border-[#dfe6cf]">
                <i class="fa-solid fa-shield-halved"></i>
              </div>
              <div class="font-semibold">Bank-grade security</div>
            </div>
            <p class="text-muted mt-2 text-sm">Your information is encrypted and stored securely.</p>

            <div class="mt-5 flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-[#eff5e3] text-olive grid place-items-center border border-[#dfe6cf]">
                <i class="fa-solid fa-file-signature"></i>
              </div>
              <div class="font-semibold">Clear, simple paperwork</div>
            </div>
            <p class="text-muted mt-2 text-sm">Sign your agreement online and keep a PDF for your records.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- STEP 2: Details -->
    <section id="step2" class="mt-8 hidden">
      <div class="bg-white rounded-2xl shadow-soft p-8">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-2xl font-bold">Investment Details</h2>
            <p class="text-muted mt-1">Please fill in your details. Address uses a map so we capture it correctly.</p>
          </div>
          <div class="hidden sm:flex items-center gap-2 text-xs text-muted">
            ~5–7 min
          </div>
        </div>

        <form id="investmentForm" class="mt-8 grid gap-6">
          <!-- Basics -->
          <div class="grid sm:grid-cols-2 gap-5">
            <div>
              <label class="text-sm text-muted">Full Name *</label>
              <input id="fullName" class="inp rounded-xl w-full px-4 py-3" placeholder="John Smith" required>
              <div id="fullNameError" class="hidden text-sm mt-1 text-red-600">Please enter your full name</div>
            </div>
            <div>
              <label class="text-sm text-muted">Email Address *</label>
              <input id="email" type="email" class="inp rounded-xl w-full px-4 py-3" placeholder="john@example.com" required>
              <div id="emailError" class="hidden text-sm mt-1 text-red-600">Please enter a valid email</div>
            </div>
          </div>

          <div class="grid sm:grid-cols-3 gap-5">
            <div>
              <label class="text-sm text-muted">SA ID / Passport *</label>
              <input id="idNumber" class="inp rounded-xl w-full px-4 py-3" placeholder="910101..." required>
              <div id="idError" class="hidden text-sm mt-1 text-red-600">ID/Passport is required</div>
            </div>
            <div>
              <label class="text-sm text-muted">Cell Number *</label>
              <input id="cell" class="inp rounded-xl w-full px-4 py-3" placeholder="+27 82 123 4567" inputmode="tel" required>
              <div id="cellError" class="hidden text-sm mt-1 text-red-600">Cell number is required</div>
            </div>
            <div>
              <label class="text-sm text-muted">Investment Amount (ZAR) *</label>
              <div class="flex">
                <span class="px-4 py-3 rounded-l-xl border border-r-0 border-slate-200 bg-slate-50">R</span>
                <input id="investmentAmount" class="inp rounded-r-xl w-full px-4 py-3" type="number" min="80000" step="1000" value="80000" required>
              </div>
              <div id="amountError" class="hidden text-sm mt-1 text-red-600">Minimum investment is R80,000</div>
              <p class="text-xs text-muted mt-1">Share price: <span class="font-semibold">R1,000</span> per share</p>
            </div>
          </div>

          <!-- Address with Map -->
          <div class="grid lg:grid-cols-3 gap-5">
            <div class="lg:col-span-2">
              <label class="text-sm text-muted">Search Address *</label>
              <input id="addressSearch" class="inp rounded-xl w-full px-4 py-3" placeholder="Start typing your address…" autocomplete="off">
              <div id="addressError" class="hidden text-sm mt-1 text-red-600">Please select an address</div>
              <div id="addressList" class="mt-2 hidden bg-white border border-slate-200 rounded-lg overflow-hidden"></div>

              <input type="hidden" id="addrLine" />
              <input type="hidden" id="addrLat" />
              <input type="hidden" id="addrLng" />
            </div>
            <div>
              <label class="text-sm text-muted">Confirm on Map</label>
              <div id="map" class="rounded-xl border border-slate-200" style="height: 220px;"></div>
            </div>
          </div>

          <!-- Summary card -->
          <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-slate-50 rounded-2xl p-6 border border-slate-200">
              <div class="flex items-center justify-between">
                <h3 class="font-semibold">Investment Summary</h3>
                <span class="text-xs px-2 py-1 rounded bg-olive/10 text-olive border border-olive/30">Live</span>
              </div>
              <dl class="mt-4 space-y-2 text-sm">
                <div class="flex justify-between"><dt class="text-muted">Amount</dt><dd id="summaryAmount" class="font-semibold text-ink">R80,000.00</dd></div>
                <div class="flex justify-between"><dt class="text-muted">Share Price</dt><dd class="font-semibold">R1,000.00</dd></div>
                <div class="flex justify-between"><dt class="text-muted">Number of Shares</dt><dd id="summaryShares" class="font-semibold">80</dd></div>
              </dl>
            </div>
          </div>

          <div class="flex items-center justify-between pt-2">
            <button type="button" data-prev class="rounded-xl px-5 py-2.5 bg-white border border-slate-200 hover:bg-slate-50">
              <i class="fa-solid fa-arrow-left mr-2"></i> Back
            </button>
            <button type="button" id="proceedBtn" class="bg-olive text-white rounded-xl px-6 py-3 font-semibold shadow-soft hover:brightness-95">
              Proceed to Payment <i class="fa-solid fa-arrow-right ml-2"></i>
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- STEP 3: Bank Transfer -->
    <section id="step3" class="mt-8 hidden">
      <div class="bg-white rounded-2xl shadow-soft p-8">
        <div class="flex items-start justify-between">
          <div>
            <h2 class="text-2xl font-bold">Bank Transfer Details</h2>
            <p class="text-muted">Complete your investment via bank transfer</p>
          </div>
          <div class="text-right">
            <div class="text-sm text-muted">Total Amount</div>
            <div id="paymentTotal" class="text-2xl font-extrabold text-ink">R80,000</div>
          </div>
        </div>

        <div class="bg-slate-50 rounded-2xl p-6 mt-6 border border-slate-200">
          <div class="grid sm:grid-cols-2 gap-6">
            <div><div class="text-xs text-muted mb-1">Bank Name</div><div class="font-semibold">Capitec Bank</div></div>
            <div><div class="text-xs text-muted mb-1">Account Name</div><div class="font-semibold">AlgoHive Business Account</div></div>
            <div><div class="text-xs text-muted mb-1">Account Number</div><div class="font-semibold">1053 0458 83</div></div>
            <div><div class="text-xs text-muted mb-1">Branch Code</div><div class="font-semibold">470010</div></div>
            <div class="sm:col-span-2"><div class="text-xs text-muted mb-1">Reference</div><div class="font-semibold">INV-<span id="emailRef">[your email]</span></div></div>
          </div>
          <p class="text-sm text-muted mt-3">Use the reference above. EFTs typically clear in 1–2 business days.</p>
        </div>

        <div class="mt-6 flex flex-col sm:flex-row gap-3">
          <button id="downloadPdfBtn" class="w-full sm:w-auto bg-olive text-white rounded-xl px-4 py-3 font-semibold shadow-soft hover:brightness-95">
            <i class="fa-solid fa-download mr-2"></i> Download Bank Confirmation PDF
          </button>
          <button type="button" id="completePaymentBtn" class="w-full sm:w-auto bg-olive text-white rounded-xl px-4 py-3 font-semibold shadow-soft hover:brightness-95">
            I’ve Completed Payment <i class="fa-solid fa-check ml-2"></i>
          </button>
        </div>

        <!-- Proof of payment upload (hidden until “Completed Payment”) -->
        <div id="proofWrap" class="mt-8 hidden">
          <h3 class="font-semibold mb-2">Upload Proof of Payment (PDF)</h3>
          <p class="text-sm text-muted mb-3">Please upload your bank’s confirmation PDF so we can reconcile faster.</p>

          <div id="dropzone" class="rounded-xl border-2 border-dashed border-slate-300 bg-slate-50 p-6 text-center">
            <input id="proofFile" type="file" accept="application/pdf" class="hidden">
            <p class="text-sm text-muted">Drag & drop your PDF here, or</p>
            <button id="browseBtn" class="mt-2 px-4 py-2 rounded-lg border border-slate-300 hover:bg-white">Browse files</button>
            <div id="fileInfo" class="mt-3 text-sm"></div>
          </div>

          <div class="mt-4 flex items-center justify-end">
            <button id="uploadBtn" class="bg-olive text-white rounded-xl px-5 py-2.5 font-semibold shadow-soft hover:brightness-95 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              Upload Proof & Continue
            </button>
          </div>
        </div>

        <div class="flex items-center justify-between mt-8">
          <button type="button" data-prev class="rounded-xl px-5 py-2.5 bg-white border border-slate-200 hover:bg-slate-50">
            <i class="fa-solid fa-arrow-left mr-2"></i> Back
          </button>
        </div>
      </div>
    </section>

    <!-- STEP 4: Confirmation -->
    <section id="step4" class="mt-8 hidden">
      <div class="bg-white rounded-2xl shadow-soft p-8">
        <div class="text-center">
          <div class="w-20 h-20 mx-auto rounded-full grid place-items-center bg-olive/10 text-olive border border-olive/30">
            <i class="fa-solid fa-check text-3xl"></i>
          </div>
          <h2 class="mt-6 text-3xl font-extrabold">Thank you for your investment!</h2>
          <p class="mt-2 text-muted">We’ve received your details. We’ll notify you once payment clears.</p>

          <div class="bg-slate-50 rounded-2xl p-6 mt-8 max-w-md mx-auto border border-slate-200">
            <div class="grid grid-cols-2 gap-y-2 text-sm">
              <div class="text-muted">Amount</div><div id="confirmationAmount" class="text-right font-semibold">R80,000.00</div>
              <div class="text-muted">Share Price</div><div class="text-right font-semibold">R1,000.00</div>
              <div class="text-muted">Shares</div><div id="confirmationShares" class="text-right font-semibold">80</div>
            </div>
            <div class="mt-5">
              <div class="text-sm text-muted">Transaction ID</div>
              <div id="finalTransactionId" class="mt-1 font-mono tracking-[.35em] text-center text-lg px-3 py-3 rounded-lg bg-white border border-slate-200">INV-ABC123</div>
            </div>
            <p class="text-sm text-muted mt-4">Confirmation sent to <span id="confirmationEmail" class="font-semibold">you@example.com</span>.</p>
          </div>

          <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4">
            <button id="downloadPdfBtn2" class="bg-olive text-white rounded-xl px-6 py-3 font-semibold shadow-soft hover:brightness-95">
              <i class="fa-solid fa-download mr-2"></i> Download PDF Again
            </button>
            <button id="resetBtn" class="rounded-xl px-6 py-3 bg-white border border-slate-200 hover:bg-slate-50">
              <i class="fa-solid fa-home mr-2"></i> Return to Homepage
            </button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Scripts -->
  <script nonce="ALGOHIVE">
    // ---------- State ----------
    let currentStep = 1;
    const totalSteps = 4;
    const sharePrice = 1000;             // R1,000
    const minInvestment = 80000;         // R80,000
    const formData = {
      fullName: '', email: '', idNumber: '', cell: '',
      address: '', lat: null, lng: null,
      investmentAmount: minInvestment,
      shares: Math.floor(minInvestment / sharePrice),
      transactionId: genTxn(),
      proofFile: null
    };

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', () => {
      // tabs
      document.querySelectorAll('[data-step-tab]').forEach(btn => {
        btn.addEventListener('click', () => goToStep(Number(btn.dataset.stepTab)));
      });

      // next/prev
      document.querySelectorAll('[data-next]').forEach(b => b.addEventListener('click', nextStep));
      document.querySelectorAll('[data-prev]').forEach(b => b.addEventListener('click', prevStep));

      // inputs
      byId('investmentAmount').addEventListener('input', updateSummary);
      byId('proceedBtn').addEventListener('click', validateStep2);
      byId('downloadPdfBtn').addEventListener('click', () => downloadPDF());
      byId('downloadPdfBtn2').addEventListener('click', () => downloadPDF());
      byId('completePaymentBtn').addEventListener('click', showProofUpload);
      byId('resetBtn').addEventListener('click', resetAll);

      // Proof upload
      initDropzone();

      // Map + address search
      initMap();

      // initial
      updateSummary();
      updateTabs();
    });

    // ---------- Helpers ----------
    const byId = id => document.getElementById(id);
    function genTxn(){ return 'INV-' + Math.random().toString(36).substr(2,9).toUpperCase(); }

    function updateProgress(){
      const pct = (currentStep / totalSteps) * 100;
      byId('progressBar').style.width = pct + '%';
    }
    function updateTabs(){
      document.querySelectorAll('[data-step-tab]').forEach((btn,i)=>{
        btn.setAttribute('aria-current', (i+1)===currentStep ? 'step' : 'false');
      });
      updateProgress();
    }
    function goToStep(k){
      if(k<1||k>totalSteps) return;
      for(let i=1;i<=totalSteps;i++){
        const sec = byId('step'+i);
        sec.classList.toggle('hidden', i!==k);
      }
      currentStep = k; updateTabs();
    }
    function nextStep(){ goToStep(currentStep+1); }
    function prevStep(){ goToStep(currentStep-1); }

    // ---------- Summary calc ----------
    function updateSummary(){
      let amt = parseFloat(byId('investmentAmount').value);
      if (isNaN(amt) || amt < minInvestment){
        amt = minInvestment;
        byId('investmentAmount').value = minInvestment.toFixed(0);
      }
      const shares = Math.floor(amt / sharePrice);
      formData.investmentAmount = shares * sharePrice; // round down
      formData.shares = shares;

      byId('summaryAmount').textContent = 'R' + formData.investmentAmount.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
      byId('summaryShares').textContent = shares.toLocaleString();
    }

    // ---------- Validate step 2 ----------
    function validateStep2(){
      const name = byId('fullName').value.trim();
      const email = byId('email').value.trim();
      const idNum = byId('idNumber').value.trim();
      const cell = byId('cell').value.trim();
      const addrOK = !!byId('addrLine').value;

      // reset
      ['fullName','email','idNumber','cell','investmentAmount','addressSearch'].forEach(id => byId(id).classList.remove('error'));
      ['fullNameError','emailError','idError','cellError','amountError','addressError'].forEach(id => byId(id).classList.add('hidden'));

      let ok = true;
      if(!name){ ok=false; byId('fullName').classList.add('error'); byId('fullNameError').classList.remove('hidden'); }
      if(!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ ok=false; byId('email').classList.add('error'); byId('emailError').classList.remove('hidden'); }
      const amt = parseFloat(byId('investmentAmount').value)||0;
      if(amt < minInvestment){ ok=false; byId('investmentAmount').classList.add('error'); byId('amountError').classList.remove('hidden'); }
      if(!idNum){ ok=false; byId('idNumber').classList.add('error'); byId('idError').classList.remove('hidden'); }
      if(!cell){ ok=false; byId('cell').classList.add('error'); byId('cellError').classList.remove('hidden'); }
      if(!addrOK){ ok=false; byId('addressSearch').classList.add('error'); byId('addressError').classList.remove('hidden'); }

      if(!ok) return;

      // store & move
      formData.fullName = name;
      formData.email = email;
      formData.idNumber = idNum;
      formData.cell = cell;
      formData.address = byId('addrLine').value;
      byId('paymentTotal').textContent = 'R' + formData.investmentAmount.toLocaleString();
      byId('emailRef').textContent = formData.email;
      nextStep();
    }

    // ---------- Bank step: proof upload ----------
    function showProofUpload(){
      const wrap = byId('proofWrap');
      wrap.classList.remove('hidden');
      wrap.scrollIntoView({behavior:'smooth', block:'start'});
    }

    function initDropzone(){
      const dz = byId('dropzone');
      const fileInput = byId('proofFile');
      const info = byId('fileInfo');
      const browse = byId('browseBtn');
      const uploadBtn = byId('uploadBtn');

      const acceptFile = f => {
        if(!f) return;
        if(f.type !== 'application/pdf'){ info.textContent = 'Please upload a PDF.'; uploadBtn.disabled = true; return; }
        if(f.size > 15 * 1024 * 1024){ info.textContent = 'File is too large (max 15MB).'; uploadBtn.disabled = true; return; }
        formData.proofFile = f;
        info.textContent = `Selected: ${f.name} (${(f.size/1024/1024).toFixed(2)} MB)`;
        uploadBtn.disabled = false;
      };

      browse.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', () => acceptFile(fileInput.files[0]));

      ['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); dz.classList.add('dropzone--active'); }));
      ['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); dz.classList.remove('dropzone--active'); }));
      dz.addEventListener('drop', e => { const f = e.dataTransfer.files?.[0]; acceptFile(f); });

      uploadBtn.addEventListener('click', uploadProof);
    }

    async function uploadProof(){
      // Hook this to your backend later:
      // const fd = new FormData(); fd.append('proof', formData.proofFile); await fetch('/api/upload-proof', {method:'POST', body: fd});
      // For now, pretend success:
      uploadBtn.disabled = true;
      uploadBtn.textContent = 'Uploading…';
      await new Promise(r => setTimeout(r, 900));
      uploadBtn.textContent = 'Uploaded ✓';
      // Move to confirmation
      updateConfirmation();
      nextStep();
    }

    // ---------- Confirmation ----------
    function updateConfirmation(){
      byId('confirmationAmount').textContent = 'R' + formData.investmentAmount.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
      byId('confirmationShares').textContent = formData.shares.toLocaleString();
      byId('confirmationEmail').textContent = formData.email;
      byId('finalTransactionId').textContent = formData.transactionId;
    }

    // ---------- PDF ----------
    function downloadPDF(){
      window.location.href = "https://ac771e08-657e-406a-9fb7-dc82bd541742.usrfiles.com/ugd/ac771e_7f8b25db5489452b8d43cceec9e9475c.pdf";
    }

    // ---------- Map + address ----------
    let map, marker;
    function initMap(){
      // Wait for Leaflet
      const ready = () => typeof L !== 'undefined';
      const retry = setInterval(()=>{
        if(!ready()) return;
        clearInterval(retry);

        map = L.map('map',{ zoomControl:false }).setView([-26.2041, 28.0473], 11); // Joburg default
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap' }).addTo(map);

        marker = L.marker(map.getCenter(), { draggable:true }).addTo(map);
        marker.on('dragend', async () => {
          const {lat, lng} = marker.getLatLng();
          byId('addrLat').value = lat; byId('addrLng').value = lng;
          // reverse geocode (Nominatim)
          try{
            const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`);
            const j = await r.json();
            byId('addressSearch').value = j.display_name || '';
            byId('addrLine').value = j.display_name || '';
          } catch {}
        });

        // search suggest
        const q = byId('addressSearch');
        const list = byId('addressList');

        let t; q.addEventListener('input', ()=>{
          const v = q.value.trim();
          byId('addrLine').value = ''; // require selection
          if(t) clearTimeout(t);
          if(v.length < 3){ list.classList.add('hidden'); list.innerHTML=''; return; }
          t = setTimeout(async ()=>{
            try{
              const r = await fetch(`https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(v)}&countrycodes=za&addressdetails=1&limit=5`);
              const arr = await r.json();
              list.innerHTML = arr.map(item => `
                <button type="button" data-lat="${item.lat}" data-lon="${item.lon}" class="w-full text-left px-3 py-2 hover:bg-slate-100 border-b last:border-0">
                  ${item.display_name}
                </button>
              `).join('');
              list.classList.toggle('hidden', arr.length===0);
              list.querySelectorAll('button').forEach(b=>{
                b.addEventListener('click', ()=>{
                  const lat = parseFloat(b.dataset.lat), lon = parseFloat(b.dataset.lon);
                  map.setView([lat,lon], 16); marker.setLatLng([lat,lon]);
                  q.value = b.textContent.trim();
                  byId('addrLine').value = q.value; byId('addrLat').value = lat; byId('addrLng').value = lon;
                  list.classList.add('hidden'); list.innerHTML='';
                });
              });
            }catch{ /* ignore */ }
          }, 250);
        });
      }, 60);
    }

    // ---------- Reset ----------
    function resetAll(){
      formData.fullName=''; formData.email=''; formData.idNumber=''; formData.cell='';
      formData.address=''; formData.lat=null; formData.lng=null;
      formData.investmentAmount=minInvestment; formData.shares=Math.floor(minInvestment/sharePrice);
      formData.transactionId=genTxn(); formData.proofFile=null;

      byId('fullName').value=''; byId('email').value=''; byId('idNumber').value=''; byId('cell').value='';
      byId('investmentAmount').value = String(minInvestment);
      byId('addressSearch').value=''; byId('addrLine').value=''; byId('addrLat').value=''; byId('addrLng').value='';
      updateSummary();
      goToStep(1);
      window.scrollTo({top:0, behavior:'smooth'});
    }
  </script>
</body>
</html>
