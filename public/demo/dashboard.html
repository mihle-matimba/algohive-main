<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AlgoHive — Demo Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    :root {
      --page: #0b1220;
      --bg: #ffffff;
      --muted: #64748b;
      --ink: #0f172a;
      --olive: #556B2F;
      --brand: #f59e0b;
      --line: #e2e8f0
    }

    html,
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink)
    }

    .card {
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 12px
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .5rem;
      height: 40px;
      padding: 0 .875rem;
      border-radius: 10px;
      border: 1px solid var(--line);
      font-weight: 600
    }

    .tab {
      height: 36px;
      border-radius: 8px;
      padding: 0 .75rem
    }

    .tab-active {
      background: #111827;
      color: #fff
    }

    #layout {
      --sb: 220px;
      display: grid;
      grid-template-columns: 1fr;
      min-height: 100vh
    }

    #ah-sidebar {
      transition: transform .3s ease, width .2s ease;
      width: 280px;
      max-width: 85vw;
      position: fixed;
      z-index: 50;
      height: 100vh;
      transform: translateX(-100%)
    }

    #ah-sidebar.is-open {
      transform: translateX(0)
    }

    @media (min-width: 768px) {
      #layout {
        grid-template-columns: var(--sb) 1fr
      }

      #layout.is-collapsed {
        --sb: 64px
      }

      #ah-sidebar {
        position: sticky;
        width: var(--sb);
        max-width: none;
        transform: translateX(0);
        z-index: auto
      }
    }

    #ah-sidebar[data-collapsed="true"] .label,
    #ah-sidebar[data-collapsed="true"] .chevron {
      display: none
    }

    #ah-sidebar[data-collapsed="true"] details>.sub {
      display: none !important
    }

    #ah-sidebar[data-collapsed="true"] nav a,
    #ah-sidebar[data-collapsed="true"] details>summary {
      justify-content: center;
      gap: .25rem
    }

    #ah-sidebar[data-collapsed="true"] details>summary span {
      gap: 0
    }

    #ah-sidebar .footer {
      transition: all .2s ease
    }

    #ah-sidebar[data-collapsed="true"] .footer {
      justify-content: center;
      flex-direction: column;
      gap: 12px
    }

    #ah-sidebar[data-collapsed="true"] .btn-collapse :is(svg, i) {
      transform: rotate(180deg)
    }

    #ah-collapse {
      display: none
    }

    @media (min-width: 768px) {
      #ah-collapse {
        display: inline-flex
      }
    }

    .ps-tile {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 14px 16px;
      background: #fff
    }

    .ps-label {
      color: #64748b;
      font-weight: 500;
      font-size: .85rem
    }

    .ps-value {
      font-weight: 600;
      font-size: 1rem;
      margin-top: 2px
    }

    .no-scrollbar::-webkit-scrollbar {
      display: none
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none
    }

    .scrollbar-hide::-webkit-scrollbar {
      display: none
    }

    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none
    }
  </style>
</head>

<body class="min-h-screen overflow-x-hidden">
  <div id="layout">
    <div id="ah-overlay" class="fixed inset-0 bg-black/40 z-40 hidden md:hidden"></div>
    <aside id="ah-sidebar" data-collapsed="false" class="border-r border-slate-200 h-[100vh] bg-white flex flex-col overflow-hidden">
      <div class="px-4 py-4 flex items-center gap-3 border-b border-slate-200">
        <img src="https://static.wixstatic.com/media/ac771e_af06d86a7a1f4abd87e52e45f3bcbd96~mv2.png" alt="AlgoHive Logo" class="w-10 h-10 object-contain" />
        <div class="min-w-0">
          <div class="font-bold text-[15px] text-slate-900 label">AlgoHive</div>
          <div class="text-[11px] text-slate-500 label">Demo Workspace</div>
        </div>
      </div>

      <nav id="main-nav" class="p-2 text-[14px] flex-1 overflow-y-auto">
        <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50 font-medium text-slate-900" href="/home.html" title="Home">
          <i class="fa-solid fa-house text-slate-500 w-4 shrink-0"></i><span class="label">Home</span>
        </a>
        <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50" href="/auth.html">
          <i class="fa-solid fa-right-to-bracket text-slate-500 w-4 shrink-0"></i><span class="label">Switch Account</span>
        </a>
      </nav>

      <div class="p-3 border-t border-slate-200 footer flex items-center justify-between gap-2">
        <button id="ah-collapse" class="btn btn-collapse h-10 w-10 p-0 rounded-xl bg-slate-100 hover:bg-slate-200 border-0" title="Collapse">
          <i class="fa-solid fa-arrow-left"></i>
        </button>
      </div>
    </aside>

    <main class="flex-1 min-w-0">
      <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 bg-white sticky top-0 z-30">
        <div class="flex items-center gap-3 flex-1 min-w-0">
          <button id="ah-mobile-menu-btn" class="md:hidden btn h-10 w-10 p-0 rounded-xl border-0" title="Open Menu">
            <i class="fa-solid fa-bars"></i>
          </button>
          <h1 class="text-xl font-bold text-slate-800 truncate">Demo Dashboard</h1>
        </div>
        <div class="flex items-center gap-3">
          <span id="guard-account-type" class="rounded-full bg-emerald-100 text-emerald-700 text-xs font-semibold px-3 py-1">Paper Account</span>
          <button id="sign-out" class="btn h-10 rounded-xl bg-slate-100 hover:bg-slate-200 border-slate-200">Sign out</button>
        </div>
      </div>

      <div class="px-4 md:px-6 py-6 grid grid-cols-12 gap-6 min-w-0">
        <section class="card col-span-12 lg:col-span-8 border border-slate-200 shadow-none">
          <div class="px-5 pt-5 pb-4 border-b border-slate-200 flex items-start justify-between gap-4">
            <div>
              <p class="text-xs font-semibold uppercase tracking-[0.24em] text-[var(--olive)]">Demo profile</p>
              <h2 class="text-2xl font-semibold text-slate-900" id="welcome-name">Welcome back</h2>
              <p class="mt-1 text-sm text-slate-600" id="welcome-sub">Your paper portfolio snapshot is below.</p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 min-w-[240px] text-sm">
              <div class="rounded-xl border border-slate-200 bg-slate-50/80 px-4 py-3">
                <p class="text-xs font-semibold uppercase tracking-[0.18em] text-slate-500">Balance</p>
                <p id="stat-balance" class="mt-1 text-xl font-semibold text-slate-900">—</p>
              </div>
              <div class="rounded-xl border border-slate-200 bg-slate-50/80 px-4 py-3">
                <p class="text-xs font-semibold uppercase tracking-[0.18em] text-slate-500">Risk appetite</p>
                <p id="stat-risk" class="mt-1 text-sm font-semibold text-slate-900">—</p>
              </div>
              <div class="rounded-xl border border-slate-200 bg-slate-50/80 px-4 py-3">
                <p class="text-xs font-semibold uppercase tracking-[0.18em] text-slate-500">Strategies</p>
                <p id="stat-strategies" class="mt-1 text-sm font-semibold text-slate-900">—</p>
              </div>
            </div>
          </div>
          <div class="px-5 py-4">
            <div class="flex items-center justify-between mb-3">
              <div>
                <p class="text-xs font-semibold uppercase tracking-[0.24em] text-[var(--olive)]">Strategy mix</p>
                <h3 class="text-lg font-semibold text-slate-900">Active paper strategies</h3>
              </div>
              <span class="rounded-full bg-[var(--olive)]/10 px-3 py-1 text-xs font-semibold text-[var(--olive)]" id="strategy-pill">—</span>
            </div>
            <div id="strategies-list" class="flex flex-wrap gap-2 text-sm text-slate-700">
              <p class="text-slate-500">Fetching strategies…</p>
            </div>
          </div>
        </section>

        <section class="card col-span-12 lg:col-span-4 border border-slate-200 shadow-none">
          <div class="px-5 pt-5 pb-3 border-b border-slate-200">
            <p class="text-xs font-semibold uppercase tracking-[0.24em] text-[var(--olive)]">Demo account</p>
            <h3 class="text-lg font-semibold text-slate-900">Performance</h3>
            <p class="text-sm text-slate-600">Live metrics from your demo account.</p>
          </div>
          <dl class="px-5 py-4 space-y-3 text-sm text-slate-700">
            <div class="flex items-center justify-between rounded-xl border border-slate-200 bg-slate-50/80 px-4 py-3">
              <dt class="font-semibold">Account ID</dt>
              <dd id="stat-account" class="font-mono text-slate-900">—</dd>
            </div>
            <div class="flex items-center justify-between rounded-xl border border-slate-200 bg-slate-50/80 px-4 py-3">
              <dt class="font-semibold">Equity</dt>
              <dd id="stat-equity" class="font-semibold text-slate-900">—</dd>
            </div>
            <div class="flex items-center justify-between rounded-xl border border-slate-200 bg-slate-50/80 px-4 py-3">
              <dt class="font-semibold">P&amp;L</dt>
              <dd id="stat-pnl" class="font-semibold text-slate-900">—</dd>
            </div>
            <div class="flex items-center justify-between rounded-xl border border-slate-200 bg-slate-50/80 px-4 py-3">
              <dt class="font-semibold">Trades</dt>
              <dd id="stat-trades" class="font-semibold text-slate-900">—</dd>
            </div>
          </dl>
          <p id="updated-at" class="px-5 pb-5 text-xs text-slate-500">—</p>
        </section>

        <section id="status" class="col-span-12 hidden rounded-2xl border border-amber-200 bg-amber-50 px-5 py-4 text-sm text-amber-800 shadow-sm">
          <p id="status-text"></p>
        </section>
      </div>
    </main>
  </div>

  <script type="module" nonce="ALGOHIVE">
    import { supabase } from "/js/supabase.js";
    import { signOut as supaSignOut } from "/js/auth.js";

    const signOutBtn = document.getElementById("sign-out");
    const welcomeName = document.getElementById("welcome-name");
    const welcomeSub = document.getElementById("welcome-sub");
    const statBalance = document.getElementById("stat-balance");
    const statRisk = document.getElementById("stat-risk");
    const statStrategies = document.getElementById("stat-strategies");
    const strategyPill = document.getElementById("strategy-pill");
    const strategiesList = document.getElementById("strategies-list");
    const statAccount = document.getElementById("stat-account");
    const statEquity = document.getElementById("stat-equity");
    const statPnl = document.getElementById("stat-pnl");
    const statTrades = document.getElementById("stat-trades");
    const updatedAt = document.getElementById("updated-at");
    const statusBox = document.getElementById("status");
    const statusText = document.getElementById("status-text");
    const accountTypeLabel = document.getElementById("guard-account-type");

    const formatter = new Intl.NumberFormat("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 2 });

    function setStatus(message, tone = "info") {
      if (!statusBox || !statusText) return;
      statusText.textContent = message;
      statusBox.className = `col-span-12 rounded-2xl px-5 py-4 text-sm shadow-sm ${tone === "error" ? "border-rose-200 bg-rose-50 text-rose-800" : "border-amber-200 bg-amber-50 text-amber-800"}`;
      statusBox.classList.remove("hidden");
    }

    function clearStatus() {
      if (statusBox) statusBox.classList.add("hidden");
      if (statusText) statusText.textContent = "";
    }

    function formatMoney(value) {
      const num = typeof value === "number" ? value : Number(value);
      return Number.isFinite(num) ? formatter.format(num) : "—";
    }

    async function guard() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        location.replace(`/auth.html?redirect=${encodeURIComponent("/demo/dashboard.html")}`);
        return null;
      }
      const metaType = session.user?.user_metadata?.account_type;
      if (metaType !== "paper") {
        location.replace("/home.html");
        return null;
      }
      return session.user;
    }

    async function fetchDemoProfile(userId) {
      const { data, error } = await supabase
        .from("demo_profiles")
        .select("id, first_name, last_name, phone, risk_appetite, balance, strategies")
        .eq("id", userId)
        .maybeSingle();
      if (error) throw error;
      return data;
    }

    async function fetchDemoAccount(userId) {
      const { data, error } = await supabase
        .from("demo_accounts")
        .select("id, equity, pnl, trades, updated_at")
        .eq("id", userId)
        .maybeSingle();
      if (error) throw error;
      return data;
    }

    function renderProfile(profile = {}, fallbackEmail = "") {
      const fullName = [profile?.first_name, profile?.last_name].filter(Boolean).join(" ") || fallbackEmail || "Demo User";
      welcomeName.textContent = fullName;
      welcomeSub.textContent = profile?.phone ? `Reachable at ${profile.phone}.` : "Your paper portfolio snapshot is below.";
      statBalance.textContent = formatMoney(profile?.balance ?? 10000);
      statRisk.textContent = (profile?.risk_appetite || "Balanced").toString();
      const strategyCount = Array.isArray(profile?.strategies) ? profile.strategies.length : 0;
      statStrategies.textContent = strategyCount;
      strategyPill.textContent = `${strategyCount} active`;
      strategiesList.innerHTML = "";
      if (strategyCount > 0) {
        profile.strategies.forEach((name) => {
          const pill = document.createElement("span");
          pill.className = "rounded-full bg-[var(--olive)]/10 px-3 py-1 text-sm font-semibold text-[var(--olive)]";
          pill.textContent = name;
          strategiesList.appendChild(pill);
        });
      }
    }

    function renderAccount(account = {}, userId = "") {
      statAccount.textContent = account?.id || userId || "—";
      statEquity.textContent = formatMoney(account?.equity ?? account?.balance ?? "—");
      const pnlNum = typeof account?.pnl === "number" ? account.pnl : null;
      statPnl.textContent = pnlNum !== null ? `${pnlNum >= 0 ? "+" : ""}${formatMoney(pnlNum)}` : "—";
      const trades = typeof account?.trades === "number" ? account.trades : (Array.isArray(account?.trade_history) ? account.trade_history.length : null);
      statTrades.textContent = trades ?? "—";
      updatedAt.textContent = account?.updated_at ? `Updated ${new Date(account.updated_at).toLocaleString()}` : "Awaiting first sync.";
    }

    signOutBtn?.addEventListener("click", async () => {
      await supaSignOut();
    });

    (async function init() {
      try {
        const user = await guard();
        if (!user) return;
        clearStatus();
        accountTypeLabel.textContent = "Paper Account";

        const [profile, account] = await Promise.all([
          fetchDemoProfile(user.id).catch((err) => { setStatus("Could not fetch demo profile.", "error"); throw err; }),
          fetchDemoAccount(user.id).catch(() => null),
        ]);

        renderProfile(profile || {}, user.email || "");
        renderAccount(account || {}, user.id);
      } catch (error) {
        console.error(error);
        setStatus("We hit a snag loading your demo dashboard. Please try again.", "error");
      }
    })();
  </script>
</body>

</html>
