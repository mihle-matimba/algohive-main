<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AlgoHive — Sign in</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root {
      --olive: #7e8d52;
      --olive-700: #576138;
      --ink: #0B1215;
    }
    body { background: #f6f7f6; }
    .btn-shine { position: relative; overflow: hidden; transition: transform .25s ease, box-shadow .25s ease; }
    .btn-shine::before { content: ""; position: absolute; inset: 0; pointer-events: none; background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,.7) 50%, transparent 100%); transform: translateX(-120%); transition: transform .8s ease; }
    .btn-shine:hover::before { transform: translateX(120%); }
    .btn-shine:hover { transform: translateY(-1px); box-shadow: 0 10px 24px -16px rgba(11,18,21,0.4); }
    .btn-shine:disabled { box-shadow: none; transform: none; }
    .btn-shine:disabled::before { display: none; }
    .auth-left { animation: heroSlideUp .7s ease-out .25s both; }
    .auth-right { animation: heroScaleIn .9s cubic-bezier(.2,.8,.2,1) .35s both; }
    @keyframes heroScaleIn { 0% { transform: scale(1.06); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes heroSlideUp { 0% { transform: translateY(16px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
    .swap-anim { animation: heroSlideUp .5s ease both; }
    .testimonial-block {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      padding: 0.5rem 0;
    }
    .account-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      border-radius: 9999px;
      border: 1px solid #e5e7eb;
      background: #fff;
      padding: 0.55rem 0.95rem;
      font-weight: 600;
      font-size: 0.9rem;
      color: #0b1215;
      box-shadow: 0 10px 30px -22px rgba(11, 18, 21, 0.35);
      transition: all .2s ease;
    }
    .account-pill__dot {
      height: 10px;
      width: 10px;
      border-radius: 9999px;
      background: #d1d5db;
      box-shadow: 0 0 0 6px rgba(126,141,82,0.14);
      transition: all .2s ease;
    }
    .account-pill--active {
      border-color: rgba(126,141,82,0.7);
      background: linear-gradient(135deg, rgba(126,141,82,0.12), rgba(126,141,82,0.05));
      color: #2f361d;
    }
    .account-pill--active .account-pill__dot {
      background: var(--olive);
      box-shadow: 0 0 0 8px rgba(126,141,82,0.18);
    }
    .account-pill:hover { border-color: rgba(126,141,82,0.55); transform: translateY(-1px); }
    .account-pill:focus-visible { outline: 2px solid rgba(126,141,82,0.4); outline-offset: 2px; }
    .testimonial-quote {
      font-size: clamp(1.4rem, 2.3vw, 1.85rem);
      line-height: 1.4;
      font-weight: 600;
      color: #0b1215;
    }
    .testimonial-quote .highlight {
      color: var(--olive);
    }
    .testimonial-author {
      display: flex;
      align-items: center;
      gap: 0.85rem;
      color: rgba(11,18,21,0.64);
    }
    .testimonial-avatar {
      height: 52px;
      width: 52px;
      border-radius: 9999px;
      object-fit: cover;
      flex-shrink: 0;
      box-shadow: 0 14px 40px -22px rgba(11, 18, 21, 0.45);
    }
    .testimonial-initials {
      display: grid;
      place-items: center;
      height: 52px;
      width: 52px;
      border-radius: 9999px;
      background: linear-gradient(135deg, rgba(126,141,82,0.9), rgba(126,141,82,0.65));
      color: #0b1215;
      font-weight: 600;
      letter-spacing: 0.08em;
      box-shadow: 0 14px 40px -22px rgba(126,141,82,0.55);
    }
    .orb-gradient {
      background-image: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.75), rgba(255,255,255,0) 60%),
                        radial-gradient(circle at 80% 20%, rgba(126,141,82,0.18), rgba(255,255,255,0) 55%),
                        radial-gradient(circle at 50% 80%, rgba(126,141,82,0.12), rgba(255,255,255,0) 55%);
    }
  </style>
  <script nonce="ALGOHIVE">
    window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
  </script>
  <script defer src="/_vercel/insights/script.js"></script>
</head>

<body class="min-h-screen antialiased text-slate-900">
  <div class="flex min-h-screen flex-col bg-transparent lg:flex-row lg:items-stretch">
    <!-- Left: Auth -->
    <main class="auth-left relative mx-auto w-full max-w-2xl bg-white px-6 py-12 shadow-sm sm:px-10 sm:py-14 lg:flex lg:min-h-screen lg:max-w-lg lg:flex-col lg:justify-between lg:px-16 lg:py-20 lg:shadow">
      <!-- Brand -->
      <div class="flex items-center gap-2">
        <img src="https://static.wixstatic.com/media/ac771e_af06d86a7a1f4abd87e52e45f3bcbd96~mv2.png" alt="AlgoHive" class="h-8 w-auto" />
        <span class="text-lg font-semibold tracking-tight text-[var(--ink)]">AlgoHive</span>
      </div>

      <!-- Auth content -->
      <div class="mt-10 flex-1 lg:mt-16">
        <header class="mb-9 space-y-3">
          <div id="heading-in" class="space-y-2">
            <p class="text-xs font-semibold uppercase tracking-[0.35em] text-[var(--olive)]">Welcome back</p>
            <h1 class="text-3xl font-semibold text-slate-900 sm:text-[34px]">Sign in to AlgoHive</h1>
            <p class="text-sm text-slate-500">Need to register? <button id="switch-to-signup" type="button" class="font-semibold text-[var(--olive)] hover:text-[var(--olive-700)]">Sign up.</button></p>
          </div>
          <div id="heading-up" class="hidden space-y-2">
            <p class="text-xs font-semibold uppercase tracking-[0.35em] text-[var(--olive)]">Join the hive</p>
            <h1 class="text-3xl font-semibold text-slate-900 sm:text-[34px]">Create your account</h1>
            <p class="text-sm text-slate-500">Already have an account? <button id="switch-to-signin" type="button" class="font-semibold text-[var(--olive)] hover:text-[var(--olive-700)]">Log in.</button></p>
          </div>
        </header>

        <section class="mb-8 space-y-3">
          <div class="flex flex-wrap items-center gap-2 text-xs font-semibold uppercase tracking-[0.28em] text-[var(--olive)]">
            <span>Account mode</span>
            <span class="h-[1px] w-10 bg-[var(--olive)]/30"></span>
          </div>
        <div class="flex flex-wrap gap-3">
          <button type="button" class="account-pill" data-account="paper">
            <span class="account-pill__dot" aria-hidden="true"></span>
            Demo Account
          </button>
          <button type="button" class="account-pill" data-account="live">
            <span class="account-pill__dot" aria-hidden="true"></span>
            Live Account
          </button>
        </div>
        <p id="live-note" class="hidden text-sm font-semibold text-amber-700">Will Require Additional Verification</p>
        <p id="live-status" class="hidden text-sm font-semibold text-rose-700">currently under maintenance</p>
      </section>

        <!-- Messages -->
        <div id="msg" class="hidden mb-5 max-w-md rounded-lg border px-3 py-2 text-sm text-left"></div>

        <!-- Sign in -->
        <section id="panel-in" class="space-y-8">
          <form id="login-form" class="space-y-5 text-left sm:max-w-md">
            <div class="space-y-2">
              <label class="text-sm font-medium text-slate-700" for="login-email">Email or username</label>
              <input id="login-email" name="email" type="email" placeholder="john@company.com" class="w-full rounded-2xl border border-slate-200/80 bg-white px-4 py-3 text-sm shadow-sm transition focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[rgba(126,141,82,0.25)]" required />
            </div>
            <div class="space-y-2">
              <div class="flex items-center justify-between text-sm">
                <label class="font-medium text-slate-700" for="login-password">Password</label>
                <button id="forgot" type="button" class="font-medium text-[var(--olive)] hover:text-[var(--olive-700)]">Forgot password?</button>
              </div>
              <input id="login-password" name="password" type="password" placeholder="••••••••" class="w-full rounded-2xl border border-slate-200/80 bg-white px-4 py-3 text-sm shadow-sm transition focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[rgba(126,141,82,0.25)]" required />
            </div>
            <button type="submit" class="btn-shine w-full rounded-2xl bg-[var(--olive)] px-4 py-3 text-sm font-semibold text-white shadow-sm transition hover:bg-[var(--olive-700)]">Log in</button>
          </form>
        </section>

        <!-- Inline forgot form -->
        <div id="forgot-wrap" class="mt-8 hidden w-full max-w-md rounded-2xl border border-slate-200 bg-slate-50/70 p-5">
          <h2 class="mb-3 text-sm font-semibold text-slate-700">Reset password</h2>
          <form id="forgot-form" class="space-y-3">
            <div class="space-y-1">
              <label class="text-xs font-medium text-slate-600" for="forgot-email">Email</label>
              <input id="forgot-email" name="email" type="email" placeholder="you@example.com" class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm shadow-sm transition focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[rgba(126,141,82,0.25)]" required />
            </div>
            <div class="flex flex-col gap-2 sm:flex-row">
              <button type="submit" class="btn-shine flex-1 rounded-2xl bg-[var(--olive)] px-4 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-[var(--olive-700)]">Send reset link</button>
              <button type="button" id="forgot-cancel" class="rounded-2xl border border-slate-200 px-4 py-2.5 text-sm font-semibold text-slate-600 hover:border-slate-300">Cancel</button>
            </div>
          </form>
        </div>

        <!-- Sign up -->
        <section id="panel-up" class="hidden space-y-6">
          <form id="signup-form" class="space-y-5 text-left sm:max-w-md">
            <div class="space-y-2">
              <label class="text-sm font-medium text-slate-700" for="signup-email">Email</label>
              <input id="signup-email" name="email" type="email" placeholder="john@company.com" class="w-full rounded-2xl border border-slate-200/80 bg-white px-4 py-3 text-sm shadow-sm transition focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[rgba(126,141,82,0.25)]" required />
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-slate-700" for="signup-password">Password</label>
              <input id="signup-password" name="password" type="password" placeholder="At least 6 characters" class="w-full rounded-2xl border border-slate-200/80 bg-white px-4 py-3 text-sm shadow-sm transition focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[rgba(126,141,82,0.25)]" required />
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-slate-700" for="signup-confirm-password">Confirm password</label>
              <input id="signup-confirm-password" name="confirm_password" type="password" placeholder="Re-enter your password" class="w-full rounded-2xl border border-slate-200/80 bg-white px-4 py-3 text-sm shadow-sm transition focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[rgba(126,141,82,0.25)]" required />
              <p id="confirm-hint" class="hidden text-xs font-medium text-rose-600">Passwords must match.</p>
            </div>
            <label class="flex items-start gap-3 rounded-2xl bg-slate-50/90 p-4 text-xs text-slate-600">
              <input id="agree" type="checkbox" class="mt-0.5 h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]" />
              <span>
                I agree to the
                <a href="/terms.html" class="font-semibold text-[var(--olive)] hover:text-[var(--olive-700)]">Terms &amp; Conditions</a>,
                <a href="/privacy.html" class="font-semibold text-[var(--olive)] hover:text-[var(--olive-700)]">Privacy Policy</a>,
                <a href="/risk.html" class="font-semibold text-[var(--olive)] hover:text-[var(--olive-700)]">Risk Disclosure</a>, and
                <a href="/investment-disclaimer.html" class="font-semibold text-[var(--olive)] hover:text-[var(--olive-700)]">Investment Disclaimer</a>.
              </span>
            </label>
            <button id="signup-btn" type="submit" class="btn-shine w-full rounded-2xl bg-[var(--olive)] px-4 py-3 text-sm font-semibold text-white shadow-sm transition hover:bg-[var(--olive-700)] disabled:cursor-not-allowed disabled:opacity-60" disabled>
              Start with a demo account
            </button>
            <p class="text-[11px] leading-relaxed text-slate-500">We’ll email a confirmation link to activate your account.</p>
          </form>
        </section>
      </div>

      <!-- Notice -->
      <footer class="mt-14 border-t border-slate-100 pt-6 text-left text-[11px] leading-5 text-slate-500">
      AlgoHive (Pty) Ltd is an authorised Financial Services Provider (<b>FSP 55118</b>) regulated by the Financial Sector Conduct Authority and a registered Credit Provider (<b>NCRCP22892</b>) under the National Credit Act. All investment activity carries risk, including the possible loss of capital and liquidity constraints. Any information provided here is educational in nature, does not constitute personalised financial advice, and should not be relied on as a recommendation to buy or sell securities. Please consider whether investing is appropriate for your circumstances and consult an independent adviser where necessary.
      </footer>
    </main>

    <!-- Right: Preview -->
    <aside class="auth-right relative hidden w-full bg-[#f7f9ff] px-6 py-14 shadow-inner lg:flex lg:flex-1 lg:items-stretch lg:rounded-none lg:px-20 lg:py-20">
      <div class="absolute inset-0 orb-gradient opacity-95"></div>
      <div class="relative z-10 mx-auto flex w-full max-w-4xl flex-1 items-center justify-center">
        <div id="authLogoSphere" class="flex w-full max-w-[620px] items-center justify-center">
          <div class="w-full aspect-square" id="authSphereRoot"></div>
        </div>
      </div>
    </aside>
  </div>

  <script type="text/babel" nonce="ALGOHIVE">
    const { useEffect, useRef, useState } = React;

    const SUPABASE_URL = "https://aazofjsssobejhkyyiqv.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhem9manNzc29iZWpoa3l5aXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMTI1NDUsImV4cCI6MjA3MzY4ODU0NX0.guYlxaV5RwTlTVFoUhpER0KWEIGPay8svLsxMwyRUyM";

    const defaultSphereImages = [
      { id: "apple", src: "https://logo.clearbit.com/apple.com" },
      { id: "microsoft", src: "https://logo.clearbit.com/microsoft.com" },
      { id: "google", src: "https://logo.clearbit.com/google.com" },
      { id: "amazon", src: "https://logo.clearbit.com/amazon.com" },
      { id: "nvidia", src: "https://logo.clearbit.com/nvidia.com" },
      { id: "meta", src: "https://logo.clearbit.com/meta.com" },
      { id: "visa", src: "https://logo.clearbit.com/visa.com" },
      { id: "netflix", src: "https://logo.clearbit.com/netflix.com" },
      { id: "jpmorgan", src: "https://logo.clearbit.com/jpmorganchase.com" },
      { id: "coca-cola", src: "https://logo.clearbit.com/coca-cola.com" },
      { id: "nike", src: "https://logo.clearbit.com/nike.com" },
      { id: "disney", src: "https://logo.clearbit.com/disney.com" },
      { id: "naspers", src: "https://s3-symbol-logo.tradingview.com/naspers--big.svg" },
      { id: "capitec", src: "https://s3-symbol-logo.tradingview.com/capitec-bank-hldgs-ltd--big.svg" },
      { id: "mtn", src: "https://logo.clearbit.com/mtn.com" },
      { id: "vodacom", src: "https://s3-symbol-logo.tradingview.com/vodafone--big.svg" },
      { id: "discovery", src: "https://logo.clearbit.com/discovery.co.za" },
      { id: "bitcoin", src: "https://cryptologos.cc/logos/bitcoin-btc-logo.png" },
      { id: "ethereum", src: "https://cryptologos.cc/logos/ethereum-eth-logo.png" },
      { id: "solana", src: "https://cryptologos.cc/logos/solana-sol-logo.png" },
      { id: "shoprite", src: "https://logo.clearbit.com/shoprite.co.za" },
      { id: "picknpay", src: "https://logo.clearbit.com/picknpay.co.za" },
      { id: "woolworths", src: "https://logo.clearbit.com/woolworths.co.za" },
      { id: "sasol", src: "https://logo.clearbit.com/sasol.com" },
      { id: "anglo-american", src: "https://logo.clearbit.com/angloamerican.com" },
      { id: "sanlam", src: "https://logo.clearbit.com/sanlam.co.za" },
      { id: "bidvest", src: "https://logo.clearbit.com/bidvest.com" },
      { id: "mastercard", src: "https://logo.clearbit.com/mastercard.com" },
    ];

    const supabase = window.supabase?.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY,
      {
        auth: { persistSession: false, autoRefreshToken: false },
        global: {
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          },
        },
      }
    );
    const TRADING_LOGOS_KEY = "ah_trading_universe_logos";

    const normalizeLogos = (rows) => {
      const seen = new Set();

      return rows
        .map((row) => ({
          id: (row.symbol || `logo-${row.id}`).toLowerCase(),
          src: row.logo,
        }))
        .filter((row) => typeof row.src === 'string' && row.src.trim().startsWith('http'))
        .filter(({ src }) => {
          if (seen.has(src)) return false;
          seen.add(src);
          return true;
        });
    };

    const fetchCachedLogos = () => {
      try {
        const cached = sessionStorage.getItem(TRADING_LOGOS_KEY);
        if (!cached) return null;

        const parsed = JSON.parse(cached);
        const cachedLogos = normalizeLogos(
          parsed?.source === 'trading_universe' && Array.isArray(parsed.logos)
            ? parsed.logos
            : []
        );

        return cachedLogos.length ? cachedLogos : null;
      } catch (err) {
        console.warn("Unable to read cached trading logos", err);
        return null;
      }
    };

    async function fetchTradingLogos() {
      const cached = fetchCachedLogos();
      if (cached) return cached;

      if (!supabase) return defaultSphereImages;

      const { data, error } = await supabase
        .from('trading_universe')
        .select('id, symbol, logo')
        .not('logo', 'is', null)
        .neq('logo', '')
        .order('symbol', { ascending: true })
        .limit(120);

      if (error || !data?.length) return defaultSphereImages;

      const logos = normalizeLogos(data);

      if (logos.length) {
        try {
          sessionStorage.setItem(
            TRADING_LOGOS_KEY,
            JSON.stringify({ source: 'trading_universe', logos })
          );
        } catch (err) {
          console.warn("Unable to cache trading logos", err);
        }
      }

      return logos.length ? logos : defaultSphereImages;
    }

    const Sphere = ({ images, size = 720 }) => {
      const [rot, setRot] = useState({ x: 15, y: 0 });
      const [vel, setVel] = useState({ x: 0, y: 0 });
      const [dragging, setDragging] = useState(false);
      const [points, setPoints] = useState([]);
      const last = useRef({ x: 0, y: 0 });

      const radius = size * 0.45;
      const baseSize = size * 0.14;

      useEffect(() => {
        const pts = [];
        const count = images.length;
        const phi = Math.PI * (3 - Math.sqrt(5));

        for (let i = 0; i < count; i++) {
          const y = 1 - (i / (count - 1)) * 2;
          const r = Math.sqrt(1 - y * y);
          const theta = phi * i;
          pts.push({
            x: Math.cos(theta) * r * radius,
            y: y * radius,
            z: Math.sin(theta) * r * radius,
          });
        }
        setPoints(pts);
      }, [images.length, radius]);

      useEffect(() => {
        let id;
        const loop = () => {
          if (!dragging) {
            setVel((v) => ({ x: v.x * 0.97, y: v.y * 0.97 }));
            setRot((r) => ({
              x: r.x + vel.x,
              y: r.y + vel.y + 0.1,
            }));
          }
          id = requestAnimationFrame(loop);
        };
        id = requestAnimationFrame(loop);
        return () => cancelAnimationFrame(id);
      }, [dragging, vel.x, vel.y]);

      const start = (e) => {
        setDragging(true);
        setVel({ x: 0, y: 0 });
        const x = e.clientX || e.touches?.[0]?.clientX || 0;
        const y = e.clientY || e.touches?.[0]?.clientY || 0;
        last.current = { x, y };
      };

      const move = (e) => {
        if (!dragging) return;
        const x = e.clientX || e.touches?.[0]?.clientX || 0;
        const y = e.clientY || e.touches?.[0]?.clientY || 0;
        const dx = x - last.current.x;
        const dy = y - last.current.y;

        setRot((r) => ({
          x: r.x - dy * 0.45,
          y: r.y + dx * 0.45,
        }));
        setVel({ x: -dy * 0.35, y: dx * 0.35 });
        last.current = { x, y };
      };

      const end = () => setDragging(false);

      const project = (p) => {
        let { x, y, z } = p;
        const rx = (rot.x * Math.PI) / 180;
        const ry = (rot.y * Math.PI) / 180;

        const tx = x * Math.cos(ry) + z * Math.sin(ry);
        z = -x * Math.sin(ry) + z * Math.cos(ry);
        x = tx;

        const ty = y * Math.cos(rx) - z * Math.sin(rx);
        z = y * Math.sin(rx) + z * Math.cos(rx);
        y = ty;

        const scale = 1 + z / (radius * 3);
        const visible = z > -radius * 0.7;

        return {
          x,
          y,
          scale: Math.max(0.45, scale),
          visible,
          opacity: visible ? Math.max(0.5, (z + radius) / (radius * 1.5)) : 0,
          zIndex: Math.round(z),
        };
      };

      return (
        <div
          className={`relative ${dragging ? "cursor-grabbing" : "cursor-grab"} select-none`}
          style={{ width: size, height: size }}
          onMouseDown={start}
          onMouseMove={move}
          onMouseUp={end}
          onMouseLeave={end}
          onTouchStart={start}
          onTouchMove={move}
          onTouchEnd={end}
        >
          {points.map((p, i) => {
            const proj = project(p);
            if (!proj.visible) return null;
            const s = baseSize * proj.scale;

            return (
              <div
                key={images[i].id}
                className="absolute"
                style={{
                  width: s,
                  height: s,
                  left: size / 2 + proj.x,
                  top: size / 2 + proj.y,
                  transform: "translate(-50%, -50%)",
                  opacity: proj.opacity,
                  zIndex: 1000 + proj.zIndex,
                }}
              >
                <div className="w-full h-full rounded-full overflow-hidden shadow-2xl bg-white p-4">
                  <img
                    src={images[i].src}
                    className="w-full h-full object-contain"
                    draggable={false}
                    loading="lazy"
                    alt={images[i].id}
                  />
                </div>
              </div>
            );
          })}
        </div>
      );
    };

    const getSphereSize = () => {
      const width = window.innerWidth;
      if (width >= 1536) return 720;
      if (width >= 1280) return 620;
      if (width >= 1024) return 540;
      return 420;
    };

    const SphereWrapper = () => {
      const [size, setSize] = useState(getSphereSize());
      const [images, setImages] = useState(defaultSphereImages);

      useEffect(() => {
        const handleResize = () => setSize(getSphereSize());
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);

      useEffect(() => {
        let isMounted = true;

        fetchTradingLogos()
          .then((logos) => {
            if (isMounted && logos?.length) {
              setImages(logos);
            }
          })
          .catch(() => {
            /* keep defaultSphereImages on failure */
          });

        return () => {
          isMounted = false;
        };
      }, []);

      return <Sphere images={images} size={size} />;
    };

    const root = document.getElementById("authSphereRoot");
    if (root) {
      ReactDOM.createRoot(root).render(<SphereWrapper />);
    }
  </script>

  <script type="module" nonce="ALGOHIVE">
    import { signIn, signUp } from "/js/auth.js";
    import { supabase } from "/js/supabase.js";

    let demoSupportsAvatar = true;

    // --- SAME COMPLETENESS RULE AS SETTINGS ---
    const REQUIRED_FIELDS = [
      "first_name",
      "last_name",
      "phone",
      "dob",
      "id_number",
      "nationality",
      "country_residence",
      "employment_status",
      "occupation",
      "employer",
      "income_bracket",
      "source_of_funds",
      "net_worth_range",
      "experience_level",
      "risk_tolerance",
      "objectives"
    ];
    const REQUIRE_KYC = false; // flip to true if you want KYC to be required to be “complete”

    function resolveKycBoolean(row){
      const v = row?.kyc_status;
      if (typeof v === "boolean") return v;
      if (typeof v === "string") {
        const t = v.toLowerCase();
        return ["verified","approved","done","passed","kyc_done"].includes(t);
      }
      return false;
    }

    function computeProfileComplete(row){
      const core = REQUIRED_FIELDS.every(k => String(row?.[k] ?? "").trim().length > 0);
      return REQUIRE_KYC ? (core && resolveKycBoolean(row)) : core;
    }

    function gateBannerMessage(profileComplete, kycDone) {
      if (!profileComplete && !kycDone) return "Please finish Additional Info and complete KYC first.";
      if (!profileComplete) return "Please finish Additional Info first.";
      if (!kycDone) return "Please complete KYC first.";
      return "";
    }

    async function fetchLiveProfileBasics(user) {
      if (!user) return {};
      const emailAddress = (user?.email || "").trim();
      let query = supabase.from("profiles").select("first_name, last_name, phone, avatar_url");
      query = emailAddress ? query.eq("email", emailAddress) : query.eq("id", user.id);
      const { data, error } = await query.maybeSingle();
      if (error && error.code !== "PGRST116") throw error;
      return data || {};
    }

    async function fetchDemoProfileBasics(user) {
      if (!user) return null;
      const selectCols = demoSupportsAvatar
        ? "id, first_name, last_name, phone, avatar_url, risk_appetite"
        : "id, first_name, last_name, phone, risk_appetite";

      const { data, error } = await supabase
        .from("demo_profiles")
        .select(selectCols)
        .eq("id", user.id)
        .maybeSingle();

      if (error && error.code === "42703") {
        const fallbackCols = demoSupportsAvatar
          ? "id, first_name, last_name, phone, avatar_url"
          : "id, first_name, last_name, phone";

        const { data: fallbackData, error: fallbackErr } = await supabase
          .from("demo_profiles")
          .select(fallbackCols)
          .eq("id", user.id)
          .maybeSingle();

        if (fallbackErr && fallbackErr.code !== "PGRST116") throw fallbackErr;
        if (!fallbackData && demoSupportsAvatar) {
          demoSupportsAvatar = false;
          return fetchDemoProfileBasics(user);
        }
        return fallbackData || null;
      }

      if (error && error.code !== "PGRST116") throw error;
      return data || null;
    }

    async function ensureDemoProfile(accountTypeValue = "paper", liveProfile = {}) {
      if (accountTypeValue !== "paper") return null;
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return null;

      const meta = user.user_metadata || {};

      const selectCols = demoSupportsAvatar
        ? "id, account_mode, first_name, last_name, phone, avatar_url, risk_appetite, balance, allocated, strategies, watch_list"
        : "id, account_mode, first_name, last_name, phone, risk_appetite, balance, allocated, strategies, watch_list";

      try {
        const { data: existing, error: existingErr } = await supabase
          .from("demo_profiles")
          .select(selectCols)
          .eq("id", user.id)
          .maybeSingle();

        if (existingErr && existingErr.code === "42703" && demoSupportsAvatar) {
          demoSupportsAvatar = false;
          return ensureDemoProfile(accountTypeValue, liveProfile);
        }

        if (existingErr && existingErr.code !== "PGRST116") throw existingErr;
        if (existing) return existing;
      } catch (err) {
        console.warn("Unable to read existing demo profile", err);
      }

      let profileFallback = liveProfile;
      if (!profileFallback || Object.keys(profileFallback).length === 0) {
        try {
          profileFallback = await fetchLiveProfileBasics(user);
        } catch (err) {
          console.warn("Unable to fetch live profile for demo defaults", err);
        }
      }

      const payloadBase = {
        id: user.id,
        account_mode: "paper",
        first_name: meta.first_name || profileFallback?.first_name || "Demo",
        last_name: meta.last_name || profileFallback?.last_name || "User",
        phone: meta.phone || profileFallback?.phone || null,
        risk_appetite: meta.risk_appetite || "balanced",
        balance: typeof meta.balance === "number" ? meta.balance : 10000,
        allocated: typeof meta.allocated === "number" ? meta.allocated : 0,
        strategies: Array.isArray(meta.strategies) ? meta.strategies : [],
        watch_list: Array.isArray(meta.watch_list) ? meta.watch_list : [],
      };

      const payload = demoSupportsAvatar
        ? { ...payloadBase, avatar_url: meta.avatar_url || profileFallback?.avatar_url || null }
        : payloadBase;

      const strippedPayload = demoSupportsAvatar
        ? {
            id: user.id,
            account_mode: "paper",
            first_name: payloadBase.first_name,
            last_name: payloadBase.last_name,
            phone: payloadBase.phone,
            avatar_url: payload.avatar_url,
          }
        : {
            id: user.id,
            account_mode: "paper",
            first_name: payloadBase.first_name,
            last_name: payloadBase.last_name,
            phone: payloadBase.phone,
          };

      const { data, error } = await supabase
        .from("demo_profiles")
        .insert(payload)
        .select("*")
        .maybeSingle();

      if (error && error.code === "42703") {
        if (demoSupportsAvatar) demoSupportsAvatar = false;
        const { data: fallbackData, error: fallbackErr } = await supabase
          .from("demo_profiles")
          .insert(strippedPayload)
          .select("*")
          .maybeSingle();
        if (fallbackErr) throw fallbackErr;
        return fallbackData || strippedPayload;
      }

      if (error) throw error;
      return data || payload;
    }

    function hasDemoBasics(profile = {}) {
      const required = ["first_name", "last_name", "phone"];
      return required.every((key) => {
        const val = profile?.[key];
        return typeof val === "string" ? val.trim().length > 0 : Boolean(val);
      });
    }

    async function hasLiveBrokerageAccount(user) {
      if (!user) return false;
      const emailAddress = (user?.email || "").trim();
      let query = supabase.from("alpaca_accounts").select("id, alpaca_account_id").limit(1);
      query = emailAddress ? query.eq("email", emailAddress) : query.eq("user_id", user.id);
      const { data, error } = await query.maybeSingle();
      if (error && error.code !== "PGRST116") throw error;
      const row = data || {};
      return Boolean(row?.alpaca_account_id || row?.id);
    }

    async function routePostAuth(preferred = "/home.html", accountTypeValue = "live") {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return; // email-confirm signup path
      try { sessionStorage.setItem("ah_account_type", accountTypeValue); } catch (err) { console.warn("Unable to cache account type", err); }

      try {
        await supabase.auth.updateUser({ data: { account_type: accountTypeValue } });
      } catch (err) {
        console.warn("Unable to persist account type on auth user", err);
      }

      const destination = accountTypeValue === "paper" ? "/demo/dashboard.html" : (preferred || "/home.html");

      if (accountTypeValue === "paper") {
        let liveProfile = {};
        let demoProfile = null;
        let liveAccount = false;
        try {
          liveProfile = await fetchLiveProfileBasics(session.user);
        } catch (err) {
          console.warn("Unable to load live profile for demo onboarding", err);
        }

        try {
          demoProfile = await fetchDemoProfileBasics(session.user);
        } catch (err) {
          console.warn("Unable to read demo profile", err);
        }

        if (!demoProfile || !demoProfile.id) {
          location.replace("/demo/onboarding.html");
          return;
        }

        try {
          demoProfile = await ensureDemoProfile(accountTypeValue, { ...liveProfile, ...demoProfile });
        } catch (err) {
          console.warn("Unable to ensure demo profile exists", err);
        }

        try {
          liveAccount = await hasLiveBrokerageAccount(session.user);
        } catch (err) {
          console.warn("Unable to verify live brokerage account", err);
        }

        const basics = hasDemoBasics({ ...liveProfile, ...demoProfile });
        if (!liveAccount && !basics) {
          location.replace("/demo/onboarding.html");
          return;
        }

        location.replace(destination);
        return;
      }

      const selectCols = [...REQUIRED_FIELDS, "kyc_status"].join(",");
      let profileComplete = false;
      let kycDone = false;
      try {
        const { data } = await supabase
          .from("profiles")
          .select(selectCols)
          .eq("id", session.user.id)
          .maybeSingle();
        const row = data || {};
        profileComplete = computeProfileComplete(row);
        kycDone = resolveKycBoolean(row);
      } catch (error) {
        console.warn("Could not fetch profile for routing", error);
      }

      if (!profileComplete || !kycDone) {
        const message = gateBannerMessage(profileComplete, kycDone);
        try {
          if (message) sessionStorage.setItem("ah_gate_reason", message);
        } catch (err) {
          console.warn("Unable to persist gate reason", err);
        }
        location.replace(`/onboarding.html`);
        return;
      }

      location.replace(destination);
    }

    const qs = new URLSearchParams(location.search);
    const redirectTo = qs.get("redirect") || "/home.html";

    // elems
    const headingIn = document.getElementById("heading-in");
    const headingUp = document.getElementById("heading-up");
    const panelIn = document.getElementById("panel-in");
    const panelUp = document.getElementById("panel-up");
    const switchToSignup = document.getElementById("switch-to-signup");
    const switchToSignin = document.getElementById("switch-to-signin");
    const fIn = document.getElementById("login-form");
    const fUp = document.getElementById("signup-form");
    const msg = document.getElementById("msg");
    const forgot = document.getElementById("forgot");
    const forgotWrap = document.getElementById("forgot-wrap");
    const forgotForm = document.getElementById("forgot-form");
    const forgotCancel = document.getElementById("forgot-cancel");
    const agree = document.getElementById("agree");
    const signupBtn = document.getElementById("signup-btn");
    const signupEmail = document.getElementById("signup-email");
    const signupPassword = document.getElementById("signup-password");
    const signupConfirm = document.getElementById("signup-confirm-password");
    const confirmHint = document.getElementById("confirm-hint");
    const liveNote = document.getElementById("live-note");
    const liveStatus = document.getElementById("live-status");
    const accountButtons = Array.from(document.querySelectorAll("[data-account]"));
    const inBtn = fIn.querySelector('button[type="submit"]');
    let accountType = "live";
    let currentTab = "in";

    // ---- UI helpers ----
    function updateLiveNote() {
      if (!liveNote) return;
      const show = accountType === "live" && currentTab === "up";
      liveNote.classList.toggle("hidden", !show);
      liveNote.textContent = show ? "Will Require Additional Verification" : "";
      const liveMaintenance = accountType === "live";
      if (liveStatus) {
        liveStatus.classList.toggle("hidden", !liveMaintenance);
        liveStatus.textContent = liveMaintenance ? "currently under maintenance" : "";
      }
      if (inBtn) {
        inBtn.disabled = liveMaintenance;
        inBtn.textContent = liveMaintenance ? "Unavailable (maintenance)" : "Log in";
      }
    }

    function setAccountType(type = "live") {
      accountType = type;
      try { localStorage.setItem("ah_account_type", type); } catch (_) {}
      accountButtons.forEach((btn) => {
        const active = btn.dataset.account === type;
        btn.classList.toggle("account-pill--active", active);
        btn.setAttribute("aria-pressed", active ? "true" : "false");
      });
      updateLiveNote();
    }

    async function hydrateAccountType() {
      const stored = (() => {
        try { return localStorage.getItem("ah_account_type"); } catch (_) { return null; }
      })();
      let metaType = null;

      try {
        const { data: { session } } = await supabase.auth.getSession();
        metaType = session?.user?.user_metadata?.account_type;
      } catch (err) {
        console.warn("Unable to read auth metadata for account type", err);
      }

      const resolved = [metaType, stored, "live"].find((v) => v === "paper" || v === "live");
      setAccountType(resolved || "live");
      return resolved || "live";
    }

    function showMsg(text, type = "info") { // "success" | "error" | "info"
      msg.classList.remove("hidden","bg-rose-50","text-rose-700","border-rose-200","bg-emerald-50","text-emerald-700","border-emerald-200");
      if (type === "success") msg.classList.add("bg-emerald-50","text-emerald-700","border-emerald-200");
      if (type === "error")   msg.classList.add("bg-rose-50","text-rose-700","border-rose-200");
      msg.textContent = text;
    }
    function clearMsg() { msg.classList.add("hidden"); msg.textContent = ""; }
    function setLoading(btn, on, idle, busy) { btn.disabled = on; btn.textContent = on ? busy : idle; }

    function animateSwap(...els) {
      els.forEach((el) => {
        if (!el) return;
        el.classList.remove("swap-anim");
        void el.offsetWidth;
        el.classList.add("swap-anim");
      });
    }

    function show(tab) {
      clearMsg();
      currentTab = tab;
      const up = tab === "up";
      const toShowPanel = up ? panelUp : panelIn;
      const toHidePanel = up ? panelIn : panelUp;
      const toShowHeading = up ? headingUp : headingIn;
      const toHideHeading = up ? headingIn : headingUp;

      toHidePanel.classList.add("hidden");
      toHideHeading.classList.add("hidden");

      toShowPanel.classList.remove("hidden");
      toShowHeading.classList.remove("hidden");

      animateSwap(toShowPanel, toShowHeading);
      forgot.classList.toggle("hidden", up);
      forgotWrap.classList.add("hidden");
      updateLiveNote();
    }

    switchToSignup?.addEventListener("click", () => show("up"));
    switchToSignin?.addEventListener("click", () => show("in"));
    accountButtons.forEach((btn) => btn.addEventListener("click", () => setAccountType(btn.dataset.account)));
    const hydratedAccountType = await hydrateAccountType();

    // enable/disable signup by checkbox
    const passwordsMatch = () => signupConfirm.value === signupPassword.value;

    const validatePasswords = () => {
      const hasConfirm = Boolean(signupConfirm.value);
      const match = passwordsMatch();

      if (!hasConfirm) {
        signupConfirm.setCustomValidity("");
        confirmHint?.classList.add("hidden");
        return true;
      }

      signupConfirm.setCustomValidity(match ? "" : "Passwords do not match.");
      if (confirmHint) {
        confirmHint.textContent = match ? "" : "Passwords must match.";
        confirmHint.classList.toggle("hidden", match);
      }
      return match;
    };

    signupPassword.addEventListener("input", validatePasswords);
    signupConfirm.addEventListener("input", validatePasswords);

    const toggleSignupBtn = () => {
      validatePasswords();
      const disabled = !agree.checked || !signupConfirm.value || !signupPassword.value || !passwordsMatch();
      signupBtn.disabled = disabled;
    };
    agree.addEventListener("change", toggleSignupBtn);
    signupPassword.addEventListener("input", toggleSignupBtn);
    signupConfirm.addEventListener("input", toggleSignupBtn);
    toggleSignupBtn();

    // ---- Sign in ----
    fIn.addEventListener("submit", async (e) => {
      e.preventDefault(); clearMsg();
      const email = e.target.email.value.trim();
      const password = e.target.password.value;
      try {
        setLoading(inBtn, true, "Log in", "Logging in…");
        const { user } = await signIn(email, password) ?? {};
        const metaType = user?.user_metadata?.account_type;
        const effectiveType = [accountType, metaType, hydratedAccountType, "live"].find((v) => v === "paper" || v === "live");
        showMsg("Signed in. Redirecting…", "success");
        await routePostAuth(redirectTo, effectiveType || "live");
      } catch (err) {
        showMsg(err.message || "Sign in failed.", "error");
      } finally {
        setLoading(inBtn, false, "Log in");
      }
    });

    // ---- Sign up ----
    fUp.addEventListener("submit", async (e) => {
      e.preventDefault(); clearMsg();
      if (!agree.checked) { showMsg("Please accept the Terms, Privacy, Risk and Investment Disclaimer.", "error"); return; }
      const email = e.target.email.value.trim();
      const password = e.target.password.value;
      const confirm = e.target.confirm_password.value;
      if (password !== confirm) {
        showMsg("Passwords must match.", "error");
        signupConfirm.focus();
        return;
      }
      try {
        setLoading(signupBtn, true, "Create account", "Creating account…");
        const { data } = await signUp(email, password, { account_type: accountType }); // { user, session }
        const needsConfirm = !data?.session;
        if (needsConfirm) {
          showMsg("Account created. Please confirm your email, then sign in.", "success");
          signupBtn.disabled = true;
          signupBtn.textContent = "Check your email to confirm";
        } else {
          showMsg("Account created. Redirecting…", "success");
          await routePostAuth(redirectTo, accountType);
        }
      } catch (err) {
        const raw = err?.message || "";
        const m = raw.toLowerCase();
        if (/already (registered|exists)/.test(m)) {
          showMsg("An account with this email already exists. Please sign in or reset your password.", "error");
          signupEmail?.focus();
        } else {
          showMsg(raw || "Sign up failed.", "error");
        }
      } finally {
        setLoading(signupBtn, false, "Create account");
      }
    });

    // ---- Forgot password (inline) ----
    forgot.addEventListener("click", () => {
      show("in");
      const emailIn = fIn.elements.email.value.trim();
      if (emailIn) forgotForm.elements.email.value = emailIn;
      forgotWrap.classList.remove("hidden");
    });
    forgotCancel.addEventListener("click", () => forgotWrap.classList.add("hidden"));

    forgotForm.addEventListener("submit", async (e) => {
      e.preventDefault(); clearMsg();
      const email = e.target.email.value.trim();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      try {
        setLoading(submitBtn, true, "Send reset link", "Sending…");
        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: "https://thealgohive.com/reset" });
        if (error) throw error;
        showMsg("If an account exists for that email, we’ve sent a reset link.", "success");
        forgotWrap.classList.add("hidden");
      } catch (err) {
        showMsg(err.message || "Could not send reset link.", "error");
      } finally {
        setLoading(submitBtn, false, "Send reset link");
      }
    });

      // ---- On load ----
      if (qs.get("tab") === "up") show("up"); else show("in");
      if (qs.get("confirmed") === "1") showMsg("Email confirmed — you can sign in now.", "success");

        // If user is already logged in and lands here, route them
        try {
          const { data: { session } } = await supabase.auth.getSession();
        const metaType = session?.user?.user_metadata?.account_type;
        const fallbackType = [accountType, metaType, hydratedAccountType, "live"].find((v) => v === "paper" || v === "live");
        if (session) await routePostAuth(redirectTo, fallbackType || "live");
        } catch (_) {}
  </script>
</body>
</html>
