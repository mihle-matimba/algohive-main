<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AlgoHive — Sign in</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --olive: #7e8d52;
      --olive-700: #576138;
      --ink: #0B1215;
    }
    body { background: #f1f4ff; }
    .orb-gradient {
      background-image: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.75), rgba(255,255,255,0) 60%),
                        radial-gradient(circle at 80% 20%, rgba(126,141,82,0.18), rgba(255,255,255,0) 55%),
                        radial-gradient(circle at 50% 80%, rgba(126,141,82,0.12), rgba(255,255,255,0) 55%);
    }
  </style>
</head>

<body class="min-h-screen antialiased text-slate-900">
  <div class="flex min-h-screen flex-col bg-transparent lg:flex-row">
    <!-- Left: Auth -->
    <main class="relative mx-auto w-full max-w-2xl bg-white px-6 py-10 shadow-lg sm:rounded-3xl sm:px-10 sm:py-12 lg:flex lg:min-h-screen lg:max-w-xl lg:flex-col lg:justify-between lg:px-12 lg:py-16 lg:shadow-xl xl:max-w-[500px]">
      <!-- Brand -->
      <div class="flex items-center gap-2">
        <img src="https://static.wixstatic.com/media/ac771e_af06d86a7a1f4abd87e52e45f3bcbd96~mv2.png" alt="AlgoHive" class="h-8 w-auto" />
        <span class="text-lg font-semibold tracking-tight text-[var(--ink)]">AlgoHive</span>
      </div>

      <!-- Auth content -->
      <div class="mt-10 flex-1 lg:mt-16">
        <header class="mb-8 space-y-2">
          <div id="heading-in" class="space-y-1">
            <h1 class="text-3xl font-semibold text-slate-900">Log in</h1>
            <p class="text-sm text-slate-500">Need to register? <button id="switch-to-signup" type="button" class="font-semibold text-[var(--olive)] hover:text-[var(--olive-700)]">Sign up.</button></p>
          </div>
          <div id="heading-up" class="hidden space-y-1">
            <h1 class="text-3xl font-semibold text-slate-900">Create account</h1>
            <p class="text-sm text-slate-500">Already have an account? <button id="switch-to-signin" type="button" class="font-semibold text-[var(--olive)] hover:text-[var(--olive-700)]">Log in.</button></p>
          </div>
        </header>

        <!-- Messages -->
        <div id="msg" class="hidden mb-4 rounded-lg border px-3 py-2 text-sm"></div>

        <!-- Sign in -->
        <section id="panel-in" class="space-y-8">
          <form id="login-form" class="space-y-4">
            <div class="space-y-2">
              <label class="text-sm font-medium text-slate-700" for="login-email">Email or username</label>
              <input id="login-email" name="email" type="email" placeholder="john@company.com" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 text-sm shadow-sm transition focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[rgba(126,141,82,0.25)]" required />
            </div>
            <div class="space-y-2">
              <div class="flex items-center justify-between text-sm">
                <label class="font-medium text-slate-700" for="login-password">Password</label>
                <button id="forgot" type="button" class="font-medium text-[var(--olive)] hover:text-[var(--olive-700)]">Forgot password?</button>
              </div>
              <input id="login-password" name="password" type="password" placeholder="••••••••" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 text-sm shadow-sm transition focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[rgba(126,141,82,0.25)]" required />
            </div>
            <button type="submit" class="w-full rounded-lg bg-[var(--olive)] px-3 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-[var(--olive-700)]">Log in</button>
          </form>
        </section>

        <!-- Inline forgot form -->
        <div id="forgot-wrap" class="mt-6 hidden rounded-lg border border-slate-200 bg-slate-50/60 p-4">
          <h2 class="mb-3 text-sm font-semibold text-slate-700">Reset password</h2>
          <form id="forgot-form" class="space-y-3">
            <div class="space-y-1">
              <label class="text-xs font-medium text-slate-600" for="forgot-email">Email</label>
              <input id="forgot-email" name="email" type="email" placeholder="you@example.com" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm shadow-sm transition focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[rgba(126,141,82,0.25)]" required />
            </div>
            <div class="flex flex-col gap-2 sm:flex-row">
              <button type="submit" class="flex-1 rounded-lg bg-[var(--olive)] px-3 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-[var(--olive-700)]">Send reset link</button>
              <button type="button" id="forgot-cancel" class="rounded-lg border border-slate-200 px-3 py-2 text-sm font-semibold text-slate-600 hover:border-slate-300">Cancel</button>
            </div>
          </form>
        </div>

        <!-- Sign up -->
        <section id="panel-up" class="hidden space-y-6">
          <form id="signup-form" class="space-y-4">
            <div class="space-y-2">
              <label class="text-sm font-medium text-slate-700" for="signup-email">Email</label>
              <input id="signup-email" name="email" type="email" placeholder="john@company.com" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 text-sm shadow-sm transition focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[rgba(126,141,82,0.25)]" required />
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-slate-700" for="signup-password">Password</label>
              <input id="signup-password" name="password" type="password" placeholder="At least 6 characters" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 text-sm shadow-sm transition focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[rgba(126,141,82,0.25)]" required />
            </div>
            <label class="flex items-start gap-3 rounded-lg bg-slate-50/80 p-3 text-xs text-slate-600">
              <input id="agree" type="checkbox" class="mt-0.5 h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]" />
              <span>
                I agree to the
                <a href="/terms.html" class="font-semibold text-[var(--olive)] hover:text-[var(--olive-700)]">Terms &amp; Conditions</a>,
                <a href="/privacy.html" class="font-semibold text-[var(--olive)] hover:text-[var(--olive-700)]">Privacy Policy</a>,
                <a href="/risk.html" class="font-semibold text-[var(--olive)] hover:text-[var(--olive-700)]">Risk Disclosure</a>, and
                <a href="/investment-disclaimer.html" class="font-semibold text-[var(--olive)] hover:text-[var(--olive-700)]">Investment Disclaimer</a>.
              </span>
            </label>
            <button id="signup-btn" type="submit" class="w-full rounded-lg bg-[var(--olive)] px-3 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-[var(--olive-700)] disabled:cursor-not-allowed disabled:opacity-60" disabled>
              Create account
            </button>
            <p class="text-[11px] leading-relaxed text-slate-500">We’ll email a confirmation link to activate your account.</p>
          </form>
        </section>
      </div>

      <!-- Notice -->
      <footer class="mt-12 border-t border-slate-100 pt-6 text-[11px] leading-5 text-slate-500">
        AlgoHive (<b>FSP 55118</b>) is a registered Financial Services Provider. Investing involves risk. Past performance is not indicative of future results.
      </footer>
    </main>

    <!-- Right: Preview -->
    <aside class="relative mt-12 flex w-full items-center justify-center overflow-hidden rounded-t-3xl bg-[#f6f8ff] px-6 py-12 shadow-inner lg:mt-0 lg:flex-1 lg:rounded-none lg:px-10 lg:py-16">
      <div class="absolute inset-0 orb-gradient opacity-90"></div>
      <div class="relative z-10 flex w-full max-w-3xl flex-col items-center gap-6 text-center">
        <span class="rounded-full border border-white/60 bg-white/70 px-4 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-[var(--olive-700)] shadow-sm">Dashboard preview</span>
        <img src="https://cdn.dribbble.com/userupload/37350648/file/original-0ded49562a31447d04c89d9eb49e3759.png?resize=1504x1128&vertical=center" alt="AlgoHive dashboard preview" loading="lazy" class="w-full max-w-2xl rounded-3xl border border-white/60 shadow-[0_30px_80px_rgba(15,23,42,0.18)]" />
        <p class="max-w-lg text-sm text-slate-600">A glimpse of the AlgoHive trading dashboard featuring live portfolio performance, allocations, and daily insights.</p>
      </div>
    </aside>
  </div>

  <script type="module" nonce="ALGOHIVE">
    import { signIn, signUp } from "/js/auth.js";
    import { supabase } from "/js/supabase.js";

    // --- SAME COMPLETENESS RULE AS SETTINGS ---
    const REQUIRED_FIELDS = [
      "first_name",
      "last_name",
      "phone",
      "dob",
      "id_number",
      "nationality",
      "country_residence",
      "employment_status",
      "occupation",
      "employer",
      "income_bracket",
      "source_of_funds",
      "net_worth_range",
      "experience_level",
      "risk_tolerance",
      "objectives"
    ];
    const REQUIRE_KYC = false; // flip to true if you want KYC to be required to be “complete”

    function resolveKycBoolean(row){
      const v = row?.kyc_status;
      if (typeof v === "boolean") return v;
      if (typeof v === "string") {
        const t = v.toLowerCase();
        return ["verified","approved","done","passed","kyc_done"].includes(t);
      }
      return false;
    }

    function computeProfileComplete(row){
      const core = REQUIRED_FIELDS.every(k => String(row?.[k] ?? "").trim().length > 0);
      return REQUIRE_KYC ? (core && resolveKycBoolean(row)) : core;
    }

    async function isProfileComplete(uid) {
      // fetch exactly the fields we need (+ kyc_status if you enable REQUIRE_KYC)
      const selectCols = [...REQUIRED_FIELDS, "kyc_status"].join(",");
      const { data, error } = await supabase
        .from("profiles")
        .select(selectCols)
        .eq("id", uid)
        .maybeSingle();              // no row -> null instead of throwing
      if (error) return false;       // treat errors as incomplete
      return computeProfileComplete(data || {});
    }

    async function routePostAuth(preferred = "/home.html") {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return; // email-confirm signup path
      const complete = await isProfileComplete(session.user.id);
      const dest = complete ? preferred : "/settings.html#extra";
      location.replace(dest);
    }

    const qs = new URLSearchParams(location.search);
    const redirectTo = qs.get("redirect") || "/home.html";

    // elems
    const headingIn = document.getElementById("heading-in");
    const headingUp = document.getElementById("heading-up");
    const panelIn = document.getElementById("panel-in");
    const panelUp = document.getElementById("panel-up");
    const switchToSignup = document.getElementById("switch-to-signup");
    const switchToSignin = document.getElementById("switch-to-signin");
    const fIn = document.getElementById("login-form");
    const fUp = document.getElementById("signup-form");
    const msg = document.getElementById("msg");
    const forgot = document.getElementById("forgot");
    const forgotWrap = document.getElementById("forgot-wrap");
    const forgotForm = document.getElementById("forgot-form");
    const forgotCancel = document.getElementById("forgot-cancel");
    const agree = document.getElementById("agree");
    const signupBtn = document.getElementById("signup-btn");

    // ---- UI helpers ----
    function showMsg(text, type = "info") { // "success" | "error" | "info"
      msg.classList.remove("hidden","bg-rose-50","text-rose-700","border-rose-200","bg-emerald-50","text-emerald-700","border-emerald-200");
      if (type === "success") msg.classList.add("bg-emerald-50","text-emerald-700","border-emerald-200");
      if (type === "error")   msg.classList.add("bg-rose-50","text-rose-700","border-rose-200");
      msg.textContent = text;
    }
    function clearMsg() { msg.classList.add("hidden"); msg.textContent = ""; }
    function setLoading(btn, on, idle, busy) { btn.disabled = on; btn.textContent = on ? busy : idle; }

    function show(tab) {
      clearMsg();
      const up = tab === "up";
      panelUp.classList.toggle("hidden", !up);
      panelIn.classList.toggle("hidden", up);
      headingUp.classList.toggle("hidden", !up);
      headingIn.classList.toggle("hidden", up);
      forgot.classList.toggle("hidden", up);
      forgotWrap.classList.add("hidden");
    }

    switchToSignup?.addEventListener("click", () => show("up"));
    switchToSignin?.addEventListener("click", () => show("in"));

    // enable/disable signup by checkbox
    const toggleSignupBtn = () => signupBtn.disabled = !agree.checked;
    agree.addEventListener("change", toggleSignupBtn);
    toggleSignupBtn();

    // ---- Sign in ----
    const inBtn = fIn.querySelector('button[type="submit"]');
    fIn.addEventListener("submit", async (e) => {
      e.preventDefault(); clearMsg();
      const email = e.target.email.value.trim();
      const password = e.target.password.value;
      try {
        setLoading(inBtn, true, "Log in", "Logging in…");
        await signIn(email, password);
        showMsg("Signed in. Redirecting…", "success");
        await routePostAuth(redirectTo);
      } catch (err) {
        showMsg(err.message || "Sign in failed.", "error");
      } finally {
        setLoading(inBtn, false, "Log in");
      }
    });

    // ---- Sign up ----
    fUp.addEventListener("submit", async (e) => {
      e.preventDefault(); clearMsg();
      if (!agree.checked) { showMsg("Please accept the Terms, Privacy, Risk and Investment Disclaimer.", "error"); return; }
      const email = e.target.email.value.trim();
      const password = e.target.password.value;
      try {
        setLoading(signupBtn, true, "Create account", "Creating account…");
        const { data } = await signUp(email, password); // { user, session }
        const needsConfirm = !data?.session;
        if (needsConfirm) {
          showMsg("Account created. Please confirm your email, then sign in.", "success");
          signupBtn.disabled = true;
          signupBtn.textContent = "Check your email to confirm";
        } else {
          showMsg("Account created. Redirecting…", "success");
          await routePostAuth(redirectTo);
        }
      } catch (err) {
        const m = (err?.message || "").toLowerCase();
        if (/already (registered|exists)/.test(m)) {
          showMsg("An account with this email already exists. Please sign in or reset your password.", "error");
          show("in");
        } else {
          showMsg(err.message || "Sign up failed.", "error");
        }
      } finally {
        setLoading(signupBtn, false, "Create account");
      }
    });

    // ---- Forgot password (inline) ----
    forgot.addEventListener("click", () => {
      show("in");
      const emailIn = fIn.elements.email.value.trim();
      if (emailIn) forgotForm.elements.email.value = emailIn;
      forgotWrap.classList.remove("hidden");
    });
    forgotCancel.addEventListener("click", () => forgotWrap.classList.add("hidden"));

    forgotForm.addEventListener("submit", async (e) => {
      e.preventDefault(); clearMsg();
      const email = e.target.email.value.trim();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      try {
        setLoading(submitBtn, true, "Send reset link", "Sending…");
        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: "https://thealgohive.com/reset" });
        if (error) throw error;
        showMsg("If an account exists for that email, we’ve sent a reset link.", "success");
        forgotWrap.classList.add("hidden");
      } catch (err) {
        showMsg(err.message || "Could not send reset link.", "error");
      } finally {
        setLoading(submitBtn, false, "Send reset link");
      }
    });

    // ---- On load ----
    if (qs.get("tab") === "up") show("up"); else show("in");
    if (qs.get("confirmed") === "1") showMsg("Email confirmed — you can sign in now.", "success");

    // If user is already logged in and lands here, route them
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) await routePostAuth(redirectTo);
    } catch (_) {}
  </script>
</body>
</html>
