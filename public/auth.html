<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AlgoHive — Sign in</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --olive: #7e8d52;
      --olive-700: #576138;
      --ink: #0B1215;
    }
    body {
      background: #040916;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
    }
    @media (min-width: 640px) {
      body { background: radial-gradient(circle at top, #081024 0%, #040916 55%, #02040c 100%); }
    }
  </style>
</head>

<body class="min-h-screen">
  <div class="mx-auto flex min-h-screen w-full max-w-sm flex-col">
    <header class="relative overflow-hidden rounded-b-[44px] bg-[#07142B] px-6 pb-24 pt-16 text-white">
      <div class="absolute -top-20 right-[-40%] h-52 w-52 rounded-full bg-white/10 blur-2xl"></div>
      <div class="absolute -bottom-8 left-1/2 h-32 w-32 -translate-x-1/2 rounded-full border border-white/10"></div>
      <p class="text-xs uppercase tracking-[0.5em] text-white/50">algohvie</p>
      <h1 class="mt-6 text-3xl font-semibold tracking-tight">Work without limits</h1>
      <p class="mt-4 text-base text-white/70">Where smart capital gathers.</p>
    </header>

    <main class="relative -mt-16 flex-1 px-5 pb-12">
      <div class="relative rounded-3xl border border-black/5 bg-white px-5 pb-6 pt-7 shadow-2xl">
        <div class="absolute left-1/2 top-0 h-1.5 w-14 -translate-x-1/2 -translate-y-1/2 rounded-full bg-slate-200"></div>

        <!-- Tabs -->
        <div class="mb-5 grid grid-cols-2 rounded-full bg-slate-100 p-1 text-sm font-semibold">
          <button id="tab-in" type="button" class="rounded-full px-3 py-2 text-center text-slate-500 transition-colors">Login</button>
          <button id="tab-up" type="button" class="rounded-full px-3 py-2 text-center text-slate-500 transition-colors">Create account</button>
        </div>

        <!-- Messages -->
        <div id="msg" class="hidden mb-3 rounded-lg border text-sm px-3 py-2"></div>

        <!-- Sign in -->
        <form id="login-form" class="space-y-3">
          <div>
            <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">Email</label>
            <input name="email" type="email" placeholder="you@example.com" class="w-full rounded-xl border border-slate-200 px-3 py-3 text-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" required />
          </div>
          <div>
            <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">Password</label>
            <input name="password" type="password" placeholder="••••••••" class="w-full rounded-xl border border-slate-200 px-3 py-3 text-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" required />
          </div>
          <button type="submit" class="w-full rounded-xl bg-[var(--olive)] px-3 py-3 text-sm font-semibold uppercase tracking-wide text-white transition hover:bg-[var(--olive-700)]">Login</button>
          <button id="forgot" type="button" class="w-full text-center text-sm font-medium text-[var(--olive-700)] underline">Forgot password?</button>
        </form>

        <!-- Inline forgot form -->
        <div id="forgot-wrap" class="hidden mt-3">
          <form id="forgot-form" class="space-y-3 rounded-2xl border border-slate-200 bg-slate-50/60 px-4 py-4">
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Reset password</p>
            <input name="email" type="email" placeholder="you@example.com" class="w-full rounded-xl border border-slate-200 px-3 py-3 text-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" required />
            <div class="flex gap-2 text-sm font-semibold uppercase tracking-wide">
              <button type="submit" class="flex-1 rounded-xl bg-[var(--olive)] px-3 py-3 text-white transition hover:bg-[var(--olive-700)]">Send link</button>
              <button type="button" id="forgot-cancel" class="rounded-xl border border-slate-300 px-3 py-3 text-slate-600">Cancel</button>
            </div>
          </form>
        </div>

        <!-- Sign up -->
        <form id="signup-form" class="mt-2 hidden space-y-3">
          <div>
            <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">Email</label>
            <input name="email" type="email" placeholder="you@example.com" class="w-full rounded-xl border border-slate-200 px-3 py-3 text-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" required />
          </div>
          <div>
            <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">Password</label>
            <input name="password" type="password" placeholder="Min. 6 characters" class="w-full rounded-xl border border-slate-200 px-3 py-3 text-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" required />
          </div>

          <!-- Legal acceptance -->
          <label class="flex items-start gap-3 rounded-2xl border border-slate-200 bg-slate-50/60 px-3 py-3 text-xs text-slate-700">
            <input id="agree" type="checkbox" class="mt-1 accent-[var(--olive)]" />
            <span>
              I agree to the
              <a href="/terms.html" class="font-medium underline text-[var(--olive-700)]">Terms &amp; Conditions</a>,
              <a href="/privacy.html" class="font-medium underline text-[var(--olive-700)]">Privacy Policy</a>,
              <a href="/risk.html" class="font-medium underline text-[var(--olive-700)]">Risk Disclosure</a>, and
              <a href="/investment-disclaimer.html" class="font-medium underline text-[var(--olive-700)]">Investment Disclaimer</a>.
            </span>
          </label>

          <button id="signup-btn" type="submit" class="w-full rounded-xl bg-[var(--olive)] px-3 py-3 text-sm font-semibold uppercase tracking-wide text-white transition hover:bg-[var(--olive-700)] disabled:opacity-50" disabled>
            Create account
          </button>
          <p class="text-[11px] text-slate-500">We’ll email a confirmation link to activate your account.</p>
        </form>

        <!-- FSP notice -->
        <div class="mt-6 rounded-2xl border border-slate-200 bg-slate-50/60 p-4">
          <p class="text-[11px] leading-5 text-slate-600">
            AlgoHive (<b>FSP 55118</b>) is a registered Financial Services Provider. Investing involves risk. Past performance is not indicative of future results.
          </p>
        </div>
      </div>
    </main>
  </div>

  <script type="module" nonce="ALGOHIVE">
    import { signIn, signUp } from "/js/auth.js";
    import { supabase } from "/js/supabase.js";

    // --- SAME COMPLETENESS RULE AS SETTINGS ---
    const REQUIRED_FIELDS = [
      "first_name",
      "last_name",
      "phone",
      "dob",
      "id_number",
      "nationality",
      "country_residence",
      "employment_status",
      "occupation",
      "employer",
      "income_bracket",
      "source_of_funds",
      "net_worth_range",
      "experience_level",
      "risk_tolerance",
      "objectives"
    ];
    const REQUIRE_KYC = false; // flip to true if you want KYC to be required to be “complete”

    function resolveKycBoolean(row){
      const v = row?.kyc_status;
      if (typeof v === "boolean") return v;
      if (typeof v === "string") {
        const t = v.toLowerCase();
        return ["verified","approved","done","passed","kyc_done"].includes(t);
      }
      return false;
    }

    function computeProfileComplete(row){
      const core = REQUIRED_FIELDS.every(k => String(row?.[k] ?? "").trim().length > 0);
      return REQUIRE_KYC ? (core && resolveKycBoolean(row)) : core;
    }

    async function isProfileComplete(uid) {
      // fetch exactly the fields we need (+ kyc_status if you enable REQUIRE_KYC)
      const selectCols = [...REQUIRED_FIELDS, "kyc_status"].join(",");
      const { data, error } = await supabase
        .from("profiles")
        .select(selectCols)
        .eq("id", uid)
        .maybeSingle();              // no row -> null instead of throwing
      if (error) return false;       // treat errors as incomplete
      return computeProfileComplete(data || {});
    }

    async function routePostAuth(preferred = "/home.html") {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return; // email-confirm signup path
      const complete = await isProfileComplete(session.user.id);
      const dest = complete ? preferred : "/settings.html#extra";
      location.replace(dest);
    }

    const qs = new URLSearchParams(location.search);
    const redirectTo = qs.get("redirect") || "/home.html";

    // elems
    const tabIn = document.getElementById("tab-in");
    const tabUp = document.getElementById("tab-up");
    const fIn = document.getElementById("login-form");
    const fUp = document.getElementById("signup-form");
    const msg = document.getElementById("msg");
    const forgot = document.getElementById("forgot");
    const forgotWrap = document.getElementById("forgot-wrap");
    const forgotForm = document.getElementById("forgot-form");
    const forgotCancel = document.getElementById("forgot-cancel");
    const agree = document.getElementById("agree");
    const signupBtn = document.getElementById("signup-btn");

    // ---- UI helpers ----
    function showMsg(text, type = "info") { // "success" | "error" | "info"
      msg.classList.remove("hidden","bg-rose-50","text-rose-700","border-rose-200","bg-emerald-50","text-emerald-700","border-emerald-200");
      if (type === "success") msg.classList.add("bg-emerald-50","text-emerald-700","border-emerald-200");
      if (type === "error")   msg.classList.add("bg-rose-50","text-rose-700","border-rose-200");
      msg.textContent = text;
    }
    function clearMsg() { msg.classList.add("hidden"); msg.textContent = ""; }
    function setLoading(btn, on, idle, busy) { btn.disabled = on; btn.textContent = on ? busy : idle; }

    function show(tab) {
      clearMsg();
      const up = tab === "up";
      fUp.classList.toggle("hidden", !up);
      fIn.classList.toggle("hidden", up);
      tabUp.classList.toggle("bg-white", up);
      tabUp.classList.toggle("shadow-sm", up);
      tabUp.classList.toggle("text-slate-900", up);
      tabUp.classList.toggle("text-slate-500", !up);
      tabIn.classList.toggle("bg-white", !up);
      tabIn.classList.toggle("shadow-sm", !up);
      tabIn.classList.toggle("text-slate-900", !up);
      tabIn.classList.toggle("text-slate-500", up);
      forgot.classList.toggle("hidden", up);
      forgotWrap.classList.add("hidden");
    }

    // tabs
    tabIn.addEventListener("click", () => show("in"));
    tabUp.addEventListener("click", () => show("up"));

    // enable/disable signup by checkbox
    const toggleSignupBtn = () => signupBtn.disabled = !agree.checked;
    agree.addEventListener("change", toggleSignupBtn);
    toggleSignupBtn();

    // ---- Sign in ----
    const inBtn = fIn.querySelector('button[type="submit"]');
    fIn.addEventListener("submit", async (e) => {
      e.preventDefault(); clearMsg();
      const email = e.target.email.value.trim();
      const password = e.target.password.value;
      try {
        setLoading(inBtn, true, "Login", "Logging in…");
        await signIn(email, password);
        showMsg("Logged in. Redirecting…", "success");
        await routePostAuth(redirectTo);
      } catch (err) {
        showMsg(err.message || "Login failed.", "error");
      } finally {
        setLoading(inBtn, false, "Login");
      }
    });

    // ---- Sign up ----
    fUp.addEventListener("submit", async (e) => {
      e.preventDefault(); clearMsg();
      if (!agree.checked) { showMsg("Please accept the Terms, Privacy, Risk and Investment Disclaimer.", "error"); return; }
      const email = e.target.email.value.trim();
      const password = e.target.password.value;
      try {
        setLoading(signupBtn, true, "Create account", "Creating account…");
        const { data } = await signUp(email, password); // { user, session }
        const needsConfirm = !data?.session;
        if (needsConfirm) {
          showMsg("Account created. Please confirm your email, then sign in.", "success");
          signupBtn.disabled = true;
          signupBtn.textContent = "Check your email to confirm";
        } else {
          showMsg("Account created. Redirecting…", "success");
          await routePostAuth(redirectTo);
        }
      } catch (err) {
        const m = (err?.message || "").toLowerCase();
        if (/already (registered|exists)/.test(m)) {
          showMsg("An account with this email already exists. Please sign in or reset your password.", "error");
          show("in");
        } else {
          showMsg(err.message || "Sign up failed.", "error");
        }
      } finally {
        setLoading(signupBtn, false, "Create account");
      }
    });

    // ---- Forgot password (inline) ----
    forgot.addEventListener("click", () => {
      show("in");
      const emailIn = fIn.elements.email.value.trim();
      if (emailIn) forgotForm.elements.email.value = emailIn;
      forgotWrap.classList.remove("hidden");
    });
    forgotCancel.addEventListener("click", () => forgotWrap.classList.add("hidden"));

    forgotForm.addEventListener("submit", async (e) => {
      e.preventDefault(); clearMsg();
      const email = e.target.email.value.trim();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      try {
        setLoading(submitBtn, true, "Send link", "Sending…");
        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: `${location.origin}/reset.html` });
        if (error) throw error;
        showMsg("If an account exists for that email, we’ve sent a reset link.", "success");
        forgotWrap.classList.add("hidden");
      } catch (err) {
        showMsg(err.message || "Could not send reset link.", "error");
      } finally {
        setLoading(submitBtn, false, "Send link");
      }
    });

    // ---- On load ----
    if (qs.get("tab") === "up") show("up"); else show("in");
    if (qs.get("confirmed") === "1") showMsg("Email confirmed — you can sign in now.", "success");

    // If user is already logged in and lands here, route them
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) await routePostAuth(redirectTo);
    } catch (_) {}
  </script>
</body>
</html>
