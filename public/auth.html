<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AlgoHive — Sign in</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen grid place-items-center bg-gray-50">
<main class="w-full max-w-md bg-white p-6 rounded-2xl shadow">
  <div class="flex gap-2 mb-4">
    <button id="tab-in"  type="button" class="flex-1 py-2 rounded-lg bg-black text-white text-sm font-semibold">Sign in</button>
    <button id="tab-up" type="button" class="flex-1 py-2 rounded-lg bg-gray-100 text-sm font-semibold">Create account</button>
  </div>

  <div id="msg" class="hidden mb-3 rounded-lg border border-rose-200 bg-rose-50 text-rose-700 text-sm px-3 py-2"></div>

  <!-- Sign in -->
  <form id="login-form" class="space-y-3">
    <input name="email" type="email" placeholder="Email" class="w-full border rounded px-3 py-2" required />
    <input name="password" type="password" placeholder="Password" class="w-full border rounded px-3 py-2" required />
    <button type="submit" class="w-full rounded px-3 py-2 bg-black text-white">Sign in</button>
  </form>

  <!-- Sign up -->
  <form id="signup-form" class="space-y-3 hidden">
    <input name="email" type="email" placeholder="Email" class="w-full border rounded px-3 py-2" required />
    <input name="password" type="password" placeholder="Password (min 6)" class="w-full border rounded px-3 py-2" required />
    <button type="submit" class="w-full rounded px-3 py-2 bg-emerald-600 text-white">Create account</button>
    <p class="text-xs text-gray-500">You may need to confirm your email if confirmations are enabled.</p>
  </form>

  <button id="forgot" type="button" class="mt-4 w-full text-sm text-emerald-700 underline">Forgot password?</button>
  <!-- inline forgot form -->
<div id="forgot-wrap" class="hidden mt-3">
  <form id="forgot-form" class="space-y-2">
    <input name="email" type="email" placeholder="Your email" class="w-full border rounded px-3 py-2" required />
    <div class="flex gap-2">
      <button type="submit" class="flex-1 rounded px-3 py-2 bg-emerald-600 text-white">Send reset link</button>
      <button type="button" id="forgot-cancel" class="rounded px-3 py-2 border">Cancel</button>
    </div>
  </form>
</div>

</main>

<script type="module">
  import { signIn, signUp } from "/js/auth.js";
  import { supabase } from "/js/supabase.js";

  const qs       = new URLSearchParams(location.search);
  const redirectTo = qs.get("redirect") || "/dashboard.html";

  // elems
  const tabIn  = document.getElementById("tab-in");
  const tabUp  = document.getElementById("tab-up");
  const fIn    = document.getElementById("login-form");
  const fUp    = document.getElementById("signup-form");
  const msg    = document.getElementById("msg");
  const forgot = document.getElementById("forgot");
  const forgotWrap   = document.getElementById("forgot-wrap");
  const forgotForm   = document.getElementById("forgot-form");
  const forgotCancel = document.getElementById("forgot-cancel");

  // ---- UI helpers ----
  function showMsg(text, type="info"){ // "success" | "error" | "info"
    msg.classList.remove("hidden","bg-rose-50","text-rose-700","border-rose-200","bg-emerald-50","text-emerald-700","border-emerald-200");
    if(type==="success"){ msg.classList.add("bg-emerald-50","text-emerald-700","border-emerald-200"); }
    if(type==="error"){   msg.classList.add("bg-rose-50","text-rose-700","border-rose-200"); }
    msg.textContent = text;
  }
  function clearMsg(){ msg.classList.add("hidden"); msg.textContent = ""; }
  function setLoading(btn, on, idle="Submit", busy="Working…"){
    btn.disabled = on;
    btn.textContent = on ? busy : idle;
  }

  function show(tab){
    clearMsg();
    const up = tab === "up";
    fUp.classList.toggle("hidden", !up);
    fIn.classList.toggle("hidden", up);

    // tab styles
    tabUp.classList.toggle("bg-black", up);
    tabUp.classList.toggle("text-white", up);
    tabUp.classList.toggle("bg-gray-100", !up);
    tabIn.classList.toggle("bg-black", !up);
    tabIn.classList.toggle("text-white", !up);
    tabIn.classList.toggle("bg-gray-100", up);

    // forgot visible only on Sign in tab
    forgot.classList.toggle("hidden", up);
    forgotWrap?.classList.add("hidden");
  }

  // tabs
  tabIn.addEventListener("click", () => show("in"));
  tabUp.addEventListener("click", () => show("up"));

  // ---- Sign in ----
  const inBtn = fIn.querySelector('button[type="submit"]');
  fIn.addEventListener("submit", async (e) => {
    e.preventDefault(); clearMsg();
    const email = e.target.email.value.trim();
    const password = e.target.password.value;
    try {
      setLoading(inBtn, true, "Sign in", "Signing in…");
      await signIn(email, password);
      showMsg("Signed in. Redirecting…", "success");
      location.href = redirectTo;
    } catch (err) {
      showMsg(err.message || "Sign in failed.", "error");
    } finally {
      setLoading(inBtn, false, "Sign in");
    }
  });

  // ---- Sign up ----
  const upBtn = fUp.querySelector('button[type="submit"]');
  fUp.addEventListener("submit", async (e) => {
    e.preventDefault(); clearMsg();
    const email = e.target.email.value.trim();
    const password = e.target.password.value;
    try {
      setLoading(upBtn, true, "Create account", "Creating account…");
      const { data } = await signUp(email, password); // { user, session }
      const needsConfirm = !data?.session; // if confirmations ON, session is null

      if (needsConfirm) {
        // stay on Create account tab; show cue & freeze button
        showMsg("Account created. Please confirm your email, then sign in.", "success");
        upBtn.disabled = true;
        upBtn.textContent = "Check your email to confirm";
      } else {
        showMsg("Account created. Redirecting…", "success");
        location.href = redirectTo;
      }
    } catch (err) {
      // friendly message if account already exists
      const m = (err?.message || "").toLowerCase();
      if (/already (registered|exists)/.test(m)) {
        showMsg("An account with this email already exists. Please sign in or reset your password.", "error");
      } else {
        showMsg(err.message || "Sign up failed.", "error");
      }
    } finally {
      setLoading(upBtn, false, "Create account");
    }
  });

  // ---- Forgot password (inline UI) ----
  forgot.addEventListener("click", () => {
    show("in"); // ensure we're on sign-in tab
    const emailIn = fIn.elements.email.value.trim();
    if (emailIn && forgotForm) forgotForm.elements.email.value = emailIn;
    forgotWrap.classList.remove("hidden");
  });
  forgotCancel?.addEventListener("click", () => forgotWrap.classList.add("hidden"));

  forgotForm?.addEventListener("submit", async (e) => {
    e.preventDefault(); clearMsg();
    const email = e.target.email.value.trim();
    const submitBtn = e.target.querySelector('button[type="submit"]');
    try {
      setLoading(submitBtn, true, "Send reset link", "Sending…");
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: `${location.origin}/reset.html`
      });
      if (error) throw error;
      showMsg("Reset link sent. Check your email.", "success");
      forgotWrap.classList.add("hidden");
    } catch (err) {
      showMsg(err.message || "Could not send reset link.", "error");
    } finally {
      setLoading(submitBtn, false, "Send reset link");
    }
  });

  // ---- On load ----
  if (qs.get("tab") === "up") show("up"); else show("in");
  if (qs.get("confirmed") === "1") showMsg("Email confirmed — you can sign in now.", "success");
</script>


</body>
</html>
