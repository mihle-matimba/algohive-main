<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AlgoHive — Sign in</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --olive: #7e8d52;
      --olive-700: #576138;
      --ink: #0B1215;
    }
    body { background: #f6f7f6 }
  </style>
</head>

<body class="min-h-screen grid place-items-center">
  <main class="w-full max-w-md bg-white p-6 rounded-2xl shadow border border-black/10">
    <!-- Brand -->
    <div class="flex items-center gap-2 mb-4">
      <img src="https://static.wixstatic.com/media/ac771e_af06d86a7a1f4abd87e52e45f3bcbd96~mv2.png" alt="AlgoHive" class="h-7 w-auto">
      <h1 class="text-lg font-extrabold text-[var(--ink)]">AlgoHive</h1>
    </div>

    <!-- Tabs -->
    <div class="flex gap-2 mb-4">
      <button id="tab-in" type="button" class="flex-1 py-2 rounded-lg bg-black text-white text-sm font-semibold">Sign in</button>
      <button id="tab-up" type="button" class="flex-1 py-2 rounded-lg bg-gray-100 text-sm font-semibold">Create account</button>
    </div>

    <!-- Messages -->
    <div id="msg" class="hidden mb-3 rounded-lg border text-sm px-3 py-2"></div>

    <!-- Sign in -->
    <form id="login-form" class="space-y-3">
      <input name="email" type="email" placeholder="Email" class="w-full border rounded px-3 py-2" required />
      <input name="password" type="password" placeholder="Password" class="w-full border rounded px-3 py-2" required />
      <button type="submit" class="w-full rounded px-3 py-2 bg-black text-white">Sign in</button>
      <button id="forgot" type="button" class="w-full text-sm text-[var(--olive-700)] underline">Forgot password?</button>
    </form>

    <!-- Inline forgot form -->
    <div id="forgot-wrap" class="hidden mt-3">
      <form id="forgot-form" class="space-y-2">
        <input name="email" type="email" placeholder="Your email" class="w-full border rounded px-3 py-2" required />
        <div class="flex gap-2">
          <button type="submit" class="flex-1 rounded px-3 py-2 bg-[var(--olive)] text-white">Send reset link</button>
          <button type="button" id="forgot-cancel" class="rounded px-3 py-2 border">Cancel</button>
        </div>
      </form>
    </div>

    <!-- Sign up -->
    <form id="signup-form" class="space-y-3 hidden mt-2">
      <input name="email" type="email" placeholder="Email" class="w-full border rounded px-3 py-2" required />
      <input name="password" type="password" placeholder="Password (min 6)" class="w-full border rounded px-3 py-2" required />

      <!-- Legal acceptance -->
      <label class="flex items-start gap-2 text-xs text-slate-700">
        <input id="agree" type="checkbox" class="mt-1 accent-[var(--olive)]" />
        <span>
          I agree to the
          <a href="/terms.html" class="underline text-[var(--olive-700)]">Terms & Conditions</a>,
          <a href="/privacy.html" class="underline text-[var(--olive-700)]">Privacy Policy</a>,
          <a href="/risk.html" class="underline text-[var(--olive-700)]">Risk Disclosure</a>, and
          <a href="/investment-disclaimer.html" class="underline text-[var(--olive-700)]">Investment Disclaimer</a>.
        </span>
      </label>

      <button id="signup-btn" type="submit" class="w-full rounded px-3 py-2 bg-[var(--olive)] text-white disabled:opacity-50" disabled>
        Create account
      </button>
      <p class="text-[11px] text-slate-500">We’ll email a confirmation link to activate your account.</p>
    </form>

    <!-- FSP notice -->
    <div class="mt-6 rounded-xl border border-black/10 bg-black/[0.03] p-3">
      <p class="text-[11px] leading-5 text-slate-600">
        AlgoHive (<b>FSP 55118</b>) is a registered Financial Services Provider. Investing involves risk. Past performance is not indicative of future results.
      </p>
    </div>
  </main>

  <script type="module" nonce="ALGOHIVE">
    import { signIn, signUp } from "/js/auth.js";
    import { supabase } from "/js/supabase.js";

    // --- SAME COMPLETENESS RULE AS SETTINGS ---
    const REQUIRED_FIELDS = [
      "first_name",
      "last_name",
      "phone",
      "dob",
      "id_number",
      "nationality",
      "country_residence",
      "employment_status",
      "occupation",
      "employer",
      "income_bracket",
      "source_of_funds",
      "net_worth_range",
      "experience_level",
      "risk_tolerance",
      "objectives"
    ];
    const REQUIRE_KYC = false; // flip to true if you want KYC to be required to be “complete”
    const INCOMPLETE_PROFILE_FLAG = "ah_profile_incomplete";

    function resolveKycBoolean(row){
      const v = row?.kyc_status;
      if (typeof v === "boolean") return v;
      if (typeof v === "string") {
        const t = v.toLowerCase();
        return ["verified","approved","done","passed","kyc_done"].includes(t);
      }
      return false;
    }

    function computeProfileComplete(row){
      const core = REQUIRED_FIELDS.every(k => String(row?.[k] ?? "").trim().length > 0);
      return REQUIRE_KYC ? (core && resolveKycBoolean(row)) : core;
    }

    async function isProfileComplete(uid) {
      // fetch exactly the fields we need (+ kyc_status if you enable REQUIRE_KYC)
      const selectCols = [...REQUIRED_FIELDS, "kyc_status"].join(",");
      const { data, error } = await supabase
        .from("profiles")
        .select(selectCols)
        .eq("id", uid)
        .maybeSingle();              // no row -> null instead of throwing
      if (error) return false;       // treat errors as incomplete
      return computeProfileComplete(data || {});
    }

    async function routePostAuth(preferred = "/home.html", sessionOverride = null) {
      let session = sessionOverride;
      if (!session) {
        const { data: { session: current } } = await supabase.auth.getSession();
        session = current;
      }
      if (!session) return; // email-confirm signup path
      const complete = await isProfileComplete(session.user.id);
      const dest = complete ? preferred : "/settings.html#extra";
      if (!complete) sessionStorage.setItem(INCOMPLETE_PROFILE_FLAG, "1");
      location.replace(dest);
    }

    const qs = new URLSearchParams(location.search);
    const redirectTo = qs.get("redirect") || "/home.html";

    // elems
    const tabIn = document.getElementById("tab-in");
    const tabUp = document.getElementById("tab-up");
    const fIn = document.getElementById("login-form");
    const fUp = document.getElementById("signup-form");
    const msg = document.getElementById("msg");
    const forgot = document.getElementById("forgot");
    const forgotWrap = document.getElementById("forgot-wrap");
    const forgotForm = document.getElementById("forgot-form");
    const forgotCancel = document.getElementById("forgot-cancel");
    const agree = document.getElementById("agree");
    const signupBtn = document.getElementById("signup-btn");

    // ---- UI helpers ----
    function showMsg(text, type = "info") { // "success" | "error" | "info"
      msg.classList.remove("hidden","bg-rose-50","text-rose-700","border-rose-200","bg-emerald-50","text-emerald-700","border-emerald-200");
      if (type === "success") msg.classList.add("bg-emerald-50","text-emerald-700","border-emerald-200");
      if (type === "error")   msg.classList.add("bg-rose-50","text-rose-700","border-rose-200");
      msg.textContent = text;
    }
    function clearMsg() { msg.classList.add("hidden"); msg.textContent = ""; }
    function setLoading(btn, on, idle, busy) { btn.disabled = on; btn.textContent = on ? busy : idle; }

    function show(tab) {
      clearMsg();
      const up = tab === "up";
      fUp.classList.toggle("hidden", !up);
      fIn.classList.toggle("hidden", up);
      tabUp.classList.toggle("bg-black", up);
      tabUp.classList.toggle("text-white", up);
      tabUp.classList.toggle("bg-gray-100", !up);
      tabIn.classList.toggle("bg-black", !up);
      tabIn.classList.toggle("text-white", !up);
      tabIn.classList.toggle("bg-gray-100", up);
      forgot.classList.toggle("hidden", up);
      forgotWrap.classList.add("hidden");
    }

    // tabs
    tabIn.addEventListener("click", () => show("in"));
    tabUp.addEventListener("click", () => show("up"));

    // enable/disable signup by checkbox
    const toggleSignupBtn = () => signupBtn.disabled = !agree.checked;
    agree.addEventListener("change", toggleSignupBtn);
    toggleSignupBtn();

    // ---- Sign in ----
    const inBtn = fIn.querySelector('button[type="submit"]');
    fIn.addEventListener("submit", async (e) => {
      e.preventDefault(); clearMsg();
      const email = e.target.email.value.trim();
      const password = e.target.password.value;
      try {
        setLoading(inBtn, true, "Sign in", "Signing in…");
        const { session } = await signIn(email, password);
        showMsg("Signed in. Redirecting…", "success");
        await routePostAuth(redirectTo, session);
      } catch (err) {
        showMsg(err.message || "Sign in failed.", "error");
      } finally {
        setLoading(inBtn, false, "Sign in");
      }
    });

    // ---- Sign up ----
    fUp.addEventListener("submit", async (e) => {
      e.preventDefault(); clearMsg();
      if (!agree.checked) { showMsg("Please accept the Terms, Privacy, Risk and Investment Disclaimer.", "error"); return; }
      const email = e.target.email.value.trim();
      const password = e.target.password.value;
      try {
        setLoading(signupBtn, true, "Create account", "Creating account…");
        const signUpResult = await signUp(email, password); // { user, session }
        const needsConfirm = !signUpResult?.session;
        if (needsConfirm) {
          showMsg("Account created. Please confirm your email, then sign in.", "success");
          signupBtn.disabled = true;
          signupBtn.textContent = "Check your email to confirm";
        } else {
          showMsg("Account created. Redirecting…", "success");
          await routePostAuth(redirectTo, signUpResult.session);
        }
      } catch (err) {
        const m = (err?.message || "").toLowerCase();
        if (/already (registered|exists)/.test(m)) {
          showMsg("An account with this email already exists. Please sign in or reset your password.", "error");
          show("in");
        } else {
          showMsg(err.message || "Sign up failed.", "error");
        }
      } finally {
        setLoading(signupBtn, false, "Create account");
      }
    });

    // ---- Forgot password (inline) ----
    forgot.addEventListener("click", () => {
      show("in");
      const emailIn = fIn.elements.email.value.trim();
      if (emailIn) forgotForm.elements.email.value = emailIn;
      forgotWrap.classList.remove("hidden");
    });
    forgotCancel.addEventListener("click", () => forgotWrap.classList.add("hidden"));

    forgotForm.addEventListener("submit", async (e) => {
      e.preventDefault(); clearMsg();
      const email = e.target.email.value.trim();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      try {
        setLoading(submitBtn, true, "Send reset link", "Sending…");
        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: `${location.origin}/reset.html` });
        if (error) throw error;
        showMsg("If an account exists for that email, we’ve sent a reset link.", "success");
        forgotWrap.classList.add("hidden");
      } catch (err) {
        showMsg(err.message || "Could not send reset link.", "error");
      } finally {
        setLoading(submitBtn, false, "Send reset link");
      }
    });

    // ---- On load ----
    if (qs.get("tab") === "up") show("up"); else show("in");
    if (qs.get("confirmed") === "1") showMsg("Email confirmed — you can sign in now.", "success");

    // If user is already logged in and lands here, route them
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) await routePostAuth(redirectTo, session);
    } catch (_) {}
  </script>
</body>
</html>
