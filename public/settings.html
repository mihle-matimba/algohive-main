<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AlgoHive — Settings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root {
      --page: #0b1220;
      --bg: #ffffff;
      --muted: #64748b;
      --ink: #0f172a;
      --olive: #7e8d52; /* OLIVE */
      --brand: #f59e0b;
      --line: #e2e8f0;
    }
    html, body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--ink); height: 100% }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:.5rem; height:40px; padding:0 .875rem; border-radius:10px; border:1px solid var(--line); font-weight:600 }
    .input { height:40px; border:1px solid var(--line); border-radius:10px; padding:0 .75rem }
    #layout { --sb: 220px; display:grid; grid-template-columns:var(--sb) 1fr; min-height:100vh }
    #layout.is-collapsed { --sb: 64px }
    #ah-sidebar { transition: width .2s ease; width: var(--sb) }
    #ah-sidebar[data-collapsed="true"] .label, #ah-sidebar[data-collapsed="true"] .chevron { display:none }
    #ah-sidebar[data-collapsed="true"] details>.sub { display:none!important }
    #ah-sidebar[data-collapsed="true"] nav a, #ah-sidebar[data-collapsed="true"] details>summary { justify-content:center; gap:.25rem }
    #ah-sidebar .footer { transition: all .2s ease }
    #ah-sidebar[data-collapsed="true"] .footer { justify-content:center; flex-direction:column; gap:12px }
    .btn-collapse :is(svg,i){ transition: transform .25s ease } #ah-sidebar[data-collapsed="true"] .btn-collapse :is(svg,i){ transform: rotate(180deg) }

    /* Olive button utility */
    .btn-olive{ background: var(--olive); color: #fff; border: 0; }
    .btn-olive:hover{ filter: brightness(0.92); }
    .btn-olive:disabled{ opacity:.6; cursor:not-allowed; }

    /* Disabled link look */
    .link-disabled{ opacity:.5; pointer-events:none; }
  </style>
</head>

<body class="min-h-screen overflow-x-hidden">
  <div id="layout">
    <!-- ===== Sidebar ===== -->
    <aside id="ah-sidebar" data-collapsed="false" class="border-r border-slate-200 h-[100vh] sticky top-0 bg-white flex flex-col overflow-hidden">
      <div class="px-4 py-4 flex items-center gap-3 border-b border-slate-200">
        <img src="https://static.wixstatic.com/media/ac771e_af06d86a7a1f4abd87e52e45f3bcbd96~mv2.png" alt="AlgoHive Logo" class="w-10 h-10 object-contain" />
        <div class="min-w-0">
          <div class="font-bold text-[15px] text-slate-900 label">AlgoHive</div>
          <div class="text-[11px] text-slate-500 label">ID: <span id="sidebar-acc">—</span></div>
        </div>
      </div>

      <nav id="main-nav" class="p-2 text-[14px] flex-1 overflow-y-auto">
        <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50 font-medium text-slate-900 bg-slate-100" href="/home.html" title="Home">
          <i class="fa-solid fa-house text-slate-500 w-4 shrink-0"></i><span class="label">Home</span>
        </a>

        <details class="group mt-1">
          <summary class="flex items-center justify-between px-3 py-2 rounded-lg hover:bg-slate-50 cursor-pointer font-medium text-slate-900">
            <span class="flex items-center gap-3">
              <i class="fa-regular fa-user w-4 text-slate-500"></i><span class="label">Portfolio</span>
            </span>
            <i class="fa-solid fa-chevron-down text-slate-400 group-open:rotate-180 transition-transform chevron"></i>
          </summary>
          <div class="ml-8 mt-1 flex flex-col sub">
            <a class="px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-2" href="#"><i class="fa-solid fa-chart-pie w-4 text-slate-500"></i><span class="label">Positions</span></a>
            <a class="px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-2" href="#"><i class="fa-regular fa-clipboard w-4 text-slate-500"></i><span class="label">Orders</span></a>
            <a class="px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-2" href="#"><i class="fa-solid fa-bars w-4 text-slate-500"></i><span class="label">Activity</span></a>
            <a class="px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-2" href="#"><i class="fa-solid fa-table w-4 text-slate-500"></i><span class="label">Balances</span></a>
            <a class="px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-2" href="#"><i class="fa-solid fa-hand-holding-dollar w-4 text-slate-500"></i><span class="label">Funding</span></a>
          </div>
        </details>

        <details class="group mt-1">
          <summary class="flex items-center justify-between px-3 py-2 rounded-lg hover:bg-slate-50 cursor-pointer font-medium text-slate-900">
            <span class="flex items-center gap-3">
              <i class="fa-solid fa-link w-4 text-slate-500"></i><span class="label">Invest</span>
            </span>
            <i class="fa-solid fa-chevron-down text-slate-400 group-open:rotate-180 transition-transform chevron"></i>
          </summary>
          <div class="ml-8 mt-1 flex flex-col sub">
            <a class="px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-2" href="#"><i class="fa-solid fa-chart-line w-4 text-slate-500"></i><span class="label">OpenStrategies</span></a>
            <a class="px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-2" href="#"><i class="fa-solid fa-coins w-4 text-slate-500"></i><span class="label">Funds</span></a>
          </div>
        </details>

        <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50" href="#"><i class="fa-regular fa-square-check w-4 text-slate-500"></i><span class="label">Plans & Features</span></a>
        <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50" href="#"><i class="fa-regular fa-comments w-4 text-slate-500"></i><span class="label">Community</span></a>
        <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50" href="#"><i class="fa-solid fa-life-ring w-4 text-slate-500"></i><span class="label">Support</span></a>
        <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50" href="#"><i class="fa-solid fa-scale-balanced w-4 text-slate-500"></i><span class="label">Legal</span></a>
      </nav>

      <div class="p-3 border-t border-slate-200 footer flex items-center justify-between gap-2">
        <button id="ah-settings" class="btn btn-settings h-10 w-10 p-0 rounded-xl bg-slate-100 hover:bg-slate-200 border-0" title="Settings">
          <i class="fa-solid fa-gear"></i>
        </button>
        <button id="ah-collapse" class="btn btn-collapse h-10 w-10 p-0 rounded-xl bg-slate-100 hover:bg-slate-200 border-0" title="Collapse">
          <i class="fa-solid fa-arrow-left"></i>
        </button>
      </div>
    </aside>

    <!-- ===== Main ===== -->
    <main class="flex-1 min-w-0">
      <!-- Top Header Bar -->
      <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 bg-white">
        <div class="flex items-center gap-3 flex-1 min-w-0 max-w-[460px]">
          <div class="relative w-full">
            <input class="input w-full pl-9" placeholder="Search" />
            <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" />
            </svg>
          </div>
        </div>

        <!-- Profile cluster -->
        <div class="flex items-center gap-3">
          <button class="relative h-10 w-10 rounded-full border border-slate-200 grid place-items-center hover:bg-slate-50" aria-label="Notifications">
            <i class="fa-regular fa-bell text-slate-500"></i>
            <span class="absolute -top-0.5 -right-0.5 h-2.5 w-2.5 rounded-full bg-orange-500 ring-2 ring-white"></span>
          </button>
          <img id="hdr-avatar" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><rect width='100%' height='100%' fill='%23f1f5f9'/></svg>" alt="Profile" class="w-9 h-9 rounded-full object-cover border border-slate-200" />
          <button id="hdr-profile-btn" class="flex items-center gap-2 text-slate-900 font-medium hover:text-slate-700">
            <span id="hdr-name">—</span>
            <i class="fa-solid fa-chevron-down text-slate-500 text-xs"></i>
          </button>
        </div>
      </div>

      <!-- ===== Settings ===== -->
      <section id="settings" class="px-6 py-8">
        <h1 class="text-2xl font-semibold text-slate-900">Profile Settings</h1>
        <hr class="mt-6 mb-8 border-slate-200"/>

        <div class="grid grid-cols-12 gap-8">
          <!-- Left: tabs -->
          <aside class="col-span-12 md:col-span-3">
            <nav id="settings-nav" class="space-y-1">
              <!-- hash links -->
              <a href="#basic"      data-tab="basic"      class="w-full block text-left px-4 py-2 rounded-lg text-slate-800 bg-slate-100">Basic Info</a>
              <a href="#manage"     data-tab="manage"     class="w-full block text-left px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-50">Manage Accounts</a>
              <a href="#docs"       data-tab="docs"       class="w-full block text-left px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-50">Account Documents</a>
              <a href="#extra"      data-tab="extra"      class="w-full block text-left px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-50">Additional Info</a>
              <a href="#agreements" data-tab="agreements" class="w-full block text-left px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-50">Agreements</a>
              <a href="#security"   data-tab="security"   class="w-full block text-left px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-50">Security</a>
              <a href="#apps"       data-tab="apps"       class="w-full block text-left px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-50">Connected Apps</a>
              <a href="#ip"         data-tab="ip"         class="w-full block text-left px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-50">IP Allowlist</a>
            </nav>
          </aside>

          <!-- Right: panels -->
          <div class="col-span-12 md:col-span-9">
            <!-- BASIC INFO -->
            <div id="basic" data-panel="basic" class="card border border-slate-200 rounded-2xl p-6">
              <h2 class="text-xl font-semibold text-slate-900">Details</h2>

              <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-6 items-center">
                <label class="text-slate-600">Account Number</label>
                <div class="sm:col-span-2 text-slate-600 font-medium" id="acc-number">—</div>
              </div>

              <h3 class="mt-10 text-xl font-semibold text-slate-900">Update Details</h3>

              <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-6 items-center">
                <label for="email" class="text-slate-600">Email</label>
                <div class="sm:col-span-2">
                  <input id="email" class="input w-full" type="email" placeholder="name@domain.com" disabled />
                  <p id="email-note" class="mt-2 text-sm text-slate-500">Please contact support to change the email for business accounts.</p>
                </div>
              </div>

              <div class="mt-8">
                <button id="save-basic" class="btn btn-olive cursor-not-allowed opacity-60" disabled>Save changes</button>
              </div>
            </div>

            <!-- MANAGE ACCOUNTS -->
            <div id="manage" data-panel="manage" class="hidden card border border-slate-200 rounded-2xl p-6">
              <h2 class="text-xl font-semibold text-slate-900">Manage Accounts</h2>
              <p class="mt-4 text-sm text-slate-500">No linked sub-accounts yet.</p>
            </div>

            <!-- ACCOUNT DOCUMENTS (KYC via external flow) -->
            <div id="docs" data-panel="docs" class="hidden card border border-slate-200 rounded-2xl p-6">
              <div class="flex items-center justify-between">
                <h2 class="text-xl font-semibold text-slate-900">KYC Verification</h2>
                <span id="kyc-state"
                      class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-amber-100 text-amber-900">
                  Complete your KYC
                </span>
              </div>
              <p class="mt-2 text-sm text-slate-500">
                We’ll take you to our verification partner. It takes ~3–5 minutes.
              </p>

              <div class="mt-6">
                <button id="btn-kyc-start" class="btn-olive inline-flex items-center gap-2 px-4 py-2 rounded-xl font-semibold">
                  <i class="fa-solid fa-id-card"></i>
                  Get Started mate
                </button>
                <span id="kyc-error" class="hidden ml-3 text-sm text-rose-700">Sorry, couldn’t start KYC. Try again.</span>
              </div>
            </div>

            <!-- ADDITIONAL INFO -->
            <div id="extra" data-panel="extra" class="hidden card border border-slate-200 rounded-2xl p-6">
              <h2 class="text-xl font-semibold text-slate-900">Additional Info</h2>
              <p class="mt-2 text-sm text-slate-500">Update your personal details, avatar and KYC suitability.</p>

              <!-- Names -->
              <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <label class="block">
                  <span class="text-sm text-slate-600">First name</span>
                  <input id="first_name" class="input w-full" placeholder="First name" />
                </label>
                <label class="block">
                  <span class="text-sm text-slate-600">Last name</span>
                  <input id="last_name" class="input w-full" placeholder="Last name" />
                </label>
              </div>

              <!-- Avatar -->
              <div class="mt-6">
                <div class="flex items-center gap-4">
                  <img id="avatar-preview" class="h-16 w-16 rounded-full object-cover border border-slate-200 bg-slate-50" alt="avatar"/>
                  <div class="space-y-2">
                    <label class="block">
                      <span class="text-sm text-slate-600">Avatar</span>
                      <input id="avatar-file" type="file" accept="image/*" class="block text-xs" />
                    </label>
                    <button id="remove-avatar" type="button" class="hidden text-xs underline text-rose-700">Remove avatar</button>
                    <p class="text-[11px] text-slate-500">JPG/PNG, &lt; 2MB. Best results: 512×512px.</p>
                  </div>
                </div>
              </div>

              <!-- Contact -->
              <div class="mt-8">
                <div class="font-semibold text-slate-900">Contact</div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
                  <label class="block">
                    <span class="text-sm text-slate-600">Phone</span>
                    <input id="phone" class="input w-full" placeholder="+27 ..." inputmode="tel"/>
                  </label>
                  <div></div>
                </div>
              </div>

              <!-- Identity -->
              <div class="mt-8">
                <div class="font-semibold text-slate-900">Identity</div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
                  <label class="block">
                    <span class="text-sm text-slate-600">Date of birth</span>
                    <input id="dob" type="date" class="input w-full"/>
                  </label>
                  <label class="block">
                    <span class="text-sm text-slate-600">ID / Passport number</span>
                    <input id="id_number" class="input w-full" placeholder="e.g. 910101..." />
                  </label>
                  <label class="block">
                    <span class="text-sm text-slate-600">Nationality</span>
                    <input id="nationality" class="input w-full" placeholder="South African"/>
                  </label>
                  <label class="block">
                    <span class="text-sm text-slate-600">Country of residence</span>
                    <input id="country_residence" class="input w-full" placeholder="South Africa"/>
                  </label>
                </div>
              </div>

              <!-- Employment & suitability -->
              <div class="mt-8">
                <div class="font-semibold text-slate-900">Employment & suitability</div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
                  <label class="block">
                    <span class="text-sm text-slate-600">Employment status</span>
                    <select id="employment_status" class="input w-full">
                      <option value="">Select…</option>
                      <option>Employed</option><option>Self-employed</option><option>Student</option>
                      <option>Unemployed</option><option>Retired</option>
                    </select>
                  </label>
                  <label class="block">
                    <span class="text-sm text-slate-600">Occupation</span>
                    <input id="occupation" class="input w-full" />
                  </label>
                  <label class="block">
                    <span class="text-sm text-slate-600">Employer</span>
                    <input id="employer" class="input w-full" />
                  </label>
                  <label class="block">
                    <span class="text-sm text-slate-600">Annual income bracket</span>
                    <select id="income_bracket" class="input w-full">
                      <option value="">Select…</option>
                      <option>&lt; R250k</option><option>R250k–R500k</option><option>R500k–R1m</option>
                      <option>R1m–R2m</option><option>&gt; R2m</option>
                    </select>
                  </label>
                  <label class="block">
                    <span class="text-sm text-slate-600">Source of funds</span>
                    <select id="source_of_funds" class="input w/full">
                      <option value="">Select…</option>
                      <option>Salary</option><option>Business</option><option>Investments</option>
                      <option>Inheritance</option><option>Gift</option><option>Other</option>
                    </select>
                  </label>
                  <label class="block">
                    <span class="text-sm text-slate-600">Net worth range</span>
                    <select id="net_worth_range" class="input w/full">
                      <option value="">Select…</option>
                      <option>&lt; R500k</option><option>R500k–R1m</option><option>R1m–R5m</option>
                      <option>R5m–R10m</option><option>&gt; R10m</option>
                    </select>
                  </label>
                  <label class="block">
                    <span class="text-sm text-slate-600">Experience level</span>
                    <select id="experience_level" class="input w/full">
                      <option value="">Select…</option>
                      <option>None</option><option>Beginner</option><option>Intermediate</option><option>Advanced</option>
                    </select>
                  </label>
                  <label class="block">
                    <span class="text-sm text-slate-600">Risk tolerance</span>
                    <select id="risk_tolerance" class="input w/full">
                      <option value="">Select…</option>
                      <option>Low</option><option>Moderate</option><option>High</option>
                    </select>
                  </label>
                </div>
              </div>

              <div class="mt-4">
                <span class="text-sm text-slate-600 block mb-2">Investment objectives</span>
                <div class="grid grid-cols-2 gap-2 text-sm">
                  <label class="flex items-center gap-2"><input type="checkbox" name="objectives" value="Growth"> Growth</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="objectives" value="Income"> Income</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="objectives" value="Preservation"> Capital preservation</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="objectives" value="Speculation"> Speculation</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="objectives" value="Hedging"> Hedging</label>
                </div>
              </div>

              <div class="mt-8">
                <div class="font-semibold text-slate-900">Compliance</div>
                <div class="mt-3 space-y-2 text-sm">
                  <label class="flex items-center gap-2"><input id="pep" type="checkbox"> Politically Exposed Person (PEP)</label>
                  <label class="flex items-center gap-2"><input id="fatca_crs" type="checkbox"> I confirm FATCA/CRS declarations as needed</label>
                </div>
              </div>

              <div class="mt-8">
                <button id="save-extra" class="btn btn-olive">Save additional info</button>
                <span id="extra-saved" class="hidden text-sm text-emerald-700 ml-2">Saved ✔</span>
              </div>
            </div>

            <!-- AGREEMENTS -->
            <div id="agreements" data-panel="agreements" class="hidden card border border-slate-200 rounded-2xl p-6">
              <h2 class="text-xl font-semibold text-slate-900">Agreements</h2>
              <p class="mt-4 text-sm text-slate-500">Your signed agreements will show here.</p>
            </div>

            <!-- SECURITY -->
            <div id="security" data-panel="security" class="hidden card border border-slate-200 rounded-2xl p-6">
              <h2 class="text-xl font-semibold text-slate-900">Security</h2>
              <div class="mt-6 space-y-4">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="font-medium text-slate-900">Two-factor authentication</div>
                    <div class="text-sm text-slate-500">Protect your account with an extra step at login.</div>
                  </div>
                  <button class="btn hover:bg-slate-50">Manage</button>
                </div>
                <div class="flex items-center justify-between">
                  <div>
                    <div class="font-medium text-slate-900">Change password</div>
                    <div class="text-sm text-slate-500">Update your password regularly.</div>
                  </div>
                  <button class="btn hover:bg-slate-50">Update</button>
                </div>
              </div>
            </div>

            <!-- CONNECTED APPS -->
            <div id="apps" data-panel="apps" class="hidden card border border-slate-200 rounded-2xl p-6">
              <h2 class="text-xl font-semibold text-slate-900">Connected Apps</h2>
              <p class="mt-4 text-sm text-slate-500">No apps connected.</p>
            </div>

            <!-- IP ALLOWLIST -->
            <div id="ip" data-panel="ip" class="hidden card border border-slate-200 rounded-2xl p-6">
              <h2 class="text-xl font-semibold text-slate-900">IP Allowlist</h2>
              <p class="mt-4 text-sm text-slate-500">Add IPs to restrict API access.</p>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- ===== Profile Modal ===== -->
  <div id="profile-modal" class="fixed inset-0 z-[100] hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute right-6 top-20 w-64 rounded-2xl bg-white shadow-xl border border-slate-200 overflow-hidden">
      <div class="px-4 py-3 border-b border-slate-200">
        <div class="text-sm font-semibold text-slate-900">Account</div>
        <div id="pm-email" class="text-xs text-slate-500 truncate">—</div>
      </div>
      <div class="p-2">
        <a href="#basic" id="pm-profile" class="w-full flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-50">
          <i class="fa-regular fa-user text-slate-500 w-4"></i>
          <span>Profile settings</span>
        </a>
        <button id="pm-logout" class="w-full flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-50 text-rose-700">
          <i class="fa-solid fa-right-from-bracket w-4"></i>
          <span>Log out</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ===== Behavior ===== -->
  <script>
    // sidebar collapse memory
    (function () {
      const layout = document.getElementById('layout');
      const aside = document.getElementById('ah-sidebar');
      const btn = document.getElementById('ah-collapse');
      const saved = localStorage.getItem('ah_collapsed') === 'true';
      if (saved) { aside.setAttribute('data-collapsed', 'true'); layout.classList.add('is-collapsed'); }
      btn.addEventListener('click', () => {
        const isCollapsed = aside.getAttribute('data-collapsed') === 'true';
        if (!isCollapsed) aside.querySelectorAll('details[open]').forEach(d => d.removeAttribute('open'));
        aside.setAttribute('data-collapsed', String(!isCollapsed));
        layout.classList.toggle('is-collapsed', !isCollapsed);
        localStorage.setItem('ah_collapsed', String(!isCollapsed));
      });
    })();

    // ===== Hash-aware tab switcher =====
    (function(){
      const nav = document.getElementById('settings-nav');
      const links = Array.from(nav.querySelectorAll('a[data-tab]'));
      const panels = Array.from(document.querySelectorAll('[data-panel]'));

      function show(tab){
        links.forEach(a=>{
          const active = a.dataset.tab === tab;
          a.classList.toggle('bg-slate-100', active);
          a.classList.toggle('text-slate-800', active);
          a.classList.toggle('text-slate-700', !active);
        });
        panels.forEach(p=>p.classList.toggle('hidden', p.dataset.panel !== tab));
        const el = document.getElementById(tab);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      function parseHash(){
        const raw = (location.hash || '').trim();
        const id = raw.startsWith('#') ? raw.slice(1) : raw;
        const allowed = new Set(links.map(a=>a.dataset.tab));
        return allowed.has(id) ? id : 'basic';
      }

      window.addEventListener('hashchange', ()=> show(parseHash()));
      show(parseHash());
    })();
  </script>

  <!-- ===== Supabase integration ===== -->
<script type="module">
  import { supabase } from "/js/supabase.js";

  // ---------- helpers ----------
  function banner(msg, tone="warn"){
    let el=document.getElementById("banner");
    if(!el){
      el=document.createElement("div");
      el.id="banner";
      el.className="fixed top-3 left-1/2 -translate-x-1/2 z-[200] px-4 py-2 rounded-lg shadow text-sm";
      document.body.appendChild(el);
    }
    el.className="fixed top-3 left-1/2 -translate-x-1/2 z-[200] px-4 py-2 rounded-lg shadow text-sm";
    if(tone==="warn"){ el.classList.add("bg-amber-100","text-amber-900"); }
    if(tone==="err"){  el.classList.add("bg-rose-100","text-rose-900"); }
    if(tone==="ok"){   el.classList.add("bg-emerald-100","text-emerald-900"); }
    el.textContent = msg;
    clearTimeout(el._t);
    el._t = setTimeout(()=>el.remove(), 4000);
  }

  const REQUIRED_FIELDS = ["first_name","last_name","phone","dob","id_number","nationality","country_residence"];
  function computeProfileComplete(row){
    return REQUIRED_FIELDS.every(k => String(row?.[k] ?? "").trim().length > 0);
  }

  async function ensureProfile(userId, email){
    let { data, error } = await supabase.from("profiles").select("*").eq("id", userId).maybeSingle();
    if (error && error.code !== "PGRST116") throw error;
    if (data) return data;
    const payload = { id: userId, email, updated_at: new Date().toISOString() };
    const up = await supabase.from("profiles").upsert(payload, { onConflict: "id" }).select("*").single();
    if (up.error) throw up.error;
    return up.data;
  }

  // KYC utilities
  function resolveKycBoolean(row) {
    const v = row?.kyc_status;
    if (typeof v === "boolean") return v;
    if (typeof v === "string") {
      const t = v.toLowerCase();
      return ["verified","approved","done","passed","kyc_done"].includes(t);
    }
    return false;
  }
  function setKycState(isDone){
    const kycStateEl = document.getElementById("kyc-state");
    if (!kycStateEl) return;
    if (isDone){
      kycStateEl.textContent = "KYC done";
      kycStateEl.className = "inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-emerald-100 text-emerald-900";
    } else {
      kycStateEl.textContent = "Complete your KYC";
      kycStateEl.className = "inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-amber-100 text-amber-900";
    }
  }
  async function getKycUrl(user){
    try {
      const { data: row } = await supabase.from("profiles").select("kyc_start_url").eq("id", user.id).single();
      if (row?.kyc_start_url) return row.kyc_start_url;
    } catch(_) {}
    try {
      const { data: { session } } = await supabase.auth.getSession();
      const res = await fetch("/functions/v1/start-kyc", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${session?.access_token || ""}` },
        body: JSON.stringify({ user_id: user.id })
      });
      if (res.ok) { const j = await res.json(); if (j?.url) return j.url; }
    } catch(_) {}
    return "/kyc/start";
  }

  // ---------- route guard ----------
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) {
    const next = encodeURIComponent(location.pathname + location.search + location.hash);
    location.replace(`/auth.html?tab=in&redirect=${next}`);
  }
  const { data: { user } } = await supabase.auth.getUser();

  // ---------- hydrate ----------
  const row = await ensureProfile(user.id, user.email || null);

  // header bits
  const emailInput  = document.getElementById("email");
  emailInput.value = user.email || "";
  const acct = row?.account_number || "949915944";
  document.getElementById("acc-number").textContent = acct;
  document.getElementById("sidebar-acc").textContent = acct;

  // map fields
  const setVal = (id, v)=>{ const el=document.getElementById(id); if(el) el.value = v ?? ""; };
  setVal("first_name", row?.first_name);
  setVal("last_name",  row?.last_name);
  setVal("phone",      row?.phone);
  setVal("dob",        row?.dob);
  setVal("id_number",  row?.id_number);
  setVal("nationality",       row?.nationality);
  setVal("country_residence", row?.country_residence);
  setVal("employment_status", row?.employment_status);
  setVal("occupation",        row?.occupation);
  setVal("employer",          row?.employer);
  setVal("income_bracket",    row?.income_bracket);
  setVal("source_of_funds",   row?.source_of_funds);
  setVal("net_worth_range",   row?.net_worth_range);
  setVal("experience_level",  row?.experience_level);
  setVal("risk_tolerance",    row?.risk_tolerance);

  const pep = document.getElementById("pep");
  const fat = document.getElementById("fatca_crs");
  if (pep) pep.checked = !!row?.pep;
  if (fat) fat.checked = !!row?.fatca_crs;

  // objectives
  const objSet = new Set(String(row?.objectives || "").split(",").map(s=>s.trim()).filter(Boolean));
  document.querySelectorAll('input[name="objectives"]').forEach(cb => cb.checked = objSet.has(cb.value));

  // avatar
  const blankAvatar = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='100%' height='100%' fill='%23f1f5f9'/></svg>";
  const avatarUrl = row?.avatar_url || blankAvatar;
  const avPrev = document.getElementById("avatar-preview");
  const hdrAvatar = document.getElementById("hdr-avatar");
  if (avPrev) avPrev.src = avatarUrl;
  if (hdrAvatar) hdrAvatar.src = avatarUrl;
  const avRemove = document.getElementById("remove-avatar");
  if (avRemove) avRemove.classList.toggle("hidden", !row?.avatar_url);

  // name
  const fn=(row?.first_name||"").trim(), ln=(row?.last_name||"").trim();
  const fallback = user.email?.split("@")[0] || "User";
  document.getElementById("hdr-name").textContent = (fn||ln) ? `${fn} ${ln}`.trim() : fallback;

  // KYC
  setKycState(resolveKycBoolean(row));

  // ---------- profile gating (UI + sidebar) ----------
  let profileComplete = computeProfileComplete(row);
  const allowedTabsWhenIncomplete = new Set(["extra","docs"]); // let them complete stuff

  function lockNavIfNeeded(){
    const mainNav = document.getElementById("main-nav");
    if (!mainNav) return;
    mainNav.querySelectorAll('a[href]:not([href^="#"])').forEach(a=>{
      if (!profileComplete && !/settings\.html/i.test(a.getAttribute("href")||"")) {
        a.classList.add("link-disabled");
        a.addEventListener("click", (e)=>{ e.preventDefault(); banner("Please complete your profile first (Additional Info).", "warn"); });
      } else {
        a.classList.remove("link-disabled");
      }
    });
  }
  lockNavIfNeeded();

  // also block switching tabs you don’t allow while incomplete
  const settingsNav = document.getElementById("settings-nav");
  settingsNav.addEventListener("click", (e)=>{
    const a = e.target.closest("a[data-tab]");
    if (!a) return;
    const tab = a.dataset.tab;
    if (!profileComplete && !allowedTabsWhenIncomplete.has(tab)){
      e.preventDefault();
      banner("Finish your profile in Additional Info (and KYC) first.", "warn");
      location.hash = "#extra";
    }
  });

  // ---------- profile modal ----------
  const hdrProfileBtn = document.getElementById("hdr-profile-btn");
  const modal = document.getElementById("profile-modal");
  const pmEmail = document.getElementById("pm-email");
  const btnLogout = document.getElementById("pm-logout");
  function openModal(){ modal.classList.remove("hidden"); }
  function closeModal(){ modal.classList.add("hidden"); }
  hdrProfileBtn?.addEventListener("click", (e)=>{ e.preventDefault(); pmEmail.textContent = user?.email || "—"; openModal(); });
  modal.addEventListener("click", (e)=>{ if (e.target === modal || e.target.classList.contains("bg-black/40")) closeModal(); });
  window.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeModal(); });
  btnLogout?.addEventListener("click", async ()=>{
    try{ await supabase.auth.signOut(); location.replace("/auth.html?tab=in"); }
    catch{ banner("Sorry, logout failed.", "err"); }
  });

  // ---------- avatar upload ----------
  async function uploadAvatar(file){
    const AVATAR_BUCKET = "avatars";
    if (!file) return;
    if (!file.type.startsWith("image/")) throw new Error("Pick an image");
    if (file.size > 2*1024*1024) throw new Error("Image too large (max 2MB)");
    avPrev.src = URL.createObjectURL(file);

    const ext=(file.name.split(".").pop()||"jpg").toLowerCase();
    const path=`${user.id}/avatar_${Date.now()}.${ext}`;
    const { error: upErr } = await supabase.storage.from(AVATAR_BUCKET)
      .upload(path, file, { upsert:true, cacheControl:"3600", contentType:file.type });
    if (upErr) throw upErr;

    const { data: pub } = supabase.storage.from(AVATAR_BUCKET).getPublicUrl(path);
    const avatar_url = pub.publicUrl;

    const { error: dbErr } = await supabase.from("profiles")
      .upsert({ id:user.id, avatar_url, updated_at:new Date().toISOString() }, { onConflict:"id" });
    if (dbErr) throw dbErr;

    hdrAvatar.src = avatar_url;
    avRemove.classList.remove("hidden");
  }
  const avFile = document.getElementById("avatar-file");
  avFile?.addEventListener("change", async ()=>{ const f=avFile.files?.[0]; if(!f) return; try{ await uploadAvatar(f); }catch(e){ banner(e.message||"Avatar upload failed", "err"); } });
  avRemove?.addEventListener("click", async ()=>{
    const { error } = await supabase.from("profiles")
      .upsert({ id:user.id, avatar_url:null, updated_at:new Date().toISOString() }, { onConflict:"id" });
    if (error) return banner(error.message, "err");
    const blank = blankAvatar; avPrev.src = blank; hdrAvatar.src = blank; avRemove.classList.add("hidden");
  });

  // ---------- KYC button ----------
  const kycBtnEl = document.getElementById("btn-kyc-start");
  const kycErrEl = document.getElementById("kyc-error");
  kycBtnEl?.addEventListener("click", async ()=>{
    try{
      kycErrEl?.classList.add("hidden");
      kycBtnEl.disabled = true; kycBtnEl.textContent = "Starting…";
      const url = await getKycUrl(user);
      if (!url) throw new Error("No KYC URL");
      location.href = url;
    }catch(e){
      kycErrEl?.classList.remove("hidden");
      console.error(e);
    }finally{
      kycBtnEl.disabled = false; kycBtnEl.textContent = "Get Started mate";
    }
  });

  // ---------- Save additional info (NO profile_complete write) ----------
  const extraSave = document.getElementById("save-extra");
  const extraSaved = document.getElementById("extra-saved");
  function setBusy(btn,on,label="Save additional info"){ btn.disabled=on; btn.textContent = on? "Saving…" : label }

  extraSave.addEventListener("click", async ()=>{
    setBusy(extraSave, true);
    extraSaved.classList.add("hidden");
    try{
      const payload = {
        id: user.id,
        first_name: (document.getElementById("first_name").value || "").trim(),
        last_name:  (document.getElementById("last_name").value  || "").trim(),
        phone:      (document.getElementById("phone").value      || "").trim(),
        dob:        document.getElementById("dob").value || null,
        id_number:  (document.getElementById("id_number").value  || "").trim() || null,
        nationality:       (document.getElementById("nationality").value || "").trim() || null,
        country_residence: (document.getElementById("country_residence").value || "").trim() || null,
        employment_status: document.getElementById("employment_status").value || null,
        occupation:        (document.getElementById("occupation").value || "").trim() || null,
        employer:          (document.getElementById("employer").value   || "").trim() || null,
        income_bracket:    document.getElementById("income_bracket").value || null,
        source_of_funds:   document.getElementById("source_of_funds").value || null,
        net_worth_range:   document.getElementById("net_worth_range").value || null,
        experience_level:  document.getElementById("experience_level").value || null,
        risk_tolerance:    document.getElementById("risk_tolerance").value || null,
        objectives: Array.from(document.querySelectorAll('input[name="objectives"]:checked')).map(cb=>cb.value).join(", "),
        pep: document.getElementById("pep").checked,
        fatca_crs: document.getElementById("fatca_crs").checked,
        updated_at: new Date().toISOString()
        // IMPORTANT: do NOT include profile_complete here — it’s generated by DB.
      };

      const { data: saved, error } = await supabase
        .from("profiles")
        .upsert(payload, { onConflict: "id" })
        .select("*")
        .single();

      if (error) throw error;

      // refresh local completeness + gating based on saved row (server truth if it also computes things)
      profileComplete = computeProfileComplete(saved);
      lockNavIfNeeded();

      // update header name instantly
      const fn = (saved.first_name||"").trim(), ln = (saved.last_name||"").trim();
      const fallback = (user.email||"").split("@")[0] || "User";
      document.getElementById("hdr-name").textContent = (fn||ln) ? `${fn} ${ln}`.trim() : fallback;

      extraSaved.classList.remove("hidden");

      // if now complete, let them roam — or soft-prompt to go home
      if (profileComplete) {
        banner("Profile completed — nice! 🎉", "ok");
      } else {
        banner("Saved. Still a few required fields missing.", "warn");
      }
    }catch(e){
      console.error(e);
      banner(e.message || "Save failed", "err");
    }finally{
      setBusy(extraSave, false);
    }
  });

</script>

</body>
</html>
