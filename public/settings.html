<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AlgoHive — Settings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root {
      --page: #0b1220;
      --bg: #ffffff;
      --muted: #64748b;
      --ink: #0f172a;
      --olive: #10b981;
      --brand: #f59e0b;
      --line: #e2e8f0;
    }
    html, body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--ink); height: 100% }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:.5rem; height:40px; padding:0 .875rem; border-radius:10px; border:1px solid var(--line); font-weight:600 }
    .input { height:40px; border:1px solid var(--line); border-radius:10px; padding:0 .75rem }
    #layout { --sb: 220px; display:grid; grid-template-columns:var(--sb) 1fr; min-height:100vh }
    #layout.is-collapsed { --sb: 64px }
    #ah-sidebar { transition: width .2s ease; width: var(--sb) }
    #ah-sidebar[data-collapsed="true"] .label, #ah-sidebar[data-collapsed="true"] .chevron { display:none }
    #ah-sidebar[data-collapsed="true"] details>.sub { display:none!important }
    #ah-sidebar[data-collapsed="true"] nav a, #ah-sidebar[data-collapsed="true"] details>summary { justify-content:center; gap:.25rem }
    #ah-sidebar .footer { transition: all .2s ease }
    #ah-sidebar[data-collapsed="true"] .footer { justify-content:center; flex-direction:column; gap:12px }
    #ah-sidebar[data-collapsed="true"] .btn-collapse { order:1 } #ah-sidebar[data-collapsed="true"] .btn-settings { order:2 }
    .btn-collapse :is(svg,i){ transition: transform .25s ease } #ah-sidebar[data-collapsed="true"] .btn-collapse :is(svg,i){ transform: rotate(180deg) }
  </style>
</head>

<body class="min-h-screen overflow-x-hidden">
  <div id="layout">
    <!-- ===== Sidebar ===== -->
    <aside id="ah-sidebar" data-collapsed="false" class="border-r border-slate-200 h-[100vh] sticky top-0 bg-white flex flex-col overflow-hidden">
      <div class="px-4 py-4 flex items-center gap-3 border-b border-slate-200">
        <img src="https://static.wixstatic.com/media/ac771e_af06d86a7a1f4abd87e52e45f3bcbd96~mv2.png" alt="AlgoHive Logo" class="w-10 h-10 object-contain" />
        <div class="min-w-0">
          <div class="font-bold text-[15px] text-slate-900 label">AlgoHive</div>
          <div class="text-[11px] text-slate-500 label">ID: <span id="sidebar-acc">—</span></div>
        </div>
      </div>

      <nav class="p-2 text-[14px] flex-1 overflow-y-auto">
        <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50 font-medium text-slate-900 bg-slate-100" href="/home.html" title="Home">
          <i class="fa-solid fa-house text-slate-500 w-4 shrink-0"></i><span class="label">Home</span>
        </a>

        <details class="group mt-1">
          <summary class="flex items-center justify-between px-3 py-2 rounded-lg hover:bg-slate-50 cursor-pointer font-medium text-slate-900">
            <span class="flex items-center gap-3">
              <i class="fa-regular fa-user w-4 text-slate-500"></i><span class="label">Portfolio</span>
            </span>
            <i class="fa-solid fa-chevron-down text-slate-400 group-open:rotate-180 transition-transform chevron"></i>
          </summary>
          <div class="ml-8 mt-1 flex flex-col sub">
            <a class="px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-2" href="#"><i class="fa-solid fa-chart-pie w-4 text-slate-500"></i><span class="label">Positions</span></a>
            <a class="px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-2" href="#"><i class="fa-regular fa-clipboard w-4 text-slate-500"></i><span class="label">Orders</span></a>
            <a class="px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-2" href="#"><i class="fa-solid fa-bars w-4 text-slate-500"></i><span class="label">Activity</span></a>
            <a class="px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-2" href="#"><i class="fa-solid fa-table w-4 text-slate-500"></i><span class="label">Balances</span></a>
            <a class="px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-2" href="#"><i class="fa-solid fa-hand-holding-dollar w-4 text-slate-500"></i><span class="label">Funding</span></a>
          </div>
        </details>

        <details class="group mt-1">
          <summary class="flex items-center justify-between px-3 py-2 rounded-lg hover:bg-slate-50 cursor-pointer font-medium text-slate-900">
            <span class="flex items-center gap-3">
              <i class="fa-solid fa-link w-4 text-slate-500"></i><span class="label">Invest</span>
            </span>
            <i class="fa-solid fa-chevron-down text-slate-400 group-open:rotate-180 transition-transform chevron"></i>
          </summary>
          <div class="ml-8 mt-1 flex flex-col sub">
            <a class="px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-2" href="#"><i class="fa-solid fa-chart-line w-4 text-slate-500"></i><span class="label">OpenStrategies</span></a>
            <a class="px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-2" href="#"><i class="fa-solid fa-coins w-4 text-slate-500"></i><span class="label">Funds</span></a>
          </div>
        </details>

        <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50" href="#"><i class="fa-regular fa-square-check w-4 text-slate-500"></i><span class="label">Plans & Features</span></a>
        <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50" href="#"><i class="fa-regular fa-comments w-4 text-slate-500"></i><span class="label">Community</span></a>
        <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50" href="#"><i class="fa-solid fa-life-ring w-4 text-slate-500"></i><span class="label">Support</span></a>
        <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50" href="#"><i class="fa-solid fa-scale-balanced w-4 text-slate-500"></i><span class="label">Legal</span></a>
      </nav>

      <div class="p-3 border-t border-slate-200 footer flex items-center justify-between gap-2">
        <button id="ah-settings" class="btn btn-settings h-10 w-10 p-0 rounded-xl bg-slate-100 hover:bg-slate-200 border-0" title="Settings">
          <i class="fa-solid fa-gear"></i>
        </button>
        <button id="ah-collapse" class="btn btn-collapse h-10 w-10 p-0 rounded-xl bg-slate-100 hover:bg-slate-200 border-0" title="Collapse">
          <i class="fa-solid fa-arrow-left"></i>
        </button>
      </div>
    </aside>

    <!-- ===== Main ===== -->
    <main class="flex-1 min-w-0">
      <!-- Top Header Bar -->
      <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 bg-white">
        <div class="flex items-center gap-3 flex-1 min-w-0 max-w-[460px]">
          <div class="relative w-full">
            <input class="input w-full pl-9" placeholder="Search" />
            <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" />
            </svg>
          </div>
        </div>

        <!-- Profile cluster (hydrated) -->
        <div class="flex items-center gap-3">
          <button class="relative h-10 w-10 rounded-full border border-slate-200 grid place-items-center hover:bg-slate-50" aria-label="Notifications">
            <i class="fa-regular fa-bell text-slate-500"></i>
            <span class="absolute -top-0.5 -right-0.5 h-2.5 w-2.5 rounded-full bg-orange-500 ring-2 ring-white"></span>
          </button>
          <img id="hdr-avatar" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><rect width='100%' height='100%' fill='%23f1f5f9'/></svg>" alt="Profile" class="w-9 h-9 rounded-full object-cover border border-slate-200" />
          <button class="flex items-center gap-2 text-slate-900 font-medium hover:text-slate-700">
            <span id="hdr-name">—</span>
            <i class="fa-solid fa-chevron-down text-slate-500 text-xs"></i>
          </button>
        </div>
      </div>

      <!-- ===== Settings ===== -->
      <section id="settings" class="px-6 py-8">
        <h1 class="text-2xl font-semibold text-slate-900">Profile Settings</h1>
        <hr class="mt-6 mb-8 border-slate-200"/>

        <div class="grid grid-cols-12 gap-8">
          <!-- Left: tabs -->
          <aside class="col-span-12 md:col-span-3">
            <nav id="settings-nav" class="space-y-1">
              <button data-tab="basic" class="w-full text-left px-4 py-2 rounded-lg text-slate-800 bg-slate-100">Basic Info</button>
              <button data-tab="manage" class="w-full text-left px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-50">Manage Accounts</button>
              <button data-tab="docs" class="w-full text-left px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-50">Account Documents</button>
              <button data-tab="extra" class="w-full text-left px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-50">Additional Info</button>
              <button data-tab="agreements" class="w-full text-left px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-50">Agreements</button>
              <button data-tab="security" class="w-full text-left px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-50">Security</button>
              <button data-tab="apps" class="w-full text-left px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-50">Connected Apps</button>
              <button data-tab="ip" class="w-full text-left px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-50">IP Allowlist</button>
            </nav>
          </aside>

          <!-- Right: panels -->
          <div class="col-span-12 md:col-span-9">
            <!-- BASIC INFO -->
            <div data-panel="basic" class="card border border-slate-200 rounded-2xl p-6">
              <h2 class="text-xl font-semibold text-slate-900">Details</h2>

              <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-6 items-center">
                <label class="text-slate-600">Account Number</label>
                <div class="sm:col-span-2 text-slate-600 font-medium" id="acc-number">—</div>
              </div>

              <h3 class="mt-10 text-xl font-semibold text-slate-900">Update Details</h3>

              <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-6 items-center">
                <label for="email" class="text-slate-600">Email</label>
                <div class="sm:col-span-2">
                  <input id="email" class="input w-full" type="email" placeholder="name@domain.com" disabled />
                  <p id="email-note" class="mt-2 text-sm text-slate-500">Please contact support to change the email for business accounts.</p>
                </div>
              </div>

              <div class="mt-8">
                <button id="save-basic" class="btn bg-amber-100 text-amber-900 cursor-not-allowed opacity-60" disabled>Save changes</button>
              </div>
            </div>

            <!-- MANAGE ACCOUNTS -->
            <div data-panel="manage" class="hidden card border border-slate-200 rounded-2xl p-6">
              <h2 class="text-xl font-semibold text-slate-900">Manage Accounts</h2>
              <p class="mt-4 text-sm text-slate-500">No linked sub-accounts yet.</p>
            </div>

            <!-- ACCOUNT DOCUMENTS -->
            <div data-panel="docs" class="hidden card border border-slate-200 rounded-2xl p-6">
              <h2 class="text-xl font-semibold text-slate-900">Account Documents</h2>
              <p class="mt-4 text-sm text-slate-500">Statements and tax docs will appear here.</p>
            </div>

            <!-- ADDITIONAL INFO (▶️ NEW: first/last + avatar) -->
            <div data-panel="extra" class="hidden card border border-slate-200 rounded-2xl p-6">
              <h2 class="text-xl font-semibold text-slate-900">Additional Info</h2>
              <p class="mt-2 text-sm text-slate-500">Update your personal details and avatar.</p>

              <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <label class="block">
                  <span class="text-sm text-slate-600">First name</span>
                  <input id="first_name" class="input w-full" placeholder="First name" />
                </label>
                <label class="block">
                  <span class="text-sm text-slate-600">Last name</span>
                  <input id="last_name" class="input w-full" placeholder="Last name" />
                </label>
              </div>

              <div class="mt-6">
                <div class="flex items-center gap-4">
                  <img id="avatar-preview" class="h-16 w-16 rounded-full object-cover border border-slate-200 bg-slate-50" alt="avatar"/>
                  <div class="space-y-2">
                    <label class="block">
                      <span class="text-sm text-slate-600">Avatar</span>
                      <input id="avatar-file" type="file" accept="image/*" class="block text-xs" />
                    </label>
                    <button id="remove-avatar" type="button" class="hidden text-xs underline text-rose-700">Remove avatar</button>
                    <p class="text-[11px] text-slate-500">JPG/PNG, &lt; 2MB. Square works best.</p>
                  </div>
                </div>
              </div>

              <div class="mt-8">
                <button id="save-extra" class="btn bg-black text-white">Save additional info</button>
                <span id="extra-saved" class="hidden text-sm text-emerald-700 ml-2">Saved ✔</span>
              </div>
            </div>

            <!-- AGREEMENTS -->
            <div data-panel="agreements" class="hidden card border border-slate-200 rounded-2xl p-6">
              <h2 class="text-xl font-semibold text-slate-900">Agreements</h2>
              <p class="mt-4 text-sm text-slate-500">Your signed agreements will show here.</p>
            </div>

            <!-- SECURITY -->
            <div data-panel="security" class="hidden card border border-slate-200 rounded-2xl p-6">
              <h2 class="text-xl font-semibold text-slate-900">Security</h2>
              <div class="mt-6 space-y-4">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="font-medium text-slate-900">Two-factor authentication</div>
                    <div class="text-sm text-slate-500">Protect your account with an extra step at login.</div>
                  </div>
                  <button class="btn hover:bg-slate-50">Manage</button>
                </div>
                <div class="flex items-center justify-between">
                  <div>
                    <div class="font-medium text-slate-900">Change password</div>
                    <div class="text-sm text-slate-500">Update your password regularly.</div>
                  </div>
                  <button class="btn hover:bg-slate-50">Update</button>
                </div>
              </div>
            </div>

            <!-- CONNECTED APPS -->
            <div data-panel="apps" class="hidden card border border-slate-200 rounded-2xl p-6">
              <h2 class="text-xl font-semibold text-slate-900">Connected Apps</h2>
              <p class="mt-4 text-sm text-slate-500">No apps connected.</p>
            </div>

            <!-- IP ALLOWLIST -->
            <div data-panel="ip" class="hidden card border border-slate-200 rounded-2xl p-6">
              <h2 class="text-xl font-semibold text-slate-900">IP Allowlist</h2>
              <p class="mt-4 text-sm text-slate-500">Add IPs to restrict API access.</p>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- ===== Behavior ===== -->
  <script>
    // sidebar collapse memory
    (function () {
      const layout = document.getElementById('layout');
      const aside = document.getElementById('ah-sidebar');
      const btn = document.getElementById('ah-collapse');
      const saved = localStorage.getItem('ah_collapsed') === 'true';
      if (saved) { aside.setAttribute('data-collapsed', 'true'); layout.classList.add('is-collapsed'); }
      btn.addEventListener('click', () => {
        const isCollapsed = aside.getAttribute('data-collapsed') === 'true';
        if (!isCollapsed) aside.querySelectorAll('details[open]').forEach(d => d.removeAttribute('open'));
        aside.setAttribute('data-collapsed', String(!isCollapsed));
        layout.classList.toggle('is-collapsed', !isCollapsed);
        localStorage.setItem('ah_collapsed', String(!isCollapsed));
      });
    })();

    // simple tab switcher
    (function(){
      const nav = document.getElementById('settings-nav');
      const buttons = Array.from(nav.querySelectorAll('button[data-tab]'));
      const panels  = Array.from(document.querySelectorAll('[data-panel]'));
      function show(tab){
        buttons.forEach(b=>{
          b.classList.toggle('bg-slate-100', b.dataset.tab===tab);
          b.classList.toggle('text-slate-800', b.dataset.tab===tab);
          b.classList.toggle('text-slate-700', b.dataset.tab!==tab);
        });
        panels.forEach(p=>p.classList.toggle('hidden', p.dataset.panel!==tab));
      }
      nav.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-tab]'); if (!btn) return; show(btn.dataset.tab);
      });
      show('basic');
    })();
  </script>

  <!-- ===== Supabase integration ===== -->
  <script type="module">
    import { supabase } from "/js/supabase.js";

    const AVATAR_BUCKET = "avatars";

    // guard route
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      const next = encodeURIComponent(location.pathname);
      location.replace(`/auth.html?tab=in&redirect=${next}`);
    }

    // elements
    const accNumberEl = document.getElementById("acc-number");
    const sidebarAcc  = document.getElementById("sidebar-acc");
    const emailInput  = document.getElementById("email");
    const hdrName     = document.getElementById("hdr-name");
    const hdrAvatar   = document.getElementById("hdr-avatar");

    const firstName   = document.getElementById("first_name");
    const lastName    = document.getElementById("last_name");
    const avPrev      = document.getElementById("avatar-preview");
    const avFile      = document.getElementById("avatar-file");
    const avRemove    = document.getElementById("remove-avatar");
    const extraSave   = document.getElementById("save-extra");
    const extraSaved  = document.getElementById("extra-saved");

    // helpers
    const blankAvatar = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='100%' height='100%' fill='%23f1f5f9'/></svg>";
    function setBusy(btn,on,label="Save additional info"){
      btn.disabled = on;
      btn.textContent = on ? "Saving…" : label;
    }
    function setHeaderName(data, user){
      const fn = (data?.first_name || "").trim();
      const ln = (data?.last_name || "").trim();
      const fallback = user?.email?.split("@")[0] || "User";
      hdrName.textContent = (fn || ln) ? `${fn} ${ln}`.trim() : fallback;
    }

    // load profile
    async function load(){
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      emailInput.value = user.email || "";

      const { data, error } = await supabase.from("profiles").select("*").eq("id", user.id).single();
      if (error && error.code !== "PGRST116") console.warn(error);

      // demo: account number could be in profiles.account_number
      const acct = data?.account_number || "949915944";
      accNumberEl.textContent = acct;
      sidebarAcc.textContent  = acct;

      firstName.value = data?.first_name || "";
      lastName.value  = data?.last_name  || "";

      const avatarUrl = data?.avatar_url || blankAvatar;
      avPrev.src = avatarUrl;
      hdrAvatar.src = avatarUrl;
      avRemove.classList.toggle("hidden", !data?.avatar_url);

      setHeaderName(data, user);
    }

    // upload avatar
    async function uploadAvatar(file){
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error("Not signed in");
      if (!file) return;
      if (!file.type.startsWith("image/")) throw new Error("Please choose an image");
      if (file.size > 2 * 1024 * 1024) throw new Error("Image too large (max 2MB)");

      avPrev.src = URL.createObjectURL(file); // optimistic preview

      const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
      const path = `${user.id}/avatar_${Date.now()}.${ext}`;

      const { error: upErr } = await supabase.storage.from(AVATAR_BUCKET)
        .upload(path, file, { upsert:true, cacheControl:"3600", contentType: file.type });
      if (upErr) throw upErr;

      const { data: pub } = supabase.storage.from(AVATAR_BUCKET).getPublicUrl(path);
      const avatar_url = pub.publicUrl;

      const { error: dbErr } = await supabase.from("profiles")
        .upsert({ id:user.id, avatar_url, updated_at:new Date().toISOString() }).eq("id", user.id);
      if (dbErr) throw dbErr;

      hdrAvatar.src = avatar_url;
      avRemove.classList.remove("hidden");
    }

    avFile.addEventListener("change", async () => {
      const f = avFile.files?.[0];
      if (!f) return;
      try { await uploadAvatar(f); } catch(e){ alert(e.message || "Could not upload avatar"); }
    });

    avRemove.addEventListener("click", async ()=>{
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      const { error } = await supabase.from("profiles")
        .update({ avatar_url:null, updated_at:new Date().toISOString() }).eq("id", user.id);
      if (error) return alert(error.message);
      avPrev.src = blankAvatar;
      hdrAvatar.src = blankAvatar;
      avRemove.classList.add("hidden");
    });

    // save extra
    extraSave.addEventListener("click", async ()=>{
      setBusy(extraSave,true);
      extraSaved.classList.add("hidden");
      try{
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error("Not signed in");
        const payload = {
          id: user.id,
          first_name: firstName.value.trim(),
          last_name:  lastName.value.trim(),
          updated_at: new Date().toISOString()
        };
        const { error } = await supabase.from("profiles").upsert(payload).eq("id", user.id);
        if (error) throw error;

        // sync to user metadata for quick header use elsewhere
        await supabase.auth.updateUser({
          data: { first_name: payload.first_name, last_name: payload.last_name, full_name: `${payload.first_name} ${payload.last_name}`.trim() }
        }).catch(()=>{});

        setHeaderName(payload, user);
        extraSaved.classList.remove("hidden");
      }catch(e){ alert(e.message || "Failed to save"); }
      finally{ setBusy(extraSave,false); }
    });

    await load();
  </script>
</body>
</html>
