<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AlgoHive – Dashboard (Dynamic)</title>

  <!-- Tailwind + Fonts + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root{ --page:#0b1220; --bg:#ffffff; --muted:#64748b; --ink:#0f172a; --olive:#556B2F; --brand:#f59e0b; --line:#e2e8f0 }
    html,body{ font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--ink) }
    .card{ background:#fff; border:1px solid var(--line); border-radius:12px }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; height:40px; padding:0 .875rem; border-radius:10px; border:1px solid var(--line); font-weight:600 }
    .input{ height:40px; border:1px solid var(--line); border-radius:10px; padding:0 .75rem }
    .tab{ height:36px; border-radius:8px; padding:0 .75rem }
    .tab-active{ background:#111827; color:#fff }

    /* Layout / Sidebar */
    #layout{ --sb:220px; display:grid; grid-template-columns:var(--sb) 1fr; min-height:100vh }
    #layout.is-collapsed{ --sb:64px }
    #ah-sidebar{ transition: width .2s ease; width:var(--sb) }
    #ah-sidebar[data-collapsed="true"] .label, #ah-sidebar[data-collapsed="true"] .chevron{ display:none }
    #ah-sidebar details .sub{ transition: height .2s ease }
    #ah-sidebar[data-collapsed="true"] details>.sub{ display:none!important }
    #ah-sidebar[data-collapsed="true"] nav a, #ah-sidebar[data-collapsed="true"] details>summary{ justify-content:center; gap:.25rem }
    #ah-sidebar[data-collapsed="true"] details>summary span{ gap:0 }
    #ah-sidebar .footer{ transition:all .2s ease }
    #ah-sidebar[data-collapsed="true"] .footer{ justify-content:center; flex-direction:column; gap:12px }
    #ah-sidebar[data-collapsed="true"] .btn-collapse{ order:1 }
    #ah-sidebar[data-collapsed="true"] .btn-settings{ order:2 }
    .btn-collapse :is(svg,i){ display:inline-block; transition:transform .25s ease }
    #ah-sidebar[data-collapsed="true"] .btn-collapse :is(svg,i){ transform:rotate(180deg) }

    .ps-tile{ border:1px solid #e5e7eb; border-radius:14px; padding:14px 16px; background:#fff }
    .ps-label{ color:#64748b; font-weight:500; font-size:.85rem }
    .ps-value{ font-weight:600; font-size:1rem; margin-top:2px }

    .no-scrollbar::-webkit-scrollbar{ display:none }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none }
    canvas{ max-width:100%; height:auto }
  </style>
</head>

<body class="min-h-screen overflow-x-hidden">
  <div id="layout">
    <!-- ===== Sidebar ===== -->
    <aside id="ah-sidebar" data-collapsed="false" class="border-r border-slate-200 h-[100vh] sticky top-0 bg-white flex flex-col overflow-hidden">
      <div class="px-4 py-4 flex items-center gap-3 border-b border-slate-200">
        <img src="https://static.wixstatic.com/media/ac771e_af06d86a7a1f4abd87e52e45f3bcbd96~mv2.png" alt="AlgoHive Logo" class="w-10 h-10 object-contain"/>
        <div class="min-w-0">
          <div class="font-bold text-[15px] text-slate-900 label">AlgoHive</div>
          <div class="text-[11px] text-slate-500 label">ID: <span id="sidebar-acc">—</span></div>
        </div>
      </div>

      <nav class="p-2 text-[14px] flex-1 overflow-y-auto">
        <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50 font-medium text-slate-900 bg-slate-100" href="#" title="Home">
          <i class="fa-solid fa-house text-slate-500 w-4 shrink-0"></i><span class="label">Home</span>
        </a>
        <!-- other navs trimmed for brevity -->
      </nav>

      <div class="p-3 border-t border-slate-200 footer flex items-center justify-between gap-2">
        <button id="ah-settings" class="btn btn-settings h-10 w-10 p-0 rounded-xl bg-slate-100 hover:bg-slate-200 border-0"><i class="fa-solid fa-gear"></i></button>
        <button id="ah-collapse" class="btn btn-collapse h-10 w-10 p-0 rounded-xl bg-slate-100 hover:bg-slate-200 border-0"><i class="fa-solid fa-arrow-left"></i></button>
      </div>
    </aside>

    <!-- ===== Main ===== -->
    <main class="flex-1 min-w-0">
      <!-- Header -->
      <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 bg-white">
        <div class="flex items-center gap-3 flex-1 min-w-0 max-w-[460px]">
          <div class="relative w-full">
            <input class="input w-full pl-9" placeholder="Search"/>
            <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
          </div>
        </div>
        <div class="flex items-center gap-3"><i class="fa-regular fa-bell text-slate-500"></i></div>
      </div>

      <!-- GRID -->
      <div class="px-6 py-6 grid grid-cols-12 gap-6 min-w-0">
        <!-- Portfolio Card -->
        <section id="portfolio-card" class="card col-span-12 lg:col-span-9">
          <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200">
            <div>
              <h3 class="font-normal text-slate-800">Your portfolio</h3>
              <div class="mt-1 text-sm text-slate-500" id="pf-updated">—</div>
            </div>
            <div class="flex items-center gap-2">
              <button data-range="1D" class="tab tab-active text-[13px]">1D</button>
              <button data-range="1M" class="tab text-[13px]">1M</button>
              <button data-range="1Y" class="tab text-[13px]">1Y</button>
              <button data-range="ALL" class="tab text-[13px]">All</button>
              <button id="pf-refresh" class="ml-2 h-9 w-9 rounded-lg border border-slate-200 grid place-items-center"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
          </div>
          <div class="px-5 pt-4">
            <div class="flex items-baseline gap-3">
              <div class="text-2xl font-bold" id="pf-value">—</div>
              <div class="text-lg font-normal" id="pf-change">—</div>
            </div>
          </div>
          <div class="px-2 pb-4 pt-2">
            <div class="h-[260px]"><canvas id="pf-chart"></canvas></div>
          </div>
        </section>

        <!-- Right column -->
        <aside class="col-span-12 lg:col-span-3 grid gap-6">
          <!-- Strategies Card w/ selector -->
          <div class="card p-5 border border-slate-200">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-base font-medium text-slate-900">Strategies</h3>
              <div class="flex items-center gap-2">
                <label for="acct-select" class="text-xs text-slate-500">Account</label>
                <select id="acct-select" class="h-9 rounded-lg border border-slate-200 px-3 text-sm min-w-[220px]"><option>Loading…</option></select>
                <a href="#" class="text-sm text-olive-600 hover:underline">View all</a>
              </div>
            </div>
            <ul class="space-y-3" id="strat-list"></ul>
          </div>
        </aside>
      </div>

      <!-- Charts -->
      <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

      <!-- Supabase account loader -->
      <script type="module">
        import { supabase } from "/js/supabase.js";
        const $=(q,el=document)=>el.querySelector(q);
        const fmtMoney=(sym,v)=>`${sym} ${Number(v||0).toLocaleString('en-ZA',{minimumFractionDigits:2,maximumFractionDigits:2})}`;
        const pct=(a,b)=>(b==null||b===0)?0:((a-b)/b*100);
        const symFor=(ccy)=>ccy==='USD'?'$':'R';

        const { data:{ session } }=await supabase.auth.getSession();
        if(!session){ location.replace('/auth.html'); }
        const { data:{ user } }=await supabase.auth.getUser();

        const { data:accounts,error }=await supabase
          .from('investment_accounts')
          .select('*').eq('profile_id',user.id);
        if(error) console.error(error);

        let current=(accounts||[]).find(a=>a.status==='ACTIVE')||(accounts||[])[0];
        if(!current) throw new Error('No accounts');

        const acctSel=$('#acct-select');
        acctSel.innerHTML=(accounts||[]).map(a=>`<option value="${a.id}">${a.broker} • ${a.account_number}</option>`).join('');
        acctSel.value=current.id;
        acctSel.onchange=()=>{current=accounts.find(a=>a.id===acctSel.value); renderRange('1D');};
        $('#sidebar-acc').textContent=current.account_number;

        const ctx=document.getElementById('pf-chart').getContext('2d');
        const grad=ctx.createLinearGradient(0,0,0,260);
        grad.addColorStop(0,'rgba(85,107,47,0.35)');
        grad.addColorStop(1,'rgba(85,107,47,0.06)');

        let chart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[{data:[],borderColor:'#556B2F',borderWidth:2,backgroundColor:grad,fill:true,tension:.35,pointRadius:0}]},options:{plugins:{legend:{display:false}}}});

        function updateHeader(arr){
          const a0=arr[0]??0,aN=arr[arr.length-1]??0;
          const ch=pct(aN,a0);
          $('#pf-value').textContent=fmtMoney(symFor(current.currency),current.equity||current.balance||0);
          $('#pf-change').textContent=`${ch>=0?'+':''}${ch.toFixed(2)}%`;
          $('#pf-change').style.color=ch>=0?'#16a34a':'#ef4444';
          $('#pf-updated').textContent=new Date().toLocaleString('en-ZA');
        }

        function getSeries(r){return current[`eq_${r.toLowerCase()}`]||[];}
        function renderRange(r){
          const arr=getSeries(r);
          chart.data.labels=arr.map((_,i)=>i);
          chart.data.datasets[0].data=arr;
          chart.update(); updateHeader(arr);
        }
        document.querySelectorAll('#portfolio-card .tab').forEach(btn=>{
          btn.onclick=()=>renderRange(btn.dataset.range=btn.textContent);
        });
        renderRange('1D');
      </script>
    </main>
  </div>
</body>
</html>
