<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stokvel — Loans Portal</title>

  <!-- Tailwind + Fonts + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- html2pdf for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root { --olive:#556B2F; --olive-700:#3e4f23; --olive-100:#ecf4e6; --page-bg:#f9fafb; }
    html,body{ font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--page-bg); color:#0f172a}
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:1rem; box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .chip{ display:inline-flex; align-items:center; border-radius:9999px; padding:.2rem .55rem; font-size:.74rem; font-weight:600}
    .glass{ backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); background:rgba(255,255,255,.65); border-bottom:1px solid rgba(229,231,235,.9)}
    .num{ font-variant-numeric:tabular-nums }
    .tab-btn{ border:1px solid #e5e7eb; border-radius:.6rem; padding:.35rem .7rem; font-size:.85rem; background:#fff }
    .tab-btn.active{ background:var(--olive); border-color:var(--olive); color:#fff }
    .aside-rail{ width:360px }
    @media (max-width:1024px){ .aside-rail{ width:auto } }
    .eq-tip{ position:absolute; pointer-events:none; background:#111827; color:#fff; font-size:.75rem; border-radius:.5rem; padding:.35rem .5rem; box-shadow:0 10px 25px rgba(0,0,0,.12)}
    .spark{ height:30px; width:120px }
    .cal-grid{ display:grid; grid-template-columns:repeat(7,minmax(0,1fr)); gap:.35rem }
    .cal-cell{ border:1px solid #e5e7eb; border-radius:.6rem; height:58px; display:flex; flex-direction:column; justify-content:space-between; padding:.35rem .4rem }
    .cal-legend span{ display:inline-block; width:14px; height:10px; border-radius:3px; border:1px solid #e5e7eb }
    .topbar{ height:52px }
    .sub-card.active{ background:var(--olive-100); border-color:var(--olive); box-shadow:inset 0 0 0 2px var(--olive-100); position:relative }
    .sub-card.active::before{ content:""; position:absolute; inset:0 auto 0 0; width:4px; background:var(--olive); border-top-left-radius:.75rem; border-bottom-left-radius:.75rem }
    .popover::before{ content:""; position:absolute; top:-6px; right:18px; border-width:6px; border-style:solid; border-color:transparent transparent #e5e7eb transparent }
    .popover::after{ content:""; position:absolute; top:-5px; right:18px; border-width:5px; border-style:solid; border-color:transparent transparent #fff transparent }
    /* PRINT */
    @media print{ body{background:#fff} .glass,#topbar-actions,.eq-controls,.no-print{display:none!important} .page-shell{max-width:100%!important; padding:0 24px!important} .print-header{display:flex!important} .card{box-shadow:none!important} }
    /* Sidebar collapse (if you mount a sidebar) */
    #sidebar{ width:260px; transition:width .2s ease } #sidebar.is-collapsed{ width:64px }
    #sidebar .label{ transition:opacity .15s ease } #sidebar.is-collapsed .label{ opacity:0; pointer-events:none }
    #sidebar.is-collapsed .sidebar-link{ justify-content:center }
    #sidebar .sidebar-link{ display:flex; align-items:center; gap:.6rem; padding:.5rem .6rem; border-radius:.5rem }
    #sidebar .sidebar-link i{ width:18px; text-align:center }
  </style>
</head>

<body>
  <div class="min-h-screen flex">
    <!-- GLOBAL MENU (optional mount) -->
    <div id="sidebarMount" data-menu="/partials/menu.html"></div>

    <!-- MAIN -->
    <main class="flex-1 min-h-screen" id="dashboardRoot">
      <!-- Topbar -->
      <section class="glass sticky top-0 z-20 topbar">
        <div class="max-w-7xl mx-auto px-6 h-full flex items-center gap-3 relative">
          <div class="text-sm text-slate-600">Loans Dashboard</div>

          <div class="flex items-center gap-2 flex-1">
            <div class="hidden md:flex items-center border rounded-full px-3 h-9 bg-white">
              <i class="fa-solid fa-magnifying-glass mr-2 text-gray-500"></i>
              <input id="search" placeholder="Search borrowers, loans, groups…" class="outline-none text-sm w-64" />
            </div>

            <!-- Right actions -->
            <div id="topbar-actions" class="ml-auto flex items-center gap-3">
              <button id="exportBtn" class="border rounded-lg h-9 px-3 bg-white hover:bg-slate-50">
                <i class="fa-solid fa-file-arrow-down mr-2"></i>Export Loan Statement
              </button>
              <button id="whatsappBtn" class="border rounded-lg h-9 px-3 bg-white hover:bg-slate-50">
                <i class="fa-brands fa-whatsapp mr-2"></i>WhatsApp Reminder
              </button>
              <img src="https://ui-avatars.com/api/?name=Stokvel&background=0f172a&color=fff&rounded=true&size=64"
                alt="Profile" class="h-9 w-9 rounded-full border object-cover" />
            </div>
          </div>
        </div>
      </section>

      <!-- PRINT HEADER -->
      <div class="print-header hidden items-center justify-between px-6 py-4">
        <div class="flex items-center gap-3">
          <img src="https://dummyimage.com/140x40/0f172a/ffffff&text=STOKVEL" alt="Stokvel" class="h-8">
          <div class="text-xs text-slate-500">Statement • Generated on <span id="printDate"></span></div>
        </div>
        <div class="text-sm">Loan Statement</div>
      </div>

      <!-- PAGE SHELL -->
      <div class="max-w-7xl mx-auto px-6 page-shell" id="sheetArea">
        <!-- Greeting -->
        <section class="pt-6">
          <div class="flex items-center">
            <div>
              <h1 id="greet" class="text-[28px] leading-tight font-semibold">Good morning</h1>
              <p class="text-sm text-slate-600">Track disbursements, repayments, interest and arrears at a glance.</p>
            </div>
          </div>
        </section>

        <!-- Actions Row -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4 no-print">
          <button id="addMemberBtn" class="card p-3 text-left hover:bg-slate-50">
            <div class="font-semibold"><i class="fa-solid fa-user-plus mr-2"></i>Add Borrower</div>
            <div class="text-xs text-slate-500">Capture details & KYC notes</div>
          </button>
          <button id="newLoanBtn" class="card p-3 text-left hover:bg-slate-50">
            <div class="font-semibold"><i class="fa-solid fa-file-signature mr-2"></i>New Loan</div>
            <div class="text-xs text-slate-500">Amount, term & interest</div>
          </button>
          <button id="recordRepaymentBtn" class="card p-3 text-left hover:bg-slate-50">
            <div class="font-semibold"><i class="fa-solid fa-hand-holding-dollar mr-2"></i>Record Repayment</div>
            <div class="text-xs text-slate-500">Monthly instalment or lump sum</div>
          </button>
        </section>

        <!-- Content Grid -->
        <section class="py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
          <!-- LEFT COLUMN -->
          <div class="lg:col-span-8 xl:col-span-9 space-y-6">

            <!-- PORTFOLIO BALANCE (Outstanding) -->
            <div class="card p-5">
              <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
                <div>
                  <div class="text-sm text-slate-600">Outstanding Portfolio — <span id="eqGroupName" class="font-medium">—</span></div>
                  <div class="flex items-center gap-2">
                    <div id="eqValue" class="text-2xl font-semibold num">R —</div>
                    <span id="eqDelta" class="chip bg-green-50 text-green-700">+0.0%</span>
                  </div>
                </div>
                <div class="flex items-center gap-2 eq-controls" id="eqTabs">
                  <button class="tab-btn active" data-range="1M">1M</button>
                  <button class="tab-btn" data-range="3M">3M</button>
                  <button class="tab-btn" data-range="6M">6M</button>
                  <button class="tab-btn" data-range="YTD">YTD</button>
                  <button class="tab-btn" data-range="1Y">1Y</button>
                </div>
              </div>

              <div id="eqMetrics" class="mb-3 grid grid-cols-2 sm:grid-cols-5 gap-3 text-sm">
                <div class="p-3 border rounded-xl">
                  <div class="text-slate-500 text-xs">Total Disbursed</div>
                  <div id="mDisbursed" class="font-semibold">—</div>
                </div>
                <div class="p-3 border rounded-xl">
                  <div class="text-slate-500 text-xs">Outstanding</div>
                  <div id="mOutstanding" class="font-semibold">—</div>
                </div>
                <div class="p-3 border rounded-xl">
                  <div class="text-slate-500 text-xs">Interest Earned (YTD)</div>
                  <div id="mInterest" class="font-semibold">—</div>
                </div>
                <div class="p-3 border rounded-xl">
                  <div class="text-slate-500 text-xs">Arrears</div>
                  <div id="mArrears" class="font-semibold">—</div>
                </div>
                <div class="p-3 border rounded-xl">
                  <div class="text-slate-500 text-xs">Active Loans</div>
                  <div id="mLoans" class="font-semibold">—</div>
                </div>
              </div>

              <div id="eqWrap" class="relative w-full h-[320px] overflow-hidden rounded-xl border bg-white">
                <svg id="eqSvg" viewBox="0 0 900 320" class="w-full h-full"></svg>
                <div id="eqTip" class="eq-tip hidden"></div>
              </div>

              <div id="eqLegend" class="flex flex-wrap items-center gap-2 mt-3 text-xs"></div>
            </div>

            <!-- MONTHLY CASHFLOW (Repayments vs Disbursements) -->
            <div class="card p-5">
              <div class="flex items-center justify-between mb-3">
                <div class="font-semibold">Monthly Cashflow — <span id="mpGroupName">—</span></div>
                <div class="flex items-center gap-2">
                  <label class="text-xs text-slate-500">Group</label>
                  <select id="groupSel" class="border rounded-lg text-sm px-2 py-1"></select>
                  <label class="text-xs text-slate-500 ml-3">Year</label>
                  <select id="yearSel" class="border rounded-lg text-sm px-2 py-1"></select>
                </div>
              </div>

              <div class="w-full h-[260px] relative overflow-hidden rounded-xl border bg-white">
                <svg id="stratChart" viewBox="0 0 900 260" class="w-full h-full"></svg>
                <div id="stratTip" class="eq-tip hidden"></div>
              </div>
              <div class="flex items-center justify-between mt-2 text-xs text-slate-600">
                <div>Repayments (in) vs Disbursements (out) per month</div>
                <div class="flex items-center gap-3">
                  <span class="inline-flex items-center gap-1"><span class="w-3 h-2 inline-block rounded-sm bg-emerald-500"></span>Repayments</span>
                  <span class="inline-flex items-center gap-1"><span class="w-3 h-2 inline-block rounded-sm bg-rose-500"></span>Disbursements</span>
                </div>
              </div>
            </div>

            <!-- REPAYMENT CALENDAR -->
            <div class="card p-5">
              <div class="flex items-center justify-between mb-3">
                <div class="font-semibold">Repayment Calendar — <span id="calMonth"></span> — <span id="dpGroupName">—</span></div>
                <div class="flex items-center gap-2">
                  <label class="text-xs text-slate-500">Month</label>
                  <select id="dpMonth" class="border rounded-lg text-sm px-2 py-1"></select>
                  <label class="text-xs text-slate-500">Year</label>
                  <select id="dpYear" class="border rounded-lg text-sm px-2 py-1"></select>
                  <div class="cal-legend text-xs text-slate-500 ml-3 hidden md:flex items-center gap-2">
                    <span style="background:#dcfce7"></span> Paid &nbsp;
                    <span style="background:#fde68a"></span> Due today &nbsp;
                    <span style="background:#fee2e2"></span> Missed
                  </div>
                </div>
              </div>
              <div class="cal-grid" id="calGrid"></div>
            </div>

            <!-- BORROWERS TABLE -->
            <div class="card">
              <div class="px-5 py-4 border-b flex items-center justify-between">
                <div class="font-semibold">Borrowers & Loan Status — <span id="membersGroupName">—</span></div>
                <div class="text-xs text-slate-500">Standard Instalment: <span id="groupContribution">—</span> / month · Repayment Day: <span id="collectionDay">—</span></div>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="text-slate-600">
                    <tr>
                      <th class="text-left px-5 py-3">Borrower</th>
                      <th class="text-left px-5 py-3">Phone</th>
                      <th class="text-right px-5 py-3">Loan Amount</th>
                      <th class="text-right px-5 py-3">Outstanding</th>
                      <th class="text-right px-5 py-3">Next Due</th>
                      <th class="text-right px-5 py-3">Status</th>
                    </tr>
                  </thead>
                  <tbody id="membersBody" class="divide-y"></tbody>
                </table>
              </div>
            </div>

            <!-- BANK DETAILS / DISBURSEMENT INFO -->
            <div class="card p-5">
              <div class="font-semibold mb-2">Disbursement / Repayment Account</div>
              <div class="grid sm:grid-cols-2 gap-3 text-sm">
                <div class="p-3 border rounded-xl">
                  <div class="text-xs text-slate-500">Account Name</div>
                  <div id="bankAccountName" class="font-semibold">—</div>
                </div>
                <div class="p-3 border rounded-xl">
                  <div class="text-xs text-slate-500">Bank</div>
                  <div id="bankName" class="font-semibold">—</div>
                </div>
                <div class="p-3 border rounded-xl">
                  <div class="text-xs text-slate-500">Account Number</div>
                  <div id="bankAccountNumber" class="font-semibold">—</div>
                </div>
                <div class="p-3 border rounded-xl">
                  <div class="text-xs text-slate-500">Branch Code</div>
                  <div id="bankBranch" class="font-semibold">—</div>
                </div>
              </div>
              <p class="mt-2 text-xs text-slate-500">Repayment reference format: <span class="font-semibold">LOAN-{memberCode}-{MMYY}</span> (e.g. LOAN-THABO-0925)</p>
            </div>
          </div>

          <!-- RIGHT COLUMN -->
          <aside class="lg:col-span-4 xl:col-span-3 space-y-6 aside-rail">
            <!-- My Groups -->
            <div class="card p-5">
              <div class="flex items-center justify-between mb-3">
                <div class="font-semibold">My Loan Groups</div>
                <a href="#" class="text-sm text-[var(--olive-700)] hover:underline">Manage Groups</a>
              </div>
              <div id="subsWrap" class="flex flex-col gap-3 max-h-72 overflow-y-auto"></div>
            </div>

            <!-- Group snapshot -->
            <div class="card p-5">
              <div class="grid grid-cols-2 gap-3 text-sm">
                <div class="p-3 border rounded-xl">
                  <div class="text-slate-500 text-xs">Portfolio Outstanding</div>
                  <div id="acctBal" class="font-semibold num">—</div>
                </div>
                <div class="p-3 border rounded-xl">
                  <div class="text-slate-500 text-xs">Cash Available</div>
                  <div id="acctCash" class="font-semibold num">—</div>
                </div>
              </div>
            </div>

            <!-- Group Health -->
            <div class="card p-5">
              <div class="font-semibold mb-3">Group Health — <span id="prGroupName">—</span></div>
              <div class="flex items-center gap-4">
                <svg id="ratingGauge" viewBox="0 0 160 160" class="h-36 w-36"></svg>
                <div>
                  <div id="ratingText" class="text-lg font-semibold">—</div>
                  <div class="text-xs text-slate-500">On-time repayment rate</div>
                  <div class="mt-2">
                    <span id="ratingDeltaChip" class="chip bg-green-50 text-green-700">+0.0%</span>
                    <span class="text-xs text-slate-500 ml-1">vs last year</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Cashflow Breakdown -->
            <div class="card p-5">
              <div class="font-semibold mb-3">Cashflow Breakdown — <span id="fbGroupName">—</span></div>
              <div class="mb-3">
                <div class="h-3 rounded-full bg-gray-100 overflow-hidden">
                  <div id="feeRepay" class="h-3 float-left" style="background:#0f172a;width:0%"></div>
                  <div id="feeDisb" class="h-3 float-left" style="background:#556B2F;width:0%"></div>
                  <div id="feeInterest" class="h-3 float-left" style="background:#94a3b8;width:0%"></div>
                  <div id="feeAdmin" class="h-3 float-left" style="background:#f59e0b;width:0%"></div>
                </div>
                <div class="text-xs text-slate-500 mt-1">Proportions of cash movement</div>
              </div>
              <table class="w-full text-sm">
                <thead class="text-slate-500">
                  <tr>
                    <th class="text-left py-2">Type</th>
                    <th class="text-right py-2">Count</th>
                    <th class="text-right py-2">Amount</th>
                  </tr>
                </thead>
                <tbody id="feeRows" class="divide-y"></tbody>
              </table>
            </div>

            <!-- Notices / POPIA -->
            <div class="card p-5">
              <div class="flex items-center justify-between mb-2">
                <div class="font-semibold">Notices</div>
                <button id="healthCta" class="text-[var(--olive-700)] text-sm hover:underline">View All</button>
              </div>
              <ul id="notices" class="text-sm space-y-2"></ul>
              <p class="mt-3 text-xs text-slate-500">POPIA: borrower contact info is used only for loans admin and notices.</p>
            </div>
          </aside>
        </section>
      </div>
      <!-- /PAGE SHELL -->
    </main>
  </div>

  <!-- Popover Portal (Benchmarks) -->
  <div id="benchPortal"></div>

</body>
<script>
  /* ===== MENU PARTIAL (optional) ===== */
  async function loadMenu(){
    const mount=document.getElementById('sidebarMount');
    const url=(mount.getAttribute('data-menu')||'/partials/menu.html').trim();
    try{ const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error('Failed to load '+url); mount.outerHTML=await res.text(); }catch(e){}
  }
  function buildMenu(activeKey='dashboard'){
    const navContainer=document.getElementById('navContainer'); if(!navContainer) return;
    const menu=[{section:'Menu',items:[
      {key:'dashboard',label:'Dashboard',icon:'fa-gauge',href:'/dashboard.html'},
      {key:'groups',label:'Groups',icon:'fa-people-group',href:'#'},
      {key:'borrowers',label:'Borrowers',icon:'fa-users',href:'#'},
      {key:'loans',label:'Loans',icon:'fa-file-signature',href:'#'},
      {key:'repayments',label:'Repayments',icon:'fa-hand-holding-dollar',href:'#'},
      {key:'arrears',label:'Arrears',icon:'fa-triangle-exclamation',href:'#'},
      {key:'reports',label:'Reports',icon:'fa-file-invoice',href:'#'},
      {key:'notices',label:'Notices',icon:'fa-bullhorn',href:'#'},
    ]},{section:'General',items:[
      {key:'settings',label:'Settings',icon:'fa-gear',href:'#'},
      {key:'help',label:'Help',icon:'fa-circle-question',href:'#'},
      {key:'integrations',label:'Integrations',icon:'fa-plug',href:'#'},
      {key:'feedback',label:'Feedback',icon:'fa-comment-dots',href:'#'},
    ]}];
    function group(sec){ const g=document.createElement('div'); g.className='mb-2';
      const header=document.createElement('button'); header.className='w-full flex items-center justify-between px-2 py-1'; header.setAttribute('aria-expanded','true');
      const title=document.createElement('div'); title.className='section-title'; title.textContent=sec.section;
      const right=document.createElement('div'); right.className='label'; right.innerHTML='<i class="fa-solid fa-chevron-up chev text-xs"></i>';
      const body=document.createElement('div'); body.className='group-body';
      const list=document.createElement('nav'); list.className='space-y-1 px-0.5';
      sec.items.forEach(it=>{ const a=document.createElement('a'); a.href=it.href; a.className='sidebar-link'; a.title=it.label; if(it.key===activeKey) a.classList.add('active'); a.innerHTML=`<i class="fa-solid ${it.icon}"></i><span class="label">${it.label}</span>`; list.appendChild(a); });
      body.appendChild(list); header.append(title,right); g.append(header,body);
      requestAnimationFrame(()=>{ body.style.maxHeight=body.scrollHeight+'px'; });
      header.addEventListener('click',()=>{ const exp=header.getAttribute('aria-expanded')==='true'; header.setAttribute('aria-expanded',String(!exp)); const chev=header.querySelector('.chev'); if(exp){ body.style.maxHeight='0px'; chev.classList.add('rot'); } else { body.style.maxHeight=body.scrollHeight+'px'; chev.classList.remove('rot'); } });
      return g; }
    navContainer.innerHTML=''; menu.forEach(s=>navContainer.appendChild(group(s)));
    const sidebar=document.getElementById('sidebar'); const collapseBtn=document.getElementById('collapseBtn');
    if(sidebar&&collapseBtn){ const applyState=(collapsed)=>{ sidebar.classList.toggle('is-collapsed',collapsed); collapseBtn.innerHTML=collapsed?'<i class="fa-solid fa-angles-right text-sm"></i>':'<i class="fa-solid fa-angles-left text-sm"></i>'; };
      let collapsed=false; try{ collapsed=sessionStorage.getItem('sv_sidebar_collapsed')==='1'; }catch(e){}
      applyState(collapsed); collapseBtn.addEventListener('click',()=>{ collapsed=!collapsed; applyState(collapsed); try{ sessionStorage.setItem('sv_sidebar_collapsed',collapsed?'1':'0'); }catch(e){} }); }
  }

  /* ===== UTIL & DRAW ===== */
  const fmtMoney=v=>new Intl.NumberFormat('en-ZA',{style:'currency',currency:'ZAR',maximumFractionDigits:0}).format(v);
  const greetLine=()=>{ const h=new Date().getHours(); const t=h<12?'Good morning':(h<18?'Good afternoon':'Good evening'); return `${t}, Mihle`; };

  function drawEquity(svgEl, mainSeries, labels){
    const W=900,H=320,pad=34; svgEl.innerHTML='';
    for(let i=0;i<5;i++){ const y=pad+i*(H-2*pad)/4; const ln=document.createElementNS('http://www.w3.org/2000/svg','line'); ln.setAttribute('x1',pad); ln.setAttribute('x2',W-pad); ln.setAttribute('y1',y); ln.setAttribute('y2',y); ln.setAttribute('stroke','#e5e7eb'); ln.setAttribute('stroke-width','1'); svgEl.appendChild(ln); }
    const min=Math.min(...mainSeries), max=Math.max(...mainSeries), rng=(max-min)||1; const step=(W-2*pad)/Math.max(1,(mainSeries.length-1));
    const X=i=>pad+i*step, Y=v=>H-pad-((v-min)/rng)*(H-2*pad);
    const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
    const grad=document.createElementNS('http://www.w3.org/2000/svg','linearGradient'); grad.setAttribute('id','eqGrad'); grad.setAttribute('x1','0'); grad.setAttribute('y1','0'); grad.setAttribute('x2','0'); grad.setAttribute('y2','1');
    const s1=document.createElementNS('http://www.w3.org/2000/svg','stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','#556B2F'); s1.setAttribute('stop-opacity','.28');
    const s2=document.createElementNS('http://www.w3.org/2000/svg','stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','#111827'); s2.setAttribute('stop-opacity','0.02');
    grad.append(s1,s2); defs.appendChild(grad); svgEl.appendChild(defs);
    let dLine=''; mainSeries.forEach((v,i)=>{ dLine+=`${i?'L':'M'}${X(i).toFixed(2)},${Y(v).toFixed(2)} `; });
    const dArea=dLine+`L${X(mainSeries.length-1).toFixed(2)},${H-pad} L${X(0).toFixed(2)},${H-pad} Z`;
    const area=document.createElementNS('http://www.w3.org/2000/svg','path'); area.setAttribute('d',dArea.trim()); area.setAttribute('fill','url(#eqGrad)'); svgEl.appendChild(area);
    const line=document.createElementNS('http://www.w3.org/2000/svg','path'); line.setAttribute('d',dLine.trim()); line.setAttribute('fill','none'); line.setAttribute('stroke','#0f172a'); line.setAttribute('stroke-width','2.75'); svgEl.appendChild(line);
    const dot=document.createElementNS('http://www.w3.org/2000/svg','circle'); dot.setAttribute('cx',X(mainSeries.length-1)); dot.setAttribute('cy',Y(mainSeries.at(-1))); dot.setAttribute('r','4.2'); dot.setAttribute('fill','#0f172a'); svgEl.appendChild(dot);
    const gL=document.createElementNS('http://www.w3.org/2000/svg','g'); labels.forEach((lb,i)=>{ const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.textContent=lb; t.setAttribute('x',X(i)); t.setAttribute('y',H-8); t.setAttribute('font-size','10'); t.setAttribute('text-anchor','middle'); t.setAttribute('fill','#64748b'); gL.appendChild(t); }); svgEl.appendChild(gL);
  }

  function drawDonut(el, percent){
    const r=68,cx=80,cy=80,C=2*Math.PI*r,val=Math.max(0,Math.min(100,percent)); el.innerHTML='';
    const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
    const grad=document.createElementNS('http://www.w3.org/2000/svg','linearGradient'); grad.setAttribute('id','gOlive'); grad.setAttribute('x1','0%'); grad.setAttribute('y1','0%'); grad.setAttribute('x2','100%'); grad.setAttribute('y2','0%');
    const s1=document.createElementNS('http://www.w3.org/2000/svg','stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','#000');
    const s2b=document.createElementNS('http://www.w3.org/2000/svg','stop'); s2b.setAttribute('offset','60%'); s2b.setAttribute('stop-color','#111827');
    const s3=document.createElementNS('http://www.w3.org/2000/svg','stop'); s3.setAttribute('offset','100%'); s3.setAttribute('stop-color','#556B2F');
    grad.append(s1,s2b,s3); defs.appendChild(grad); el.appendChild(defs);
    const bg=document.createElementNS('http://www.w3.org/2000/svg','circle'); bg.setAttribute('cx',cx); bg.setAttribute('cy',cy); bg.setAttribute('r',r); bg.setAttribute('fill','none'); bg.setAttribute('stroke','#e5e7eb'); bg.setAttribute('stroke-width','16'); el.appendChild(bg);
    const arc=document.createElementNS('http://www.w3.org/2000/svg','circle'); arc.setAttribute('cx',cx); arc.setAttribute('cy',cy); arc.setAttribute('r',r); arc.setAttribute('fill','none'); arc.setAttribute('stroke','url(#gOlive)'); arc.setAttribute('stroke-width','16'); arc.setAttribute('stroke-linecap','round'); arc.setAttribute('transform','rotate(-90 80 80)'); arc.setAttribute('stroke-dasharray',`${(val/100)*C} ${C}`); el.appendChild(arc);
    const txt=document.createElementNS('http://www.w3.org/2000/svg','text'); txt.textContent=val.toFixed(0)+'%'; txt.setAttribute('x',cx); txt.setAttribute('y',cy+5); txt.setAttribute('text-anchor','middle'); txt.setAttribute('font-size','20'); txt.setAttribute('font-weight','700'); txt.setAttribute('fill','#0f172a'); el.appendChild(txt);
  }

  function drawBars(svgEl, values, labels){
    const W=900,H=260,padL=42,padB=26,padT=16,padR=12; svgEl.innerHTML='';
    for(let i=0;i<4;i++){ const y=padT+i*(H-padT-padB)/3; const ln=document.createElementNS('http://www.w3.org/2000/svg','line'); ln.setAttribute('x1',padL); ln.setAttribute('x2',W-padR); ln.setAttribute('y1',y); ln.setAttribute('y2',y); ln.setAttribute('stroke','#e5e7eb'); ln.setAttribute('stroke-width','1'); svgEl.appendChild(ln); }
    const absMax=Math.max(2,Math.max(...values.map(v=>Math.abs(v)))); const maxY=absMax, minY=-absMax;
    const xw=(W-padL-padR)/values.length*0.72; const xPos=i=>padL+(i+0.5)*((W-padL-padR)/values.length)-xw/2; const yPos=v=>padT+(maxY-v)*((H-padT-padB)/(maxY-minY));
    const y0=yPos(0); const zero=document.createElementNS('http://www.w3.org/2000/svg','line'); zero.setAttribute('x1',padL); zero.setAttribute('x2',W-padR); zero.setAttribute('y1',y0); zero.setAttribute('y2',y0); zero.setAttribute('stroke','#cbd5e1'); zero.setAttribute('stroke-width','1.2'); svgEl.appendChild(zero);
    values.forEach((v,i)=>{ const rect=document.createElementNS('http://www.w3.org/2000/svg','rect'); const x=xPos(i), y=Math.min(y0,yPos(v)), h=Math.abs(yPos(v)-y0); rect.setAttribute('x',x); rect.setAttribute('y',y); rect.setAttribute('width',xw); rect.setAttribute('height',Math.max(0.5,h)); rect.setAttribute('rx','4'); rect.setAttribute('fill', v>=0?'#10b981':'#ef4444'); rect.dataset.idx=i; svgEl.appendChild(rect); });
    const g=document.createElementNS('http://www.w3.org/2000/svg','g'); labels.forEach((lb,i)=>{ const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.textContent=lb; t.setAttribute('x',padL+(i+0.5)*((W-padL-padR)/labels.length)); t.setAttribute('y',H-8); t.setAttribute('font-size','10'); t.setAttribute('text-anchor','middle'); t.setAttribute('fill','#64748b'); g.appendChild(t); }); svgEl.appendChild(g);
  }

  /* ===== SAMPLE
