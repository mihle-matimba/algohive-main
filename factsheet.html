<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AlgoHive — Strategy Factsheet</title>

  <!-- Tailwind + Fonts + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root { --olive:#556B2F; --olive-700:#3e4f23; --olive-100:#ecf4e6; --page-bg:#f9fafb; }
    html,body { font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--page-bg); color: #0f172a; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:1rem; box-shadow:0 1px 2px rgba(0,0,0,.04) }
    .chip{ display:inline-flex; align-items:center; border-radius:9999px; padding:.2rem .55rem; font-size:.74rem; font-weight:600 }
    .glass{ backdrop-filter: blur(8px); -webkit-backdrop-filter:blur(8px); background:rgba(255,255,255,.65); border-bottom:1px solid rgba(229,231,235,.9) }
    .num{ font-variant-numeric: tabular-nums }
    .topbar{ height:52px }
    .kv td{ padding:.4rem .6rem; border-bottom:1px solid #e5e7eb; font-size:.9rem; }
    .kv td:first-child{ color:#64748b; width:46% }
    /* charts */
    .tip{ position:absolute; pointer-events:none; background:#111827; color:#fff; font-size:.75rem; border-radius:.5rem; padding:.35rem .5rem; box-shadow:0 10px 25px rgba(0,0,0,.12) }
    .legend-dot{ width:10px; height:10px; border-radius:9999px; display:inline-block; }
    /* print */
    @media print{ .no-print{ display:none !important } body{ background:#fff } .print-block{ break-inside: avoid } }
  </style>
</head>
<body>
  <div class="min-h-screen flex">
    <!-- GLOBAL MENU (partial) -->
    <div id="sidebarMount" data-menu="/partials/menu.html"></div>

    <!-- MAIN -->
    <main class="flex-1 min-h-screen">
      <!-- Topbar -->
      <section class="glass sticky top-0 z-10 topbar no-print">
        <div class="max-w-7xl mx-auto px-6 h-full flex items-center gap-3">
          <a href="/dashboard.html" class="text-sm text-slate-600 hover:underline">Dashboard</a>
          <i class="fa-solid fa-chevron-right text-xs text-slate-400"></i>
          <div class="text-sm text-slate-900 font-medium">Factsheet</div>
          <div class="flex items-center gap-2 w-full">
            <div class="hidden md:flex items-center border rounded-full px-3 h-9 bg-white ml-4">
              <i class="fa-solid fa-magnifying-glass mr-2 text-gray-500"></i>
              <input id="search" placeholder="Search anything…" class="outline-none text-sm w-56" />
            </div>
            <button id="btnPrint" class="border rounded-lg h-9 px-3 bg-white ml-auto mr-0"><i class="fa-solid fa-file-arrow-down mr-2"></i>Export PDF</button>
          </div>
        </div>
      </section>

      <!-- Page -->
      <div class="max-w-7xl mx-auto px-6">
        <!-- Header -->
        <section class="pt-6">
          <div class="flex flex-wrap items-center gap-4 justify-between">
            <div class="min-w-0">
              <div class="flex items-center gap-2 text-xs text-slate-500">
                <span class="uppercase tracking-wider">Strategy Factsheet</span>
                <span class="hidden sm:inline">•</span>
                <span id="fsUpdated" class="hidden sm:inline"></span>
              </div>
              <h1 id="fsTitle" class="text-[28px] leading-tight font-semibold truncate">—</h1>
              <div class="flex flex-wrap items-center gap-2 mt-1 text-sm text-slate-600">
                <span id="fsProvider">—</span>
                <span>•</span>
                <span id="fsSince">Live since —</span>
                <span>•</span>
                <span id="fsCurrency">—</span>
                <span class="chip bg-amber-50 text-amber-700" id="fsRisk">Risk —</span>
                <span class="chip bg-emerald-50 text-emerald-700" id="fsAum">AUM —</span>
              </div>
            </div>
            <div class="flex items-center gap-3 no-print">
              <select id="strategySel" class="border rounded-lg text-sm px-2 py-1"></select>
              <button id="btnShare" class="border rounded-lg px-3 py-1.5 text-sm bg-white"><i class="fa-solid fa-link mr-2"></i>Copy Link</button>
            </div>
          </div>
        </section>

        <!-- Content Grid -->
        <section class="py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
          <!-- LEFT MAIN -->
          <div class="lg:col-span-8 xl:col-span-9 space-y-6">
            <!-- Investment Growth (Net of TIF) -->
            <div class="card p-5 print-block">
              <div class="flex items-center justify-between mb-2">
                <div class="font-semibold">Investment Growth (Net of TIF)<span class="text-xs text-slate-500 font-normal"> — Cumulative wealth (base 100)</span></div>
                <div class="flex items-center gap-4 text-xs">
                  <span><span class="legend-dot" style="background:#0f172a"></span> Portfolio</span>
                  <span><span class="legend-dot" style="background:#556B2F"></span> Benchmark</span>
                </div>
              </div>
              <div class="relative w-full h-[320px] overflow-hidden rounded-xl border bg-white">
                <svg id="growthSvg" viewBox="0 0 900 320" class="w-full h-full"></svg>
                <div id="grTip" class="tip hidden"></div>
              </div>
              <div class="mt-2 text-xs text-slate-500">* TIF (Total Investment Fee) applied as a monthly deduction.</div>
            </div>

            <!-- Asset Allocation (%) -->
            <div class="card p-5 print-block">
              <div class="flex items-center justify-between mb-2">
                <div class="font-semibold">Asset Allocation (%)</div>
                <div class="text-xs text-slate-500">Percentage (%)</div>
              </div>
              <div class="w-full h-[260px] relative overflow-hidden rounded-xl border bg-white">
                <svg id="allocSvg" viewBox="0 0 900 260" class="w-full h-full"></svg>
              </div>
            </div>

            <!-- Narrative: Risk / Objective / Strategy -->
            <div class="card p-5 print-block">
              <div class="grid md:grid-cols-3 gap-6">
                <div>
                  <div class="font-semibold mb-1">Risk Description</div>
                  <p id="fsRiskDesc" class="text-sm text-slate-700 leading-relaxed">—</p>
                </div>
                <div>
                  <div class="font-semibold mb-1">Investment Objective</div>
                  <p id="fsObjective" class="text-sm text-slate-700 leading-relaxed">—</p>
                </div>
                <div>
                  <div class="font-semibold mb-1">Investment Strategy</div>
                  <p id="fsStrategy" class="text-sm text-slate-700 leading-relaxed">—</p>
                </div>
              </div>
            </div>

            <!-- Costs -->
            <div class="card p-5 print-block">
              <div class="font-semibold mb-2">What Costs Can I Expect to Pay?</div>
              <table class="w-full text-sm">
                <thead class="text-slate-500">
                  <tr>
                    <th class="text-left py-2">Fee</th>
                    <th class="text-right py-2">Incl. VAT</th>
                  </tr>
                </thead>
                <tbody id="costRows" class="divide-y"></tbody>
              </table>
              <div class="text-xs text-slate-500 mt-2">Please refer to the end of the factsheet for detailed notes on fees.</div>
            </div>

            <!-- Disclaimer -->
            <div class="card p-5 print-block">
              <div class="font-semibold mb-2">Important Information</div>
              <p id="fsDisclaimer" class="text-sm text-slate-600 leading-relaxed"></p>
            </div>
          </div>

          <!-- RIGHT RAIL -->
          <aside class="lg:col-span-4 xl:col-span-3 space-y-6">
            <!-- Portfolio Information (Key Facts) -->
            <div class="card p-5">
              <div class="font-semibold mb-2">Portfolio Information</div>
              <table class="kv w-full">
                <tbody id="keyFacts"></tbody>
              </table>
            </div>

            <!-- Portfolio Holdings (Donut) -->
            <div class="card p-5">
              <div class="font-semibold mb-2">Portfolio Holdings (Neutral)</div>
              <div class="flex items-center gap-4">
                <svg id="holdingsDonut" viewBox="0 0 180 180" class="h-40 w-40"></svg>
                <div id="holdingsLegend" class="text-sm grow"></div>
              </div>
            </div>
          </aside>
        </section>
      </div>
    </main>
  </div>

  <script>
    /* =================== MENU PARTIAL (same as dashboard) =================== */
    async function loadMenu() {
      const mount = document.getElementById('sidebarMount');
      const url = (mount.getAttribute('data-menu') || '/partials/menu.html').trim();
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to load ' + url);
      mount.outerHTML = await res.text();
    }
    function buildMenu(activeKey = 'factsheet') {
      const navContainer = document.getElementById('navContainer');
      if (!navContainer) return;
      const menu = [{
        section: "Menu", items: [
          { key: "dashboard", label: "Dashboard", icon: "fa-gauge", href: "/dashboard.html" },
          { key: "open-strategies", label: "Open Strategies", icon: "fa-cubes", href: "/open-strategies.html" },
          { key: "portfolio", label: "My Portfolio", icon: "fa-chart-line", href: "/portfolio.html" },
          { key: "funding", label: "Funding", icon: "fa-wallet", href: "/funding.html" },
          { key: "reports", label: "Reports", icon: "fa-file-invoice", href: "/reports.html" },
          { key: "news", label: "News & Insights", icon: "fa-newspaper", href: "/news.html" },
          { key: "alerts", label: "Notifications", icon: "fa-bell", href: "/alerts.html" },
          // (Optional) uncomment if you want a visible Factsheet nav item:
          // { key: "factsheet", label: "Factsheet", icon: "fa-sheet-plastic", href: "/factsheet.html" },
        ]
      }, {
        section: "General", items: [
          { key: "settings", label: "Settings", icon: "fa-gear", href: "/settings.html" },
          { key: "help", label: "Help Desk", icon: "fa-circle-question", href: "/help.html" },
          { key: "integration", label: "Integration", icon: "fa-plug", href: "/integrations.html" },
          { key: "feedback", label: "Feedback", icon: "fa-comment-dots", href: "/feedback.html" },
        ]
      }];
      function group(sec) {
        const g = document.createElement('div'); g.className = 'mb-2';
        const header = document.createElement('button'); header.className = 'w-full flex items-center justify-between px-2 py-1'; header.setAttribute('aria-expanded', 'true');
        const title = document.createElement('div'); title.className = 'section-title'; title.textContent = sec.section;
        const right = document.createElement('div'); right.className = 'label'; right.innerHTML = '<i class="fa-solid fa-chevron-up chev text-xs"></i>';
        const body = document.createElement('div'); body.className = 'group-body';
        const list = document.createElement('nav'); list.className = 'space-y-1 px-0.5';
        sec.items.forEach(it => {
          const a = document.createElement('a'); a.href = it.href; a.className = 'sidebar-link'; a.title = it.label;
          if (it.key === activeKey) a.classList.add('active');
          a.innerHTML = `<i class="fa-solid ${it.icon}"></i><span class="label">${it.label}</span>`; list.appendChild(a);
        });
        body.appendChild(list); header.append(title, right); g.append(header, body);
        requestAnimationFrame(() => { body.style.maxHeight = body.scrollHeight + 'px'; });
        header.addEventListener('click', () => {
          const exp = header.getAttribute('aria-expanded') === 'true';
          header.setAttribute('aria-expanded', String(!exp));
          const chev = header.querySelector('.chev');
          if (exp) { body.style.maxHeight = '0px'; chev.classList.add('rot'); } else { body.style.maxHeight = body.scrollHeight + 'px'; chev.classList.remove('rot'); }
        });
        return g;
      }
      navContainer.innerHTML = ''; menu.forEach(s => navContainer.appendChild(group(s)));
      const sidebar = document.getElementById('sidebar');
      const collapseBtn = document.getElementById('collapseBtn'); let collapsed = false;
      collapseBtn?.addEventListener('click', () => {
        collapsed = !collapsed; sidebar.classList.toggle('is-collapsed', collapsed);
        collapseBtn.innerHTML = collapsed ? '<i class="fa-solid fa-angles-right text-sm"></i>' : '<i class="fa-solid fa-angles-left text-sm"></i>';
        try { sessionStorage.setItem('ah_sidebar_collapsed', collapsed ? '1' : '0'); } catch (e) { };
      });
      try { if (sessionStorage.getItem('ah_sidebar_collapsed') === '1') { collapsed = true; sidebar.classList.add('is-collapsed'); if (collapseBtn) collapseBtn.innerHTML = '<i class="fa-solid fa-angles-right text-sm"></i>'; } } catch (e) { }
    }

    /* =================== UTIL =================== */
    const fmtMoney = (v,c='ZAR')=> new Intl.NumberFormat('en-ZA',{style:'currency',currency:c,maximumFractionDigits:0}).format(v);
    const fmtPct   = (x,dp=2)=> (x>=0?'+':'')+x.toFixed(dp)+'%';
    const lastUpdated = ()=> new Date().toLocaleString();

    /* =================== CHARTS =================== */
    function drawGrowth(svgEl, port, bench, labels){
      const W=900, H=320, padL=44, padR=12, padT=16, padB=28;
      svgEl.innerHTML='';
      const all = port.concat(bench);
      const mn = Math.min(...all), mx = Math.max(...all), rng=(mx-mn)||1;
      // grid
      for(let i=0;i<4;i++){ const y=padT+i*(H-padT-padB)/3; const ln=document.createElementNS('http://www.w3.org/2000/svg','line'); ln.setAttribute('x1',padL); ln.setAttribute('x2',W-padR); ln.setAttribute('y1',y); ln.setAttribute('y2',y); ln.setAttribute('stroke','#e5e7eb'); ln.setAttribute('stroke-width','1'); svgEl.appendChild(ln); }
      const step=(W-padL-padR)/(port.length-1);
      const X=i=> padL+i*step, Y=v=> padT + (mx-v)*((H-padT-padB)/rng);
      // series path helper
      function pathFor(arr){ let d=''; arr.forEach((v,i)=>{ d+=(i?'L':'M')+X(i).toFixed(2)+','+Y(v).toFixed(2)+' '; }); return d.trim(); }

      const pPath = document.createElementNS('http://www.w3.org/2000/svg','path');
      pPath.setAttribute('d', pathFor(port)); pPath.setAttribute('fill','none'); pPath.setAttribute('stroke','#0f172a'); pPath.setAttribute('stroke-width','2.6'); svgEl.appendChild(pPath);

      const bPath = document.createElementNS('http://www.w3.org/2000/svg','path');
      bPath.setAttribute('d', pathFor(bench)); bPath.setAttribute('fill','none'); bPath.setAttribute('stroke','#556B2F'); bPath.setAttribute('stroke-width','2.2'); bPath.setAttribute('stroke-dasharray','4 4'); svgEl.appendChild(bPath);

      // labels (sparse to avoid clutter)
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      const stepL=(W-padL-padR)/(labels.length-1);
      labels.forEach((lb,i)=>{ if(i%6!==0 && i!==labels.length-1) return; const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.textContent=lb; t.setAttribute('x', padL+i*stepL); t.setAttribute('y', H-8); t.setAttribute('font-size','10'); t.setAttribute('text-anchor','middle'); t.setAttribute('fill','#64748b'); g.appendChild(t); });
      svgEl.appendChild(g);
    }

    function drawAllocBars(svgEl, rows){ // rows = [{label,pct,color}]
      const W=900, H=260, padL=130, padR=26, padT=18, padB=28;
      svgEl.innerHTML='';
      const maxPct = Math.max(100, Math.max(...rows.map(r=>r.pct)));
      const X=v=> padL + (v/maxPct)*(W-padL-padR), Y=i=> padT + i*((H-padT-padB)/rows.length) + 8;
      // x grid lines
      for(let i=0;i<=5;i++){ const x=padL+i*(W-padL-padR)/5; const ln=document.createElementNS('http://www.w3.org/2000/svg','line'); ln.setAttribute('x1',x); ln.setAttribute('x2',x); ln.setAttribute('y1',padT); ln.setAttribute('y2',H-padB); ln.setAttribute('stroke','#e5e7eb'); ln.setAttribute('stroke-width','1'); svgEl.appendChild(ln); }
      rows.forEach((r,i)=>{
        // label
        const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.textContent=r.label; t.setAttribute('x', padL-8); t.setAttribute('y', Y(i)+4); t.setAttribute('font-size','11'); t.setAttribute('text-anchor','end'); t.setAttribute('fill','#334155'); svgEl.appendChild(t);
        // bar
        const rect=document.createElementNS('http://www.w3.org/2000/svg','rect'); rect.setAttribute('x', padL); rect.setAttribute('y', Y(i)-8); rect.setAttribute('width', Math.max(1, X(r.pct)-padL)); rect.setAttribute('height', 16); rect.setAttribute('rx','4'); rect.setAttribute('fill', r.color || '#0f172a'); svgEl.appendChild(rect);
        // pct
        const p=document.createElementNS('http://www.w3.org/2000/svg','text'); p.textContent=r.pct.toFixed(2)+'%'; p.setAttribute('x', X(r.pct)+6); p.setAttribute('y', Y(i)+4); p.setAttribute('font-size','11'); p.setAttribute('fill','#64748b'); svgEl.appendChild(p);
      });
      // x-axis labels
      const g=document.createElementNS('http://www.w3.org/2000/svg','g');
      for(let i=0;i<=5;i++){ const v=i*20; const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.textContent=v+'%'; t.setAttribute('x', padL+i*(W-padL-padR)/5); t.setAttribute('y', H-10); t.setAttribute('font-size','10'); t.setAttribute('text-anchor','middle'); t.setAttribute('fill','#64748b'); g.appendChild(t); }
      svgEl.appendChild(g);
    }

    function drawDonut(svgEl, items){ // items = [{label,pct,color}]
      const cx=90, cy=90, r=62, R=72, TAU=Math.PI*2;
      svgEl.innerHTML='';
      const sum = items.reduce((s,i)=>s+i.pct,0) || 1;
      let a0=-Math.PI/2;
      items.forEach(it=>{
        const frac = it.pct/sum;
        const a1 = a0 + frac*TAU;
        // large-arc flags
        const la = (a1-a0) > Math.PI ? 1 : 0;
        const p0 = [cx + R*Math.cos(a0), cy + R*Math.sin(a0)];
        const p1 = [cx + R*Math.cos(a1), cy + R*Math.sin(a1)];
        const q0 = [cx + r*Math.cos(a1), cy + r*Math.sin(a1)];
        const q1 = [cx + r*Math.cos(a0), cy + r*Math.sin(a0)];
        const d = `M ${p0[0]} ${p0[1]} A ${R} ${R} 0 ${la} 1 ${p1[0]} ${p1[1]} L ${q0[0]} ${q0[1]} A ${r} ${r} 0 ${la} 0 ${q1[0]} ${q1[1]} Z`;
        const path=document.createElementNS('http://www.w3.org/2000/svg','path'); path.setAttribute('d', d); path.setAttribute('fill', it.color || '#0f172a'); path.setAttribute('opacity','.95'); svgEl.appendChild(path);
        a0=a1;
      });
      // center label (total)
      const tot=document.createElementNS('http://www.w3.org/2000/svg','text'); tot.textContent='100%'; tot.setAttribute('x',cx); tot.setAttribute('y',cy+5); tot.setAttribute('text-anchor','middle'); tot.setAttribute('font-size','16'); tot.setAttribute('font-weight','700'); svgEl.appendChild(tot);
    }

    /* =================== DATA (sample) =================== */
    const STRATS = {
      'trend-alpha': {
        name:'Trend Alpha', provider:'AlgoForge', currency:'ZAR', aum: 1200000, risk:'Moderate',
        manager:'AlgoHive Multi-Manager', client_need:'2.5% – 6.5% income band', benchmark:'SA CPI +4%', inception:'2021-02-01',
        risk_desc:'Suitable for investors seeking exposure to a diversified mix of growth and income assets while prioritising capital preservation over the medium term. Investors should be willing to accept moderate market volatility in exchange for the possibility of beating inflation.',
        objective:'Provide moderate long-term total return with a low probability of capital loss over the medium term. Target drawdown range of 4.5% to 6.5% and achieve CPI+4% over a rolling 5-year period.',
        strategy:'Dual-bucket rebalancing approach that blends a risk-managed equity trend sleeve with a flexible income sleeve. Uses volatility targeting, dynamic stop-losses and macro filters to reduce tail risk while preserving upside.',
        costs:{ mpc:1.26, tif:1.51 }, // %
        // monthly returns (gross) for portfolio & benchmark (%)
        monthly_port: {
          2019:[0.6,0.4,0.9,1.2,-0.8,0.7,0.9,1.0,-0.3,1.1,0.8,1.0],
          2020:[0.5,-2.1,-6.2,3.8,2.2,1.1,1.2,1.5,0.8,1.0,1.2,1.3],
          2021:[1.0,0.8,0.9,1.3,0.6,0.5,0.9,1.1,1.0,-0.7,1.1,1.0],
          2022:[1.1,-0.8,0.9,1.3,0.6,-2.1,1.0,2.2,-0.4,1.6,0.7,1.2],
          2023:[0.8,1.0,-0.6,1.4,2.1,0.5,1.3,0.9,1.6,-0.7,1.2,1.0],
          2024:[1.1,0.7,0.6,1.0,0.9,1.0,0.4,0.6,1.1,0.8,0.9,1.0]
        },
        monthly_bench: { // CPI+4% proxy (steady)
          2019:[0.5,0.4,0.5,0.5,0.4,0.5,0.5,0.5,0.4,0.5,0.5,0.5],
          2020:[0.5,0.4,0.4,0.5,0.4,0.5,0.5,0.4,0.5,0.4,0.5,0.5],
          2021:[0.4,0.5,0.4,0.4,0.5,0.4,0.4,0.5,0.4,0.4,0.5,0.4],
          2022:[0.5,0.5,0.5,0.4,0.5,0.5,0.4,0.5,0.4,0.5,0.5,0.4],
          2023:[0.4,0.5,0.4,0.5,0.4,0.5,0.4,0.5,0.4,0.5,0.4,0.5],
          2024:[0.4,0.4,0.5,0.4,0.4,0.5,0.4,0.4,0.5,0.4,0.4,0.5]
        },
        allocation:[
          {label:'SA Equity', pct:29.56, color:'#0f172a'},
          {label:'Offshore Equity', pct:25.49, color:'#3b82f6'},
          {label:'SA Cash', pct:10.44, color:'#94a3b8'},
          {label:'Offshore Bonds', pct:4.05, color:'#10b981'},
          {label:'Offshore Cash', pct:2.12, color:'#6ee7b7'},
          {label:'SA Property', pct:1.13, color:'#f59e0b'},
          {label:'Offshore Property', pct:1.05, color:'#f97316'},
        ],
        holdings:[
          {label:'AlgoHive Global Flexible Fund B3', pct:20.15, color:'#0f172a'},
          {label:'Stability Income Fund B1', pct:18.65, color:'#94a3b8'},
          {label:'Asc SA Absolute Prescient Fund B3', pct:10.07, color:'#3b82f6'},
          {label:'Stone Growth BCI Opportunity Fund B3', pct:7.85, color:'#64748b'},
          {label:'Allan Gray Balanced Fund R', pct:7.58, color:'#6366f1'},
          {label:'Baillie Gifford Worldwide Fund', pct:7.55, color:'#10b981'},
          {label:'Laurium SA Flexible Prescient Fund C1', pct:7.56, color:'#ef4444'},
          {label:'Ninety One Opportunity Fund Z', pct:7.23, color:'#f59e0b'},
          {label:'AlgoHive Multi-Asset Growth Fund', pct:7.08, color:'#3f6212'},
          {label:'Truffle SCI Flexible Fund R', pct:7.58, color:'#6b7280'}
        ],
      },

      'momentum-fx': {
        name:'Momentum FX', provider:'QuantBee', currency:'USD', aum: 820000, risk:'Low',
        manager:'AlgoHive Multi-Manager', client_need:'Income stabiliser (low vol)', benchmark:'Bloomberg Barclays US Agg (proxy)', inception:'2020-06-01',
        risk_desc:'Low-volatility FX momentum & carry sleeve designed for diversification from equity beta; tight downside controls.',
        objective:'Low correlation to equities with steady returns and shallow drawdowns.',
        strategy:'Systematic G10 FX basket using time-series momentum & carry with volatility scaling and risk parity sizing.',
        costs:{ mpc:1.10, tif:1.30 },
        monthly_port:{
          2020:[0.3,0.2,0.2,0.4,0.3,0.2,0.1],
          2021:[0.2,0.3,0.1,0.2,0.4,0.2,0.3,0.1,0.4,0.2,0.3,0.2],
          2022:[-0.3,0.6,0.9,-0.4,0.8,1.2,0.5,0.7,-0.2,0.3,0.9,1.1],
          2023:[0.4,0.3,0.2,0.4,0.5,0.3,0.2,0.4,0.3,0.2,0.2,0.3],
          2024:[0.4,0.3,0.2,0.4,0.5,0.3,0.2,0.4,0.3,0.2,0.2,0.3]
        },
        monthly_bench:{
          2020:[0.2,0.2,0.2,0.2,0.2,0.2,0.2],
          2021:[0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2],
          2022:[0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2],
          2023:[0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2],
          2024:[0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2]
        },
        allocation:[
          {label:'FX (G10 Majors)', pct:88.00, color:'#10b981'},
          {label:'Cash', pct:12.00, color:'#94a3b8'}
        ],
        holdings:[
          {label:'EURUSD', pct:22, color:'#0f172a'},
          {label:'GBPUSD', pct:18, color:'#3b82f6'},
          {label:'USDJPY', pct:16, color:'#6366f1'},
          {label:'AUDUSD', pct:14, color:'#10b981'},
          {label:'USDCAD', pct:12, color:'#f59e0b'},
          {label:'USDCHF', pct:10, color:'#ef4444'},
          {label:'NZDUSD', pct:8, color:'#94a3b8'}
        ]
      }
    };

    /* =================== HELPERS =================== */
    function flattenMonthlyMap(m){ // chronological arrays (vals & labels)
      const years = Object.keys(m).map(n=>+n).sort((a,b)=>a-b);
      const vals=[], labels=[]; const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      years.forEach(y=>{ (m[y]||[]).forEach((v,i)=>{ vals.push(v); labels.push(`${months[i]} ${String(y).slice(2)}`); }); });
      return {vals, labels};
    }
    function applyTIFNet(monthlyPct, tifAnnualPct){ // subtract monthly fee
      const mFee = (tifAnnualPct||0)/12;
      return monthlyPct.map(x => x - mFee);
    }
    function seqFromMonthly(pcts, base=100){
      const out=[base]; pcts.forEach(p=> out.push(out.at(-1)*(1+p/100))); return out;
    }

    /* =================== RENDER =================== */
    let currentKey='trend-alpha';

    function renderFactsheet(key){
      const s = STRATS[key] || STRATS[Object.keys(STRATS)[0]];
      currentKey = key;

      // Header
      document.getElementById('fsTitle').textContent = s.name;
      document.getElementById('fsProvider').textContent = s.provider;
      document.getElementById('fsSince').textContent = 'Live since ' + new Date(s.inception).toLocaleDateString();
      document.getElementById('fsCurrency').textContent = s.currency;
      document.getElementById('fsRisk').textContent = 'Risk ' + s.risk;
      document.getElementById('fsAum').textContent = 'AUM ' + fmtMoney(s.aum, s.currency);
      document.getElementById('fsUpdated').textContent = 'Updated ' + lastUpdated();

      // Key Facts
      const facts = [
        ['Discretionary Manager', s.manager],
        ['Client Need', s.client_need],
        ['Benchmark', s.benchmark],
        ['Inception Date', new Date(s.inception).toLocaleDateString()],
        ['Risk Profile', s.risk],
      ];
      document.getElementById('keyFacts').innerHTML = facts.map(([k,v])=>`<tr><td>${k}</td><td class="text-right">${v}</td></tr>`).join('');

      // Narrative
      document.getElementById('fsRiskDesc').textContent = s.risk_desc;
      document.getElementById('fsObjective').textContent = s.objective;
      document.getElementById('fsStrategy').textContent = s.strategy;

      // Growth (net of TIF) vs Benchmark
      const port = flattenMonthlyMap(s.monthly_port);
      const bench = flattenMonthlyMap(s.monthly_bench);
      const seriesPortNet = applyTIFNet(port.vals, s.costs?.tif || 0);
      const eqPort = seqFromMonthly(seriesPortNet, 100);
      const eqBench = seqFromMonthly(bench.vals, 100);
      drawGrowth(document.getElementById('growthSvg'), eqPort, eqBench, port.labels);

      // Allocation bars
      drawAllocBars(document.getElementById('allocSvg'), s.allocation);

      // Holdings donut + legend
      drawDonut(document.getElementById('holdingsDonut'), s.holdings);
      document.getElementById('holdingsLegend').innerHTML = s.holdings.map(h=>`
        <div class="flex items-center justify-between py-1">
          <div class="flex items-center gap-2 min-w-0">
            <span class="legend-dot" style="background:${h.color}"></span>
            <span class="truncate">${h.label}</span>
          </div>
          <div class="num ml-3">${h.pct.toFixed(2)}%</div>
        </div>`).join('');

      // Costs table
      const mpc = (s.costs?.mpc ?? 0), tif = (s.costs?.tif ?? 0);
      document.getElementById('costRows').innerHTML = `
        <tr><td class="py-2">Model Portfolio Charge (MPC) incl. VAT</td><td class="py-2 text-right">${mpc.toFixed(2)}%</td></tr>
        <tr><td class="py-2">Solution Total Investment Fee (TIF) incl. VAT</td><td class="py-2 text-right">${tif.toFixed(2)}%</td></tr>`;

      // Disclaimer
      document.getElementById('fsDisclaimer').innerHTML =
        `Past performance is not indicative of future results. Returns are shown <strong>net of TIF</strong> (see fee table) and before brokerage, slippage and taxes. 
        Trading and investing involve risk, including the possible loss of capital. AlgoHive is an authorised Financial Services Provider (FSP No. 55118) regulated by the FSCA in South Africa. 
        This factsheet is for information only and does not constitute advice.`;
    }

    /* =================== BOOT =================== */
    (async function(){
      await loadMenu();
      buildMenu('factsheet');

      // selector
      const sel=document.getElementById('strategySel');
      sel.innerHTML = Object.entries(STRATS).map(([k,v])=> `<option value="${k}">${v.name}</option>`).join('');
      const qp=new URLSearchParams(location.search); const key=qp.get('strategy'); if(key && STRATS[key]) currentKey=key;
      sel.value=currentKey;

      renderFactsheet(currentKey);

      sel.addEventListener('change', e=>{
        const k=e.target.value; const url=new URL(location.href); url.searchParams.set('strategy',k); history.replaceState({},'',url);
        renderFactsheet(k);
      });

      document.getElementById('btnPrint').addEventListener('click',()=>window.print());
      document.getElementById('btnShare').addEventListener('click',async()=>{
        const url=location.href; try{ await navigator.clipboard.writeText(url); }catch(e){}
        const btn=document.getElementById('btnShare'); const old=btn.innerHTML; btn.innerHTML='<i class="fa-solid fa-check mr-2"></i>Copied!'; setTimeout(()=>btn.innerHTML=old,1200);
      });
    })();
  </script>
</body>
</html>
